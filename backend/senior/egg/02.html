<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.22" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>二、核心组件 | 赵建辉的前端知识库</title><meta name="description" content="前端的基础的html,css,js,进阶的ts,es,sass,less,也有vue,react等框架,也包含node.js后端处理">
    <link rel="preload" href="/note-front/assets/style-iqQQ7olI.css" as="style"><link rel="stylesheet" href="/note-front/assets/style-iqQQ7olI.css">
    <link rel="modulepreload" href="/note-front/assets/app-Cok9BT0p.js"><link rel="modulepreload" href="/note-front/assets/02.html-oWqlb-40.js">
    <link rel="prefetch" href="/note-front/assets/index.html-CBDFUdKH.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-BEDUDlA8.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-BsVjrGVF.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-sD0ZocLq.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-Bnnn3kIR.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-lkD5_tqh.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-FHx8-K78.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-CN-R71Oa.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-DdQN-D0H.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-DEON7lyH.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-Cnwgzeiv.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-BToXmBD8.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-BA0nsNfu.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-DM8VaS0J.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-rwRvIShe.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-DHempCWI.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-D-p0tV1j.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-D0PaUPsf.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-WAj7vjM_.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-C9M2foOS.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-dApqMpz5.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-BudKeAUs.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-Dv8Ixd5Q.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-s_sUGEsW.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-BMO1pyrv.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-C8hP8wPR.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-C5MWZXKi.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-DCziuatT.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-DZIr_UWo.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-6kblyDxU.js" as="script"><link rel="prefetch" href="/note-front/assets/00.html-CXTL9Lnk.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DwAvkFzl.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-Bu7H_1Sy.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DeZs4CRk.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BkwLsPKN.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-BRdE_K-_.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-DDKQsYeZ.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-CjYxV8gF.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-BHIDnxS2.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-BNiQqMbj.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-xBXIEfBt.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-DTtxlGDC.js" as="script"><link rel="prefetch" href="/note-front/assets/00.html-CBN5QRkT.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-BP7H7mRA.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-DZzvpKh1.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-Drkvuukt.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-C1H5c4Cx.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-DbA6CxCJ.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-C0FNBrIb.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-CUUeRUgQ.js" as="script"><link rel="prefetch" href="/note-front/assets/index.html-BlfKj_ek.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-IAaO-hjT.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-B7Mk9Yy8.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BjQMf0Yf.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-DhXyomuH.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-BoEhrFHb.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-DUCP91d5.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-DpDELNxF.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-BnC2KV_4.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-N14Dt8RD.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Etibm5pE.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-L6fU_hEv.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-Cc4gRnoL.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-1-m82TmN.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-Dob_jyQS.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CHWlvgMP.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BdKSEzX9.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-Cr2xAuBU.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BGv7S6GD.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-CaR42qhb.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-D8MO2Vab.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-BKC-kEgU.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-ak_URleo.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DpUpGQXU.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-DfvXiv6x.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-CELliKL5.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-D-1Kpj5a.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-Dhvw6DKE.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-DTUmbttt.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-8lfaIAkJ.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-DdVf1XYM.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-Dw6QLJ2t.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-X2r4461x.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-DzzWbCpP.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-NS1NXKoW.js" as="script"><link rel="prefetch" href="/note-front/assets/13.html-BdlpMAfK.js" as="script"><link rel="prefetch" href="/note-front/assets/14.html-CSAQvvOa.js" as="script"><link rel="prefetch" href="/note-front/assets/15.html-CEpRSn5w.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DcRN1WAV.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-QFhL2cdv.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BSFyvJVJ.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-BR8RF8bv.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BoPzZFM4.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-D7Skw6nv.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-BdeOnF_7.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BuH6OhBS.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-D53Jrsnv.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-4HGhXpBl.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-Z3-dKrpf.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-5VQRR3W2.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-BB7vQCPO.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-BSBHSsrz.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-D5250p3i.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-C4zc5Uyv.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-Cgo6aAsZ.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-CjkuDr2t.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-aJi1Ti2r.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CqylPntc.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-zrSVwi3N.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BdVznpbZ.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-DB8NwUoA.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-DZ4Qfucf.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-E4d3nFdu.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-Ckt-vTzg.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-DXPr-MOn.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-CDDBdrVL.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-Co11GS4E.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-DZcsu5Uq.js" as="script"><link rel="prefetch" href="/note-front/assets/13.html-Bdc1fxrS.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Cie7TaDv.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-5yBCPaGM.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-CHsp3mDi.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BMr9cysq.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-B_zZSFhp.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-Bs6YDl8L.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-Dd_Jp2yO.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-B-CEmJCo.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-CfCvlMPS.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DGaG3qFF.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-I-7DeOs1.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BjfTeu6a.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CuQN-Ejq.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-BpMfc2Xo.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-B293LFli.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-DLJTSJgQ.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-B3EgzxYR.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-GzaTYYex.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-DdJELVUT.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-DUublUcX.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-DOw1qr4U.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Ilz6lDwJ.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BAULvNQb.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-J93GyvDb.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CTufObE_.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BEQhkd3x.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DqpeK_7j.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BNxlYm4R.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-sy1AGjlk.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-8kH5TIGZ.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Ca3gWr6N.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-PQzrVkw5.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BfzdCv-U.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-Cv2RKmF1.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-5qcn1Ts0.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-DA-Zg2xr.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-DLBlQJ_x.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-Dqq_pD7y.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CqTy03QX.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CNKcbiab.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-1fPZdxCA.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CE4esTlV.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-txB9p7Rh.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-0ovIAv8L.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-OdwkVsk-.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-DNnXmRpx.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Btquerfu.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CUP1K1TV.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-De0kxZf6.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-FDlXBneu.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BxxAsPut.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-JPPpL-uF.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-B3AAo10y.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-BYVlBjT3.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-DGvMbyJA.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-DcdDaaz8.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-C9QDpmYk.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-BpEQyEFi.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-CZ-pOag7.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-DWUoeoKM.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-C3j3Jhw8.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-C5qhJ9jB.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-C0wolP1M.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-Bh1M0I18.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BR8_2Jcw.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-Ci4i-pLP.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-D_p8CiWM.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-DZS_TuYv.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-BU00Bzac.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-DOTV-m74.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-6hn3v7VB.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-DYt2owap.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-QxkVF07u.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-U3BaavzP.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-CxFQ5iD3.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-B3f64qHY.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-yRIX45d0.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-Co0O8CSj.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-D8CYFcOj.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DrUvnr6l.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-OdP7QFK4.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DORxf_y9.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CY5iOrYa.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-utWFHNzp.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DOYh5Vet.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-xfJVwM0E.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-s59ytZqv.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-DHZkGapz.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-BfwktrGt.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-D4x6JppM.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-BWBB57pW.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-DIsGWEap.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-Q4XAVuHU.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Cr4AgR6v.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BTAF_K46.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DWwB8u9j.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-VBwulBGa.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CbyPGUhy.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-Ba6oe7Pu.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-BTALIO9f.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-D15uoWEE.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-zVmmGFrB.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CV0stUgJ.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Dy-7v7sP.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-Dt04NJkZ.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-C4nhFFAM.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CAHX2Zit.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-D9A9_w2y.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-DFNp2MkI.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-Ct8hYZpg.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-RaLlZ_Jb.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-DJg-q3LB.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Cd5Uvaix.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-IU9aRY6U.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-2xDH8bzb.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BdAN-tpL.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-Bkls8yiN.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-D8EmMKGL.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-CGGAhzGc.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CRsyLuZA.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DrmKpQXI.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-Dowheb_1.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DIAJV-ia.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-As2avK5Z.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BKo28tM1.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-D41iwy9t.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-DhiBxF-o.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-BSNwhCP_.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-LROmW-Zr.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-CQm93va6.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DCUeZWWG.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-RPtzndLs.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BjK4w9tV.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-8w-retj5.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-DZYX9eF0.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-BmBT1VuB.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-7FPCZD4N.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CmIe3X9J.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-Odx3EpnN.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-CVfnzVhi.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-0iNvw38W.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-BCQJ93lW.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-g9NYhmBw.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-legYG0SU.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CrfJorV4.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-C4HumNXg.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-D_rAMDUA.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-3Zsgpm5l.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-41QJyyDg.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DmsdNkBX.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-Bt38FQ4F.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-WhrmE35w.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-BK-c_K46.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-Bmz2VpNR.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-z042KLTx.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-D2a6Uiri.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DKxRsu7m.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-B7n5_DRf.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Cb9_XuF9.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BQbLiRVo.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-0nS2UOUp.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-XH4v8L6l.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CkFCpGyd.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DfhcFtmP.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CYDmGIlP.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-t3XHajEE.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-_ECIvEsL.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BeHw8SoF.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CzSM7oeF.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CslJx0SM.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DYAMAl2M.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-mHunCXBC.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-D8o4EdCh.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-vjYCenQU.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CY235a30.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-D7I8lIC7.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-w9iMZ1nT.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-z6ncwQIF.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DuAVDPP5.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-DpMiFA9B.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-0cNPBqKE.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-CcmQYYhW.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-D4wOBJaX.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-BlKwDixL.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-BKZ02jBY.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-JsiQuwIx.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-C8s9_pO_.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-DeVxzx7A.js" as="script"><link rel="prefetch" href="/note-front/assets/13.html-CcYpsVly.js" as="script"><link rel="prefetch" href="/note-front/assets/14.html-CkezQEX4.js" as="script"><link rel="prefetch" href="/note-front/assets/15.html-BuhjTS67.js" as="script"><link rel="prefetch" href="/note-front/assets/16.html-hjjGG1KP.js" as="script"><link rel="prefetch" href="/note-front/assets/17.html-DvLKvM5l.js" as="script"><link rel="prefetch" href="/note-front/assets/18.html-DD_hGPpB.js" as="script"><link rel="prefetch" href="/note-front/assets/19.html-UkdzPnyQ.js" as="script"><link rel="prefetch" href="/note-front/assets/20.html-3qePXX7H.js" as="script"><link rel="prefetch" href="/note-front/assets/21.html-DjoLzPc1.js" as="script"><link rel="prefetch" href="/note-front/assets/22.html-HBc3itU-.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-LIqKv-Kp.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BlV6KWUT.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-C30w6eW7.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-C-LCqq4C.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-RCs3Bqmt.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CqGw_Vra.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CDaAaTVn.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DpRlY1MU.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-9-ZM_mXL.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BE37-d66.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-io_JmM0t.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BVyLX-y2.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-BoLGhmLK.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-CkiXuTGB.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CUSyzHW1.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-IWJE9zqI.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-mTJeaYLS.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-COeAKS2t.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-CvfxHdyw.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-X5pZkun5.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-BHfSr_tN.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-C3BT29sj.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-CqPnKedo.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-D4aZvmlF.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CNYs5Vvv.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BIkkPuj0.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BqUfx_Bq.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-Cti3TPao.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DDU6cN06.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-0-mKlrfs.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-CRUgMiRH.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-DFp1ZBtU.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-bx4925mZ.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-IFq_LkpB.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-B60rkotq.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-0HGS71rv.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-lwL6qXCo.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-C4n2QXJx.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-DUR2eKUS.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-B9MvZRX-.js" as="script"><link rel="prefetch" href="/note-front/assets/13.html-DQE7J54P.js" as="script"><link rel="prefetch" href="/note-front/assets/14.html-DdK1BBzc.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DKzMXjQX.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-Ym3SPJwR.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-Cx7aRx65.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-Dk4_0vAV.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-CBC3m1AJ.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-DI_ZrgLK.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-CfNT5Ol7.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-odBXzKtl.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-DuQPyhOP.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-CD9biDPc.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-Z7tFShpX.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-DfY0Lc4a.js" as="script"><link rel="prefetch" href="/note-front/assets/13.html-CTFSXTrQ.js" as="script"><link rel="prefetch" href="/note-front/assets/14.html-BDFNE2g1.js" as="script"><link rel="prefetch" href="/note-front/assets/15.html-C70cIqvU.js" as="script"><link rel="prefetch" href="/note-front/assets/16.html-BbO0N5N_.js" as="script"><link rel="prefetch" href="/note-front/assets/17.html-BOJjWncM.js" as="script"><link rel="prefetch" href="/note-front/assets/00.html-CLy7fK7y.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Kd7hJ5GQ.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-DExZHKS0.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-C0JbDdz8.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BibYPT3X.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-DoXs4CkI.js" as="script"><link rel="prefetch" href="/note-front/assets/00.html-C0PaSG8T.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Bhxpndcy.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-O6yFAAAa.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DJz7xkbt.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-ChVDFWGa.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-DEcJ-jqh.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-sp2lXMeI.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-lZfJGuII.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-D4iPOzZh.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-CHVJKdwo.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-puj3dVzO.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-FC46sL49.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CTzUQYrh.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-oaI2VDIZ.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CeGfWU30.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-AjiY99xL.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BdeM_az6.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-D2jWBV6v.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CzQ6_h8D.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-Dj7ymYse.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-FBC0KEOe.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-Bdmbj_Gj.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-DtVfrLjv.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-BZqwfSca.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-BTn_Uri3.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-BcfHD4hZ.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-Rd6t5rt2.js" as="script"><link rel="prefetch" href="/note-front/assets/13.html-CuPyYHAm.js" as="script"><link rel="prefetch" href="/note-front/assets/14.html-CU1EyQH9.js" as="script"><link rel="prefetch" href="/note-front/assets/15.html-CBO6Ws5R.js" as="script"><link rel="prefetch" href="/note-front/assets/16.html-BR7mB121.js" as="script"><link rel="prefetch" href="/note-front/assets/17.html-CKafl59Q.js" as="script"><link rel="prefetch" href="/note-front/assets/18.html-Bm4zAvG2.js" as="script"><link rel="prefetch" href="/note-front/assets/19.html-JXBedbGn.js" as="script"><link rel="prefetch" href="/note-front/assets/20.html-COnGxqPk.js" as="script"><link rel="prefetch" href="/note-front/assets/21.html-DrqCAMzE.js" as="script"><link rel="prefetch" href="/note-front/assets/22.html-Cfp16sxj.js" as="script"><link rel="prefetch" href="/note-front/assets/23.html-CiWna-Ds.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-BFD5npTX.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BQsrDMX1.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-CtZYfjs4.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CqaofeWs.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-BHUnQcp1.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CNriX6FG.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-DQGlxmdV.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-LX84J2N9.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BYo1BNkl.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-QMkL2tMn.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-DBE2aluM.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-CJK2v39n.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-DWIvjP2r.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-CkC05nC6.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-qHktcqzT.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-D7KAcLJ_.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-C1JNOgpz.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-BCAdxVqO.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CbFXjoA3.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DsdfcST_.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-DibF_TPc.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DWGxDlHn.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-Dqzbxp31.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Jh-M_ole.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CdT_wZI4.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BfCfnZQm.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CQlXVJxI.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CS4zigTv.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CVlmmqYw.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-7VUfghaf.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-DK2zg4Wx.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-BpVo9hCI.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-C0mupD4p.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-BmMNBw6v.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-tR7SbS8z.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Q6vE7laL.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-D6-cVKoy.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-CIeK0qpb.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BI69lNGe.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-C0KL6DVG.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-B5Y94mFP.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-AgCvlo-c.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-Dj3H_FMw.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-Cl8MbrdG.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-Wig_8fWB.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-MAduf_4c.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-D1_Pknak.js" as="script"><link rel="prefetch" href="/note-front/assets/13.html-10hyBLqm.js" as="script"><link rel="prefetch" href="/note-front/assets/14.html-BnI1reQ7.js" as="script"><link rel="prefetch" href="/note-front/assets/15.html-CeC3tOsM.js" as="script"><link rel="prefetch" href="/note-front/assets/16.html-BK_M8RKN.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html--oPzyjuO.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CFupcg8P.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-B6RdXZGi.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-D8187fnr.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-DJRLgQqs.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Dsoqh3n7.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-6aAXZ_j-.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-Cb8MBJWH.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CVaKY7TT.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-BDsgHLiz.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-B0qOMjYZ.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-xyJ0wrGV.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BObW1K4n.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BJ2AO5DN.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-Rs9gopm1.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-NwWlfaYl.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-T7FLsGPW.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-BbOvYu-B.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-tGCMOjd4.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-BF-1TRQY.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-Bij9UtAq.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-Dt3du3Q3.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BqqIFlXj.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-BJvrlccQ.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-DsmhPDxF.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-CAhDRWJw.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-e9mA0R_8.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-B5tB7u5f.js" as="script"><link rel="prefetch" href="/note-front/assets/09.html-Cdh3XZy7.js" as="script"><link rel="prefetch" href="/note-front/assets/10.html-CCWh5Dkj.js" as="script"><link rel="prefetch" href="/note-front/assets/11.html-BEkzXH9n.js" as="script"><link rel="prefetch" href="/note-front/assets/12.html-vgYs0gv2.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CcphCPIG.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-dXvb1cU0.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-lp8DTQqs.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CMT8TLGr.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-jss-2SZf.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-BrnkvIj6.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-B2rQkRG0.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-CYSTrDhi.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-u4GSXLqQ.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-EVFPSjSD.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-fR44cJB_.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-GRBA15jP.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-B4UEXhWB.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BZ4XnOSn.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-FBAeJlLK.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-MMeZX5g8.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-D8XbBKdg.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-RguEv5LM.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-DM3piJ5Q.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-Bvm6vyyE.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-sPxcGMYS.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DvDl5p39.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-hXJ-Xzu0.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-S8ZZGWr8.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-CJeBq48Z.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-CEKGyTP8.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-acldhgF5.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DvAD5STm.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-BqBLx4dq.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-YGX3Lv33.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-DgHpBwBL.js" as="script"><link rel="prefetch" href="/note-front/assets/04.html-DnQrKxqM.js" as="script"><link rel="prefetch" href="/note-front/assets/05.html-Bc5tWgrh.js" as="script"><link rel="prefetch" href="/note-front/assets/06.html-CH69vfJw.js" as="script"><link rel="prefetch" href="/note-front/assets/07.html-B8Y7ON-e.js" as="script"><link rel="prefetch" href="/note-front/assets/08.html-B2JCXuWH.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-yYV0QCh-.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-BUcTsWBs.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-DIXEUU52.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-FRhRTyFr.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-Cz_kZzAG.js" as="script"><link rel="prefetch" href="/note-front/assets/01.html-B3Q59Uzl.js" as="script"><link rel="prefetch" href="/note-front/assets/02.html-CtIFq1E0.js" as="script"><link rel="prefetch" href="/note-front/assets/03.html-BLmODuf9.js" as="script"><link rel="prefetch" href="/note-front/assets/404.html-DEHhwvCm.js" as="script"><link rel="prefetch" href="/note-front/assets/katex-ChWnQ-fc.js" as="script"><link rel="prefetch" href="/note-front/assets/dagre-OKDRZEBW-DqpdoKlG.js" as="script"><link rel="prefetch" href="/note-front/assets/c4Diagram-VJAJSXHY-Bu_6A4f8.js" as="script"><link rel="prefetch" href="/note-front/assets/flowDiagram-4HSFHLVR-DnP0x8bD.js" as="script"><link rel="prefetch" href="/note-front/assets/flowDiagram-4HSFHLVR-DnP0x8bD.js" as="script"><link rel="prefetch" href="/note-front/assets/erDiagram-Q7BY3M3F-BXoOj3Oz.js" as="script"><link rel="prefetch" href="/note-front/assets/gitGraphDiagram-7IBYFJ6S-1VWA3_1d.js" as="script"><link rel="prefetch" href="/note-front/assets/ganttDiagram-APWFNJXF-CkpBqKAn.js" as="script"><link rel="prefetch" href="/note-front/assets/infoDiagram-PH2N3AL5-BJy3Ietf.js" as="script"><link rel="prefetch" href="/note-front/assets/pieDiagram-IB7DONF6-DMFyK5Uc.js" as="script"><link rel="prefetch" href="/note-front/assets/quadrantDiagram-7GDLP6J5-DYFu9Jr0.js" as="script"><link rel="prefetch" href="/note-front/assets/xychartDiagram-VJFVF3MP-COlmlmjD.js" as="script"><link rel="prefetch" href="/note-front/assets/requirementDiagram-KVF5MWMF-CIoMUjb7.js" as="script"><link rel="prefetch" href="/note-front/assets/sequenceDiagram-X6HHIX6F-CEyU2xCK.js" as="script"><link rel="prefetch" href="/note-front/assets/classDiagram-GIVACNV2-DKpJM5Q5.js" as="script"><link rel="prefetch" href="/note-front/assets/classDiagram-v2-COTLJTTW-DKpJM5Q5.js" as="script"><link rel="prefetch" href="/note-front/assets/stateDiagram-DGXRK772-osqlrq2x.js" as="script"><link rel="prefetch" href="/note-front/assets/stateDiagram-v2-YXO3MK2T-BEfzXktv.js" as="script"><link rel="prefetch" href="/note-front/assets/journeyDiagram-U35MCT3I-DEKqEJoN.js" as="script"><link rel="prefetch" href="/note-front/assets/flowDiagram-4HSFHLVR-DnP0x8bD.js" as="script"><link rel="prefetch" href="/note-front/assets/timeline-definition-BDJGKUSR-whKBVkc_.js" as="script"><link rel="prefetch" href="/note-front/assets/mindmap-definition-ALO5MXBD-Bp7eI7H8.js" as="script"><link rel="prefetch" href="/note-front/assets/kanban-definition-NDS4AKOZ-PdZxpcfV.js" as="script"><link rel="prefetch" href="/note-front/assets/sankeyDiagram-QLVOVGJD-CQFpeeMU.js" as="script"><link rel="prefetch" href="/note-front/assets/diagram-VNBRO52H-B6uirg5H.js" as="script"><link rel="prefetch" href="/note-front/assets/diagram-SSKATNLV--Jpm_9T3.js" as="script"><link rel="prefetch" href="/note-front/assets/blockDiagram-JOT3LUYC-DlDXHZ8z.js" as="script"><link rel="prefetch" href="/note-front/assets/architectureDiagram-IEHRJDOE-cpg61kBY.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/note-front/"><!----><span class="vp-site-name" aria-hidden="true">赵建辉的前端知识库</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端样式"><span class="title">前端样式</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端样式"><span class="title">前端样式</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/base_htmlcss/" aria-label="html+css"><!--[--><!--[--><!--]--><!--]-->html+css<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/records_css/" aria-label="css整理记录"><!--[--><!--[--><!--]--><!--]-->css整理记录<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/records_html/" aria-label="html整理记录"><!--[--><!--[--><!--]--><!--]-->html整理记录<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/records_layout/" aria-label="页面布局记录"><!--[--><!--[--><!--]--><!--]-->页面布局记录<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/pre_compile_css/" aria-label="CSS 预编译器"><!--[--><!--[--><!--]--><!--]-->CSS 预编译器<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/pre_defined_css/" aria-label="CSS 预定义"><!--[--><!--[--><!--]--><!--]-->CSS 预定义<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端交互"><span class="title">前端交互</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端交互"><span class="title">前端交互</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/script/JavaScript/" aria-label="JavaScript相关"><!--[--><!--[--><!--]--><!--]-->JavaScript相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/script/ECMAScript/" aria-label="ECMAScript相关"><!--[--><!--[--><!--]--><!--]-->ECMAScript相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/script/TypeScript/" aria-label="TypeScript相关"><!--[--><!--[--><!--]--><!--]-->TypeScript相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/script/other/" aria-label="其他相关"><!--[--><!--[--><!--]--><!--]-->其他相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/script/plugin/" aria-label="插件相关"><!--[--><!--[--><!--]--><!--]-->插件相关<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端框架"><span class="title">前端框架</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端框架"><span class="title">前端框架</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/framework/vue/" aria-label="Vue相关"><!--[--><!--[--><!--]--><!--]-->Vue相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/framework/react/" aria-label="React相关"><!--[--><!--[--><!--]--><!--]-->React相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/framework/angular/" aria-label="Angular相关"><!--[--><!--[--><!--]--><!--]-->Angular相关<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端动画"><span class="title">前端动画</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端动画"><span class="title">前端动画</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/canvas/" aria-label="canvas"><!--[--><!--[--><!--]--><!--]-->canvas<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/svg/" aria-label="svg"><!--[--><!--[--><!--]--><!--]-->svg<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/fabric/" aria-label="Fabric.js"><!--[--><!--[--><!--]--><!--]-->Fabric.js<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/pixi/" aria-label="pixi.js"><!--[--><!--[--><!--]--><!--]-->pixi.js<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/echats/" aria-label="Echats.js"><!--[--><!--[--><!--]--><!--]-->Echats.js<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/antv/" aria-label="antv"><!--[--><!--[--><!--]--><!--]-->antv<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/webgl/" aria-label="webgl"><!--[--><!--[--><!--]--><!--]-->webgl<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/three/" aria-label="three.js"><!--[--><!--[--><!--]--><!--]-->three.js<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端应用"><span class="title">前端应用</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端应用"><span class="title">前端应用</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/application/weixin/" aria-label="微信小程序"><!--[--><!--[--><!--]--><!--]-->微信小程序<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/application/uniapp/" aria-label="uni-app"><!--[--><!--[--><!--]--><!--]-->uni-app<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/application/electron/" aria-label="electron桌面"><!--[--><!--[--><!--]--><!--]-->electron桌面<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/application/cocos/" aria-label="cocos游戏"><!--[--><!--[--><!--]--><!--]-->cocos游戏<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="JS后端"><span class="title">JS后端</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="JS后端"><span class="title">JS后端</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/backend/node/" aria-label="node基础"><!--[--><!--[--><!--]--><!--]-->node基础<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/note-front/backend/senior/" aria-label="web后台框架"><!--[--><!--[--><!--]--><!--]-->web后台框架<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/backend/quote/" aria-label="依赖包记录"><!--[--><!--[--><!--]--><!--]-->依赖包记录<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="其他知识"><span class="title">其他知识</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="其他知识"><span class="title">其他知识</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/other/knowledge/" aria-label="前端常识记录"><!--[--><!--[--><!--]--><!--]-->前端常识记录<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/other/plugin/" aria-label="插件开发"><!--[--><!--[--><!--]--><!--]-->插件开发<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/other/construct/" aria-label="前端构建工具"><!--[--><!--[--><!--]--><!--]-->前端构建工具<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/other/other/" aria-label="其他标记语言"><!--[--><!--[--><!--]--><!--]-->其他标记语言<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/other/tool/" aria-label="开发工具使用"><!--[--><!--[--><!--]--><!--]-->开发工具使用<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端样式"><span class="title">前端样式</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端样式"><span class="title">前端样式</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/base_htmlcss/" aria-label="html+css"><!--[--><!--[--><!--]--><!--]-->html+css<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/records_css/" aria-label="css整理记录"><!--[--><!--[--><!--]--><!--]-->css整理记录<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/records_html/" aria-label="html整理记录"><!--[--><!--[--><!--]--><!--]-->html整理记录<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/records_layout/" aria-label="页面布局记录"><!--[--><!--[--><!--]--><!--]-->页面布局记录<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/pre_compile_css/" aria-label="CSS 预编译器"><!--[--><!--[--><!--]--><!--]-->CSS 预编译器<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/style/pre_defined_css/" aria-label="CSS 预定义"><!--[--><!--[--><!--]--><!--]-->CSS 预定义<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端交互"><span class="title">前端交互</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端交互"><span class="title">前端交互</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/script/JavaScript/" aria-label="JavaScript相关"><!--[--><!--[--><!--]--><!--]-->JavaScript相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/script/ECMAScript/" aria-label="ECMAScript相关"><!--[--><!--[--><!--]--><!--]-->ECMAScript相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/script/TypeScript/" aria-label="TypeScript相关"><!--[--><!--[--><!--]--><!--]-->TypeScript相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/script/other/" aria-label="其他相关"><!--[--><!--[--><!--]--><!--]-->其他相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/script/plugin/" aria-label="插件相关"><!--[--><!--[--><!--]--><!--]-->插件相关<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端框架"><span class="title">前端框架</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端框架"><span class="title">前端框架</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/framework/vue/" aria-label="Vue相关"><!--[--><!--[--><!--]--><!--]-->Vue相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/framework/react/" aria-label="React相关"><!--[--><!--[--><!--]--><!--]-->React相关<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/framework/angular/" aria-label="Angular相关"><!--[--><!--[--><!--]--><!--]-->Angular相关<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端动画"><span class="title">前端动画</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端动画"><span class="title">前端动画</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/canvas/" aria-label="canvas"><!--[--><!--[--><!--]--><!--]-->canvas<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/svg/" aria-label="svg"><!--[--><!--[--><!--]--><!--]-->svg<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/fabric/" aria-label="Fabric.js"><!--[--><!--[--><!--]--><!--]-->Fabric.js<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/pixi/" aria-label="pixi.js"><!--[--><!--[--><!--]--><!--]-->pixi.js<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/echats/" aria-label="Echats.js"><!--[--><!--[--><!--]--><!--]-->Echats.js<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/antv/" aria-label="antv"><!--[--><!--[--><!--]--><!--]-->antv<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/webgl/" aria-label="webgl"><!--[--><!--[--><!--]--><!--]-->webgl<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/animation/three/" aria-label="three.js"><!--[--><!--[--><!--]--><!--]-->three.js<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="前端应用"><span class="title">前端应用</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="前端应用"><span class="title">前端应用</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/application/weixin/" aria-label="微信小程序"><!--[--><!--[--><!--]--><!--]-->微信小程序<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/application/uniapp/" aria-label="uni-app"><!--[--><!--[--><!--]--><!--]-->uni-app<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/application/electron/" aria-label="electron桌面"><!--[--><!--[--><!--]--><!--]-->electron桌面<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/application/cocos/" aria-label="cocos游戏"><!--[--><!--[--><!--]--><!--]-->cocos游戏<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="JS后端"><span class="title">JS后端</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="JS后端"><span class="title">JS后端</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/backend/node/" aria-label="node基础"><!--[--><!--[--><!--]--><!--]-->node基础<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/note-front/backend/senior/" aria-label="web后台框架"><!--[--><!--[--><!--]--><!--]-->web后台框架<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/backend/quote/" aria-label="依赖包记录"><!--[--><!--[--><!--]--><!--]-->依赖包记录<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="其他知识"><span class="title">其他知识</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="其他知识"><span class="title">其他知识</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/other/knowledge/" aria-label="前端常识记录"><!--[--><!--[--><!--]--><!--]-->前端常识记录<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/other/plugin/" aria-label="插件开发"><!--[--><!--[--><!--]--><!--]-->插件开发<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/other/construct/" aria-label="前端构建工具"><!--[--><!--[--><!--]--><!--]-->前端构建工具<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/other/other/" aria-label="其他标记语言"><!--[--><!--[--><!--]--><!--]-->其他标记语言<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/note-front/other/tool/" aria-label="开发工具使用"><!--[--><!--[--><!--]--><!--]-->开发工具使用<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active">egg.js <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note-front/backend/senior/egg/01.html" aria-label="一、基础使用"><!--[--><!--[--><!--]--><!--]-->一、基础使用<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/note-front/backend/senior/egg/02.html" aria-label="二、核心组件"><!--[--><!--[--><!--]--><!--]-->二、核心组件<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note-front/backend/senior/egg/03.html" aria-label="三、内置对象"><!--[--><!--[--><!--]--><!--]-->三、内置对象<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note-front/backend/senior/egg/04.html" aria-label="四、插件相关"><!--[--><!--[--><!--]--><!--]-->四、插件相关<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note-front/backend/senior/egg/05.html" aria-label="五、基础项目配置"><!--[--><!--[--><!--]--><!--]-->五、基础项目配置<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">nest.js <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note-front/backend/senior/nest/01.html" aria-label="一、前置知识"><!--[--><!--[--><!--]--><!--]-->一、前置知识<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note-front/backend/senior/nest/02.html" aria-label="二、核心"><!--[--><!--[--><!--]--><!--]-->二、核心<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note-front/backend/senior/nest/03.html" aria-label="三、项目设置"><!--[--><!--[--><!--]--><!--]-->三、项目设置<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note-front/backend/senior/nest/04.html" aria-label="四、nestjs 结合vue"><!--[--><!--[--><!--]--><!--]-->四、nestjs 结合vue<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">框架日常记录 <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="二、核心组件" tabindex="-1"><a class="header-anchor" href="#二、核心组件"><span>二、核心组件</span></a></h1><p>HTTP调用图解</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">HTTP 请求</span>
<span class="line">   ↓</span>
<span class="line">路由(Router) → 匹配URL和方法</span>
<span class="line">   ↓</span>
<span class="line">中间件(Middleware) → 执行预处理</span>
<span class="line">   ↓</span>
<span class="line">控制器(Controller) → 协调请求和响应</span>
<span class="line">   ↓</span>
<span class="line">服务(Service) → 执行业务逻辑和数据访问</span>
<span class="line">   ↓</span>
<span class="line">返回响应</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-1-路由-router" tabindex="-1"><a class="header-anchor" href="#_2-1-路由-router"><span>2.1 路由（Router）</span></a></h2><h3 id="_2-1-1-基础认识" tabindex="-1"><a class="header-anchor" href="#_2-1-1-基础认识"><span>2.1.1 基础认识</span></a></h3><p>路由是请求的入口，负责将 HTTP 请求映射到对应的控制器(Controller)上。</p><ol><li><p>特点</p><ul><li>URL 映射：定义 URL 路径与控制器方法的对应关系</li><li>HTTP 方法：支持 GET、POST、PUT、DELETE 等 HTTP 方法</li><li>参数传递：支持路径参数、查询参数等</li></ul></li><li><p>工作流程</p><ul><li>接收 HTTP 请求</li><li>根据 URL 和方法匹配路由规则</li><li>执行路由对应的中间件(如果有)</li><li>调用对应的控制器方法</li></ul></li><li><p>基础使用</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 基本路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/posts&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>posts<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// RESTful 资源路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/api/users&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 带参数路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/user/:id&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>show<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>使用示例</p><h3 id="_2-1-2-基础路由配置" tabindex="-1"><a class="header-anchor" href="#_2-1-2-基础路由配置"><span>2.1.2 基础路由配置</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 基本GET路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 带参数的路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/user/:id&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>show<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// POST路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/user&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// PUT路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&#39;/user/:id&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// DELETE路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&#39;/user/:id&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>destroy<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 重定向路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&#39;/home&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-3-restful-风格路由" tabindex="-1"><a class="header-anchor" href="#_2-1-3-restful-风格路由"><span>2.1.3 RESTful 风格路由</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// RESTful 资源路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">&#39;posts&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/api/posts&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>posts<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">/*</span>
<span class="line">        等同于:</span>
<span class="line">        GET    /api/posts        - controller.posts.index</span>
<span class="line">        GET    /api/posts/:id    - controller.posts.show</span>
<span class="line">        POST   /api/posts        - controller.posts.create</span>
<span class="line">        PUT    /api/posts/:id    - controller.posts.update</span>
<span class="line">        DELETE /api/posts/:id    - controller.posts.destroy</span>
<span class="line">    */</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 自定义resources动作</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/api/v1/users&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">middleware</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;auth&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 中间件</span></span>
<span class="line">        <span class="token literal-property property">only</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;index&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;show&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;create&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 只生成特定路由</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-4-路由分组与模块化" tabindex="-1"><a class="header-anchor" href="#_2-1-4-路由分组与模块化"><span>2.1.4 路由分组与模块化</span></a></h3><ul><li><p>总路由</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./router/user&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./router/article&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./router/admin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>模块路由1</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router/user.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> middleware <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 用户相关路由分组</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;/user&#39;</span><span class="token punctuation">,</span> <span class="token parameter">user</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        user<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/register&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>register<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        user<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/login&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        user<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/info&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        user<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&#39;/password&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>changePassword<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>模块路由1</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router/article.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> middleware <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 文章相关路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">&#39;articles&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/api/articles&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 自定义动作</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/articles/:id/like&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>article<span class="token punctuation">.</span>like<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/api/articles/tag/:tag&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>article<span class="token punctuation">.</span>findByTag<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_2-1-5-中间件在路由中的使用" tabindex="-1"><a class="header-anchor" href="#_2-1-5-中间件在路由中的使用"><span>2.1.5 中间件在路由中的使用</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> middleware <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 全局中间件已在config中配置</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 路由级别中间件</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token string">&#39;/api/protected&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">        middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 认证中间件</span></span>
<span class="line">        middleware<span class="token punctuation">.</span><span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 限流中间件</span></span>
<span class="line">        controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>protected</span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 多个中间件</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token string">&#39;/api/upload&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        middleware<span class="token punctuation">.</span><span class="token function">multipart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 文件上传中间件</span></span>
<span class="line">        controller<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>upload</span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 忽略中间件的路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/api/public&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">ignore</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>public<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-6-参数验证与路由约束" tabindex="-1"><a class="header-anchor" href="#_2-1-6-参数验证与路由约束"><span>2.1.6 参数验证与路由约束</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line">    <span class="token comment">// app/router.js</span></span>
<span class="line">    module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 带参数约束的路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/user/:id(\\d+)&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>show<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只匹配数字ID</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 多段路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/posts/:year/:month/:day&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>posts<span class="token punctuation">.</span>archive<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 可选参数</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/search/:keyword?&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>search<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 正则约束</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/files/:name([^/]+\\.[^/]+)&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>files<span class="token punctuation">.</span>show<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-7-多域名与子域名路由" tabindex="-1"><a class="header-anchor" href="#_2-1-7-多域名与子域名路由"><span>2.1.7 多域名与子域名路由</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 主域名路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// API子域名</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;api&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/api&#39;</span><span class="token punctuation">,</span> <span class="token parameter">api</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        api<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/users&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>user<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        api<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/users&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>user<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 管理后台子域名</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;admin&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/admin&#39;</span><span class="token punctuation">,</span> <span class="token parameter">admin</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        admin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>home<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        admin<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/users&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 多域名配置</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token string">&#39;mobile.example.com&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>mobile<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token string">&#39;www.example.com&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>web<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-8-文件上传与下载路由" tabindex="-1"><a class="header-anchor" href="#_2-1-8-文件上传与下载路由"><span>2.1.8 文件上传与下载路由</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> middleware <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 文件上传</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/upload&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">        middleware<span class="token punctuation">.</span><span class="token function">multipart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 启用文件上传</span></span>
<span class="line">        controller<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>upload</span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 多文件上传</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/upload/multiple&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">        middleware<span class="token punctuation">.</span><span class="token function">multipart</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">multiples</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        controller<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>multiple</span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 文件下载</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/download/:filename&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>download<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 文件流</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/stream/:filename&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>download<span class="token punctuation">.</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-9-websocket-路由" tabindex="-1"><a class="header-anchor" href="#_2-1-9-websocket-路由"><span>2.1.9 WebSocket 路由</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// WebSocket路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">ws</span><span class="token punctuation">(</span><span class="token string">&#39;/ws&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">ws</span><span class="token punctuation">(</span><span class="token string">&#39;/ws/chat&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>chat<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 命名空间</span></span>
<span class="line">    router<span class="token punctuation">.</span>ws<span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token string">&#39;/api/v1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ws</span><span class="token punctuation">(</span><span class="token string">&#39;/notify&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>ws<span class="token punctuation">.</span>notify<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-10-重定向与别名路由" tabindex="-1"><a class="header-anchor" href="#_2-1-10-重定向与别名路由"><span>2.1.10 重定向与别名路由</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 简单重定向</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&#39;/old&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/new&#39;</span><span class="token punctuation">,</span> <span class="token number">301</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 带参数重定向</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&#39;/post/:id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/articles/:id&#39;</span><span class="token punctuation">,</span> <span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 路由别名</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token string">&#39;/users/list&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/api/v1/users&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 条件重定向</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&#39;/legacy&#39;</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>version <span class="token operator">===</span> <span class="token string">&#39;1&#39;</span> <span class="token operator">?</span> <span class="token string">&#39;/v1&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;/v2&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-11-复杂业务路由示例" tabindex="-1"><a class="header-anchor" href="#_2-1-11-复杂业务路由示例"><span>2.1.11 复杂业务路由示例</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> middleware <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// API版本控制</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;/api&#39;</span><span class="token punctuation">,</span> <span class="token parameter">api</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        api<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;/v1&#39;</span><span class="token punctuation">,</span> <span class="token parameter">v1</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            v1<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">&#39;products&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/products&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        api<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;/v2&#39;</span><span class="token punctuation">,</span> <span class="token parameter">v2</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            v2<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">&#39;products&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/products&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">apiVersion</span><span class="token punctuation">(</span><span class="token string">&#39;v2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>api<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 后台管理系统路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;/admin&#39;</span><span class="token punctuation">,</span> <span class="token parameter">admin</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        admin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/login&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        admin<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/login&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>doLogin<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 需要管理员权限的路由组</span></span>
<span class="line">        admin<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">adminAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">authAdmin</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            authAdmin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            authAdmin<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/users&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            authAdmin<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">&#39;roles&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/roles&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 微信小程序接口</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token string">&#39;/weapp&#39;</span><span class="token punctuation">,</span> <span class="token parameter">weapp</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        weapp<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/login&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>weapp<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        weapp<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/decrypt&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">weappAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>weapp<span class="token punctuation">.</span>decryptData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 图形验证码</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/captcha&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>util<span class="token punctuation">.</span>captcha<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 健康检查</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/health&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>util<span class="token punctuation">.</span>healthCheck<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-2-中间件-middleware" tabindex="-1"><a class="header-anchor" href="#_2-2-中间件-middleware"><span>2.2 中间件（Middleware）</span></a></h2><h3 id="_2-2-1-基础" tabindex="-1"><a class="header-anchor" href="#_2-2-1-基础"><span>2.2.1 基础</span></a></h3><p>中间件是在路由和控制器之间执行的函数，可以访问请求对象(ctx)和响应对象，用于处理横切关注点。</p><ol><li><p>特点</p><ul><li>洋葱圈模型：类似 Koa 的中间件机制，支持 async/await</li><li>可配置：可以全局使用或针对特定路由使用</li><li>链式调用：多个中间件按顺序执行</li></ul></li><li><p>简单使用</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/middleware/auth.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">options</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 获取token</span></span>
<span class="line">        <span class="token keyword">const</span> token <span class="token operator">=</span> ctx<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>authorization<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token string">&#39;未提供认证令牌&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 配置中使用</span></span>
<span class="line"><span class="token comment">// config/config.default.js</span></span>
<span class="line">exports<span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;auth&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 不适用于login</span></span>
<span class="line">exports<span class="token punctuation">.</span>auth <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">ignore</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;/login&#39;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>注意点</p><ul><li>中间件顺序 <ol><li>在 config.default.js 中 middleware 数组的顺序就是执行顺序</li><li>全局中间件 (onfig.default.js) 比路由中间件先触发</li></ol></li><li>中间件要求 <ol><li>避免在中间件中进行耗时操作</li><li>确保中间件有良好的错误处理机制</li></ol></li></ul></li></ol><h3 id="_2-2-2-错误处理中间件" tabindex="-1"><a class="header-anchor" href="#_2-2-2-错误处理中间件"><span>2.2.2 错误处理中间件</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/middleware/error_handler.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 记录错误日志</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 根据错误类型返回不同的响应</span></span>
<span class="line">            <span class="token keyword">const</span> status <span class="token operator">=</span> err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">const</span> error <span class="token operator">=</span> status <span class="token operator">===</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>env <span class="token operator">===</span> <span class="token string">&#39;prod&#39;</span></span>
<span class="line">                <span class="token operator">?</span> <span class="token string">&#39;Internal Server Error&#39;</span></span>
<span class="line">                <span class="token operator">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> </span>
<span class="line">                <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">message</span><span class="token operator">:</span> error<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">stack</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>env <span class="token operator">===</span> <span class="token string">&#39;local&#39;</span> <span class="token operator">?</span> err<span class="token punctuation">.</span>stack <span class="token operator">:</span> <span class="token keyword">undefined</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-3-请求日志中间件" tabindex="-1"><a class="header-anchor" href="#_2-2-3-请求日志中间件"><span>2.2.3 请求日志中间件</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/middleware/request_logger.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">requestLogger</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> duration <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>duration<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>ip<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-4-api响应格式化中间件" tabindex="-1"><a class="header-anchor" href="#_2-2-4-api响应格式化中间件"><span>2.2.4 API响应格式化中间件</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/middleware/response_formatter.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">responseFormatter</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 如果已经有body则不再处理</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> ctx<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">302</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 格式化响应</span></span>
<span class="line">        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">success</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">message</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>body<span class="token punctuation">.</span>message <span class="token operator">||</span> <span class="token string">&#39;success&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">data</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data <span class="token operator">||</span> ctx<span class="token punctuation">.</span>body</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-5-权限验证中间件" tabindex="-1"><a class="header-anchor" href="#_2-2-5-权限验证中间件"><span>2.2.5 权限验证中间件</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/middleware/auth.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authMiddleware</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 1. 从配置中获取忽略验证的路径</span></span>
<span class="line">        <span class="token keyword">const</span> ignorePaths <span class="token operator">=</span> options<span class="token punctuation">.</span>ignore <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>ignorePaths<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">path</span> <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 2. 获取token</span></span>
<span class="line">        <span class="token keyword">const</span> token <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;authorization&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>token<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token string">&#39;未提供认证令牌&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 3. 验证token</span></span>
<span class="line">            <span class="token keyword">const</span> decoded <span class="token operator">=</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user <span class="token operator">=</span> decoded<span class="token punctuation">;</span> <span class="token comment">// 将用户信息挂载到ctx上</span></span>
<span class="line">            <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token string">&#39;无效的认证令牌&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-6-请求频率限制中间件" tabindex="-1"><a class="header-anchor" href="#_2-2-6-请求频率限制中间件"><span>2.2.6 请求频率限制中间件</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/middleware/rate_limit.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> max <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> windowMs <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">rateLimit</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rate_limit:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>ip<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">&gt;=</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">429</span><span class="token punctuation">,</span> <span class="token string">&#39;请求过于频繁，请稍后再试&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 计数器+1</span></span>
<span class="line">        <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> windowMs <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 设置响应头</span></span>
<span class="line">        ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;X-RateLimit-Limit&#39;</span><span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;X-RateLimit-Remaining&#39;</span><span class="token punctuation">,</span> max <span class="token operator">-</span> current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;X-RateLimit-Reset&#39;</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>windowMs <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-7-跨域中间件" tabindex="-1"><a class="header-anchor" href="#_2-2-7-跨域中间件"><span>2.2.7 跨域中间件</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/middleware/cors.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> allowOrigins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> allowMethods <span class="token operator">=</span> <span class="token string">&#39;GET,HEAD,PUT,POST,DELETE,PATCH&#39;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">corsMiddleware</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> origin <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;origin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 设置允许的源</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>allowOrigins<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;Access-Control-Allow-Origin&#39;</span><span class="token punctuation">,</span> origin<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;Access-Control-Allow-Credentials&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;true&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 处理预检请求</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&#39;OPTIONS&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;Access-Control-Allow-Methods&#39;</span><span class="token punctuation">,</span> allowMethods<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;Access-Control-Allow-Headers&#39;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;access-control-request-headers&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;Access-Control-Max-Age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;86400&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">204</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-8-配置与使用" tabindex="-1"><a class="header-anchor" href="#_2-2-8-配置与使用"><span>2.2.8 配置与使用</span></a></h3><ol><li><p>在配置文件中启用中间件：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// config/config.default.js</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">middleware</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;errorHandler&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;requestLogger&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;responseFormatter&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;cors&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 中间件配置</span></span>
<span class="line">    <span class="token literal-property property">cors</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">allowOrigins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;https://yourdomain.com&#39;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token literal-property property">rateLimit</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">windowMs</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token literal-property property">auth</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">ignore</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;/api/login&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/api/register&#39;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>路由中使用中间件</p><pre><code> ```js
</code></pre><p>// app/router.js module.exports = app =&gt; { const { router, controller, middleware } = app;</p><pre><code> // 全局中间件已在config中配置
 
 // 特定路由使用额外中间件
 router.get(
     &#39;/api/protected&#39;, 
     middleware.auth(), 
     middleware.rateLimit(), 
     controller.user.protected
 );
</code></pre><p>};</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h2 id="_2-3-控制器-controller" tabindex="-1"><a class="header-anchor" href="#_2-3-控制器-controller"><span>2.3 控制器（Controller）</span></a></h2><h3 id="_2-3-1-基础" tabindex="-1"><a class="header-anchor" href="#_2-3-1-基础"><span>2.3.1 基础</span></a></h3><p>控制器负责处理业务逻辑，是路由和服务的桥梁。</p><ol><li><p>特点</p><ul><li>业务入口：接收请求参数，调用服务处理，返回响应</li><li>瘦控制器：建议保持简洁，复杂逻辑放在 Service</li><li>约定优于配置：文件必须放在 app/controller 目录</li></ul></li><li><p>职责</p><ul><li>参数校验</li><li>调用服务处理业务</li><li>处理异常</li><li>返回响应</li></ul></li><li><p>简单示例</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/controller/user.js</span></span>
<span class="line"><span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user<span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">422</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">error</span><span class="token operator">:</span> e<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>最佳实践</p><ul><li><strong>保持控制器简洁</strong>：将复杂逻辑放到 Service 层</li><li><strong>统一响应格式</strong>：使用基类控制器统一成功/失败响应</li><li><strong>参数验证</strong>：使用 Egg.js 内置的 validate 方法</li><li><strong>错误处理</strong>：合理捕获和处理错误</li><li><strong>权限控制</strong>：敏感操作需要验证用户权限</li><li><strong>日志记录</strong>：重要操作记录日志</li><li><strong>代码复用</strong>：提取公共逻辑到基类或 Helper</li></ul></li></ol><h3 id="_2-3-2-基础控制器结构" tabindex="-1"><a class="header-anchor" href="#_2-3-2-基础控制器结构"><span>2.3.2 基础控制器结构</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/controller/base.js</span></span>
<span class="line"><span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">BaseController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 成功响应</span></span>
<span class="line">    <span class="token function">success</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&#39;success&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            message<span class="token punctuation">,</span></span>
<span class="line">            data<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 失败响应</span></span>
<span class="line">    <span class="token function">fail</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> code <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> code<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">            message<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 分页响应</span></span>
<span class="line">    <span class="token function">pagination</span><span class="token punctuation">(</span><span class="token parameter">list<span class="token punctuation">,</span> total<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                list<span class="token punctuation">,</span></span>
<span class="line">                total<span class="token punctuation">,</span></span>
<span class="line">                page<span class="token punctuation">,</span></span>
<span class="line">                pageSize<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">totalPage</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>total <span class="token operator">/</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> BaseController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-3-用户控制器示例" tabindex="-1"><a class="header-anchor" href="#_2-3-3-用户控制器示例"><span>2.3.3 用户控制器示例</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/controller/user.js</span></span>
<span class="line"><span class="token keyword">const</span> BaseController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./base&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 用户注册</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 参数验证</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 检查用户名是否存在</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&#39;用户名已存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 创建用户</span></span>
<span class="line">            <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                username<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">password</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">&#39;注册成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>errors<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> err<span class="token punctuation">.</span>field <span class="token operator">+</span> <span class="token string">&#39; &#39;</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 用户登录</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> user<span class="token punctuation">.</span>password <span class="token operator">!==</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&#39;用户名或密码错误&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 生成 token</span></span>
<span class="line">        <span class="token keyword">const</span> token <span class="token operator">=</span> app<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">userId</span><span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">username</span><span class="token operator">:</span> user<span class="token punctuation">.</span>username<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span>secret<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">expiresIn</span><span class="token operator">:</span> <span class="token string">&#39;1d&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 设置 cookie</span></span>
<span class="line">        ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">httpOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">signed</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;登录成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 获取当前用户信息</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> userId <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&#39;用户不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 过滤敏感信息</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> password<span class="token punctuation">,</span> <span class="token operator">...</span>userInfo <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-4-文章控制器示例" tabindex="-1"><a class="header-anchor" href="#_2-3-4-文章控制器示例"><span>2.3.4 文章控制器示例</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/controller/article.js</span></span>
<span class="line"><span class="token keyword">const</span> BaseController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./base&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ArticleController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建文章</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> title<span class="token punctuation">,</span> content <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> userId <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                title<span class="token punctuation">,</span></span>
<span class="line">                content<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">user_id</span><span class="token operator">:</span> userId<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>article<span class="token punctuation">,</span> <span class="token string">&#39;创建成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 获取文章列表</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span> <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> list<span class="token punctuation">,</span> total <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">page</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">pageSize</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pagination</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> total<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 获取文章详情</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">detail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>article<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&#39;文章不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 增加阅读量</span></span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">incrementViewCount</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 更新文章</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> title<span class="token punctuation">,</span> content <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> userId <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 检查文章是否存在且属于当前用户</span></span>
<span class="line">            <span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">checkOwner</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>article<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&#39;无权操作此文章&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">const</span> updated <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">                title<span class="token punctuation">,</span></span>
<span class="line">                content<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>updated<span class="token punctuation">,</span> <span class="token string">&#39;更新成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 删除文章</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> userId <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 检查文章是否存在且属于当前用户</span></span>
<span class="line">            <span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">checkOwner</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>article<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&#39;无权操作此文章&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&#39;删除成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ArticleController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-5-文件上传控制器" tabindex="-1"><a class="header-anchor" href="#_2-3-5-文件上传控制器"><span>2.3.5 文件上传控制器</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/controller/upload.js</span></span>
<span class="line"><span class="token keyword">const</span> BaseController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./base&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UploadController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 单文件上传</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> file <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&#39;请选择文件&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 读取文件</span></span>
<span class="line">            <span class="token keyword">const</span> fileContent <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 生成新文件名</span></span>
<span class="line">            <span class="token keyword">const</span> filename <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 文件保存路径</span></span>
<span class="line">            <span class="token keyword">const</span> targetPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">&#39;app/public/uploads&#39;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 写入文件</span></span>
<span class="line">            fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> fileContent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 删除临时文件</span></span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">cleanupRequestFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/public/uploads/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;上传成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 确保临时文件被清理</span></span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">cleanupRequestFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 多文件上传</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">multiUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> files <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files <span class="token operator">||</span> files<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&#39;请选择文件&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> file <span class="token keyword">of</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> fileContent <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">const</span> filename <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">const</span> targetPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">&#39;app/public/uploads&#39;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                </span>
<span class="line">                fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> fileContent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">name</span><span class="token operator">:</span> file<span class="token punctuation">.</span>filename<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/public/uploads/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">cleanupRequestFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">&#39;上传成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">cleanupRequestFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UploadController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-6-微信小程序控制器示例" tabindex="-1"><a class="header-anchor" href="#_2-3-6-微信小程序控制器示例"><span>2.3.6 微信小程序控制器示例</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/controller/weapp.js</span></span>
<span class="line"><span class="token keyword">const</span> BaseController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./base&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;axios&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">WeappController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 微信小程序登录</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 调用微信接口获取openid</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> appid<span class="token punctuation">,</span> secret <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>weapp<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;https://api.weixin.qq.com/sns/jscode2session&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                    appid<span class="token punctuation">,</span></span>
<span class="line">                    secret<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">js_code</span><span class="token operator">:</span> code<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">&#39;authorization_code&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> openid<span class="token punctuation">,</span> session_key<span class="token punctuation">,</span> errcode<span class="token punctuation">,</span> errmsg <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>errcode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>errmsg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 查找或创建用户</span></span>
<span class="line">            <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">findByOpenid</span><span class="token punctuation">(</span>openid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                openid<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">&#39;weapp&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 生成token</span></span>
<span class="line">            <span class="token keyword">const</span> token <span class="token operator">=</span> app<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">userId</span><span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">                openid<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span>secret<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">expiresIn</span><span class="token operator">:</span> <span class="token string">&#39;30d&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> token <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;登录成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 获取微信手机号</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">getPhoneNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> encryptedData<span class="token punctuation">,</span> iv <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> sessionKey <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>sessionKey<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">encryptedData</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">iv</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 解密数据</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> phoneNumber <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>weapp<span class="token punctuation">.</span><span class="token function">decryptData</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 更新用户手机号</span></span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">phone</span><span class="token operator">:</span> phoneNumber<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span> phoneNumber <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;获取成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> WeappController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-7-路由配置示例" tabindex="-1"><a class="header-anchor" href="#_2-3-7-路由配置示例"><span>2.3.7 路由配置示例</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/router.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> middleware <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 用户相关路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/user/register&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>register<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/user/login&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/api/user/current&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 文章相关路由</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">&#39;article&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/api/article&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 文件上传</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/upload&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>upload<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/upload/multi&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>multiUpload<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 微信小程序</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/weapp/login&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>weapp<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/weapp/phone&#39;</span><span class="token punctuation">,</span> middleware<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>weapp<span class="token punctuation">.</span>getPhoneNumber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-4-服务-service" tabindex="-1"><a class="header-anchor" href="#_2-4-服务-service"><span>2.4 服务（Service）</span></a></h2><h3 id="_2-4-1-基础" tabindex="-1"><a class="header-anchor" href="#_2-4-1-基础"><span>2.4.1 基础</span></a></h3><p>服务是业务逻辑的具体实现，供控制器调用。</p><ol><li><p>特点</p><ul><li>复用性：可被多个控制器调用</li><li>独立性：不依赖请求上下文，便于测试</li><li>领域驱动：按业务领域组织代码</li></ul></li><li><p>常见职责</p><ul><li>数据库操作</li><li>第三方 API 调用</li><li>复杂业务逻辑</li><li>数据加工处理</li></ul></li><li><p>简单使用</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/service/user.js</span></span>
<span class="line"><span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">userData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendWelcomeEmail</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> user<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">sendWelcomeEmail</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 发送邮件逻辑</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="_2-4-2-基础服务结构" tabindex="-1"><a class="header-anchor" href="#_2-4-2-基础服务结构"><span>2.4.2 基础服务结构</span></a></h3><p>首先创建一个基础服务类，封装常用方法：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/service/base.js</span></span>
<span class="line"><span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">BaseService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 分页查询封装</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">paginate</span><span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> where <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> order <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;DESC&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>query <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> offset <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> model<span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            where<span class="token punctuation">,</span></span>
<span class="line">            <span class="token operator">...</span>query<span class="token punctuation">,</span></span>
<span class="line">            offset<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            order<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">list</span><span class="token operator">:</span> result<span class="token punctuation">.</span>rows<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">total</span><span class="token operator">:</span> result<span class="token punctuation">.</span>count<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">page</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">pageSize</span><span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">totalPages</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>count <span class="token operator">/</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 检查资源是否存在</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">checkExist</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> where<span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&#39;资源不存在&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> item <span class="token operator">=</span> <span class="token keyword">await</span> model<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> item<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 检查资源所有权</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">checkOwner</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> id<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&#39;无权操作此资源&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> item <span class="token operator">=</span> <span class="token keyword">await</span> model<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> </span>
<span class="line">            <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">                id<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">user_id</span><span class="token operator">:</span> userId </span>
<span class="line">            <span class="token punctuation">}</span> </span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> item<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> BaseService<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-3-用户服务示例" tabindex="-1"><a class="header-anchor" href="#_2-4-3-用户服务示例"><span>2.4.3 用户服务示例</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/service/user.js</span></span>
<span class="line"><span class="token keyword">const</span> BaseService <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./base&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;bcryptjs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 根据ID查找用户</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;password&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;deleted_at&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 根据用户名查找用户</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">findByUsername</span><span class="token punctuation">(</span><span class="token parameter">username</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> </span>
<span class="line">            <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span> </span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 根据openid查找用户</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">findByOpenid</span><span class="token punctuation">(</span><span class="token parameter">openid</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> </span>
<span class="line">            <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> openid <span class="token punctuation">}</span> </span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 创建用户</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">userData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> transaction <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 密码加密</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>userData<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                userData<span class="token punctuation">.</span>password <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>userData<span class="token punctuation">.</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userData<span class="token punctuation">,</span> <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 创建用户资料</span></span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>UserProfile<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">user_id</span><span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">await</span> transaction<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> user<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> transaction<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&#39;创建用户失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 更新用户信息</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> userData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 过滤不允许更新的字段</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> password<span class="token punctuation">,</span> <span class="token operator">...</span>updateData <span class="token punctuation">}</span> <span class="token operator">=</span> userData<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 如果需要更新密码</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            updateData<span class="token punctuation">.</span>password <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">[</span> affectedCount <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>updateData<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>affectedCount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">&#39;用户不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 验证用户密码</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">verifyPassword</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserService<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-4-文章服务示例" tabindex="-1"><a class="header-anchor" href="#_2-4-4-文章服务示例"><span>2.4.4 文章服务示例</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/service/article.js</span></span>
<span class="line"><span class="token keyword">const</span> BaseService <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./base&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ArticleService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建文章</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">articleData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> transaction <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>articleData<span class="token punctuation">,</span> <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 处理标签</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>articleData<span class="token punctuation">.</span>tags <span class="token operator">&amp;&amp;</span> articleData<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processTags</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>id<span class="token punctuation">,</span> articleData<span class="token punctuation">.</span>tags<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">await</span> transaction<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> article<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> transaction<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&#39;创建文章失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 获取文章列表</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> tag<span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> <span class="token operator">...</span>query <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> where <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 标签筛选</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            where<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token punctuation">[</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Op<span class="token punctuation">.</span>in<span class="token punctuation">]</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">literal</span><span class="token punctuation">(</span></span>
<span class="line">                    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(SELECT article_id FROM article_tags WHERE tag_id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span></span>
<span class="line">                <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 关键词搜索</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            where<span class="token punctuation">[</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token punctuation">{</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">{</span> <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">paginate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">,</span> where<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token operator">...</span>query<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">model</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;author&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;username&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;avatar&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">model</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Tag<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;tags&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">through</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 获取文章详情</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">model</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;author&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;username&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;avatar&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">model</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Tag<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;tags&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">through</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">model</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Comment<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;comments&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;DESC&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                        <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token literal-property property">model</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">,</span></span>
<span class="line">                            <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                            <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;username&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;avatar&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>article<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">&#39;文章不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> article<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 更新文章</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> articleData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> transaction <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">[</span> affectedCount <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>articleData<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                transaction<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>affectedCount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">&#39;文章不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 处理标签</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>articleData<span class="token punctuation">.</span>tags<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleTag<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> </span>
<span class="line">                    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">article_id</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                    transaction<span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                </span>
<span class="line">                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processTags</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> articleData<span class="token punctuation">.</span>tags<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">await</span> transaction<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> transaction<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&#39;更新文章失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 删除文章</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> affectedCount <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>affectedCount <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">&#39;文章不存在&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 增加文章阅读量</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">incrementViewCount</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">&#39;view_count&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 处理文章标签</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">_processTags</span><span class="token punctuation">(</span><span class="token parameter">articleId<span class="token punctuation">,</span> tags<span class="token punctuation">,</span> transaction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 查找或创建标签</span></span>
<span class="line">        <span class="token keyword">const</span> tagInstances <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span></span>
<span class="line">            tags<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">tagName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> <span class="token punctuation">[</span>tag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Tag<span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> tagName <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                    transaction<span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">return</span> tag<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 关联文章和标签</span></span>
<span class="line">        <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleTag<span class="token punctuation">.</span><span class="token function">bulkCreate</span><span class="token punctuation">(</span></span>
<span class="line">            tagInstances<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">tag</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">article_id</span><span class="token operator">:</span> articleId<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">tag_id</span><span class="token operator">:</span> tag<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ArticleService<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-5-文件上传服务" tabindex="-1"><a class="header-anchor" href="#_2-4-5-文件上传服务"><span>2.4.5 文件上传服务</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/service/upload.js</span></span>
<span class="line"><span class="token keyword">const</span> BaseService <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./base&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> pump <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mz-modules/pump&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">v4</span><span class="token operator">:</span> uuidv4 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;uuid&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UploadService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 上传文件</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token parameter">stream<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> allowedExtensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> maxSize <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 验证文件扩展名</span></span>
<span class="line">        <span class="token keyword">const</span> ext <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>allowedExtensions<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>allowedExtensions<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">不支持的文件类型: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ext<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 验证文件大小</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>stream<span class="token punctuation">.</span>byteLimit <span class="token operator">&amp;&amp;</span> stream<span class="token punctuation">.</span>byteLimit <span class="token operator">&gt;</span> maxSize<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">文件大小不能超过 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>maxSize <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">MB</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 生成唯一文件名</span></span>
<span class="line">        <span class="token keyword">const</span> filename <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">uuidv4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ext<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> relativePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">uploads/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">day</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&#39;YYYY/MM/DD&#39;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> targetDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">&#39;app/public&#39;</span><span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> targetPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>targetDir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 确保目录存在</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>targetDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>targetDir<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 写入文件</span></span>
<span class="line">        <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token function">pump</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> writeStream<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 返回文件信息</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            filename<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">originalname</span><span class="token operator">:</span> stream<span class="token punctuation">.</span>filename<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">mimetype</span><span class="token operator">:</span> stream<span class="token punctuation">.</span>mimeType<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">size</span><span class="token operator">:</span> stream<span class="token punctuation">.</span>byteLimit<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 生成文件访问URL</span></span>
<span class="line">    <span class="token function">generateUrl</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>domain<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 删除文件</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">delete</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> absolutePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">&#39;app/public&#39;</span><span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UploadService<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-6-微信小程序服务" tabindex="-1"><a class="header-anchor" href="#_2-4-6-微信小程序服务"><span>2.4.6 微信小程序服务</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/service/weapp.js</span></span>
<span class="line"><span class="token keyword">const</span> BaseService <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./base&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;axios&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> WXBizDataCrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../utils/WXBizDataCrypt&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">WeappService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 获取微信openid</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">code2Session</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> appid<span class="token punctuation">,</span> secret <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>weapp<span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;https://api.weixin.qq.com/sns/jscode2session&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                    appid<span class="token punctuation">,</span></span>
<span class="line">                    secret<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">js_code</span><span class="token operator">:</span> code<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">&#39;authorization_code&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> openid<span class="token punctuation">,</span> session_key<span class="token punctuation">,</span> unionid<span class="token punctuation">,</span> errcode<span class="token punctuation">,</span> errmsg <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>errcode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">微信接口错误: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>errmsg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span> openid<span class="token punctuation">,</span> <span class="token literal-property property">sessionKey</span><span class="token operator">:</span> session_key<span class="token punctuation">,</span> unionid <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&#39;获取微信openid失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 解密用户数据</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">decryptData</span><span class="token punctuation">(</span><span class="token parameter">encryptedData<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> sessionKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> appid <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>weapp<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> pc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WXBizDataCrypt</span><span class="token punctuation">(</span>appid<span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> pc<span class="token punctuation">.</span><span class="token function">decryptData</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">&#39;解密用户数据失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 获取微信access_token</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> appid<span class="token punctuation">,</span> secret <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>weapp<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> cacheKey <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">weapp:access_token:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 从缓存获取</span></span>
<span class="line">        <span class="token keyword">let</span> accessToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> accessToken<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 从微信接口获取</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;https://api.weixin.qq.com/cgi-bin/token&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">params</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">&#39;client_credential&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                appid<span class="token punctuation">,</span></span>
<span class="line">                secret<span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> access_token<span class="token punctuation">,</span> expires_in<span class="token punctuation">,</span> errcode<span class="token punctuation">,</span> errmsg <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>errcode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">获取access_token失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>errmsg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 缓存access_token</span></span>
<span class="line">            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> access_token<span class="token punctuation">,</span> <span class="token string">&#39;EX&#39;</span><span class="token punctuation">,</span> expires_in <span class="token operator">-</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">return</span> access_token<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">&#39;获取access_token失败&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 发送模板消息</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">sendTemplateMessage</span><span class="token punctuation">(</span><span class="token parameter">openid<span class="token punctuation">,</span> templateId<span class="token punctuation">,</span> data<span class="token punctuation">,</span> page <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> accessToken <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/message/wxopen/template/send?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>accessToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">touser</span><span class="token operator">:</span> openid<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">template_id</span><span class="token operator">:</span> templateId<span class="token punctuation">,</span></span>
<span class="line">                page<span class="token punctuation">,</span></span>
<span class="line">                data<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;发送模板消息失败:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> WeappService<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-7-缓存服务示例" tabindex="-1"><a class="header-anchor" href="#_2-4-7-缓存服务示例"><span>2.4.7 缓存服务示例</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/service/cache.js</span></span>
<span class="line"><span class="token keyword">const</span> BaseService <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./base&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CacheService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 设置缓存</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ttl <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>ttl <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;EX&#39;</span><span class="token punctuation">,</span> ttl<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 获取缓存</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> value <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 删除缓存</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 获取或设置缓存</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">remember</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> cached <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> cached<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ttl<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> value<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 递增</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">incr</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> amount <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">incrby</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 递减</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">decr</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> amount <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">decrby</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> CacheService<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-5-模型-model" tabindex="-1"><a class="header-anchor" href="#_2-5-模型-model"><span>2.5 模型（Model）</span></a></h2><p>下面我将展示如何在 Egg.js 中定义 Model 并连接 MySQL 数据库。我们将使用 Sequelize 作为 ORM 框架来操作 MySQL。</p><ol><li><p>安装必要的依赖</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">--save</span> egg-sequelize mysql2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>配置 MySQL 连接</p><p>在 <code>config/config.default.js</code> 中配置数据库：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// config/config.default.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">appInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// Sequelize 配置</span></span>
<span class="line">    config<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">dialect</span><span class="token operator">:</span> <span class="token string">&#39;mysql&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;127.0.0.1&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;egg_demo&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;yourpassword&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">timezone</span><span class="token operator">:</span> <span class="token string">&#39;+08:00&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 东八区</span></span>
<span class="line">        <span class="token literal-property property">define</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 自动添加 createdAt 和 updatedAt</span></span>
<span class="line">            <span class="token literal-property property">paranoid</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 添加 deletedAt</span></span>
<span class="line">            <span class="token literal-property property">underscored</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 使用下划线命名风格</span></span>
<span class="line">            <span class="token literal-property property">freezeTableName</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 禁止表名自动复数化</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">dialectOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">dateStrings</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">typeCast</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> config<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>启用 Sequelize 插件</p><p>在 <code>config/plugin.js</code> 中启用插件：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// config/plugin.js</span></span>
<span class="line">exports<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">&#39;egg-sequelize&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>定义 Model 示例</p><ul><li><p>用户模型 (User)</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/model/user.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;用户名&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;密码&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">validate</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">isEmail</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;邮箱&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">phone</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;手机号&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">avatar</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;头像URL&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;状态: true-启用, false-禁用&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">last_login_at</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;最后登录时间&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">deleted_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 自定义表名</span></span>
<span class="line">        <span class="token literal-property property">tableName</span><span class="token operator">:</span> <span class="token string">&#39;users&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token comment">// 开启软删除</span></span>
<span class="line">        <span class="token literal-property property">paranoid</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token comment">// 自定义时间戳字段名</span></span>
<span class="line">        <span class="token literal-property property">createdAt</span><span class="token operator">:</span> <span class="token string">&#39;created_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token string">&#39;updated_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">deletedAt</span><span class="token operator">:</span> <span class="token string">&#39;deleted_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 定义关联关系</span></span>
<span class="line">    User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 一个用户有多篇文章</span></span>
<span class="line">        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">&#39;user_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;articles&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 一个用户有一个资料</span></span>
<span class="line">        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>UserProfile<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">&#39;user_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;profile&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 用户和角色是多对多关系</span></span>
<span class="line">        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">through</span><span class="token operator">:</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>UserRole<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">&#39;user_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">otherKey</span><span class="token operator">:</span> <span class="token string">&#39;role_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;roles&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> User<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>文章模型 (Article)</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/model/article.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> Article <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&#39;article&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;文章标题&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;文章内容&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">user_id</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;作者ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">view_count</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;浏览数&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">like_count</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;点赞数&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;状态: 1-草稿, 2-已发布, 3-已下架&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">deleted_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">tableName</span><span class="token operator">:</span> <span class="token string">&#39;articles&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">paranoid</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">createdAt</span><span class="token operator">:</span> <span class="token string">&#39;created_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token string">&#39;updated_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">deletedAt</span><span class="token operator">:</span> <span class="token string">&#39;deleted_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    Article<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 文章属于一个用户</span></span>
<span class="line">        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">&#39;user_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;author&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 文章和标签是多对多关系</span></span>
<span class="line">        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Tag<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">through</span><span class="token operator">:</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleTag<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">&#39;article_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">otherKey</span><span class="token operator">:</span> <span class="token string">&#39;tag_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;tags&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 文章有多条评论</span></span>
<span class="line">        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Comment<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">&#39;article_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;comments&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> Article<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>标签模型 (Tag)</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/model/tag.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> Tag <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&#39;tag&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;标签名称&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">description</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;标签描述&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">tableName</span><span class="token operator">:</span> <span class="token string">&#39;tags&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">createdAt</span><span class="token operator">:</span> <span class="token string">&#39;created_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token string">&#39;updated_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    Tag<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 标签和文章是多对多关系</span></span>
<span class="line">        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Tag<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">through</span><span class="token operator">:</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ArticleTag<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">&#39;tag_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">otherKey</span><span class="token operator">:</span> <span class="token string">&#39;article_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;articles&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> Tag<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>文章标签关联模型 (ArticleTag)</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line">    <span class="token comment">// app/model/article_tag.js</span></span>
<span class="line">    module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">const</span> ArticleTag <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&#39;article_tag&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">article_id</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;文章ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">tag_id</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;标签ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">tableName</span><span class="token operator">:</span> <span class="token string">&#39;article_tags&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">createdAt</span><span class="token operator">:</span> <span class="token string">&#39;created_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">indexes</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">fields</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;article_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;tag_id&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> ArticleTag<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>用户资料模型 (UserProfile)</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/model/user_profile.js</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">TEXT</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> UserProfile <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&#39;user_profile&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">user_id</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">allowNull</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;用户ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">nickname</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;昵称&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">gender</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">defaultValue</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;性别: 0-未知, 1-男, 2-女&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">birthday</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;生日&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">bio</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;个人简介&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">website</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">comment</span><span class="token operator">:</span> <span class="token string">&#39;个人网站&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">tableName</span><span class="token operator">:</span> <span class="token string">&#39;user_profiles&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">createdAt</span><span class="token operator">:</span> <span class="token string">&#39;created_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token string">&#39;updated_at&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    UserProfile<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 资料属于一个用户</span></span>
<span class="line">        app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>UserProfile<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">foreignKey</span><span class="token operator">:</span> <span class="token string">&#39;user_id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> UserProfile<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>数据库迁移（可选）</p><ol><li><p>如果需要使用数据库迁移功能，可以安装 <code>sequelize-cli</code>：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">npm</span> <span class="token function">install</span> --save-dev sequelize-cli</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>然后在项目根目录创建 <code>.sequelizerc</code> 文件：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// .sequelizerc</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">config</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;config/sequelize.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&#39;models-path&#39;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;app/model&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&#39;seeders-path&#39;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;database/seeders&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&#39;migrations-path&#39;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;database/migrations&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>创建 <code>config/sequelize.js</code> 配置文件：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// config/sequelize.js</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> database<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./config&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sequelize<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">development</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        username<span class="token punctuation">,</span></span>
<span class="line">        password<span class="token punctuation">,</span></span>
<span class="line">        database<span class="token punctuation">,</span></span>
<span class="line">        host<span class="token punctuation">,</span></span>
<span class="line">        port<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">dialect</span><span class="token operator">:</span> <span class="token string">&#39;mysql&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">timezone</span><span class="token operator">:</span> <span class="token string">&#39;+08:00&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        username<span class="token punctuation">,</span></span>
<span class="line">        password<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>database<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_test</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span>
<span class="line">        host<span class="token punctuation">,</span></span>
<span class="line">        port<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">dialect</span><span class="token operator">:</span> <span class="token string">&#39;mysql&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">timezone</span><span class="token operator">:</span> <span class="token string">&#39;+08:00&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">production</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        username<span class="token punctuation">,</span></span>
<span class="line">        password<span class="token punctuation">,</span></span>
<span class="line">        database<span class="token punctuation">,</span></span>
<span class="line">        host<span class="token punctuation">,</span></span>
<span class="line">        port<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">dialect</span><span class="token operator">:</span> <span class="token string">&#39;mysql&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">timezone</span><span class="token operator">:</span> <span class="token string">&#39;+08:00&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol></li><li><p>在 Service 中使用 Model</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/service/user.js</span></span>
<span class="line"><span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建用户</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">userData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 根据ID查找用户</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">model</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>UserProfile<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;profile&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 分页查询用户</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">paginate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> pageSize <span class="token operator">=</span> <span class="token number">10</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">offset</span><span class="token operator">:</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">limit</span><span class="token operator">:</span> pageSize<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">order</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;DESC&#39;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">model</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>UserProfile<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">&#39;profile&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">attributes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;nickname&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;gender&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserService<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>模型使用最佳实践</p><ol><li><strong>命名规范</strong>： <ul><li>模型文件使用单数形式（如 <code>user.js</code>）</li><li>数据库表名使用复数形式（如 <code>users</code>）</li></ul></li><li><strong>关联关系</strong>： <ul><li>一对一：<code>hasOne</code> 和 <code>belongsTo</code></li><li>一对多：<code>hasMany</code> 和 <code>belongsTo</code></li><li>多对多：<code>belongsToMany</code> 和 <code>belongsToMany</code></li></ul></li><li><strong>字段定义</strong>： <ul><li>明确指定字段类型和长度</li><li>添加适当的验证规则</li><li>添加注释说明字段用途</li></ul></li><li><strong>时间戳</strong>： <ul><li>建议统一使用 <code>created_at</code>、<code>updated_at</code> 和 <code>deleted_at</code></li><li>启用 <code>paranoid</code> 模式实现软删除</li></ul></li><li><strong>性能优化</strong>： <ul><li>查询时指定需要的字段</li><li>合理使用 <code>include</code> 进行关联查询</li><li>添加适当的索引</li></ul></li></ol></li></ol><h2 id="_2-6-定时任务-schedule" tabindex="-1"><a class="header-anchor" href="#_2-6-定时任务-schedule"><span>2.6 定时任务（Schedule）</span></a></h2><ol><li><p>基本配置</p><p>首先需要在 <code>config/plugin.js</code> 中启用 schedule 插件：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// config/plugin.js</span></span>
<span class="line">exports<span class="token punctuation">.</span>schedule <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">&#39;egg-schedule&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>定时任务示例</p><ul><li><p>示例1：简单的定时任务</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/schedule/update_cache.js</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 定时任务配置</span></span>
<span class="line">    <span class="token literal-property property">schedule</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">interval</span><span class="token operator">:</span> <span class="token string">&#39;1h&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 1小时间隔</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;all&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 指定所有的 worker 都需要执行</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 任务执行函数</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 更新缓存数据</span></span>
<span class="line">            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">getLatest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;latest_data&#39;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;缓存更新成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;缓存更新失败:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>示例2：使用 Cron 表达式</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/schedule/clean_log.js</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">schedule</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 使用 cron 表达式，每天凌晨3点执行</span></span>
<span class="line">        <span class="token literal-property property">cron</span><span class="token operator">:</span> <span class="token string">&#39;0 0 3 * * *&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;worker&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 只有一个 worker 会执行</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 清理7天前的日志</span></span>
<span class="line">            <span class="token keyword">const</span> beforeDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            beforeDate<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span>beforeDate<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Log<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token punctuation">[</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Op<span class="token punctuation">.</span>lt<span class="token punctuation">]</span><span class="token operator">:</span> beforeDate<span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">清理了 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 条旧日志</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;清理日志失败:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>示例3：动态禁用任务</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/schedule/sync_data.js</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">schedule</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">interval</span><span class="token operator">:</span> <span class="token string">&#39;30m&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;all&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function-variable function">disable</span><span class="token operator">:</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 只在生产环境启用</span></span>
<span class="line">            <span class="token keyword">return</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>env <span class="token operator">!==</span> <span class="token string">&#39;prod&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 同步外部数据</span></span>
<span class="line">            <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>external<span class="token punctuation">.</span><span class="token function">syncData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">同步了 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 条数据</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;数据同步失败:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>示例4：立即执行任务</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/schedule/immediate_task.js</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">schedule</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;worker&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">immediate</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 应用启动后立即执行一次</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 初始化数据</span></span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>system<span class="token punctuation">.</span><span class="token function">initData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;系统数据初始化完成&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;初始化失败:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>定时任务配置选项</p><table><thead><tr><th>选项</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>interval</td><td>string</td><td>执行间隔，如 &#39;1s&#39;, &#39;2m&#39;, &#39;3h&#39;</td></tr><tr><td>cron</td><td>string</td><td>cron 表达式，如 &#39;0 0 */3 * * *&#39;</td></tr><tr><td>type</td><td>string</td><td>执行方式：&#39;worker&#39;（随机一个 worker 执行），&#39;all&#39;（所有 worker 都执行）</td></tr><tr><td>immediate</td><td>boolean</td><td>是否立即执行一次</td></tr><tr><td>disable</td><td>function</td><td>是否禁用任务</td></tr><tr><td>env</td><td>array</td><td>指定在哪些环境下启用，如 [&#39;prod&#39;, &#39;test&#39;]</td></tr></tbody></table></li><li><p>高级用法</p><ol><li><p>使用 Redis 实现分布式锁</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/schedule/distributed_task.js</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">schedule</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">interval</span><span class="token operator">:</span> <span class="token string">&#39;5m&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;all&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> lockKey <span class="token operator">=</span> <span class="token string">&#39;schedule:distributed_task:lock&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> lockTimeout <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span> <span class="token comment">// 5分钟</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 获取分布式锁</span></span>
<span class="line">        <span class="token keyword">const</span> locked <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">,</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;EX&#39;</span><span class="token punctuation">,</span> lockTimeout<span class="token punctuation">,</span> <span class="token string">&#39;NX&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>locked<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;任务已被其他 worker 执行&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 执行任务</span></span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">processBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;分布式任务执行完成&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 释放锁</span></span>
<span class="line">            <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>定时发送邮件</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/schedule/send_daily_report.js</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">schedule</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">cron</span><span class="token operator">:</span> <span class="token string">&#39;0 30 9 * * *&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 每天上午9:30</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;worker&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 获取日报数据</span></span>
<span class="line">            <span class="token keyword">const</span> reportData <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>report<span class="token punctuation">.</span><span class="token function">generateDailyReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 获取需要发送的用户列表</span></span>
<span class="line">            <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">receive_report</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 批量发送邮件</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> user <span class="token keyword">of</span> users<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>mail<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">to</span><span class="token operator">:</span> user<span class="token punctuation">.</span>email<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">subject</span><span class="token operator">:</span> <span class="token string">&#39;每日报告&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">&#39;daily_report&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                        user<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">report</span><span class="token operator">:</span> reportData<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">已发送 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>users<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 份日报邮件</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;发送日报邮件失败:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>定时备份数据库</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// app/schedule/backup_database.js</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;child_process&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> dayjs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;dayjs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">schedule</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">cron</span><span class="token operator">:</span> <span class="token string">&#39;0 0 2 * * *&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 每天凌晨2点</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;worker&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">task</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> backupDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>baseDir<span class="token punctuation">,</span> <span class="token string">&#39;backups&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// 创建备份目录</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>backupDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>backupDir<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">const</span> timestamp <span class="token operator">=</span> <span class="token function">dayjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&#39;YYYYMMDD_HHmmss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> backupFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>backupDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">backup_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.sql</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 执行mysqldump命令</span></span>
<span class="line">            <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> <span class="token punctuation">{</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> database <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>sequelize<span class="token punctuation">;</span></span>
<span class="line">                </span>
<span class="line">                <span class="token keyword">const</span> cmd <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mysqldump -h</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -P</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -u</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -p</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>database<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>backupFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">                </span>
<span class="line">                <span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// 保留最近7天的备份</span></span>
<span class="line">            <span class="token keyword">const</span> files <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>backupDir<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> file<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;backup_&#39;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;.sql&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>files<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> file <span class="token keyword">of</span> files<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>backupDir<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">数据库备份成功: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>backupFile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;数据库备份失败:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol></li><li><p>测试定时任务</p><ol><li><p>手动执行定时任务</p><p>你可以在开发环境中手动执行定时任务进行测试：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// 在 controller 中调用</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token function">triggerSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> schedule <span class="token operator">=</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>schedules<span class="token punctuation">[</span><span class="token string">&#39;update_cache&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> schedule<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;定时任务已手动触发&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>日志查看</p><p>定时任务的执行情况会记录在日志中，可以在 <code>logs/{app_name}/common-log.{app_name}.log</code> 中查看。</p></li></ol></li><li><p>注意事项</p><ol><li><strong>任务执行时间</strong>：确保任务的执行时间不会超过间隔时间，避免任务重叠执行</li><li><strong>错误处理</strong>：务必做好错误处理，避免任务失败导致整个应用崩溃</li><li><strong>分布式环境</strong>：在集群环境下，考虑使用分布式锁避免重复执行</li><li><strong>性能影响</strong>：长时间运行的任务可能会影响应用性能，建议拆分大任务</li><li><strong>配置管理</strong>：生产环境和开发环境的定时任务配置可能需要不同</li></ol></li><li><p>最佳实践</p><ol><li><strong>任务拆分</strong>：将大任务拆分为多个小任务</li><li><strong>幂等设计</strong>：确保任务可以重复执行而不会产生副作用</li><li><strong>监控报警</strong>：对关键任务添加监控和报警机制</li><li><strong>日志记录</strong>：详细记录任务执行情况和结果</li><li><strong>资源释放</strong>：确保任务执行完毕后释放所有资源</li></ol></li></ol></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">最近更新：: </span><time class="meta-item-info" datetime="2025-08-04T05:34:25.000Z" data-allow-mismatch>2025/8/4 05:34</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 857899180@qq.com">zhao-farmer</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/note-front/backend/senior/egg/01.html" aria-label="一、基础使用"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span class="external-link">一、基础使用</span></div><!--]--></a><a class="route-link auto-link next" href="/note-front/backend/senior/egg/03.html" aria-label="三、内置对象"><!--[--><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span class="external-link">三、内置对象</span></div><!--]--></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/note-front/assets/app-Cok9BT0p.js" defer></script>
  </body>
</html>
