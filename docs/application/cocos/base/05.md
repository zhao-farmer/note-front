# 五、网络与数据

## 5.1 数据存储

类似H5的localStorage

```ts
import { _decorator, Component, sys } from 'cc';
const { ccclass, property } = _decorator;

@ccclass('JsonTest')
export class JsonTest extends Component {
    start() { 
        // 存储数据 键值
        sys.localStorage.setItem("name","蝙蝠侠");
        // 获取数据
        let name = sys.localStorage.getItem("name");
        console.log(name);
        // 移除一个数据
        sys.localStorage.removeItem("name");
        // 清除
        sys.localStorage.clear()
        
    }

    update(deltaTime: number) {
        
    }
}
```


## 5.2 Json数据

```ts
import { _decorator, Component, sys } from 'cc';
const { ccclass, property } = _decorator;

class Person{
    id:number;
    name:string;
    wugong:string[];
    //...
}

@ccclass('JsonTest')
export class JsonTest extends Component {
    start() {
        let person:Person = new Person();
        person.id = 10;
        person.name = "李逍遥";
        person.wugong = ["降龙十八掌","独孤九剑"];
        // 对象到字符串
        /* 
            json: {}对象 []数组
            '{"id":10,"name":"李逍遥","wugong":["降龙十八掌","独孤九剑"]}'
        */

        // 对象->json 序列化
        let json = JSON.stringify(person);
        console.log(json);
        // sys.localStorage.setItem("save2",json)
        let person2:Person = Object.assign(new Person(),JSON.parse(json));
        console.log(person2.name);
    }
}
```

## 5.3 数据格式

对象转字符串的数据格式

1. json

```json
[
    {
        "id":10,
        "name":"李逍遥",
        "wugong":[
            "降龙十八掌","独孤九剑"
        ]
    },
    {
        "id":2,
        "name":"王小虎",
        "wugong":[
            "魔刃","翻云覆雨"
        ]
    }
]
```

2. xml

```xml
<root>
    <person id="10">
        <name>李逍遥</name>
        <wugong>降龙十八掌,独孤九剑</wugong>
    </person>
    <person id="2">
        <name>王小虎</name>
        <wugong>魔刃,翻云覆雨</wugong>
    </person>
</root>
```

3. csv

```csv
id,name,wugong
10,李逍遥,降龙十八掌/独孤九剑
2,王小虎,魔刀/翻云覆雨
```

4. 自定义文本协议

```
id:123|name:张无忌|wugong:九阳神功;乾坤大挪移;太极拳
```

分隔符规则：`|` 分隔字段,`;` 分隔多个武功

## 5.4 网络请求

使用fetch调用

- 代码
    ```ts
    import { _decorator, Component } from 'cc';
    const { ccclass, property } = _decorator;

    @ccclass('Request')
    export class Request extends Component {
        start() {
            const url = "https://v.api.aa1.cn/api/bilibili-rs/"; // 替换为你的 API 地址
            
            // fetch 请求
            fetch(url).then((response: Response) => {
                return response.text()
            }).then((value) => {
                console.log(value);
            })
        }
        update(deltaTime: number) {
            
        }
    }
    ```
- 运行结果

    ![](/application/cocos/base/167.png)


## 5.5 socket

### 5.5.1 node.js 服务端

1. 创建服务端项目

    ```sh
    # 新建文件夹
    mkdir socket-server
    # 进入文件夹
    cd socket-server
    # 初始化项目
    npm init
    # 安装express
    npm install express --save
    # 安装socket.io
    npm install socket.io -save
    ```
2. 新建 server.js

    ```ts
    const app = require('express')();
    const http = require('http');
    // 创建服务对象
    const server = http.createServer(app);

    // 创建socket
    const io = require("socket.io")(server,{ cors: true });

    // 监听有客户端连接
    io.on("connection",function(socket){
        
        // 收到连接
        console.log("客户端连接");

        // 监听客户端发来的消息
        socket.on("message",function(data){
            console.log("客户端发来消息："+data);
            // 给客户端返消息
            socket.emit('message',"client")
        })
    })

    // 在某个端口开始监听客户端连接
    server.listen(3001, () => {
        console.log("Server listen on 3001");
    });
    ```

### 5.5.2 socket.io 客户端

1. 下载文件

    [进入下载页面](https://github.com/socketio/socket.io/blob/main/packages/socket.io-client/dist/socket.io.js)

2. 创建类型声明文件 socket.io.d.ts

    ```ts
    declare function io(url: string, options?: any): Socket;

    interface Socket {
        connected: boolean;
        id: string;
        
        on(event: string, callback: (data: any) => void): void;
        off(event: string, callback?: (data: any) => void): void;
        emit(event: string, data?: any): void;
        disconnect(): void;
        connect(): void;
    }
    ```

3. 客户端文件

    ```ts
    import { _decorator, Component, Node } from 'cc';
    const { ccclass, property } = _decorator;

    @ccclass('SocketTest')
    export class SocketTest extends Component {

        socket: Socket = null;
        start() {
            // 连接服务端
            this.socket = io("http://localhost:3001")

            // 判断是否连接成功
            this.socket.on("connect",(data)=>{
                console.log("连接成功");
                // 给服务端发消息
                this.socket.emit("message","hello server")

                // 客户端接收消息
                this.socket.on('message',(data)=>{
                    console.log(data);
                })
            })

            // 判断是否断开
            this.socket.on("disconnect",(data)=>{

            })
        }

        update(deltaTime: number) {
            
        }
    }
    ```

4. 脚本添加到组件上

    ![](/application/cocos/base/170.png)