# äº”ã€æ•°æ®

## 5.1 ESç‰ˆæœ¬ä¸è·¯å¾„

1. åœ¨ package.json ä¿®æ”¹ä¸º esm ç±»å‹

    ```json{6}
    {
    "name": "05-es",
    "version": "1.0.0",
    "main": "main.mjs",
    "license": "MIT",
    "type": "module",
    "scripts": {
        "start": "electron .",
        "start2": "chcp 65001 && nodemon --exec electron . --watch ./ --ext .js,.mjs,.html"
    },
    "devDependencies": {
        "electron": "^37.2.1",
        "nodemon": "^3.1.10"
    }
    }
    ```
2. ä¿®æ”¹ä¸»è¿›ç¨‹ä¸º main.mjs

    app.getPath è·å–å„å¼è·¯å¾„

    ```js
    import { app, BrowserWindow } from "electron";
    import path from "path";

    let mainWindow = null;

    // åˆ›å»ºçª—å£
    function createWindow() {

        mainWindow = new BrowserWindow({
            width: 800, // å®½åº¦
            height: 600, // é«˜åº¦
            // é¢„åŠ è½½é¡µé¢
            webPreferences: {
                // åŠ è½½æ¸²æŸ“è¿›ç¨‹
                preload: path.join(import.meta.dirname, "./preload.mjs"),
                // å…è®¸æ¸²æŸ“è¿›ç¨‹ç›´æ¥è®¿é—®Node.js API
                nodeIntegration: true,
            },
        });

        // ç»‘å®šindex
        mainWindow.loadFile("./pages/index.html");
    }


    function testpath(){
        console.log(app.getPath('appData')); // C:\Users\zhaojianhui\AppData\Roaming
        console.log(app.getPath('userData')); // C:\Users\zhaojianhui\AppData\Roaming\electron_basic04 ï¼ˆæ­¤å¤„ä¸º Windows ç³»ç»Ÿï¼‰
        console.log(app.getPath('home')); // C:\Users\zhaojianhui
        console.log(app.getPath('desktop')); // C:\Users\zhaojianhui\Desktop
    }

    function restart(){
        console.log(app.getPath('appData')); // ä¿®æ”¹å‰ï¼šC:\Users\zhaojianhui\AppData\Roaming

        // é‡ç½®ç”¨æˆ·æ•°æ®ç›®å½•ï¼ˆå‚æ•°ä¸€ï¼šè¦é‡ç½®çš„è·¯å¾„çš„åç§°ï¼Œå‚æ•°äºŒï¼šå…·ä½“çš„è·¯å¾„ï¼‰
        app.setPath('appData','D:\\test')

        console.log(app.getPath('appData')); // ä¿®æ”¹åï¼šD:\test
    }


    //å½“appå‡†å¤‡å¥½åï¼Œæ‰§è¡Œcreatewindowåˆ›å»ºçª—å£
    app.on( 'ready' ,()=>{
        createWindow()
        console.log('åº”ç”¨åŠ è½½å®Œæˆ');
        // æµ‹è¯•è·¯å¾„
        testpath()
        restart()
    })

    ```

3. é¢„åŠ è½½è„šæœ¬ä¸º preload.mjs 

    ```js
    //é¢„åŠ è½½è„šæœ¬
    import { contextBridge ,ipcRenderer } from 'electron';

    // ç»‘å®šnodeç‰ˆæœ¬æ•°æ®
    contextBridge.exposeInMainWorld('myAPI',{
        nodeVersion:process.version,
        chromeVersion:process.versions.chrome,
        electronVersion:process.versions.electron
    })
    ```

4. æ¸²æŸ“è¿›ç¨‹ä¸é¡µé¢

    render.js

    ```js
    const btn1 = document.getElementById('btn1')

    btn1.onclick = ()=>{
        console.log(123);
        
        alert(
            'æ­¤åº”ç”¨çš„nodeç‰ˆæœ¬: ' + myAPI.nodeVersion
            + '\næ­¤åº”ç”¨çš„chromeç‰ˆæœ¬: '+myAPI.chromeVersion 
            + '\næ­¤åº”ç”¨çš„electronç‰ˆæœ¬: '+myAPI.electronVersion 
        );
    }
    ```

    index.html

    å¼•å…¥è„šæœ¬åŠ ä¸Š`type="module"`

    ```html
   <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>esç‰ˆæœ¬</title>
        <link rel="stylesheet" href="index.css" />
    </head>
    <body>
    
        <button  id="btn1">è·å–ç‰ˆæœ¬ä¿¡æ¯</button>

        <script type="module" src="./render.js"></script>
    </body>
    </html>
    ```

5. è¿è¡Œç»“æœ

![](/application/electron/base/029.gif)

## 5.2 electron-store æ•°æ®åº“

### 5.2.1 åŸºç¡€æ•™ç¨‹

1. å®‰è£…

```sh
yarn add electron-store
```

>è¿™ä¸ªåŒ…æ˜¯åŸç”ŸESMï¼Œä¸å†æä¾›CommonJSå¯¼å‡ºã€‚å¦‚æœä½ çš„é¡¹ç›®ä½¿ç”¨CommonJSï¼Œä½ å°†ä¸å¾—ä¸è½¬æ¢ä¸ºESMã€‚æ›´å¤šå…³äºç”µå­å’ŒESMçš„ä¿¡æ¯ã€‚è¯·ä¸è¦ä¸ºCommonJSå’ŒESMçš„é—®é¢˜æ‰“å¼€é—®é¢˜ã€‚

2. ä½¿ç”¨
```js
import Store from 'electron-store';

const store = new Store();

store.set('unicorn', 'ğŸ¦„');
console.log(store.get('unicorn'));
//=> 'ğŸ¦„'

// Use dot-notation to access nested properties
store.set('foo.bar', true);
console.log(store.get('foo'));
//=> {bar: true}

store.delete('unicorn');
console.log(store.get('unicorn'));
//=> undefined
```


### 5.2.2 eletron ä½¿ç”¨

1. ä¸»è¿›ç¨‹ main.js

    ```js
    import { app, BrowserWindow,ipcMain } from "electron";
    import path from "path";
    import Store from 'electron-store';

    const store = new Store();
    let mainWindow = null;

    // åˆ›å»ºçª—å£
    function createWindow() {

        mainWindow = new BrowserWindow({
            width: 800, // å®½åº¦
            height: 600, // é«˜åº¦
            // é¢„åŠ è½½é¡µé¢
            webPreferences: {
                // åŠ è½½æ¸²æŸ“è¿›ç¨‹
                preload: path.join(import.meta.dirname, "./preload.mjs"),
                // å…è®¸æ¸²æŸ“è¿›ç¨‹ç›´æ¥è®¿é—®Node.js API
                nodeIntegration: true,
            },
        });
        // ç»‘å®šindex
        mainWindow.loadFile("./pages/index.html");
    }

    // å­˜å…¥æ•°æ®
    ipcMain.on('setData', (event, params) => {
        console.log(params);
        store.set('testData', params);
    })

    // è·å–æ•°æ® è¦ä½¿ç”¨handle
    ipcMain.handle('getData', (event, params) => {
        return store.get("testData");
    })

    //å½“appå‡†å¤‡å¥½åï¼Œæ‰§è¡Œcreatewindowåˆ›å»ºçª—å£
    app.on( 'ready' ,()=>{
        createWindow()
        console.log('åº”ç”¨åŠ è½½å®Œæˆ');
    })
    ```

2. é¢„å¤„ç†è„šæœ¬ preload.mjs

    ```js
    //é¢„åŠ è½½è„šæœ¬
    import { contextBridge, ipcRenderer } from "electron";

    // ç»‘å®šnodeç‰ˆæœ¬æ•°æ®
    contextBridge.exposeInMainWorld("myAPI", {
        // åŒæ­¥ç±»å‹
        setData(data) {
            ipcRenderer.send("setData",data);
        },
        // å¼‚æ­¥æ•°æ®
        getData: ()=> {
            return ipcRenderer.invoke("getData");
        },
    });
    ```

3. é¡µé¢ä¸æ¸²æŸ“è¿›ç¨‹

    index.html

    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>esç‰ˆæœ¬</title>
        <link rel="stylesheet" href="index.css" />
    </head>
    <body>
    <div id="app">
        <div class="input-data">
        å§“åï¼š<input type="text" class="name">
        å¹´é¾„ï¼š<input type="number" class="age">
        ä»‹ç»ï¼š<input type="text" class="describe">
        </div>
        <div  class="button-data">
        <button id="setData">å­˜å…¥æ•°æ®åº“</button>
        <button id="getData">è¯»å–æ•°æ®</button>
        </div>
    </div>
    
    <script type="module" src="./render.js"></script>
    </body>
    </html>
    ```

    index.css

    ```css
    html {
        margin: 0px;
        padding: 0px;
        overflow: hidden;
        height: 100%;
    }
    body{
        padding: 0px;
        margin: 0px;
    }
    #app{
        padding: 15px;
    }
    .input-data{
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
        width: 200px;
    } 
    .button-data{
        display: flex;
        gap: 20px;
        justify-content: space-between;
        width: 200px;
    }
    ```

    render.js

    ```js

    const setDataBtn = document.getElementById("setData");
    const getDataBtn = document.getElementById("getData");

    // è·å–æ•°æ®å¹¶ä¼ ç»™é¢„å¤„ç†
    setDataBtn.onclick = ()=>{
        const nameValue =  document.querySelector(".name").value;
        const ageValue =  document.querySelector(".age").value;
        const describeValue = document.querySelector(".describe").value;
        
    let data = {name:nameValue,age:ageValue,des:describeValue}
    myAPI.setData(data)
    }

    // è·å–æ•°æ® å¹¶å±•ç¤º
    getDataBtn.addEventListener("click",async () => {
        let data = await myAPI.getData();
        document.body.innerHTML += `<h2>${ JSON.stringify(data) }</h2>`;
    });
    ```

4. è¿è¡Œç»“æœ

    ![](/application/electron/base/030.gif)

## 5.3 sqllite æ•°æ®åº“


1. å®‰è£…

    ```sh
    yarn add sqlite
    ```

2. æ–°å»ºå·¥å…·ç±»

    DatabaseService.js

    ```js
    import sqlite3 from 'sqlite3';
    import { app } from 'electron';
    import path from 'path';
    import { fileURLToPath } from 'url';

    class DatabaseService {
    constructor() {
        const __dirname = path.dirname(fileURLToPath(import.meta.url));
        this.dbPath = path.join(app.getPath('userData'), 'appdata.db');
        this.db = new sqlite3.Database(this.dbPath);
        this.initTables();
    }

    initTables() {
        this.db.exec(`
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            email TEXT UNIQUE,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
        `);
    }

    async query(sql, params = []) {
        return new Promise((resolve, reject) => {
        this.db.all(sql, params, (err, rows) => {
            err ? reject(err) : resolve(rows);
        });
        });
    }

    async insert(table, data) {
        const keys = Object.keys(data);
        const values = Object.values(data);
        const placeholders = keys.map(() => '?').join(',');
        const sql = `INSERT INTO ${table} (${keys.join(',')}) VALUES (${placeholders})`;
        return this.query(sql, values);
    }

    async update(table, data, condition) {
        const setClause = Object.keys(data)
        .map(key => `${key} = ?`)
        .join(',');
        const values = [...Object.values(data), ...condition.values];
        const sql = `UPDATE ${table} SET ${setClause} WHERE ${condition.sql}`;
        return this.query(sql, values);
    }

    async delete(table, condition) {
        const sql = `DELETE FROM ${table} WHERE ${condition.sql}`;
        return this.query(sql, condition.values);
    }
    }

    export default new DatabaseService();
    ```

3. ä¸»è¿›ç¨‹ main.js

    ```js
    import { app, BrowserWindow,ipcMain } from "electron";
    import path from "path";
    import database from "./DatabaseService.mjs";

    let mainWindow = null;

    // åˆ›å»ºçª—å£
    function createWindow() {

        mainWindow = new BrowserWindow({
            width: 800, // å®½åº¦
            height: 600, // é«˜åº¦
            // é¢„åŠ è½½é¡µé¢
            webPreferences: {
                // åŠ è½½æ¸²æŸ“è¿›ç¨‹
                preload: path.join(import.meta.dirname, "./preload.mjs"),
                // å…è®¸æ¸²æŸ“è¿›ç¨‹ç›´æ¥è®¿é—®Node.js API
                nodeIntegration: true,
            },
        });

        // ç»‘å®šindex
        mainWindow.loadFile("./pages/index.html");

    }

    // å­˜å…¥æ•°æ®
    ipcMain.on('setData', (event, params) => {
        console.log(params);
        
        database.insert("users",params)
    })

    // è·å–æ•°æ® è¦ä½¿ç”¨handle
    ipcMain.handle('getData', (event, params) => {
        // è¯»å–æ•°æ®
        return database.query("SELECT * FROM users WHERE created_at = (SELECT max(created_at) FROM users)");
    })


    //å½“appå‡†å¤‡å¥½åï¼Œæ‰§è¡Œcreatewindowåˆ›å»ºçª—å£
    app.on( 'ready' ,()=>{
        createWindow()
        console.log('åº”ç”¨åŠ è½½å®Œæˆ');
    })
    ```

4. é¢„å¤„ç†è„šæœ¬ preload.mjs

    ```js
    //é¢„åŠ è½½è„šæœ¬
    import { contextBridge, ipcRenderer } from "electron";

    // ç»‘å®šnodeç‰ˆæœ¬æ•°æ®
    contextBridge.exposeInMainWorld("myAPI", {
        // åŒæ­¥ç±»å‹
        setData(data) {
            ipcRenderer.send("setData",data);
        },
        // å¼‚æ­¥æ•°æ®
        getData: ()=> {
            return ipcRenderer.invoke("getData");
        },
    });
    ```

5. é¡µé¢ä¸æ¸²æŸ“è¿›ç¨‹

    index.html

    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>esç‰ˆæœ¬</title>
        <link rel="stylesheet" href="index.css" />
    </head>
    <body>
    <div id="app">
        <div class="input-data">
        å§“åï¼š<input type="text" class="name">
        é‚®ç®±ï¼š<input type="email" class="email">
        </div>
        <div  class="button-data">
        <button id="setData">å­˜å…¥æ•°æ®åº“</button>
        <button id="getData">è¯»å–æ•°æ®</button>
        </div>
    </div>
    
    <script type="module" src="./render.js"></script>
    </body>
    </html>
    ```

    index.css

    ```css
    html {
        margin: 0px;
        padding: 0px;
        overflow: hidden;
        height: 100%;
    }
    body{
        padding: 0px;
        margin: 0px;
    }
    #app{
        padding: 15px;
    }
    .input-data{
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
        width: 200px;
    } 
    .button-data{
        display: flex;
        gap: 20px;
        justify-content: space-between;
        width: 200px;
    }
    ```

    render.js

    ```js

    const setDataBtn = document.getElementById("setData");
    const getDataBtn = document.getElementById("getData");

    // è·å–æ•°æ®å¹¶ä¼ ç»™é¢„å¤„ç†
    setDataBtn.onclick = ()=>{
        const nameValue =  document.querySelector(".name").value;
        const emailValue =  document.querySelector(".email").value;

    let data = {name:nameValue,email:emailValue}
    myAPI.setData(data)
    }

    // è·å–æ•°æ® å¹¶å±•ç¤º
    getDataBtn.addEventListener("click",async () => {
        let data = await myAPI.getData();
        document.body.innerHTML += `<h2>${ JSON.stringify(data) }</h2>`;
    });
    ```

6. è¿è¡Œç»“æœ

    ![](/application/electron/base/031.gif)