# 六、express项目配置

## 6.1 项目增删改查


这里是使用脚手架创建的express项目


### 6.1.1 连接数据库

项目结构

![](/backend/node/base/027.png)

1. 安装插件

    ```sh
    npm i mongoose
    ```

    [点击进入 github](https://github.com/Automattic/mongoose) 查询使用方式

2. 连接配置

    ./config/db.config.js

    ```js
    // 连接数据库
    const mongoose = require("mongoose")

    // 开始连接 
    mongoose.connect("mongodb://127.0.0.1:27017/kerwin_project")
    // 插入集合和数据，数据库kerwin_project会自动创建
    ```

3. 启动文件调用配置

    ./bin/www

    ```js
    // 引入数据库模块
    require("../config/db.config")
    ```

4. 实体模型

    ./model/UserModel.js

    ```js
    
    const mongoose = require("mongoose")

    // 轮廓 用于限制类型
    const Schema = mongoose.Schema

    //限制模型
    const UserType = {
        username:String,
        password:String,
        age:Number
    }

    const UserModel = mongoose.model("user",new Schema(UserType))

    // 模式user 将会对应users集合
    module.exports = UserModel
    ```

### 6.1.2 插入

1. index.ejs文件

    ```html
    <!DOCTYPE html>
    <html>
    <head>
        <title><%= title %></title>
        <link rel="stylesheet" href="/stylesheets/style.css" />
    </head>
    <body>
        <h1>mongodb的增删改查的演示</h1>
        <div>
            <div>用户名：<input id="username" /></div>
            <div>密码：<input type="password" id="password" /></div>
            <div>年龄：<input type="number" id="age" /></div>
            <div><button id="register">注册</button></div>
        </div>

        <script>
            var register = document.querySelector("#register");
            var username = document.querySelector("#username");
            var password = document.querySelector("#password");
            var age = document.querySelector("#age");

            register.onclick = () => {
                console.log(username.value, password.value,age.value);

                // 调用后台
                fetch("/api/user/add",{
                    method:"POST",
                    body:JSON.stringify({
                        username:username.value,
                        password:password.value,
                        age:age.value
                    }),
                    headers:{
                    "Content-Type":"application/json"
                    }
                }).then(res=>res.json()).then(res=>{
                    console.log(res);
                })
            };

        </script>
    </body>
    </html>
    ```

2. 查询user接口配置

    ```js
    app.use('/api', usersRouter);
    ```

3. 后端接口调用

    ```js
    // 用户添加
    router.post("/api/add", (req, res) => {
        console.log(req.body);
        // 插入数据库
        // 1.创建一个模型(users,限制filed类型), --对应数据库的集合(users)
        // user.create user.find user.delete user.update

        const { username, password, age } = req.body;
        UserModel.create({
            username,
            password,
            age,
        }).then(data => {
            console.log(data);
            res.send({
                ok: 1,
            });
        });
    });

    ```

4. 运行结果

    - 页面调用

        ![](/backend/node/base/028.png)
    - 数据库数据

        ![](/backend/node/base/029.png)

### 6.1.3 更新

1. index.ejs文件

    ```html
    <button id="update">更新</button>
    <script>
        var updatebtn = document.querySelector("#update");

        updatebtn.onclick = ()=>{
            fetch("/api/user/update/6886f3f5550c92b092f6f6fd",{
                method:"POST",
                body:JSON.stringify({
                    username:"修改的名字",
                    password:"修改的密码",
                    age:1
                }),
                headers:{
                    "Content-Type":"application/json"
                }
            }).then(res=>res.json()).then(res=>{
                console.log(res);
            })
        }
    </script>
    ```


2. 后端接口调用

    ```js
    // 动态路由，获取id
    router.post("/user/update/:id",(req,res)=>{
        console.log(req.body,req.params.id);
        const {username,age,password} = req.body

        UserModel.updateOne({
            _id:req.params.id,
        },{
            username:username,
            password,
            age
        }).then(data=>{
            res.send({
                ok:1
            })
        })
    })
    ```

3. 数据库结果

    ![](/backend/node/base/030.png)

### 6.1.4 删除

1. index.ejs文件

    ```html
    <button id="delete">删除</button>
    <script>
        var deletebtn = document.querySelector("#delete");

        deletebtn.onclick = ()=>{
            fetch("/api/user/update/6886f3f5550c92b092f6f6fd")
            .then(res=>res.json()).then(res=>{
                console.log(res);
            })
        }
    </script>

    ```

2. 后端接口调用

    ```js
    // 删除
    router.get("/user/delete/:id",(req,res)=>{
        UserModel.deleteOne({
            _id:req.params.id
        }).then(data=>{
            res.send({
                ok:1
            })
        })
    })
    ```

3. 数据库结果

    ![](/backend/node/base/031.png)

### 6.1.5 查询

1. 数据库数据

    ![](/backend/node/base/032.png)

2. index.ejs文件

    ```html
     <table border="1">
        <thead>
            <tr>
                <td>id</td>
                <td>用户名</td>
                <td>年龄</td>
            </tr>
        </thead>
        <!-- 往这里插入数据 -->
        <tbody>

        </tbody>
    </table>

    <script>
        // 获取列表
        fetch("/api/user/list?page=2&limit=2")
        .then(res=>res.json()).then(res=>{
            console.log(res);
            var tbody = document.querySelector("tbody")
            tbody.innerHTML = res.map(item=>`
                <tr>
                    <td>${item._id}</td>    
                    <td>${item.username}</td>    
                    <td>${item.age}</td>    
                </tr>
            `).join("")
        })
    </script>
    ```

3. 后端接口调用

    ```js
    router.get("/user/list",(req,res)=>{
        console.log(req.query);
        const {page,limit} = req.query

        // 1. 查询特定的字段
        // 2. 进行排序 age = 1 正序 age = -1 倒序
        // 3. 获取第几行 第几页
        UserModel.find({},["username","age"])
            .sort({age:1})
            .skip((page-1) * limit).limit(limit)
            .then(data=>{
            res.send(data)
        })
    })
    ```

4. 页面数据

    ![](/backend/node/base/033.png)


## 6.2 接口规范

1. RESTfuI架构

    - 服务器上每一种资源，比如一个文件，一张图片，一部电影，都有对应的url地址，如果我们的客户端需要对服务器上的这个资源进行操作，就需要通过http协议执行相应的动作来操作它，比如进行获取，更新，删除。

    - 简单来说就是url地址中只包含名词表示资源，使用http动词表示动作进行操作资源举个例子:左边是错误的设计，而右边是正确的


    ```
    GET /blog/getArticles -->GET /blog/Articles 获取所有文章
    GET /blog/addArticles -->PosT /blog/Articles 添加一篇文章
    GET /blog/editArticles -->PuT /blog/Articles 修改一篇文章
    GET /rest/api/deleteArticles?id=1 -->DELETE /blog/Articles/1 删除一篇文章
    ```

2. 使用方式

    ```yml
    GET http://www.birjemin.com/api/user # 获取列表
    POST http://www.birjemin.com/api/user # 创建用户
    PUT http://www.birjemin.com/api/user/{id} # 修改用户信息
    DELETE http://www.birjemin.com/api/user/{id} # 删除用户信息
    ```
3. 过滤信息(用于补充规范一些通用字段)

    ```yml
    ?limit=10 # 指定返回记录的数量
    ?offset=10 # 指定返回记录的开始位置
    ?page=2&per_page=100 #指定第几页，以及每页的记录数
    ?sortby=name&order=asc # 指定返回结果按照哪个属性排序，以及排序顺序
    ?state=close    #指定筛选条件
    ```
4. 代码实操

    - 前端调用

        ```js
        registerbtn.onclick = () => {
            // 调用后台
            fetch("/api/user",{
                method:"POST",
                body:JSON.stringify({
                    username:username.value,
                    password:password.value,
                    age:age.value
                }),
                headers:{
                    "Content-Type":"application/json"
                }
            }).then(res=>res.json()).then(res=>{
                console.log(res);
            })
        };

        updatebtn.onclick = ()=>{
                fetch("/api/user/6887235c314763ca245ee3b0",{
                method:"PUT",
                body:JSON.stringify({
                    username:"修改的名字",
                    password:"修改的密码",
                    age:1
                }),
                headers:{
                    "Content-Type":"application/json"
                }
            }).then(res=>res.json()).then(res=>{
                console.log(res);
            })
        }
        deletebtn.onclick = ()=>{
            fetch("/api/user/6887235c314763ca245ee3b0",{
                method:"delete"
            }).then(res=>res.json()).then(res=>{
                console.log(res);
            })
        }

        // 获取列表
        fetch("/api/user?page=1&limit=10")
        .then(res=>res.json()).then(res=>{
            console.log(res);
            var tbody = document.querySelector("tbody")
            tbody.innerHTML = res.map(item=>`
                <tr>
                    <td>${item._id}</td>    
                    <td>${item.username}</td>    
                    <td>${item.age}</td>    
                </tr>
            `).join("")
        })
        ```
    - 后端接口

        ```js
        // restful 风格  新增
        router.post("/user", (req, res) => {

            const { username, password, age } = req.body;
            UserModel.create({
                username,
                password,
                age,
            }).then(data => {
                console.log(data);
                res.send({
                    ok: 1,
                });
            });
        });

        // restful 风格  修改
        router.put("/user/:id",(req,res)=>{
            const {username,age,password} = req.body

            UserModel.updateOne({
            _id:req.params.id,
            },{
            username:username,
            password,
            age
            }).then(data=>{
                res.send({
                ok:1
                })
            })
        })

        // restful 风格  删除
        router.delete("/user/:id",(req,res)=>{
            UserModel.deleteOne({
                _id:req.params.id
            }).then(data=>{
                res.send({
                ok:1
                })
            })
        })

        // restful 风格 获取
        router.get("/user",(req,res)=>{
        console.log(req.query);
        const {page,limit} = req.query
        UserModel.find({},["username","age"])
            .sort({age:1})
            .skip((page-1) * limit).limit(limit)
            .then(data=>{
            res.send(data)
        })
        })

        ```


## 6.3 业务分层

1. mvc架构

    - routerjs:负责将请求分发给C层
    - controllerjs:C层负责处理业务逻辑(V与M之间的沟通)
    - views:V层:负责展示页面
    - model: M层:负责处理数据(增删改查)

    ![](/backend/node/base/034.png)

2. 后端分层
    - controller：控制层 （负责前端交互）
    - service: 业务层 （负责逻辑判断和运算）
    - model：持久层 （与数据库交互）

    ![](/backend/node/base/035.png)

3. 代码实操

    - 项目结构

        ![](/backend/node/base/036.png)

    - router.js 

        ```js
        var express = require("express");
        const UserController = require("../controllers/UserController");
        var router = express.Router();


        // restful 风格  新增
        router.post("/user", UserController.addUser);

        // restful 风格  修改
        router.put("/user/:id",UserController.updateUser)

        // restful 风格  删除
        router.delete("/user/:id",UserController.deleteUser)

        // restful 风格 获取
        router.get("/user",UserController.getUser)

        module.exports = router;
        ```
    - UserController.js

        ```js
        const UserService = require("../services/UserService");

        const UserController = {
            addUser: async (req, res) => {
                // 获取参数
                const { username, password, age } = req.body;
                // 调用service
                await UserService.addUser(username, password, age);
                // 返回信息
                res.send({
                    ok: 1,
                });
            },

            updateUser: async (req, res) => {
                // 获取参数
                const { username, age, password } = req.body;
                const id = req.params.id;
                // 调用service
                await UserService.updateUser(id, username,password,age);
                // 返回信息
                res.send({
                    ok: 1,
                });
            },
            deleteUser: async (req,res)=>{
                // 获取参数
                const id = req.params.id;
                // 调用service
                await UserService.deleteUser(id);
                // 返回信息
                res.send({
                    ok:1
                })
            },
            getUser: async (req,res)=>{
                // 获取参数
                const {page,limit} = req.query
                // 调用service
                let data = await UserService.getUser(page,limit);
                // 返回信息
                res.send(data)
            }
        };

        module.exports = UserController;
        ```
    
    - UserService.js

        ```js
        const UserModel = require("../model/UserModel")

        const UserService = {
            addUser: (username,password,age)=>{
                return UserModel.create({
                    username,
                    password,
                    age,
                })
            },
            updateUser:(_id,username,password,age)=>{
                return UserModel.updateOne(
                    {
                        _id
                    },
                    {
                        username: username,
                        password,
                        age,
                    }
                )
            },
            deleteUser:(_id)=>{
                return UserModel.deleteOne({_id})
            },
            getUser:(page,limit)=>{
                return UserModel.find({},["username","age"])
                .sort({age:-1})
                .skip((page-1) * limit).limit(limit)
            }
        }

        module.exports = UserService
        ```

    - UserModel.js

        ```js
        const mongoose = require("mongoose")

        // 轮廓 用于限制类型
        const Schema = mongoose.Schema

        //限制模型
        const UserType = {
            username:String,
            password:String,
            age:Number
        }


        const UserModel = mongoose.model("user",new Schema(UserType))

        // 模式user 将会对应users集合
        module.exports = UserModel
        ```
## 6.4 登录鉴权

### 6.4.1 cookie与Session

1. 介绍

    「HTTP 无状态」我们知道，HTTP 是无状态的。也就是说，HTTP 请求方和响应方间无法维护状态，都是一次性的，它不知道前后的请求都发生了什么。但有的场景下，我们需要维护状态。最典型的，一个用户登陆微博，发布、关注、评论，都应是在登录后的用户状态下的。「标记」那解决办法是什么呢？

    ![](/backend/node/base/037.png)

2. 示例代码

    ```js
    const express = require("express");
    const session = require("express-session");
    const MongoStore = require("connect-mongo");
    const app = express();


    app.use(
    session({
        secret: "this is session", // 服务器生成 session 的签名
        resave: true, 
        saveUninitialized: true, //强制将为初始化的 session 存储
        cookie: {
        maxAge: 1000 * 60 * 10,// 过期时间
        secure: false, // 为 true 时候表示只有 https 协议才能访问cookie
        },
        rolling: true, //为 true 表示 超时前刷新，cookie 会重新计时； 为 false 表示在超时前刷新多少次，都是按照第一次刷新开始计时。
        store: MongoStore.create({
        mongoUrl: 'mongodb://127.0.0.1:27017/kerwin_session',
        ttl: 1000 * 60 * 10 // 过期时间
    }),

    })
    );

    app.use((req,res,next)=>{
    if(req.url==="/login"){
        next()
        return;
    }
    if(req.session.user){
        req.session.garbage = Date();
        next();
    }else{
        res.redirect("/login")   
    }
    })

    ```

3. 代码实现

    1. 登录操作

        - 新建login页面 views/login.ejs

            ```html
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <title>Document</title>
            </head>
            <body>
                <h1>登录页面</h1>

                <div>
                    <div>用户名：<input id="username" /></div>
                    <div>密码：<input type="password" id="password" /></div>
                    <div><button id="login">登录</button></div>
                </div>

                <script>
                    var username = document.querySelector("#username");
                    var password = document.querySelector("#password");
                    var login = document.querySelector("#login");

                    login.onclick = () => {
                        console.log(username.value,password.value);
                        
                        // 调用后台
                        fetch("/api/login",{
                            method:"POST",
                            body:JSON.stringify({
                                username:username.value,
                                password:password.value,
                            }),
                            headers:{
                                "Content-Type":"application/json"
                            }
                        }).then(res=>res.json()).then(res=>{
                            console.log(res);
                            if(res.ok === 1){
                                location.href = "/"
                            }else{
                                console.log("用户名密码不匹配");
                            }
                        })
                    };
                </script>
            </body>
            </html>
            ```
        - login路由 routes/login.js

            ```js
            var express = require('express');
            var router = express.Router();

            // 渲染到login
            router.get('/', function(req, res, next) {
                res.render('login', { title: 'Express' });
            });

            module.exports = router;
            ```
        - 加载路由 app.js(增量)

            ```js
            var loginRouter = require("./routes/login");
            app.use("/login", loginRouter);
            ```
    2. 安装与配置session 

        - 安装 `express-session`

            ```sh
            npm i express-session
            ```
        - 初始化组件 app.js

            ```js
            // 引入session
            var session = require("express-session");

            // 注册session中间件 必须再路由前
            app.use(
                session({
                    name: "kerwinsystem", // 名称
                    secret: "dwad444444dadwa", // 密钥
                    cookie: {
                        maxAge: 1000 * 60 * 60, // cookie 过期时间
                        secure: false,
                    },
                    resave: true, // 重新设置过期事件
                    saveUninitialized: true, // 一开始是否给cookie
                })
            );
            ```
    3. 使用session

        - 设置退出 index.ejs

            ```html
            <button id="exit">退出登录</button>
            <script>
                // 回去dom
                var exit = document.querySelector("#exit");
                // 点击退出
                exit.onclick=()=>{
                    fetch("/api/logout").then(res=>res.json()).then(res=>{
                        if(res.ok === 1){
                            console.log("退出登录");
                        }
                    })
                }
            </script>
            ```
        - 设置路由 router/users.js

            ```js
            // 登录校验
            router.post("/login",UserController.login)
            // 退出
            router.get("/logout",UserController.logout) 
            ```
        - 后台UserController.js （配置session）

            ```js
            login:async(req,res)=>{
                const {username,password} = req.body
                const data =  await UserService.login(username,password)
                if(data.length === 0){
                    res.send({
                        ok:0,
                    })
                }else{
                    // 设置session
                    req.session.user = data[0] // 设置session 对象
                    // 默认存在内存中，重启就会丢掉

                    res.send({
                        ok:1,
                    })
                }
            },
            logout: async (req,res)=>{
                req.session.destroy(()=>{
                    res.send({ok:1})
                })
            }
            ```
        - 账户查询 UserService.js

            ```js
            login:(username,password)=>{
                return UserModel.find({username,password})
            }
            ```
        - 设置中间件 过滤

            ```js
            // 设置中间件，sesssion过期校验
            app.use((req, res, next) => {
                // 排除login相关的路由和接口
                if (req.url.includes("login")) {
                    next();
                    return;
                }

                // 判断session 是否存在用户
                if (req.session.user) {
                    // 重新设置session
                    req.session.mydate = Date.now()

                    next();
                } else {
                    // 是接口，返回 错误码
                    // 不是接口，就重定向

                    req.url.includes("api")?
                    res.status(401).send({ok:0}):
                    res.redirect("/login");
                }
            });
            ```
    4. session 放入数据库中

        - 安装插件

            ```sh
            npm install connect-mongo
            ```

        - 修改express-session 选项

            ```js
            const MongoStore = require("connect-mongo");
            // 注册session中间件 必须再路由前
            app.use(
                session({
                    name: "kerwinsystem", // 名称
                    secret: "dwad444444dadwa", // 密钥
                    cookie: {
                        maxAge: 1000 * 60 * 60, // cookie 过期时间
                        secure: false,
                    },
                    resave: true, // 重新设置过期事件
                    saveUninitialized: true, // 一开始是否给cookie
                    store: MongoStore.create({
                        mongoUrl: 'mongodb://127.0.0.1:27017/kerwin_session', // 新创建一个数据库
                        ttl: 1000 * 60 * 60 // 过期时间
                    }),
                })
            );
            ```
    5. 运行结果
        - 页面cookie

            ![](/backend/node/base/039.png)
        - 数据库session

            ![](/backend/node/base/038.png)

### 6.4.2 JWT

1. jwt与session对比

    - 多后台session

        ![](/backend/node/base/040.png)
    - 多后台jwt

        ![](/backend/node/base/041.png)
    - 缺点

        1. 占带宽，正常情况下要比 session_id 更大，需要消耗更多流量，挤占更多带宽，假如你的网站每月有 10 万次的浏览器，就意味着要多开销几十兆的流量。听起来并不多，但日积月累也是不小一笔开销。实际上，许多人会在 JWT 中存储的信息会更多；
        2. 无法在服务端注销，那么久很难解决劫持问题；
        3. 性能问题，JWT 的卖点之一就是加密签名，由于这个特性，接收方得以验证 JWT 是否有效且被信任。对于有着严格性能要求的 Web 应用，这并不理想，尤其对于单线程环境。

    - 注意
        - CSRF攻击的原因是浏览器会自动带上cookie，而不会带上token；
        - 以CSRF攻击为例：
            - cookie：用户点击了链接，cookie未失效，导致发起请求后后端以为是用户正常操作，于是进行扣款操作； 
            - token：用户点击链接，由于浏览器不会自动带上token，所以即使发了请求，后端的token验证不会通过，所以不会进行扣款操作；

2. 小案例
    - 安装jwt

        ```sh
        npm install jsonwebtoken
        ```
    - 代码
        ```js
        // 测试 token 的加密与验证的过程

        var jwt = require("jsonwebtoken")
        var token =  jwt.sign({
            data:"kerwin"
            },"anydata",{expiresIn:"10s"}
        );
        console.log(token);

        var decoded  = jwt.verify(token,"anydata")
        console.log(decoded);

        setTimeout(()=>{
            var decoded  = jwt.verify(token,"anydata")
            console.log(decoded);
        },11000)
        ```
3. 封装jwt

    - 封装工具 util/JWT.js

        ```js
        const jwt = require("jsonwebtoken")
        const secret = "kerwin-anydata"

        const JWT = {
            // 加密数据 过期时间
            generate(value,expires){
                return jwt.sign(value,secret,{expiresIn:expires})
            },

            verify(token){
                try {
                    return jwt.verify(token,secret)
                } catch (error) {
                    return false
                }
            }
        }

        module.exports = JWT
        ```
    - 登录后调用工具 UserController.js

        ```js{9-15}
        login:async(req,res)=>{
            const {username,password} = req.body
            const data =  await UserService.login(username,password)
            if(data.length === 0){
                res.send({
                    ok:0,
                })
            }else{
                // 设置token
                const token = JWT.generate({
                    _id:data[0]._id,
                    username:data[0].username
                },"20s")
                // token返回在header中
                res.header("Authorization",token) 

                res.send({
                    ok:1,
                })
            }
        },
        ```
4. 使用axios拦截token并存储到本地

    - 安装
        
        ```sh
        npm install axios
        ```
    - 登录使用 login.ejs

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8" />
            <title>Document</title>
            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
            <script>
                // 拦截器配置

                // request 拦截
                axios.interceptors.request.use(
                    function (config) {
                        console.log("请求发出前，执行的方法");
                        return config;
                    },
                    function (error) {
                        return Promise.reject(error);
                    }
                );

                // response 拦截
                axios.interceptors.response.use(
                    function (response) {
                        console.log("请求成功后，第一个调用的方法");
                        
                        // 获取token，后端返给前端在headers中的，都转为小写
                        const {authorization} = response.headers
                        // 保存到本地
                        authorization && localStorage.setItem("token",authorization)
                        
                        return response;
                    },
                    function (error) {
                        return Promise.reject(error);
                    }
                );
            </script>
        </head>
        <body>
            <h1>登录页面</h1>

            <div>
                <div>用户名：<input id="username" /></div>
                <div>密码：<input type="password" id="password" /></div>
                <div><button id="login">登录</button></div>
            </div>

            <script>
                var username = document.querySelector("#username");
                var password = document.querySelector("#password");
                var login = document.querySelector("#login");

                login.onclick = () => {
                    console.log(username.value, password.value);

                    axios.post("/api/login", {
                            username: username.value,
                            password: password.value,
                    }).then(res => {
                        console.log(res.data);
                        if (res.data.ok === 1) {
                            location.href = "/";
                        } else {
                            console.log("用户名密码不匹配");
                        }
                    });
                };
            </script>
        </body>
        </html>
        ```
    - 其他页面使用 index.ejs

        ```html
        <!DOCTYPE html>
        <html>
        <head>
            <title><%= title %></title>
            <link rel="stylesheet" href="/stylesheets/style.css" />
            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
            <script>
                // 拦截器配置

                // request 拦截
                axios.interceptors.request.use(
                    function (config) {
                        // 本地token传给后端，用于验证用户
                        const token = localStorage.getItem("token")
                        config.headers.Authorization = `Bearer ${token}`

                        return config;
                    },
                    function (error) {
                        return Promise.reject(error);
                    }
                );

                // response 拦截
                axios.interceptors.response.use(
                    function (response) {
                        // 同样放到token中
                        const {authorization} = response.headers
                        authorization && localStorage.setItem("token",authorization)
                        
                        return response;
                    },
                    function (error) {
                        if(error.response.status == 401){
                            localStorage.removeItem("token")
                            location.href = "/login"
                        }
                        return Promise.reject(error);
                    }
                );
            </script>
        </head>
        <body>
            <h1>mongodb的增删改查的演示</h1>
            <button id="exit">退出登录</button>
            <div>
                <div>用户名：<input id="username" /></div>
                <div>密码：<input type="password" id="password" /></div>
                <div>年龄：<input type="number" id="age" /></div>
                <div><button id="register">注册</button></div>
            </div>
            <hr>
            <div>
                <button id="update">更新</button>
                <button id="delete">删除</button>
            </div>

            <table border="1">
                <thead>
                    <tr>
                        <td>id</td>
                        <td>用户名</td>
                        <td>年龄</td>
                    </tr>
                </thead>
                <!-- 往这里插入数据 -->
                <tbody>

                </tbody>
            </table>

            <script>
                var registerbtn = document.querySelector("#register");
                var updatebtn = document.querySelector("#update");
                var deletebtn = document.querySelector("#delete");
                var username = document.querySelector("#username");
                var password = document.querySelector("#password");
                var age = document.querySelector("#age");
                var exit = document.querySelector("#exit");

                registerbtn.onclick = () => {
                    axios.post("/api/user",{
                        username:username.value,
                        password:password.value,
                        age:age.value
                    }).then(res=>{
                        console.log(res.data);
                    })
                
                };

                updatebtn.onclick = ()=>{
                    axios.post("/api/user/68872d74e0d6408361cb0e5e",{
                        username:"修改的名字",
                        password:"修改的密码",
                        age:1
                    }).then(res=>{
                        console.log(res.data);
                    })
                }
                deletebtn.onclick = ()=>{
                    axios.delete("/api/user/68872d74e0d6408361cb0e5e").then(res=>{
                        console.log(res.data);
                    })
                }

                axios.get("/api/user?page=1&limit=10").then(res=>{
                    res = res.data
                    var tbody = document.querySelector("tbody")
                    tbody.innerHTML = res.map(item=>`
                        <tr>
                            <td>${item._id}</td>    
                            <td>${item.username}</td>    
                            <td>${item.age}</td>    
                        </tr>
                    `).join("")
                })

                exit.onclick=()=>{
                    localStorage.removeItem("token") 
                    location.href = "/login"
                }

            </script>
        </body>
        </html>
        ```

5. 在后端中验证token

    - app.js

        ```js
        var JWT = require('./util/JWT');

        // 设置中间件，验证token
        app.use((req, res, next) => {
            // 排除login相关的路由和接口
            if (req.url.includes("login")) {
                next();
                return;
            }

        const token = req.headers["authorization"]?.split(" ")[1]
        if(token){
            console.log(token);
            const payload = JWT.verify(token)
            if(payload){
                // 重新计算token过期时间
                console.log("token重新设置");
                
                const newToken = JWT.generate({
                _id:payload._id,
                username:payload.username
                },"20s")
                res.header("Authorization",newToken) 
                next()
            }else{
                res.status(401).send({errCode:-1,errInfo:"token过期"})
            }
        }else{
            next()
        }

        });
        ```

## 6.5 登录文件管理

1. 接收 `multipart/form-data` 格式文件
    
    - 安装工具

        ```sh
        npm install --save multer
        ```

        Multer 是一个 node.js 中间件，用于处理 multipart/form-data 类型的表单数据，它主要用于上传文件。

        注意: Multer 不会处理任何非 multipart/form-data 类型的表单数据。

    - 路由中使用 users.js

        ```js
        // 引入multer
        const multer = require("multer")
        // 存放到固定文件夹
        const upload = multer({dest:"public/uploads/"})

        // 多执行函数
        router.post("/user", upload.single("avatar"),UserController.addUser);
        ```
    - 后台控制器接收 UserController.js

        ```js
        addUser: async (req, res) => {

            console.log(req.body,req.file);
            // 获取文件路径
            const avatar = req.file?`/uploads/${req.file.filename}`:`/images/default.png`
            // 获取参数
            const { username, password, age } = req.body;
            // 调用service
            await UserService.addUser(username, password, age ,avatar);
            // 返回信息
            res.send({
                ok: 1,
            });
        },
        ```

2. 表单方式上传

    - 新建路由文件 router/upload.js

        ```js
        var express = require('express');
        var router = express.Router();

        /* GET home page. */
        router.get('/', function(req, res, next) {
        res.render('upload', { title: 'Express' });
        });

        module.exports = router;
        ```

    - 加载路由 app.js

        ```js
        var uploadRouter = require("./routes/upload");

        app.use("/upload", uploadRouter);
        ```
    - 前端页面 view/upload.ejs

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
        </head>
        <body>
            <!-- 上传文件 使用 enctype="multipart/form-data" -->
            <form action="/api/user" method="POST" enctype="multipart/form-data">
                <div>
                    用户名：<input type="text" name="username">
                </div>
                <div>
                    密码：<input type="password" name="password">
                </div>
                <div>
                    年龄：<input type="number" name="age">
                </div>
                <div>
                    头像：<input type="file" name="avatar">
                </div>
                <div>
                    <input type="submit" value="添加用户">
                </div>
            </form>
        </body>
        </html>
        ```
3. 前后分离模式

    - 修改管理页面 index.ejs

        ```html
        <div>
            <div>用户名：<input id="username" /></div>
            <div>密码：<input type="password" id="password" /></div>
            <div>年龄：<input type="number" id="age" /></div>
            <div>头像：<input type="file" id="avatar"></div>
            <div><button id="register">添加用户</button></div>
        </div>
        <script>
            var username = document.querySelector("#username");
            var password = document.querySelector("#password");
            var age = document.querySelector("#age");
            var registerbtn = document.querySelector("#register");
            var avatar = document.querySelector("#avatar");

            registerbtn.onclick = () => {
          
                // formdata对象
                const formdata = new FormData()
                formdata.append("username",username.value);
                formdata.append("password",password.value)
                formdata.append("age",age.value)
                formdata.append("avatar",avatar.files[0])

                axios.post("/api/user",formdata,{
                    headers:{
                    "Content-Type":"multipart/form-data"
                    }
                }).then(res=>{
                    console.log(res.data);
                })
            };
        </script>
        ```

## 6.6 文档生成工具

[APIDOC - API 文档生成工具](https://github.com/apidoc/apidoc)

已经好长时间不更新了，新版本express 并不匹配