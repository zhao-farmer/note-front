# 七、koa2

## 7.1 介绍与安装

1. 简介

koa 是由 Express 原班人马打造的，致力于成为一个更小、更富有表现力、更健壮的 Web 框架。使用 koa 编写 web 应用，通过组合不同的 generator，可以免除重复繁琐的回调函数嵌套，并极大地提升错误处理的效率。koa 不在内核方法中绑定任何中间件，它仅仅提供了一个轻量优雅的函数库，使得编写 Web 应用变得得心应手。

2. 快速开始

    - 初始化项目
        
        ```sh
        # 初始化package.json
        npm init

        # 安装koa2 
        npm install koa
        ```
    - 启动类 index.js

        ```js
        const koa = require("koa")

        const app = new koa()
        // ctx === context 上下文
        app.use((ctx,next)=>{
            // ctx.response
            console.log(ctx.request.path);
            
            // ctx.response.body="<b>hello world</b>"

            // 可省略response
            ctx.body = "hello world"
        })

        app.listen(3000)
        ```
3. koa的ctx

    ![](/backend/node/base/042.png)


## 7.2 koa对比express

通常都会说 Koa 是洋葱模型，这重点在于中间件的设计。但是按照上面的分析，会发现 Express 也是类似的，不同的是Express 中间件机制使用了 Callback 实现，这样如果出现异步则可能会使你在执行顺序上感到困惑，因此如果我们想做接口耗时统计、错误处理 Koa 的这种中间件模式处理起来更方便些。最后一点响应机制也很重要，Koa 不是立即响应，是整个中间件处理完成在最外层进行了响应，而 Express 则是立即响应。

1. 更轻量
    - koa 不提供内置的中间件；
    - koa 不提供路由，而是把路由这个库分离出来了（koa/router）
2. Context对象

    koa增加了一个Context的对象，作为这次请求的上下文对象（在koa2中作为中间件的第一个参数传入）。同时Context上也挂载了Request和Response两个对象。和Express类似，这两个对象都提供了大量的便捷方法辅助开发, 这样的话对于在保存一些公有的参数的话变得更加合情合理

3. 异步流程控制
    
    - express采用callback来处理异步， koa v1采用generator，koa v2 采用async/await。
    - generator和async/await使用同步的写法来处理异步，明显好于callback和promise，

4. 中间件模型
    - express基于connect中间件，线性模型；
    - koa中间件采用洋葱模型（对于每个中间件，在完成了一些事情后，可以非常优雅的将控制权传递给下一个中间件，并能够等待它完成，当后续的中间件完成处理后，控制权又回到了自己）

5. 代码验证中间件模型

    ![](/backend/node/base/043.png)

    - express 同步

        ```js
        //同步
        var express = require("express")
        var app = express()

        app.use((req,res,next)=>{
            console.log(1)
            next()
            console.log(4)
            res.send("hello")
        })
        app.use(()=>{
            console.log(3)
        })
        ```
    - express 异步
        
        ```js
        //异步
        var express = require("express")
        var app = express()

        app.use(async (req,res,next)=>{
            console.log(1)
            await next()
            console.log(4)
            res.send("hello")
        })
        app.use(async ()=>{
            console.log(2)
            await delay(1)
            console.log(3)
        })

        function delay(time){
        return new Promise((resolve,reject)=>{
            setTimeout(resolve,1000)
        })
        }
        ```
    - koa 同步
        
        ```js
        //同步
        var koa = require("koa")
        var app = new koa()

        app.use((ctx,next)=>{
            console.log(1)
            next()
            console.log(4)
            ctx.body="hello"
        })
        app.use(()=>{
            console.log(3)
        })

        app.listen(3000)
        ```
    - koa 异步
        
        ```js
        //异步
        var koa = require("koa")
        var app = new koa()

        app.use(async (ctx,next)=>{
            console.log(1)
            await next()
            console.log(4)
            ctx.body="hello"
        }) 
        app.use(async ()=>{
            console.log(2)
            await delay(1)
            console.log(3)
        })

        function delay(time){
        return new Promise((resolve,reject)=>{
            setTimeout(resolve,1000)
        })
        }

        app.listen(3000)
        ```
## 7.3 路由

### 7.3.1 认识与使用路由

1. 安装插件

    ```sh
    npm i koa-router
    ```

2. 基本使用

    ```js
    const koa = require("koa")
    const Router = require("koa-router")
    const app = new koa()
    const router = new Router()


    // 路由可以链式使用
    router.post("/list",(ctx,next)=>{
        ctx.body={
            ok:1,
            info:"add list success"
        }
    })
    .get("/list",(ctx,next)=>{
        ctx.body=["1111","2222","33333"]
    })
    .put("/list/:id",(ctx,next)=>{
        ctx.body={
            ok:1,
            info:"put list success"
        }
    })
    .del("/list/:id",(ctx,next)=>{
        ctx.body={
            ok:1,
            info:"delete list success"
        }
    })

    router.post("/list2",(ctx,next)=>{
        ctx.body=["1111","2222","33333"]
    })

    // 挂载所有路由
    // router.allowedMethods() 错误类型调用会返回405 如: list2按照get调用
    app.use(router.routes()).use(router.allowedMethods())

    app.listen(3000)
    ```

3. router.allowedMethods作用

    ![](/backend/node/base/044.png)


### 7.3.2 路由模块化

1. 路由拆分

    - routes/list.js

        ```js
        const Router = require("koa-router")
        const router = new Router()
        // 路由可以链式使用
        router.post("/",(ctx,next)=>{
            ctx.body={
                ok:1,
                info:"add list success"
            }
        })
        .get("/",(ctx,next)=>{
            ctx.body=["1111","2222","33333"]
        })
        .put("/:id",(ctx,next)=>{
            ctx.body={
                ok:1,
                info:"put list success"
            }
        })
        .del("/:id",(ctx,next)=>{
            ctx.body={
                ok:1,
                info:"delete list success"
            }
        })

        module.exports = router
        ```
    - routes/user.js

        ```js
        const Router = require("koa-router")
        const router = new Router()
        // 路由可以链式使用
        router.post("/",(ctx,next)=>{
            ctx.body={
                ok:1,
                info:"add user success"
            }
        })
        .get("/",(ctx,next)=>{
            ctx.body=["1111","2222","33333"]
        })
        .put("/:id",(ctx,next)=>{
            ctx.body={
                ok:1,
                info:"put user success"
            }
        })
        .del("/:id",(ctx,next)=>{
            ctx.body={
                ok:1,
                info:"delete user success"
            }
        })

        module.exports = router
        ```
    - index.js

        ```js
        const koa = require("koa")
        const Router = require("koa-router")
        const userRouter = require("./routes/user.js")
        const listRouter = require("./routes/list.js")

        const app = new koa()
        const router = new Router()
        // ctx === context 上下文


        // 先注册路由级 组件
        // 第一个参数是一级路由 下面是二级路由
        router.use("/user",userRouter.routes(),userRouter.allowedMethods())
        router.use("/list",listRouter.routes(),listRouter.allowedMethods())

        // 应用级
        app.use(router.routes()).use(router.allowedMethods())

        app.listen(3000)
        ```

2. 路由使用抽成模块

    - routes/index.js

        ```js
        const Router = require("koa-router")
        const userRouter = require("./user.js")
        const listRouter = require("./list.js")
        const router = new Router()

        // 统一加前缀
        router.prefix("/api")

        // 先注册路由级 组件
        // 第一个参数是一级路由 下面是二级路由
        router.use("/user",userRouter.routes(),userRouter.allowedMethods())
        router.use("/list",listRouter.routes(),listRouter.allowedMethods())

        module.exports = router
        ```
    - index.js

        ```js
        const koa = require("koa")
        const app = new koa()

        const router = require("./routes")
        // ctx === context 上下文

        // 应用级
        app.use(router.routes()).use(router.allowedMethods())

        app.listen(3000)
        ```

3. 路由重定向

    - routes/home.js

        ```js
        const Router = require("koa-router")
        const router = new Router()

        router.get("/",(ctx,next)=>{
            ctx.body=`
            <html>
                <h1>home页面</h1>
            </html>
            `
        })

        module.exports = router
        ```
    - index.js(增量)

        ```js
        const homeRouter = require("./home.js")
        router.use("/home",homeRouter.routes(),homeRouter.allowedMethods())

        //写法1 
        router.redirect('/', '/home');
        //写法2
        router.get("/",(ctx)=>{
            ctx.redirect("/home")
        })

        module.exports = router
        ```

## 7.4 静态资源

1. 安装插件

    ```sh
    npm i koa-static
    ```

2. 使用插件 app.js(增量)

    ```js
    const static = require("koa-static")
    const path = require("path")

    // 设置静态资源目录
    app.use(static(path.join(__dirname,"public")))
    ```

3. 创建静态资源

    - public/css/center.css

        ```css
        div{
            background-color: brown;
        }
        ```

    - public/center.html

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
            <link rel="stylesheet" href="/css/center.css">
        </head>
        <body>
            <div>center</div>
        </body>
        </html>
        ```

4. 运行结果

    ![](/backend/node/base/045.png)

## 7.5 获取请求参数

1. get参数

    在koa中，获取GET请求数据源头是koa中request对象中的query方法或querystring方法，query返回是格式化好的参数对象，querystring返回的是请求字符串，由于ctx对request的API有直接引用的方式，所以获取GET请求数据有两个途径。

    - 是从上下文中直接获取 请求对象ctx.query，返回如 { a:1, b:2 } 请求字符串 ctx.querystring，返回如 a=1&b=2
    - 是从上下文的request对象中获取 请求对象ctx.request.query，返回如 { a:1, b:2 } 请求字符串 ctx.request.querystring，返回如 a=1&b=2

2. post参数
    
    对于POST请求的处理，koa-body中间件可以把koa2上下文的formData数据解析到ctx.request.body中

    ```sh
    npm install koa-body
    ```

3. 代码设置

    - index.js(增量)

        ```js
        const { koaBody } = require('koa-body');

        // 用于获取post参数
        app.use(koaBody())
        ```
    - 路由打印 routes/user.js

        ```js
        router.post("/",(ctx,next)=>{
            // post请求参数
            console.log(ctx.request.body);
            
            ctx.body={
                ok:1,
                info:"add user success"
            }
        })
        .get("/",(ctx,next)=>{
            // get请求参数
            console.log(ctx.query,ctx.querystring);
            
            ctx.body=["1111","2222","33333"]
        })
        ```
    - 前端调用

        ```js
        getlogin.onclick = () => {
            let pathUrl = `/user?username=${username.value}&password=${password.value}`;
            //get请求
            fetch(pathUrl).then(res => res.json()).then(res => {
                console.log(res);
            })

        }
        postlogin.onclick = () => {
            let options = {
                method: "POST",
                body: JSON.stringify({
                    username: username.value,
                    password: password.value
                }),
                Headers: {
                    "Content-Type": "application/json"
                }
            }
            let optionsForm = {
                method: "POST",
                body: `username=${username.value}&password=${password.value}`,
                Headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                }
            }
            //post请求
            fetch("/user", options).then(res => res.text()).then(res => {
                console.log(res);
            })
            // form表单请求
            fetch("/user", optionsForm).then(res => res.text()).then(res => {
                console.log(res);
            })
        }
        ```

## 7.6 使用渲染模板


1. 安装模块

    ```sh
    # 安装koa模板使用中间件
    npm install --save koa-views

    # 安装ejs模板引擎
    npm install --save ejs
    ```

2. 用模板引擎

    - index.js

        ```js
        const views = require('koa-views')
        // 加载模板引擎
        app.use(views(path.join(__dirname, './view'), {
            extension: 'ejs'
        }))
        ```
    
    - view/home.ejs

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
        </head>
        <body>
            <h1>home模板页面</h1>
            <div>欢迎<%= username %>回来</div>
        </body>
        </html>
        ```

    - routes/home.js

        ```js
        const Router = require("koa-router")
        const router = new Router()

        // 路由可以链式使用
        router.get("/",async (ctx,next)=>{
        await ctx.render("home",{username:"kerwin"}) // 自动找views/home.ejs
        })
        module.exports = router
        ```