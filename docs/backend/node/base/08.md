# 八、koa项目配置

## 8.1 koa 登录鉴权

### 8.1.1 cookie与session

1. 直接使用cookie

    koa提供了从上下文直接读取、写入cookie的方法

    - `ctx.cookies.get(name, [options])` 读取上下文请求中的cookie
    - `ctx.cookies.set(name, value, [options])` 在上下文中写入cookie

    ```js
    // 获取cookie
    console.log(ctx.cookies.get("age"));
    
    // 设置cookie
    ctx.cookies.set("location","dalian")
    ```

2. session 使用

    1. 使用 koa-session 插件

        - 安装

            ```sh
            npm install koa-session
            ```
        - 初始化 session 设置 index.js(增量)

            ```js
            const session = require('koa-session');
            
            app.keys = ['kerwin'];
            const CONFIG = {
                key: 'koa.sess', // cookie 键名
                maxAge: 86400000, // 有效期 (24小时)
                autoCommit: true, // 自动提交 headers
                overwrite: true, // 允许覆盖
                httpOnly: true, // 仅服务器可访问
                signed: true, // 签名(需要设置keys,且cookie会多存一份 koa.sess.sig)
                rolling: false, // 不强制每次响应设置 cookie
                renew: false, // 不自动续期
                secure: false, // 非 HTTPS 环境下设为 false
                // sameSite: null, // 不限制 sameSite
            };

            // 配置session
            app.use(session.createSession(CONFIG,app));
            ```
    2. 登录后session

        ```js
        ctx.session.user = {
            username : "kerwin"
        }
        ```

    3. 路由拦截 index.js(增量)

        ```js
        // session 拦截
        app.use(async (ctx, next) => {
            //排除login相关的路由和接口
            if (ctx.url.includes("login")) {
                await next()
                return
            }
            if (ctx.session.user) {
                // console.log(ctx.session);
                //重新设置以下sesssion
                ctx.session.mydate = Date.now()
                await next()
            } else {
                // 重定向
                ctx.redirect("/login")
            }
        })
        ```


### 8.1.2 jwt

1. 安装并封装

    - 安装

        ```sh
        npm install jsonwebtoken
        ```
    - 封装 util/JWT.js

        ```js
        const jwt = require("jsonwebtoken")
        const secret = "kerwin-anydata"

        const JWT = {
            // 加密数据 过期时间
            generate(value,expires){
                return jwt.sign(value,secret,{expiresIn:expires})
            },

            verify(token){
                try {
                    return jwt.verify(token,secret)
                } catch (error) {
                    return false
                }
            }
        }

        module.exports = JWT
        ```

2. 页面应用

    - 登录页面 view/login.ejs

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8" />
            <title>Document</title>
            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
            <script>
                // 拦截器配置

                // request 拦截
                axios.interceptors.request.use(
                    function (config) {
                        console.log("请求发出前，执行的方法");
                        return config;
                    },
                    function (error) {
                        return Promise.reject(error);
                    }
                );

                // response 拦截
                axios.interceptors.response.use(
                    function (response) {
                        console.log("请求成功后，第一个调用的方法");
                        
                        // 获取token，后端返给前端在headers中的，都转为小写
                        const {authorization} = response.headers
                        // 保存到本地
                        authorization && localStorage.setItem("token",authorization)
                        
                        return response;
                    },
                    function (error) {
                        return Promise.reject(error);
                    }
                );
            </script>
        </head>
        <body>
            <h1>登录页面</h1>

            <div>
                <div>用户名：<input id="username" /></div>
                <div>密码：<input type="password" id="password" /></div>
                <div><button id="login">登录</button></div>
            </div>

            <script>
                var username = document.querySelector("#username");
                var password = document.querySelector("#password");
                var login = document.querySelector("#login");

                login.onclick = () => {
                    console.log(username.value, password.value);

                    axios.post("/login/verify", {
                            username: username.value,
                            password: password.value,
                    }).then(res => {
                        console.log(res.data);
                        if (res.data.ok === 1) {
                            location.href = "/";
                        } else {
                            console.log("用户名密码不匹配");
                        }
                    });
                };
            </script>
        </body>
        </html>
        ```

    - 登录路由 routes/login.js

        ```js
        const Router = require("koa-router")
        const router = new Router()
        const JWT = require("../util/JWT")

        // 刷新薄板文件
        router.get("/",async (ctx,next)=>{
        await ctx.render("login") // 自动找views/home.ejs
        })

        // 验证用户名密码
        router.post("/verify",(ctx,next)=>{
            console.log(ctx.request.body);

            const {username,password} = ctx.request.body
            if(username === "admin" && password === "123"){

                // 设置header
                const token = JWT.generate({
                    _id:1111,
                    username:"kerwin"
                },"10s")
                // token返回在header中
                ctx.set("Authorization",token)
        
                ctx.body = {
                    ok:1
                }
            }else{
                ctx.body = {
                    ok:0
                }
            }
        
        })


        module.exports = router
        ```

3. token拦截器

    - 其他页面 view/home.ejs

        ```html
        <!DOCTYPE html>
        <html>
        <head>
            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
            <script>
                // 拦截器配置

                // request 拦截
                axios.interceptors.request.use(
                    function (config) {
                        // 本地token传给后端，用于验证用户
                        const token = localStorage.getItem("token")
                        config.headers.Authorization = `Bearer ${token}`

                        return config;
                    },
                    function (error) {
                        return Promise.reject(error);
                    }
                );

                // response 拦截
                axios.interceptors.response.use(
                    function (response) {
                        // 同样放到token中
                        const {authorization} = response.headers
                        authorization && localStorage.setItem("token",authorization)
                        
                        return response;
                    },
                    function (error) {
                        if(error.response.status == 401){
                            localStorage.removeItem("token")
                            location.href = "/login"
                        }
                        return Promise.reject(error);
                    }
                );
            </script>
        </head>
        <body>
            <h1>
                用户管理
                <button id="exit">退出登录</button>
            </h1>

            <hr>
            <table border="1">
                <thead>
                    <tr>
                        <td>id</td>
                        <td>用户名</td>
                        <td>年龄</td>
                    </tr>
                </thead>
                <!-- 往这里插入数据 -->
                <tbody>

                </tbody>
            </table>

            <script>
        
                var exit = document.querySelector("#exit");

                axios.get("/home/list?page=1&limit=10").then(res=>{
                    res = res.data
                    var tbody = document.querySelector("tbody")
                    tbody.innerHTML = res.map(item=>`
                        <tr>
                            <td>${item._id}</td>    
                            <td>${item.username}</td>    
                            <td>${item.age}</td>    
                        </tr>
                    `).join("")
                })

                exit.onclick=()=>{
                    localStorage.removeItem("token") 
                    location.href = "/login"
                }

            </script>
        </body>
        </html>
        ```

    - 添加拦截 index.js(增量)

        ```js
        const JWT = require("./util/JWT")

        // token判断拦截
        app.use(async (ctx,next)=>{
            if(ctx.url.includes("login")){
                await next()
                return
            }

            const token = ctx.headers["authorization"]?.split(" ")[1]

            if(token){
                const payload = JWT.verify(token)
                if(payload){
                    // 重新经计算过期时间
                    const newToken = JWT.generate({
                        _id:payload._id,
                        username:payload.username
                    },"10s")

                    ctx.set("Authorization",newToken)

                    // 验证通过放行
                    await next()
                }else{
                    // 返回401
                    ctx.status = 401
                    ctx.body = {errCode:-1,errInfo:"token过期"}
                }
            }else{
                // 用于页面路由
                await next()
            }
        })
        ```

## 8.2 文件上传

1. 安装插件

    ```sh
    npm install --save @koa/multer multer
    ```
2. 使用multer

    - 提交页面 upload.ejs

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
        </head>
        <body>
            <!-- 上传文件 使用 enctype="multipart/form-data" -->
            <form action="/upload/user" method="POST" enctype="multipart/form-data">
                <div>
                    用户名：<input type="text" name="username">
                </div>
                <div>
                    密码：<input type="password" name="password">
                </div>
                <div>
                    年龄：<input type="number" name="age">
                </div>
                <div>
                    头像：<input type="file" name="avatar">
                </div>
                <div>
                    <input type="submit" value="添加用户">
                </div>
            </form>
        </body>
        </html>
        ```
    - 提交路由 upload.js

        ```js
        const Router = require("koa-router")
        const router = new Router()
        const JWT = require("../util/JWT")

        const multer = require("@koa/multer")
        // 图片存放的目录
        const upload = multer({dest:"public/upload"})

        // 刷新模板文件
        router.get("/",async (ctx,next)=>{
            await ctx.render("upload") // 自动找views/home.ejs
        })

        // 上传接口 
        // 中间upload.single("avatar") 是调用
        router.post("/user",upload.single("avatar"),(ctx)=>{
            // 打印出上传文件地址 ctx.file
            console.log(ctx.request.body,ctx.file);

            ctx.body = {
                ok:1
            }
        })

        module.exports = router
        ```

## 8.3 操作mongodb

1. 安装插件

    ```sh
    npm install mongoose
    ```
2. 配置数据库连接

    - 配置类 config/db.config.js

        ```js
        // 链接数据库
        const mongoose = require("mongoose")

        // 开始连接 
        mongoose.connect("mongodb://127.0.0.1:27017/kerwin_koa")
        // 插入集合和数据，数据库kerwin_koa会自动创建
        ```
    - 开启连接 index.js(增量)

        ```js
        // 数据库的连接
        require("./config/db.config")
        ```

3. 插入使用

    - 实体模型 model/UserModel.js

        ```js
        const mongoose = require("mongoose")

        // 轮廓 用于限制类型
        const Schema = mongoose.Schema

        //限制模型
        const UserType = {
            username:String,
            password:String,
            age:Number,
            avatar:String
        }


        const UserModel = mongoose.model("user",new Schema(UserType))

        // 模式user 将会对应users集合
        module.exports = UserModel
        ```

    - 脚本中调用 routes/upload.js(增量)

        ```js
        router.post("/user",upload.single("avatar"),async (ctx)=>{
            console.log(ctx.request.body,ctx.file);

            const {username,password,age} = ctx.request.body
            const avatar = ctx.file?`/upload/${ctx.file.filename}`:``
            
            // 利用User模型进程存储操作 UserModel.create
            await UserModel.create({
                username,
                age,
                password,
                avatar
            })

            ctx.body = {
                ok:1
            }
        })
        ```