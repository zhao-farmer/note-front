# 九、网络连接

## 9.1 websocket介绍

1. http与websocket区别

    ![](/backend/node/base/046.png)

2. 应用场景：

    - 弹幕
    - 媒体聊天
    - 协同编辑
    - 基于位置的应用
    - 体育实况更新
    - 股票基金报价实时更新


3. websocket 协议

    WebSocket并不是全新的协议，而是利用了HTTP协议来建立连接。我们来看看WebSocket连接是如何创建的。

    1. 首先，WebSocket连接必须由浏览器发起，因为请求协议是一个标准的HTTP请求，格式如下：

        ```
        GET ws://localhost:3000/ws/chat HTTP/1.1
        Host: localhost
        Upgrade: websocket
        Connection: Upgrade
        Origin: http://localhost:3000
        Sec-WebSocket-Key: client-random-string
        Sec-WebSocket-Version: 13
        ```
        
        该请求和普通的HTTP请求有几点不同：

        - GET请求的地址不是类似/path/，而是以ws://开头的地址；
        - 请求头Upgrade: websocket和Connection: Upgrade表示这个连接将要被转换为WebSocket连接；
        - Sec-WebSocket-Key是用于标识这个连接，并非用于加密数据；
        - Sec-WebSocket-Version指定了WebSocket的协议版本。
    2. 随后，服务器如果接受该请求，就会返回如下响应：

        ```
        HTTP/1.1 101 Switching Protocols
        Upgrade: websocket
        Connection: Upgrade
        Sec-WebSocket-Accept: server-random-string
        ```

        该响应代码101表示本次连接的HTTP协议即将被更改，更改后的协议就是Upgrade: websocket指定的WebSocket协议。

        版本号和子协议规定了双方能理解的数据格式，以及是否支持压缩等等。如果仅使用WebSocket的API，就不需要关心这些。

        现在，一个WebSocket连接就建立成功，浏览器和服务器就可以随时主动发送消息给对方。消息有两种，一种是文本，一种是二进制数据。通常，我们可以发送JSON格式的文本，这样，在浏览器处理起来就十分容易。
    3. 全双工

        为什么WebSocket连接可以实现全双工通信而HTTP连接不行呢？实际上HTTP协议是建立在TCP协议之上的，TCP协议本身就实现了全双工通信，但是HTTP协议的请求－应答机制限制了全双工通信。WebSocket连接建立以后，其实只是简单规定了一下：接下来，咱们通信就不使用HTTP协议了，直接互相发数据吧。

        安全的WebSocket连接机制和HTTPS类似。首先，浏览器用wss://xxx创建WebSocket连接时，会先通过HTTPS创建安全的连接，然后，该HTTPS连接升级为WebSocket连接，底层通信走的仍然是安全的SSL/TLS协议。

4. 浏览器支持

    很显然，要支持WebSocket通信，浏览器得支持这个协议，这样才能发出ws://xxx的请求。目前，支持WebSocket的主流浏览器如下：

    - Chrome
    - Firefox
    - IE >= 10
    - Sarafi >= 6
    - Android >= 4.4
    - iOS >= 8

5. 服务器支持

    由于WebSocket是一个协议，服务器具体怎么实现，取决于所用编程语言和框架本身。Node.js本身支持的协议包括TCP协议和HTTP协议，要支持WebSocket协议，需要对Node.js提供的HTTPServer做额外的开发。已经有若干基于Node.js的稳定可靠的WebSocket实现，我们直接用npm安装使用即可。

## 9.1 ws模块

### 9.1.1 简单使用

1. 安装插件

    ```sh
    npm install express
    npm install ws
    ```
2. 初始化应用 index.js

    ```js
    const express = require("express");
    const app = express();

    // 设置静态文件夹
    app.use(express.static("./public"));

    // http响应
    app.get("/", (req, res) => {
        res.send({ ok: 1 });
    });

    // websocket响应

    // 启动服务
    const WebSocket = require("ws");
    const WebSocketServer = WebSocket.WebSocketServer;
    const wss = new WebSocketServer({ port: 8080 });

    wss.on("connection", function connection(ws) {
        ws.on("message", function message(data) {
            console.log("received: %s", data);
            // 转发给其他人
            wss.clients.forEach(function each(client) {
                if (client !== ws && client.readyState === WebSocket.OPEN) {
                    client.send(data, { binary: false });
                }
            });
        });

        ws.send("欢迎来到聊天室");
    });

    app.listen(3000);

    ```
3. 聊天室页面

    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Document</title>
    </head>
    <body>
        <div>聊天室</div>

        <script>
            // H5 创建 websocket
            var ws = new WebSocket("ws://localhost:8080")
            
            ws.onopen = () =>{
                console.log("连接成功");
            }
            ws.onmessage = (msgObj) =>{
                console.log(msgObj.data);
            }
            ws.onerror = () =>{
                console.log("error");
                
            }
        </script>
    </body>
    </html>
    ```
### 9.1.2 授权用户

1. 准备工作

    - 复制express使用jwt的代码

        ![](/backend/node/base/047.png)
    - 安装插件

        ```sh
        npm install ws
        ```

2. 新建websocket服务端

    - 新建websocket启动类 bin/websocketServer.js

        ```js
        // 启动服务
        const WebSocket = require("ws");
        const JWT = require("../util/JWT");
        const WebSocketServer = WebSocket.WebSocketServer;
        const wss = new WebSocketServer({ port: 8080 });

        wss.on("connection", function connection(ws,req) {
            console.log(req.url);
            const myURL = new URL(req.url,"http://127.0.0.1:3000")
            let token = myURL.searchParams.get("token");
            // 校验token
            const payload = JWT.verify(token);
            if(payload){
                ws.send(createMessage(WebSocketType.GroupChat,null,"欢迎来到聊天室"))
            }else{
                ws.send(createMessage(WebSocketType.Error,null,"token过期"))
            }
            
            ws.on("message", function message(data) {
                console.log("received: %s", data);
                // 转发给其他人
                wss.clients.forEach(function each(client) {
                    if (client !== ws && client.readyState === WebSocket.OPEN) {
                        client.send(data, { binary: false });
                    }
                });
            });

        
        });

        const WebSocketType = {
            Error:0, // 错误
            GroupList:1,    // 获取用户列表
            GroupChat:2,    // 群聊
            SingleChat:3    // 单聊
        }

        function createMessage(type,user,data){
            return JSON.stringify({
                type,
                user,
                data
            })
        }
        ```
    - 应用脚本 bin/www (增量)
        
        ```js
        // 引入socket服务器
        require("./websocketServer")
        ```
3. 新建websocket客户端

    - 新建页面 view/chat.ejs

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
        </head>
        <body>
            <h1>聊天室</h1>

            <!-- 建立socket连接 带着token 后端验证 -->
            <script>
                const WebSocketType = {
                    Error:0, // 错误
                    GroupList:1,    // 获取用户列表
                    GroupChat:2,    // 群聊
                    SingleChat:3    // 单聊
                }
                const ws = new WebSocket(`ws://localhost:8080?token=${localStorage.getItem("token")}`)
                ws.open = () =>{
                    console.log("open");
                }
                ws.onmessage = (msgObj) =>{
                    msgObj = JSON.parse(msgObj.data)

                switch(msgObj.type){
                        case WebSocketType.Error:
                            localStorage.removeItem("token")
                            location.href="/login"
                            break;
                        case WebSocketType.GroupChat:
                            console.log(msgObj);
                            
                            break;
                }
                }
            </script>
        </body>
        </html>
        ```
    - 页面路由 routes/chat.js

        ```js
        var express = require('express');
        var router = express.Router();

        router.get('/', function(req, res, next) {
            res.render('chat', { title: 'Express' });
        });

        module.exports = router;

        ```
    - 路由配置 app.js(增量)

        ```js
        var chatRouter = require("./routes/chat");
        app.use("/chat", chatRouter);
        ```

### 9.1.3 私聊群聊广播

1. websocket服务端 bin/websocketServer.js

    ```js
    // websocket响应

    // 启动服务
    const WebSocket = require("ws");
    const JWT = require("../util/JWT");
    const WebSocketServer = WebSocket.WebSocketServer;
    const wss = new WebSocketServer({ port: 8080 });

    wss.on("connection", function connection(ws,req) {

        // 获取token
        const myURL = new URL(req.url,"http://127.0.0.1:3000")
        let token = myURL.searchParams.get("token");
        // 校验token
        const payload = JWT.verify(token);
        if(payload){
        ws.send(createMessage(WebSocketType.GroupChat,null,"欢迎来到聊天室"))

        ws.user = payload;
        }else{
        ws.send(createMessage(WebSocketType.Error,null,"token过期"))
        }
        
        ws.on("message", function message(data) {
            console.log("received: %s", data);
            // 转发给其他人

            const msgObj = JSON.parse(data)

            switch(msgObj.type){
                case WebSocketType.GroupList:        
                    // 用户群发给所有人
                    sendAll()

                    break;
                case WebSocketType.GroupChat:
                    wss.clients.forEach(function each(client) {
                        if (client.readyState === WebSocket.OPEN) {
                            client.send(createMessage(WebSocketType.GroupChat,ws.user,msgObj.data))
                        }
                    });
                    break;
                case WebSocketType.SingleChat:
                    wss.clients.forEach(function each(client) {
                        if (client.user.username === msgObj.to && client.readyState === WebSocket.OPEN) {
                            
                            console.log("发送给："+ client.user.username);
                            
                            client.send(createMessage(WebSocketType.SingleChat,ws.user,msgObj.data))
                        }
                    });
                    break;
            }
        });

        ws.on("close",()=>{
            // 删除用户
            wss.clients.delete(ws.user)
            // 群发给所有人
            sendAll()
        })
    

    
    });

    const WebSocketType = {
        Error:0, // 错误
        GroupList:1,    // 获取用户列表
        GroupChat:2,    // 群聊
        SingleChat:3    // 单聊
    }


    function createMessage(type,user,data){
        return JSON.stringify({
            type,
            user,
            data
        })
    }

    function sendAll(){
        let users = Array.from(wss.clients).map(item=>item.user) 
        wss.clients.forEach(function each(client) {
            if (client.readyState === WebSocket.OPEN) {
            client.send(createMessage(WebSocketType.GroupList,null,JSON.stringify(users)))
            }
        });
    }
    ```
2. 客户端 view/chat.ejs

    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Document</title>
    </head>
    <body>
        <h1>聊天室</h1>
        <input type="text" id="text"> <button id="send">send</button>

        <select id="select"></select>

        <!-- 建立socket连接 带着token 后端验证 -->
        <script>
            var select = document.getElementById("select")
            var text = document.getElementById("text")
            var sendBtn = document.getElementById("send")

            const WebSocketType = {
                Error:0, // 错误
                GroupList:1,    // 获取用户列表
                GroupChat:2,    // 群聊
                SingleChat:3    // 单聊
            }
            const ws = new WebSocket(`ws://localhost:8080?token=${localStorage.getItem("token")}`)
            ws.onopen = () =>{
                console.log("open");
                // 获取用户列表
                ws.send(JSON.stringify({type:1}))
            }
            ws.onmessage = (msgObj) =>{
                msgObj = JSON.parse(msgObj.data)

            switch(msgObj.type){
                    case WebSocketType.Error:
                        localStorage.removeItem("token")
                        location.href="/login"
                        break;
                    case WebSocketType.GroupList:
                        console.log(JSON.parse(msgObj.data));
                        const onlineList = JSON.parse(msgObj.data);
                        select.innerHTML = "";
                        select.innerHTML =  `<option value="all">all</option>` + 
                            onlineList.map(item=>`
                                <option value="${item.username}">${item.username}</option>
                            `).join("")
                        break;
                    case WebSocketType.GroupChat:
                        var title = msgObj.user?msgObj.user.username + "发送：":"广播：";
                        console.log( title + msgObj.data);
                        break;
                    case WebSocketType.SingleChat:
                        var title = msgObj.user.username + "单独发送：";
                        console.log( title + msgObj.data);
                        break;
            }
            }
            
            sendBtn.onclick = () =>{
                if(select.value == "all"){
                    ws.send(createMessage(WebSocketType.GroupChat,text.value,null))
                }else{
                    ws.send(createMessage(WebSocketType.SingleChat,text.value,select.value))
                }
            }


            function createMessage(type,data,to){
                return JSON.stringify({
                    type,
                    data,
                    to
                })
            }
        </script>
    </body>
    </html>
    ```

## 9.2 scoket.io

### 9.2.1 基础连接

1. 安装依赖

    ```sh
    npm install socket.io
    ```
2. 服务端 
    
    - 修改配置类 socketIoServer.js

        ```js
        const JWT = require('../util/JWT');

        function start(server){
        
            const io = require('socket.io')(server);
            io.on('connection', (socket) => {

                const payload = JWT.verify(socket.handshake.query.token)
                if(payload){
                    socket.user = payload
                    // 发送 
                    socket.emit(WebSocketType.GroupChat,createMessage(null,"欢迎来到聊天室"))
                }else{
                    socket.emit(WebSocketType.Error,createMessage( socket.user,"连接错误"))
                }
            });
        }


        const WebSocketType = {
            Error:0, // 错误
            GroupList:1,    // 获取用户列表
            GroupChat:2,    // 群聊
            SingleChat:3    // 单聊
        }


        function createMessage(user,data){
            return {
                user,
                data
            }
        }

        function sendAll(){
        
        }

        module.exports = start
        ```
    - 启动类 bin/www

        ```js
        // 引入socket 启动方法
        var socketServer =  require("./socketIoServer.js")

        // express 
        var http = require('http');
        var server = http.createServer(app);

        // 启动 socket
        socketServer(server)
        ```
3. 客户端

   - 下载客户端引入文件

        [点击进入下载](https://github.com/socketio/socket.io/blob/main/packages/socket.io-client/dist/socket.io.min.js)

        ![](/backend/node/base/048.png)

   - 导入本地文件夹

        ![](/backend/node/base/049.png)

   - 客户端页面 chat.ejs

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
            <script src="/javascripts/socket.io.min.js"></script>
        </head>
        <body>
            <h1>聊天室</h1>
            <h1>
                当前用户:
                <b id="user"></b>
            </h1>
            <input type="text" id="text"> <button id="send">send</button>

            <select id="select"></select>

            <!-- 建立socket连接 带着token 后端验证 -->
            <script>
                var select = document.getElementById("select")
                var text = document.getElementById("text")
                var sendBtn = document.getElementById("send")
                var user= document.querySelector("#user")
                user.innerHTML = localStorage.getItem("user")

                const WebSocketType = {
                    Error:0, // 错误
                    GroupList:1,    // 获取用户列表
                    GroupChat:2,    // 群聊
                    SingleChat:3    // 单聊
                }
                
                // 引入socket.io js端

                // http 连接
                // const socket = io(`http://localhost:3000?token=${localStorage.getItem("token")}`);
                // websocket 连接
                const socket = io(`ws://localhost:3000?token=${localStorage.getItem("token")}`)
                // 不管是那种都使用http调用了5次请求，这里ws并没有意义

                socket.on(WebSocketType.GroupChat,(msg)=>{
                    var title = msg.user?msg.user.username + "发送：":"广播：";
                    console.log( title + msg.data);
                })

                // 失败
                socket.on(WebSocketType.Error,(msg)=>{
                    localStorage.removeItem("token")
                    location.href = "/login"
                })

                sendBtn.onclick = () =>{
                    if(select.value == "all"){
                    
                    }else{
                        
                    }
                }


                function createMessage(type,data,to){
                    return JSON.stringify({
                        type,
                        data,
                        to
                    })
                }
            </script>
        </body>
        </html>
        ```
### 9.2.2 私聊群聊广播

1. 服务端 

    ```js
    const JWT = require('../util/JWT');

    function start(server){
    
        const io = require('socket.io')(server);
        io.on('connection', (socket) => {
            const payload = JWT.verify(socket.handshake.query.token)
            if(payload){
                socket.user = payload
                // 发送 
                socket.emit(WebSocketType.GroupChat,createMessage(null,"欢迎来到聊天室"))
                sendAll(io)
            }else{
                socket.emit(WebSocketType.Error,createMessage( socket.user,"token过期"))
            }

            // 发送列表
            socket.on(WebSocketType.GroupList, ()=>{
                sendAll(io)
            })

            socket.on(WebSocketType.GroupChat,(msg)=>{
                // socket.emit()
                console.log(msg);
                // 给所有人发
                // io.sockets.emit(WebSocketType.GroupChat,createMessage(socket.user,msg.data))
                // 出来自己发给其他人
                socket.broadcast.emit(WebSocketType.GroupChat,createMessage(socket.user,msg.data))
            })

            socket.on(WebSocketType.SingleChat,(msgObj)=>{
                Array.from(io.sockets.sockets).forEach(item=>{
                    if(item[1].user.username === msgObj.to){
                        item[1].emit(WebSocketType.SingleChat,createMessage(socket.user,msgObj.data))
                    }
                })
            })

            socket.on("disconnect",()=>{
                sendAll(io)
            })
        });

        
    }


    const WebSocketType = {
        Error:0, // 错误
        GroupList:1,    // 获取用户列表
        GroupChat:2,    // 群聊
        SingleChat:3    // 单聊
    }


    function createMessage(user,data){
        return {
            user,
            data
        }
    }

    function sendAll(io){
        // filter(item=>item) 过滤没有刷新还是空的数据
        let userlist =  Array.from(io.sockets.sockets).map(item=>item[1].user).filter(item=>item)
        
        io.sockets.emit(WebSocketType.GroupList,createMessage(null,userlist))
    }

    module.exports = start
    ```

2. 客户端

    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Document</title>
        <script src="/javascripts/socket.io.min.js"></script>
    </head>
    <body>
        <h1>聊天室</h1>
        <h1>
            当前用户:
            <b id="user"></b>
        </h1>
        <input type="text" id="text"> <button id="send">send</button>

        <select id="select"></select>

        <!-- 建立socket连接 带着token 后端验证 -->
        <script>
            var select = document.getElementById("select")
            var text = document.getElementById("text")
            var sendBtn = document.getElementById("send")
            var user= document.querySelector("#user")
            user.innerHTML = localStorage.getItem("user")

            const WebSocketType = {
                Error:0, // 错误
                GroupList:1,    // 获取用户列表
                GroupChat:2,    // 群聊
                SingleChat:3    // 单聊
            }
            
            // 引入socket.io js端

            // http 连接
            // const socket = io(`http://localhost:3000?token=${localStorage.getItem("token")}`);
            // websocket 连接
            const socket = io(`ws://localhost:3000?token=${localStorage.getItem("token")}`)
            // 不管是那种都使用http调用了5次请求，这里ws并没有意义

            socket.on(WebSocketType.GroupChat,(msg)=>{
                var title = msg.user?msg.user.username + "发送：":"广播：";
                console.log( title + msg.data);
                // socket.emit({type:1})
            })

            // 失败
            socket.on(WebSocketType.Error,(msg)=>{
                localStorage.removeItem("token")
                location.href = "/login"
            })

            socket.on(WebSocketType.GroupList,(msg)=>{
                const onlineList = msg.data;
                select.innerHTML = "";
                select.innerHTML =  `<option value="all">all</option>` + 
                    onlineList.map(item=>`
                        <option value="${item.username}">${item.username}</option>
                    `).join("")
            })

            socket.on(WebSocketType.SingleChat,(msgObj)=>{
                console.log(msgObj);
                
                console.log(msgObj.user.username + "发送：" + msgObj.data );
            })

            sendBtn.onclick = () =>{
                if(select.value == "all"){
                    socket.emit(WebSocketType.GroupChat,createMessage(text.value))
                }else{
                    socket.emit(WebSocketType.SingleChat,createMessage(text.value,select.value))
                }
            }


            function createMessage(data,to){
                return {
                    data,
                    to
                }
            }
        </script>
    </body>
    </html>
    ```