# 一、基础使用

## 1.1 项目创建

### 1.1.1 初始化项目

1. 先来初始化下目录结构：

    ```bash
    mkdir egg-example
    cd egg-example
    npm init
    npm i egg --save
    npm i egg-bin --save-dev
    ```

2. 添加 `npm scripts` 到 `package.json`：

    ```json
    {
        "name": "egg-example",
        "scripts": {
            "dev": "egg-bin dev"
        }
    }
    ```

### 1.1.2 项目结构

```md
egg-project
├── package.json
├── app.js（可选）
├── agent.js（可选）
├── app
|   ├── router.js
│   ├── controller
│   │   └── home.js
│   ├── service（可选）
│   │   └── user.js
│   ├── middleware（可选）
│   │   └── response_time.js
│   ├── schedule（可选）
│   │   └── my_task.js
│   ├── public（可选）
│   │   └── reset.css
│   ├── view（可选）
│   │   └── home.tpl
│   └── extend（可选）
│       ├── helper.js（可选）
│       ├── request.js（可选）
│       ├── response.js（可选）
│       ├── context.js（可选）
│       ├── application.js（可选）
│       └── agent.js（可选）
├── config
|   ├── plugin.js
|   ├── config.default.js
│   ├── config.prod.js
|   ├── config.test.js（可选）
|   ├── config.local.js（可选）
|   └── config.unittest.js（可选）
└── test
    ├── middleware
    |   └── response_time.test.js
    └── controller
        └── home.test.js
```

- 框架约定的目录：

    - app/router.js 用于配置 URL 路由规则，具体参见 Router。
    - app/controller/** 用于解析用户的输入，处理后返回相应的结果，具体参见 Controller。
    - app/service/** 用于编写业务逻辑层，建议使用，具体参见 Service。
    - app/middleware/** 用于编写中间件，具体参见 Middleware。
    - app/public/** 用于放置静态资源，具体参见内置插件 egg-static。
    - app/extend/** 用于框架的扩展，具体参见 框架扩展。
    - config/config.{env}.js 用于编写配置文件，具体参见 配置。
    - config/plugin.js 用于配置需要加载的插件，具体参见 插件。
    - test/** 用于单元测试，具体参见 单元测试。
    - app.js 和 agent.js 用于自定义启动时的初始化工作，具体参见 启动自定义。关于 agent.js 的作用，参见 Agent 机制。

- 内置插件约定的目录：

    - app/public/** 用于放置静态资源，具体参见内置插件 egg-static。
    - app/schedule/** 用于定时任务，具体参见 定时任务。

- 若需自定义自己的目录规范，参见 Loader API

    - app/view/** 用于放置模板文件，具体参见 模板渲染。
    - app/model/** 用于放置领域模型，如 egg-sequelize 等领域类相关插件。

### 1.1.3 设置路由  

1. 编写代码

    ```js
    // app/router.js
    module.exports = app => {
        console.log(app);
        /**
         * {
            env: 'local',
            name: 'egg',
            baseDir: 'C:\\Users\\Administrator\\Desktop\\egg',
            subdomainOffset: 2,
            config: '<egg config>',
            controller: '<egg controller>',
            httpclient: '<egg httpclient>',
            loggers: '<egg loggers>',
            middlewares: '<egg middlewares>',
            router: '<egg router>',
            serviceClasses: '<egg serviceClasses>'
            }
        */
        // 从服务器实例上解构出处理路由的对象和处理控制器的对象
        const { router, controller } = app

        // 监听路由请求
        // controller.home：相当于拿到了controller目录下的home.js（如果有多级可以通过.语法使用）
        router.get('/', controller.home.index)
    }
    ```
2. 注意点

    在router.js中必须暴露出去一个方法，这个方法接受一个参数，这个参数就算服务器的实例对象


### 1.1.4 编写 Controller

1. 编写代码   

    ```js
    // app/controller/home.js（home.js可自定义名称）
    const Controller = require('egg').Controller

    class HomeController extends Controller {
        async index() {
            this.ctx.body = 'hello egg.js'
        }
    }

    module.exports = HomeController
    ```

2. 在eggjs中会自动给控制器挂载一些属性：

    - this.ctx：当前请求的上下文 Context 对象的实例，通过它我们可以拿到框架封装好的处理当前请求的各种便捷属性和方法。
    - this.ctx.body: 页面body的数据
    
### 1.1.5 启动项目

1. 加一个配置文件：

    ```js
    // config/config.default.js
    exports.keys = '<此处改为你自己的 Cookie 安全字符串>';
    ```

2. 此时目录结构如下：

    ```bash
    egg-example
    ├── app
    │   ├── controller
    │   │   └── home.js
    │   └── router.js
    ├── config
    │   └── config.default.js
    └── package.json
    ```

3. 运行项目
    
    ```bash
    npm run dev
    open http://localhost:7001
    ```

4. 运行结果

    - vscode 
        
        ![](/backend/senior/egg/001.png)

    - 浏览器打开

        ![](/backend/senior/egg/002.png)

## 1.2 静态资源


1. 静态资源位置

    Egg 内置了 static 插件，static 插件默认映射 `/public/* -> app/public/*` 目录。

    ```bash
    app/public
    ├── css
    │   └── news.css
    └── js
        ├── lib.js
        └── news.js
    ```

2. 编写静态文件

    - app/public/index.html

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
            <link rel="stylesheet" href="/public/css/index.css">
        </head>
        <body>
            <div>主页</div>
            <img src="/public/images/test.jpg" alt="">
        </body>
        </html>
        ```

    - app/public/css/index.css

        ```css
        div{
            background-color: brown;
            padding: 20px;
        }
        img{
            height: 300px;
        }
        ```

    - app/public/image/test.jpg

        像素大小：690 x 920

3. 运行结果

    ![](/backend/senior/egg/003.png)

    >注意：获取静态文件要加上public

## 1.3 模板渲染

1. 安装插件

    ```bash
    npm i egg-view-nunjucks --save
    ```

2. 开启插件

    - 插件配置

        ```js
        // config/plugin.js
        exports.nunjucks = {
            enable: true,
            package: 'egg-view-nunjucks', // 配置使用的插件
        };
        ```
    - 总体配置

        ```js
        // config/config.default.js
        exports.view = {
            defaultViewEngine: 'nunjucks',
            mapping: {
                '.njk': 'nunjucks',
            },
        };
        ```

3. 编写模板文件

    - 模板文件

        ```html
        <!-- app/view/news/list.njk -->
        <!DOCTYPE html>
        <html>
        <head>
            <title>Hacker News</title>
            <link rel="stylesheet" href="/public/css/news.css" type="text/css" />
        </head>
        <body>
            <ul class="news-view view">
            {% for item in list %}
                <li class="item">
                <a href="{{ item.url }}">{{ item.title }}</a>
                </li>
            {% endfor %}
            </ul>
        </body>
        </html>
        ```
    - 引入的静态文件

        ```css
        /* app/public/css/news.css */
        .news-view.view{
            background-color: #ccc;
        }
        .news-view.view .item{
            font-size: 14px;
            color: salmon;
        }
        ```

4. 添加 Controller 

    ```js
    // app/controller/news.js
    const Controller = require('egg').Controller;

    class NewsController extends Controller {
        async list() {
            // 传入一个对象 key值与模板中数据一一对应
            const dataList = {
                list: [
                    { id: 1, title: '新闻1', url: '/news/1' },
                    { id: 2, title: '新闻2', url: '/news/2' }
                ]
            };
            await this.ctx.render('news/list.njk', dataList);
        }
    }

    module.exports = NewsController;
    ```

5. 修改 Router：

    ```js
    // app/router.js
    module.exports = app => {
        const { router, controller } = app;
        router.get('/', controller.home.index);
        // controller下 news类 的 list方法
        router.get('/news', controller.news.list);
    };
    ```

6. 运行结果

    ![](/backend/senior/egg/004.png)


> **提示：** 开发期默认开启了 development 插件，修改后端代码后，会自动重启 Worker 进程。

## 1.4 获取数据

使用  Service 抓取 [Hacker News](https://github.com/HackerNews/API) 的数据

1. 配置配置项

    用于 
    ```js
    // config/config.default.js
    // 添加 news 的配置项
    exports.news = {
        pageSize: 5,
        serverUrl: 'https://hacker-news.firebaseio.com/v0',
    };
    ```
2. 修改 Controller

    
    ```js
    // app/controller/news.js
    const Controller = require('egg').Controller;

    class NewsController extends Controller {
        async list() {
            // 获取ctx对象 类似koa的ctx
            const ctx = this.ctx;
            // 页数
            const page = ctx.query.page || 1;
            
            // 通过service 获取列表数据 
            // ctx.service 指向目录
            // news 指向文件
            // list 指向函数
            const newsList = await ctx.service.news.list(page);
            // 刷新到模板文件中
            await ctx.render('news/list.njk', { list: newsList });
        }
    }

    module.exports = NewsController;
    ```

3. 添加sevice

    ```js
    // app/service/news.js
    const Service = require('egg').Service;

    class NewsService extends Service {
        async list(page = 1) {
            // 1.读取配置
            const { serverUrl, pageSize } = this.config.news;

            // 2. 获取列表id
            const { data: idList } = await this.ctx.curl(
                `${serverUrl}/topstories.json`,
                {
                    data: {
                        orderBy: '"$key"',
                        startAt: `"${pageSize * (page - 1)}"`,
                        endAt: `"${pageSize * page - 1}"`,
                    },
                    dataType: 'json',
                }
            );

            // 3. 通过id 获取列表数据
            const newsList = await Promise.all(
                Object.keys(idList).map((key) => {
                    const url = `${serverUrl}/item/${idList[key]}.json`;
                    return this.ctx.curl(url, { dataType: 'json' });
                })
            );
            // 4. 返回其中的data数据
            return newsList.map((res) => res.data);
        }
    }

    module.exports = NewsService;
    ```

    - this.service：应用定义的 Service。通过它，我们可以访问到其他业务层，等同于 this.ctx.service。
    - 使用 this.ctx.curl 发起网络调用。

4. 注意
    
    - service目录必须放在app目录中
    - service目录支持多级目录，如果是多级目录，在调用的时候可以通过链式调用
    - service目录下的js文件，如果是以_或首字母大写，那么在调用的时候必须转换成驼峰命名：
        - get_user.js => getUser
        - GetUser.js => getUser

    - 框架提供了内置的 [HttpClient](https://eggjs.org/zh-CN/core/httpclient) 来方便开发者使用 HTTP 请求。
