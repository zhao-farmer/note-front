# 四、插件相关

## 4.1 egg-validate（验证器）


### 4.1.1 校验规则

1. 类型校验 (type)

```javascript
{
    name: { type: 'string' },      // 字符串
    age: { type: 'int' },          // 整数
    price: { type: 'number' },     // 数字(包含小数)
    isAdmin: { type: 'boolean' },  // 布尔值
    birth: { type: 'date' },       // 日期
    id: { type: 'id' },            // MongoDB/ObjectId 格式
    email: { type: 'email' },      // 邮箱格式
    phone: { type: 'tel' },        // 电话号码
    url: { type: 'url' },          // URL格式
}
```

2. 必填校验 (required)


```javascript
{
    username: {
        type: 'string',
        required: true,  // 必须提供该字段
    }
}
```

3. 默认值 (default)

```javascript
{
    page: {
        type: 'int',
        default: 1,  // 未提供时默认为1
    }
}
```


4. 最小/最大值


```javascript
{
    age: {
        type: 'int',
        min: 0,      // 最小值
        max: 120     // 最大值
    },
    price: {
        type: 'number',
        min: 0.01    // 最小金额
    }
}
```

5. 长度限制

```javascript
{
    password: {
        type: 'string',
        min: 6,      // 最小长度
        max: 20      // 最大长度
    }
}
```

6. 枚举值 (enum)

```javascript
{
    gender: {
        type: 'string',
        enum: ['male', 'female', 'unknown']
    }
}
```

7. 正则校验 (format)

```javascript
{
    zipCode: {
        type: 'string',
        format: /^\d{6}$/  // 6位数字邮编
    }
}
```

8. 自定义校验 (validator)

```javascript
{
    coupon: {
        type: 'string',
        validator: (value) => {
        return value.startsWith('DISCOUNT-');
        }
    }
}
```


9. 对象校验

```javascript
{
    address: {
        type: 'object',
        rule: {
            city: { type: 'string', required: true },
            street: { type: 'string' }
        }
    }
}
```

10. 数组校验

```javascript
{
    tags: {
        type: 'array',
        itemType: 'string',  // 数组元素类型
        min: 1,              // 最小数组长度
        max: 5               // 最大数组长度
    }
}
```
11. 嵌套对象数组

```javascript
{
    products: {
        type: 'array',
        rule: {
            id: { type: 'string', required: true },
            quantity: { type: 'int', min: 1 }
        }
    }
}
```


12. 别名 (alias)

```javascript
{
    user_name: {
        type: 'string',
        alias: 'username'  // 客户端传username，服务端接收为user_name
    }
}
```

13. 允许空值 (allowEmpty)

```javascript
{
    description: {
        type: 'string',
        allowEmpty: true  // 允许空字符串
    }
}
```

### 4.1.2 使用示例

```javascript
// 定义完整规则
const rule = {
    username: {
        type: 'string',
        required: true,
        min: 4,
        max: 20,
        format: /^[a-zA-Z0-9_]+$/,
        trim: true
    },
    age: {
        type: 'int',
        min: 18,
        max: 60,
        default: 20
    },
    email: {
        type: 'email',
        required: false
    },
    hobbies: {
        type: 'array',
        itemType: 'string',
        min: 1,
        max: 5
    }
};

// 在控制器中使用
async update() {
    const { ctx } = this;
    ctx.validate(rule);
    // 通过校验后继续处理
}
```

### 4.1.3 错误处理

校验失败会抛出 422 错误，可以通过中间件统一处理：

```javascript
// app/middleware/error_handler.js
module.exports = () => {
    return async (ctx, next) => {
        try {
            await next();
        } catch (err) {
            if (err.code === 'invalid_param') {
                ctx.status = 422;
                ctx.body = {
                    error: '参数校验失败',
                    details: err.errors
                };
                return;
            }
            throw err;
        }
    };
};
```

## 4.2 egg-multipart（表单提交）

1. 核心功能
    1. 文件上传支持：
        - 解析 HTTP 请求中的文件数据
        - 支持多文件同时上传
        - 提供文件流式处理和缓冲处理两种模式
    2. 表单数据处理：
        - 解析普通表单字段
        - 支持文件与表单字段混合提交
    3. 安全控制：
        - 文件大小限制
        - 文件类型白名单
        - 临时文件自动清理
2. 主要作用
    
    1. 简化文件上传处理

        自动处理 multipart 表单数据，开发者无需手动解析复杂的二进制流数据。

    2. 提供两种处理模式
        - file 模式：将上传文件保存为临时文件，适合中小文件
        - stream 模式：提供文件流接口，适合大文件上传

    3. 安全防护
        ```javascript
        // config/config.default.js
        config.multipart = {
            fileSize: '10mb', // 限制文件大小
            whitelist: ['.jpg', '.png'], // 允许的文件扩展名
            fileExtensions: ['.xls'], // 追加允许的扩展名
        };
        ```
    4. 临时文件管理

        自动创建临时目录存储上传文件，并可在处理后自动清理。

## 4.3 orm工具

1. egg-sequelize

    目前已过时，长时间不更新了

2. egg-orm (官方推荐)

    - [官方文档](https://github.com/eggjs/egg-orm/blob/master/Readme.zh-CN.md)

    - 基于 Leoric 实现 [进入文档](https://leoric.js.org/zh)


## 4.4 egg-jwt

长时间不更新，目前已不适配最新版本，建议使用cookie与session

## 4.5 egg-swagger

长时间不维护，不适配最新版本，不建议使用

