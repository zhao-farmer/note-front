# 五、基础项目配置

## 5.1 创建项目

1. 创建项目

    ```sh
    # 使用工程创建项目
    npm init egg --type=simple
    # npm 安装插件
    npm i
    ```

## 5.2 数据库与模型

1. 安装插件

    ```
    # 安装orm与数据库
    npm install egg-orm mysql 
    ```

    [进入egg-orm的文档](https://github.com/eggjs/egg-orm)

    egg-orm使用的是leoric [查看文档](https://leoric.js.org/zh/querying/)

2. 启动配置

    - 插件配置 plugin.js

        ```js
        module.exports = {
            //  ORM 框架
            sequelize: {
                package: "egg-orm",
                enable: true,
            },
        }
        ```
    - 系统默认配置

        ```js
        const config = (exports = {
            orm: {
                client: "mysql",
                database: "egg-mysql",
                host: "127.0.0.1",
                port: 3306,
                username: "root",
                password: "123456",
                // 用于提供内置对象 可以 `app.model` and `ctx.model`
                delegate: "model",
                // 文件位置 `app/model/*.js`
                baseDir: "model",
                // 迁移路径
                migrations: "database/migrations",
                // 东八区
                timezone: "+08:00",
                // 支持 bigint
                dialectOptions: {
                    supportBigNumbers: true,
                    bigNumberStrings: true,
                },
            },
        });


3. 新建数据库(mysql)

    - 新建egg-mysql 数据库

    - 新建user表

        ![](/backend/senior/egg/005.png)

4. 新建模型

    - app/model/user.js

        ```js
        // app/model/user.js
        module.exports = app => {

            const { DataTypes:{STRING, INTEGER, DATE }} = app.model;

            const User = app.model.define(
                "user",
                {
                    id: { type: INTEGER, primaryKey: true, autoIncrement: true },
                    username: STRING(50),
                    password: STRING(100),
                    age:INTEGER,
                    avatar: STRING(100),
                    created_at: DATE,
                    updated_at: DATE,
                },
                {
                    timestamps: true, // 自动维护 createdAt 和 updatedAt 字段
                    tableName: "users", // 自定义表名
                }
            );

            return User;
        };

        ```
## 5.3 准备工作

1. 关闭配置文件警告 .eslintrc 

    ```json
    {
        "extends": "eslint-config-egg",
        "root": true,
        // 取消验证文档
        "valid-jsdoc": "off"
    }
    ```

2. 安装插件

    ```
    # 安装表单提交
    npm install egg-multipart
    # 安装参数验证
    npm install egg-validate
    # 安装数据加密
    npm install bcryptjs
    ```
3. 插件应用

    ```js
    // config/plugin.js
    module.exports = {

        // 是否开启静态
        static: {
            enable: true,
        },
        //  ORM 框架
        sequelize: {
            package: "egg-orm",
            enable: true,
        },
        // 表单上传
        multipart: {
            package: "egg-multipart",
            enable: true,
        },
        // 验证参数
        validate: {
            enable: true,
            package: 'egg-validate',
        }
    };
    ```

4. 加入cookie与session 配置

    ```js
    // config/config.default.js
    module.exports = appInfo => {
        const config = (exports = {
            orm: {
                client: "mysql",
                database: "egg-mysql",
                host: "127.0.0.1",
                port: 3306,
                username: "root",
                password: "123456",
                // 用于提供内置对象 可以 `app.model` and `ctx.model`
                delegate: "model",
                // 文件位置 `app/model/*.js`
                baseDir: "model",
                // 迁移路径
                migrations: "database/migrations",
                // 东八区
                timezone: "+08:00",
                // 支持 bigint
                dialectOptions: {
                    supportBigNumbers: true,
                    bigNumberStrings: true,
                },
            },
    
            multipart: {
                mode: "file",
                fileSize: "50mb",
            },
            
            // cookie
            cookies: {
                httpOnly: true,
                sameSite: 'lax',
                encrypt: true,
            },
            // session
            session: {
                key: 'EGG_SESS',
                maxAge: 24 * 60 * 60 * 1000,
                httpOnly: true,
                encrypt: true,
                renew: true,
            },
            // 安装验证
            security: {
                csrf: {
                    enable: false,
                    // ignoreJSON: true,
                    // cookieName: 'csrfToken',
                },
            },
        });

        // 设置cookie 的key
        config.keys = appInfo.name + "_1754187155918_3232";

        // 中间件 
        config.middleware = ["errorHandler"];

        // 用户配置
        const userConfig = {
            // myAppName: 'egg',
            uploadPrefix:"uploads/"
        };

        return {
            ...config,
            ...userConfig,
        };
    };
    ```

## 5.4 编写中间件

1. 错误处理中间件 (app/middleware/error_handler.js)

    ```js
    // app/middleware/error_handler.js
    module.exports = () => {
        return async (ctx, next) => {
            try {
                await next();
            } catch (err) {
                // 记录错误日志
                ctx.app.emit("error", err, ctx);

                // 返回错误响应
                ctx.status = err.status || 500;
                ctx.body = {
                    success: false,
                    message: err.message,
                    stack: ctx.app.config.env === "prod" ? undefined : err.stack,
                };
            }
        };
    };

    ```

2. cookie与session验证中间件

    ```js
    // app/middleware/auth.js
    module.exports = () => {
        return async (ctx, next) => {
            // 检查 session
            if (!ctx.session.user) {
                ctx.throw(401, "请先登录");
            }

            // 检查 cookie
            const authCookie = ctx.cookies.get("user_auth", { encrypt: true });
            if (!authCookie) {
                ctx.session = null;
                ctx.throw(401, "请重新登录");
            }

            await next();
        };
    };
    ```

## 5.5 后端流程

### 5.5.1 router

```js
// app/router.js
module.exports = app => {
    
    const { router, controller, middleware } = app;

    // auth 中间件 过滤其中的请求
    const auth = middleware.auth({
        ignore: ["/api/user/register", "/api/user/login", "/public"],
    });

    // 用户路由
    router.post("/api/user/register",  controller.user.register);
    router.post("/api/user/login",  controller.user.login);
    router.get("/api/user/list", auth, controller.user.list);

};
```

### 5.5.2 controller

```js
// app/controller/user.js
const Controller = require("egg").Controller;

class UserController extends Controller {
    // 用户注册
    async register() {
        const { ctx } = this;

        // 参数
        ctx.request.body.age = Number(ctx.request.body.age)

        // 获取上传的文件
        const files = ctx.request.files; 
        // 调用 service 层的 saveImages 方法
        const result = await ctx.service.uploadFileService.saveImages(files);
        // 设置头像
        ctx.request.body.avatar = result

        // 参数校验
        ctx.validate({
            username: { type: 'string', required: true },
            password: { type: 'string', required: true, min: 2 },
            age: { type: 'number', required: false, max: 120 },
        });
 
        // 创建用户
        const user = await ctx.service.user.register(ctx.request.body);

        ctx.body = {
            success: true,
            data: {
                ok:1,
            },
        };
    }

    // 用户登录
    async login() {
        const { ctx } = this;

        // 参数校验
        ctx.validate({
            username: "string",
            password: "string",
        });

        // 验证用户
        const user = await ctx.service.user.login(ctx.request.body.username, ctx.request.body.password);

       // 设置 Session
        ctx.session.user = {
            id: user.id,
            username: user.username,
            role: user.role,
            loginTime: Date.now(),
        };
        
        // 设置 Cookie
        ctx.cookies.set('user_auth', '1', {
            maxAge: 24 * 60 * 60 * 1000,
            encrypt: true,
        });
        ctx.body = {
            success: true,
            data: {
                ok:1
            },
        };
    }


    // 获取用户列表
    async list() {
        const { ctx } = this;
        console.log(ctx.query);
        
        // 参数校验
        ctx.validate({
            page: { type: 'string', required: false },
            size: { type: 'string', required: false, max: 100 },
        });

        let params = {pageSize:ctx.query.size,page:ctx.query.page}
        const users = await ctx.service.user.list(params);
        ctx.body = {
            success: true,
            data: users,
        };
    }
}

module.exports = UserController;
```

### 5.5.3 servie

1. 用户service

    ```js
    // app/service/user.js
    const Service = require("egg").Service;
    const bcrypt = require("bcryptjs");

    class UserService extends Service {
        // 用户注册
        async register(userData) {
            const { ctx } = this;

            // 检查用户名是否已存在
            if (await this.findByUsername(userData.username)) {
                ctx.throw(400, "用户名已存在");
            }

            // 生成盐
            const salt = bcrypt.genSaltSync(10);
            // 哈希密码
            userData.password = bcrypt.hashSync(userData.password, salt);

            // 创建用户
            return await ctx.model.user.create(userData);
        }

        // 用户登录
        async login(username, password) {
            const { ctx } = this;
            const user = await this.findByUsername(username);

            console.log(password, user.password);

            console.log(bcrypt.compareSync(password, user.password));

            if (!user || !bcrypt.compareSync(password, user.password)) {
                ctx.throw(400, "用户名或密码错误");
            }

            return user;
        }

        // 根据用户名查找用户
        async findByUsername(username) {
            return await this.ctx.model.user.findOne({
                username: username,
            });
        }

        // 获取用户列表
        async list(params = {}) {

            const { page = 1, pageSize = 10 } = params;

            // 计算偏移量
            const offset = (page - 1) * pageSize;

            // 一定要使用 await
            const list  = await this.ctx.model.user
                .order("created_at", "desc")
                .limit(pageSize)
                .offset(offset);

            // 查询总数
            const total = await this.ctx.model.user.count();

            console.log(total);
            
                
            return {
                list,
                pagination: {
                    page: parseInt(page),
                    pageSize: parseInt(pageSize),
                    total,
                    totalPages: Math.ceil(total / pageSize),
                },
            };

        
        }
    }

    module.exports = UserService;
    ```

2. 上传服务

    ```js
    const Service = require("egg").Service;
    const fs = require("fs");
    const path = require("path");
    const crypto = require("crypto"); // 引入 crypto 模块

    class uploadFileService extends Service {

        async saveImages(files) {
            const uploadLoad = this.ctx.app.config.uploadPrefix

            const uploadDir = "app/public/" + uploadLoad; // 上传目录

            try {
                // 检查文件数量是否为1
                if (files.length !== 1) {
                    return { success: false, message: "目前只支持上传一个文件" };
                }
                const file = files[0]; // 只处理第一个文件
                const fileName = file.filename;
                // 使用 MD5 对文件名进行加密
                const hash = crypto.createHash("md5").update(fileName).digest("hex");
                const timestamp = Date.now(); // 获取当前时间戳

                // 新文件名
                const newFileName = `${hash}_${timestamp}${path.extname(fileName)}`; 
                // 真实路径
                const filePath = path.join(uploadDir, newFileName);

                // 将文件保存到指定目录
                const writeStream = fs.createWriteStream(filePath);
                const readStream = fs.createReadStream(file.filepath);
                readStream.pipe(writeStream);

                // 可以在这里添加其他逻辑，如数据库记录保存等
                return uploadLoad + newFileName;
            } catch (err) {
                return { success: false, message: "上传图片失败" };
            }
        }
    }

    module.exports = uploadFileService;
    ```

## 5.6 静态文件配置

1. 登录界面 /public/login.html

    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Document</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    </head>
    <body>
        <h1>登录页面</h1>

        <div>
            <div>用户名：<input id="username" /></div>
            <div>密码：<input type="password" id="password" /></div>
            <div><button id="login">登录</button></div>
        </div>

        <script>
            var username = document.querySelector("#username");
            var password = document.querySelector("#password");
            var login = document.querySelector("#login");

            login.onclick = () => {
                console.log(username.value, password.value);

                axios.post("/api/user/login", {
                    username: username.value,
                    password: password.value,
                }).then(res => {
                    console.log(res.data);
                    console.log(res.data.ok);
                    
                    if (res.data.data.ok === 1) {
                        location.href = "/public/home.html";
                    } else {
                        console.log("用户名密码不匹配");
                    }
                });
            };
        </script>
    </body>
    </html>
    ```

2. 用户管理页面 /public/home.html

    ```html
    <!DOCTYPE html>
    <html>
    <head>
        <title>验证</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <style>
            td img{
                width: 80px;
                height: 80px;
            }
        </style>
    </head>
    <body>

        <h1>后台系统-用户管理业务</h1>
        <div>
            <div>用户名：<input id="username" /></div>
            <div>密码：<input type="password" id="password" /></div>
            <div>年龄：<input type="number" id="age" /></div>
            <div>头像：<input type="file" id="avatar"></div>
            <div><button id="register">添加用户</button></div>
        </div>
        <hr>
        <div>
            <button id="show">列表数据</button>
        </div>

        <table border="1">
            <thead>
                <tr>
                    <td>id</td>
                    <td>用户名</td>
                    <td>年龄</td>
                    <td>头像</td>
                </tr>
            </thead>
            <!-- 往这里插入数据 -->
            <tbody>

            </tbody>
        </table>

    
        <script>
            var registerbtn = document.querySelector("#register");
            var username = document.querySelector("#username");
            var password = document.querySelector("#password");
            var age = document.querySelector("#age");
            var exit = document.querySelector("#exit");
            var avatar = document.querySelector("#avatar");
        
            

            registerbtn.onclick = () => {

                const formdata = new FormData()
                formdata.append("username",username.value);
                formdata.append("password",password.value)
                formdata.append("age",age.value)
                formdata.append("avatar",avatar.files[0])
                
                axios.post("/api/user/register",formdata,{
                    headers:{
                    "Content-Type":"multipart/form-data"
                    }
                }).then(res=>{
                    console.log(res.data);
                })
            
            };

            
            show.onclick = () =>{
                axios.get("/api/user/list?page=1&size=10").then(res=>{
                    
                    res = res.data.data.list
                    console.log(res);
                    
                    var tbody = document.querySelector("tbody")
                    tbody.innerHTML = res.map(item=>`
                        <tr>
                            <td>${item.id}</td>    
                            <td>${item.username}</td>    
                            <td>${item.age}</td>
                            <td><img src="${item.avatar}"/></td>
                        </tr>
                    `).join("")
                })
            }
        </script>
    </body>
    </html>
    ```

## 5.7 运行结果

![](/backend/senior/egg/006.gif)