# 四、nestjs 结合vue

## 4.1 基础使用

### 4.1.1 vue项目

1. 准备工作

    - 创建vue项目与添加依赖

        ```sh
        # 创建vue项目
        npm create vue@latest
        # 安装插件
        npm i element-plus axios --save
        ```
    - main.ts 添加element-plus模块

        ```ts
        import { createApp } from 'vue'
        import ElementPlus from 'element-plus'
        import 'element-plus/dist/index.css'
        import App from './App.vue'

        const app = createApp(App)

        app.use(ElementPlus)
        app.mount('#app')
        ```
2. 添加 axios 访问

    - server/index.ts 文件

        ```ts
        import axios from 'axios'

        export const addUser = (data:object) => axios.post('/api/user',data).then(res => res.data)
        
        export const getList = (data:object) => axios.get('/api/user',{params:data}).then(res => res.data)
        
        export const delUser = (data:{id:number}) => axios.delete(`/api/user/${data.id}`).then(res => res.data)
        
        export const updateUser = (data:{id:number}) => axios.patch(`/api/user/${data.id}`,data).then(res => res.data)

        ```
    - vite.config.ts 配置代理

        ```ts
        server: {
            proxy: {
                "/api": {
                    target: "http://localhost:3006/",
                    changeOrigin: true,
                    rewrite: path => path.replace(/^\/api/, ""),
                },
            },
        },
        ```
3. app.vue 文件设置页面

    ```vue
    <template>
        <div class="wraps">
            <div>
                <el-input v-model="search.keyWord" style="width: 300px"></el-input>
                <el-button @click="init" style="margin-left: 10px">搜索</el-button>
                <el-button @click="openDialog" type="primary" style="margin-left: 10px">添加</el-button>
            </div>
            <el-table border :data="tableData" style="width: 100%; margin-top: 30px">
                <el-table-column prop="name" label="名字" />
                <el-table-column prop="desc" label="描述" />
                <el-table-column prop="id" label="id" />
                <el-table-column>
                    <template #default="scope">
                        <el-button @click="edit(scope.row)">编辑</el-button>
                        <el-button @click="deleteRow(scope.row)">删除</el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-pagination @current-change="changeSize" style="float: right; margin-top: 10px" background layout="prev, pager, next" :total="total" />
        </div>

        <el-dialog v-model="dialogVisible" title="弹框" width="50%">
            <el-form :model="form">
                <el-form-item prop="name" label="名称">
                    <el-input v-model="form.name" placeholder="名称" />
                </el-form-item>
                <el-form-item prop="desc" label="描述">
                    <el-input v-model="form.desc" placeholder="描述"> </el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="close">关闭</el-button>
                    <el-button type="primary" @click="save"> 保存 </el-button>
                </span>
            </template>
        </el-dialog>
    </template>

    <script setup lang="ts">
    import { ref, reactive } from "vue";

    import { addUser, updateUser, delUser, getList } from '@/server/index'

    interface User{
        id:number
        name:string
        desc:string
    }

    const total = ref<number>(0);
    //搜索框
    const search = reactive({
        keyWord: "",
        page: 1,
        pageSize: 10,
    });
    //表单
    const form = reactive({
        name: "",
        desc: "",
        id: 0,
    });
    //清空数据
    const resetForm = reactive({ ...form });
    //表格数据
    const tableData = ref([]);
    //弹框开关
    const dialogVisible = ref<boolean>(false);
    const openDialog = () => {
        dialogVisible.value = true;
        Object.assign(form, resetForm);
    };
    //初始化表格数据
    const init = async () => {
        const list = await getList(search);
        tableData.value = list?.data ?? [];
        total.value = list?.total ?? 0;
    };
    init();

    const changeSize = (page:number) => {
        search.page = page;
        init();
    };

    //保存 和修改 表格数据
    const save = async () => {
        if (form.id) {
            await updateUser(form);
        } else {
            await addUser(form);
        }

        close();
        init();
    };
    //删除表格数据
    const deleteRow = async (row:User) => {
        await delUser({ id: row.id });
        init();
    };
    //获取 详情
    const edit = (row: User) => {
        dialogVisible.value = true;
        Object.assign(form, row);
    };
    //关闭弹框
    const close = () => {
        dialogVisible.value = false;
    };
    </script>

    <style>
    * {
        padding: 0;
        margin: 0;
    }

    html,
    body {
        background: #ccc;
    }

    .wraps {
        height: 100vh;
        padding: 30px;
    }
    </style>
    ```
### 4.1.2 nest后台

1. 准备工作

    - 创建项目与添加依赖

        ```
        # 创建nest项目
        nest new server
        # 创建user模块
        nest g res user
        # 安装orm依赖
        npm install --save @nestjs/typeorm typeorm mysql2
        ```
    - 配置 数据库连接 app.module.ts

        ```ts
        import { Module } from '@nestjs/common';
        import { AppController } from './app.controller';
        import { AppService } from './app.service';
        import { UserModule } from './user/user.module';
        import { TypeOrmModule } from '@nestjs/typeorm';

        @Module({
            imports: [
                UserModule,
                TypeOrmModule.forRoot({
                type: 'mysql', //数据库类型
                username: 'root', //账号
                password: '123456', //密码
                host: 'localhost', //host
                port: 3306, //端口
                database: 'nestmysql', //库名
                entities: [__dirname + '/**/*.entity{.ts,.js}'], //实体文件
                synchronize: true, //synchronize字段代表是否自动将实体类同步到数据库
                retryDelay: 500, //重试连接数据库间隔
                retryAttempts: 10, //重试连接数据库的次数
                autoLoadEntities: true, // forFeature() 实体添加
                }),
            ],
            controllers: [AppController],
            providers: [AppService],
        })
        export class AppModule {}
        ```
2. 实体与dto配置

    - create-user.dto.ts 

        ```ts
        export class CreateUserDto {
            name:string
            desc:string
        }
        ``` 
    - user.entity.ts

        ```ts
        import { Entity,Column,PrimaryGeneratedColumn, CreateDateColumn } from "typeorm"

        @Entity()
        export class User {
            @PrimaryGeneratedColumn()
            id:number

            @Column({type:"varchar",length:255})
            name:string
            
            @CreateDateColumn({type:"timestamp"})
            createTime:Date

            @Column({type:"text"})
            desc:string
        }
        ```
3. controller 配置

    ```ts
    import { Controller, Get, Post, Body, Patch, Param, Delete, Query } from '@nestjs/common';
    import { UserService } from './user.service';
    import { CreateUserDto } from './dto/create-user.dto';
    import { UpdateUserDto } from './dto/update-user.dto';

    @Controller('user')
    export class UserController {
        constructor(private readonly userService: UserService) {}

        @Post()
        create(@Body() createUserDto: CreateUserDto) {
            return this.userService.create(createUserDto);
        }

        @Get()
        findAll(@Query() query:{keyWord:string,page:number,pageSize:number}) {
            return this.userService.findAll(query);
        }

        @Patch(':id')
        update(@Param('id') id: string, @Body() updateUserDto: UpdateUserDto) {
            return this.userService.update(+id, updateUserDto);
        }

        @Delete(':id')
        remove(@Param('id') id: string) {
            return this.userService.remove(+id);
        }
    }

    ```
4. service 配置
    - 使用 orm 操作数据库

        1. 引入 InjectRepository typeOrm 依赖注入 接受一个实体
        2. 引入类型 Repository 接受实体泛型
        3. Like 用于模糊查询
        4. save 保存  find 查询 update 更新 delete 删除
    - 代码
        ```ts
        import { Injectable } from '@nestjs/common';
        import { CreateUserDto } from './dto/create-user.dto';
        import { UpdateUserDto } from './dto/update-user.dto';
        import { User } from './entities/user.entity'
        import { InjectRepository } from '@nestjs/typeorm';
        import { Repository,Like } from 'typeorm';

        @Injectable()
        export class UserService {
            // 依赖注入实体用户
            constructor(@InjectRepository(User) private readonly user: Repository<User>){}

            // 存入到数据库
            create(createUserDto: CreateUserDto) {
                const data = new User()
                data.name = createUserDto.name
                data.desc = createUserDto.desc
                return this.user.save(data)
            }

            async findAll(query: {keyWord:string,page:number,pageSize:number}) {
                // 数据
                const data = await this.user.find({
                    where:{
                        name: Like(`%${query.keyWord}%`)
                    },
                    order: {
                        id: "DESC"
                    },
                    skip: (query.page - 1) * query.pageSize,
                    take: query.pageSize,
                })
                // 页数
                const total = await this.user.count({
                    where:{
                        name: Like(`%${query.keyWord}%`)
                    },
                })
                return {
                    data,
                    total
                };
            }

            update(id: number, updateUserDto: UpdateUserDto) {
                return this.user.update(id,updateUserDto);
            }

            remove(id: number) {
                return this.user.delete(id);
            }
        }
        ```
5. 运行结果

    - 页面添加

        ![](/backend/senior/nest/048.png)
    - 数据库内容

        ![](/backend/senior/nest/049.png)
## 4.2 多表联合操作

### 4.2.1 vue修改

1. app.vue

    ```vue{16,40-50,55,57-58,67-73,136-144}
    <template>
        <div class="wraps">
            <div>
                <el-input v-model="search.keyWord" style="width: 300px"></el-input>
                <el-button @click="init" style="margin-left: 10px">搜索</el-button>
                <el-button @click="openDialog" type="primary" style="margin-left: 10px">添加</el-button>
            </div>
            <el-table border :data="tableData" style="width: 100%; margin-top: 30px">
                <el-table-column prop="name" label="名字" />
                <el-table-column prop="desc" label="描述" />
                <el-table-column prop="id" label="id" />
                <el-table-column>
                    <template #default="scope">
                        <el-button @click="edit(scope.row)">编辑</el-button>
                        <el-button @click="deleteRow(scope.row)">删除</el-button>
                        <el-button @click="(isShowTag = true,row = scope.row)">添加tag</el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-pagination @current-change="changeSize" style="float: right; margin-top: 10px" background layout="prev, pager, next" :total="total" />
        </div>

        <!-- 添加名称描述 -->
        <el-dialog v-model="dialogVisible" title="弹框" width="50%">
            <el-form :model="form">
                <el-form-item prop="name" label="名称">
                    <el-input v-model="form.name" placeholder="名称" />
                </el-form-item>
                <el-form-item prop="desc" label="描述">
                    <el-input v-model="form.desc" placeholder="描述"> </el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="close">关闭</el-button>
                    <el-button type="primary" @click="save"> 保存 </el-button>
                </span>
            </template>
        </el-dialog>
        <!-- 添加tags -->
        <el-dialog v-model="isShowTag" title="添加tag">
            <el-select style="width:100%" v-model="tags" multiple>
                <el-option value="tag1">tag1</el-option>
                <el-option value="tag2">tag2</el-option>
                <el-option value="tag3">tag3</el-option>
            </el-select>
            <template #footer>
                <el-button @click="addTa" type="primary">确定</el-button>
            </template>
        </el-dialog>
    </template>

    <script setup lang="ts">
    import { ref, reactive } from "vue";
    import { addUser, updateUser, delUser, getList,addTags } from '@/server/index'

    const isShowTag = ref<boolean>(false)
    const tags = ref<string[]>([])
    const total = ref<number>(0);

    // 用户数据
    interface User{
        id:number
        name:string
        desc:string
    }
    // 行数据
    const row = ref<{
        id?: number,
        name?: string,
        desc?: string,
        createTime?: Date
    }>({})
    //搜索框
    const search = reactive({
        keyWord: "",
        page: 1,
        pageSize: 10,
    });
    //表单
    const form = reactive({
        name: "",
        desc: "",
        id: 0,
    });
    //清空数据
    const resetForm = reactive({ ...form });
    //表格数据
    const tableData = ref([]);
    //弹框开关
    const dialogVisible = ref<boolean>(false);
    const openDialog = () => {
        dialogVisible.value = true;
        Object.assign(form, resetForm);
    };


    //初始化表格数据
    const init = async () => {
        const list = await getList(search);
        tableData.value = list?.data ?? [];
        total.value = list?.total ?? 0;
    };
    init();

    const changeSize = (page:number) => {
        search.page = page;
        init();
    };

    //保存 和修改 表格数据
    const save = async () => {
        if (form.id) {
            await updateUser(form);
        } else {
            await addUser(form);
        }

        close();
        init();
    };
    //删除表格数据
    const deleteRow = async (row:User) => {
        await delUser({ id: row.id });
        init();
    };
    //获取 详情
    const edit = (row: User) => {
        dialogVisible.value = true;
        Object.assign(form, row);
    };
    //关闭弹框
    const close = () => {
        dialogVisible.value = false;
    };
    // 添加tags
    const addTa = async () => {
        const res = await addTags({
            tags: tags.value,
            userId: row.value.id
        })
        isShowTag.value = false;
        tags.value = [];
    }
    </script>

    <style>
    * {
        padding: 0;
        margin: 0;
    }

    html,
    body {
        background: #ccc;
    }

    .wraps {
        height: 100vh;
        padding: 30px;
    }
    </style>
    ```

2. server/index.ts

    ```ts{11-12}
    import axios from 'axios'

    export const addUser = (data:object) => axios.post('/api/user',data).then(res => res.data)
    
    export const getList = (data:object) => axios.get('/api/user',{params:data}).then(res => res.data)
    
    export const delUser = (data:{id:number}) => axios.delete(`/api/user/${data.id}`).then(res => res.data)
    
    export const updateUser = (data:{id:number}) => axios.patch(`/api/user/${data.id}`,data).then(res => res.data)

    //添加tag
    export const addTags = (data:object) => axios.post(`/api/user/add/tags`,data).then(res => res.data)
    ```

### 4.2.2 nest后台修改
1. 实体类修改
    - tags实体类 tags.entity.ts

        ```ts
        import { Column, Entity, PrimaryGeneratedColumn, JoinColumn, ManyToOne } from 'typeorm'
        import { User } from './user.entity'
        @Entity()
        export class Tags {
            @PrimaryGeneratedColumn()
            id: number
        
            @Column()
            tags:string
        
            @ManyToOne(()=>User,(user)=>user.tags)
            @JoinColumn()
            user:User
        } 
        ```
    - user实体类 user.entity.ts

        ```ts{2,21-22}
        import { Column, Entity, PrimaryGeneratedColumn, CreateDateColumn, Generated, OneToMany } from 'typeorm'
        import { Tags } from './tags.entity'
        @Entity()
        export class User {
            @PrimaryGeneratedColumn()
            id: number
            
            @Column({ type: "varchar", length: 255 })
            name: string
            
            
            @Column({ type: "text" })
            desc: string
            
            @Generated('uuid')
            uuid: string
            
            @CreateDateColumn({ type: "timestamp" })
            createTime: Date
            
            @OneToMany(() => Tags, (tags) => tags.user)
            tags:Tags[]
        }
        ```
2. 模块类修改 user.module.ts

    ```ts{6,9}
    import { Module } from '@nestjs/common';
    import { UserService } from './user.service';
    import { UserController } from './user.controller';
    import {TypeOrmModule} from '@nestjs/typeorm'
    import { User } from './entities/user.entity'
    import { Tags } from './entities/tags.entity';

    @Module({
        imports:[TypeOrmModule.forFeature([User,Tags])],
        controllers: [UserController],
        providers: [UserService],
    })
    export class UserModule {}
    ```
3. service 修改

    ```ts{7,14,20-35}
    import { GoneException, Injectable } from '@nestjs/common';
    import { CreateUserDto } from './dto/create-user.dto';
    import { UpdateUserDto } from './dto/update-user.dto';
    import { User } from './entities/user.entity';
    import { InjectRepository } from '@nestjs/typeorm';
    import { Repository, Like } from 'typeorm';
    import { Tags } from './entities/tags.entity';

    @Injectable()
    export class UserService {
        // 依赖注入实体用户
        constructor(
            @InjectRepository(User) private readonly user: Repository<User>,
            @InjectRepository(Tags) private readonly tag: Repository<Tags>,
        ) {}

        // 通过前端传入的userId 查到当前id 的用户信息，然后拿到前端传入的tags [tag1,tag2,tag3]
        // 进行遍历 给tag实例进行赋值 然后调用保存方法添加tag 添加完之后 通过 tagList 保存该tag类
        // 最后把tagList 赋给 user类的tags属性 然后重新调用save 进行更新
        async addTags(params: { tags: string[]; userId: number }) {
            const userInfo = await this.user.findOne({ where: { id: params.userId } });
            const tagList: Tags[] = [];
            for (let i = 0; i < params.tags.length; i++) {
                let T = new Tags();
                T.tags = params.tags[i];
                await this.tag.save(T);
                tagList.push(T);
            }
            if(!userInfo) {
                throw new GoneException("传入userIdc错误")
            }
            userInfo.tags = tagList;
            console.log(userInfo, 1);
            return this.user.save(userInfo);
        }

        // 存入到数据库
        create(createUserDto: CreateUserDto) {
            const data = new User();
            data.name = createUserDto.name;
            data.desc = createUserDto.desc;
            return this.user.save(data);
        }

        async findAll(query: { keyWord: string; page: number; pageSize: number }) {
            const data = await this.user.find({
                where: {
                    name: Like(`%${query.keyWord}%`),
                },
                order: {
                    id: 'DESC',
                },
                skip: (query.page - 1) * query.pageSize,
                take: query.pageSize,
            });

            const total = await this.user.count({
                where: {
                    name: Like(`%${query.keyWord}%`),
                },
            });
            return {
                data,
                total,
            };
        }

        update(id: number, updateUserDto: UpdateUserDto) {
            return this.user.update(id, updateUserDto);
        }

        remove(id: number) {
            return this.user.delete(id);
        }
    }

    ```
4. controller修改

    ```ts{10,13}
    import { Controller, Get, Post, Body, Patch, Param, Delete, Query } from '@nestjs/common';
    import { UserService } from './user.service';
    import { CreateUserDto } from './dto/create-user.dto';
    import { UpdateUserDto } from './dto/update-user.dto';

    @Controller('user')
    export class UserController {
        constructor(private readonly userService: UserService) {}

        @Post('/add/tags')
        addTags (@Body() params:{tags:string[],userId:number}) {
            return this.userService.addTags(params)
        }


        @Post()
        create(@Body() createUserDto: CreateUserDto) {
            return this.userService.create(createUserDto);
        }

        @Get()
        findAll(@Query() query:{keyWord:string,page:number,pageSize:number}) {
            return this.userService.findAll(query);
        }

        @Patch(':id')
        update(@Param('id') id: string, @Body() updateUserDto: UpdateUserDto) {
            return this.userService.update(+id, updateUserDto);
        }

        @Delete(':id')
        remove(@Param('id') id: string) {
            return this.userService.remove(+id);
        }
    }
    ```
5. 运行结果

    - 操作命令

        ![](/backend/senior/nest/050.png)
    - 数据结果

        ![](/backend/senior/nest/051.png)

## 4.3 事物

实现一个转账的扣钱与加钱动作



1. 新建模块

    ```sh
    nest g res manager
    ```

2. 修改实体类与注入orm映射

    - 实体类 manager.entity.ts

        ```ts
        import { Column, Entity, PrimaryGeneratedColumn } from "typeorm";

        @Entity()
        export class Manager {
            @PrimaryGeneratedColumn()
            id:number
            @Column()
            name:string
            @Column()
            money:number
        }
        ```

    - 模块类 manager.module.ts

        ```ts
        import { Module } from '@nestjs/common';
        import { ManagerService } from './manager.service';
        import { ManagerController } from './manager.controller';
        import {TypeOrmModule} from '@nestjs/typeorm'
        import { Manager } from './entities/manager.entity'

        @Module({
            imports:[TypeOrmModule.forFeature([Manager])],
            controllers: [ManagerController],
            providers: [ManagerService],
        })
        export class ManagerModule {}
        ```

3. 使用事物进行加钱减钱

    - dto参数 create-manager.dto.ts

        ```ts
        export class CreateManagerDto {
            name:string;
            money:number;
        }

        export class TransferMoneyDto {
            fromId:number;  // 发起人
            toId:number;    // 接收人
            money:number;   // 转账人
        }
        ```

    - controller 

        ```ts
        import { Controller, Get, Post, Body, Patch, Param, Delete } from '@nestjs/common';
        import { ManagerService } from './manager.service';
        import { TransferMoneyDto } from './dto/create-manager.dto';

        @Controller('manager')
        export class ManagerController {
        constructor(private readonly managerService: ManagerService) {}

            @Post('/transferMoney')
            transferMoney(@Body() transferMoneyDto: TransferMoneyDto) {
                return this.managerService.transferMoney(transferMoneyDto);
            }

        }
        ```
    - service 含有调用事物

        ```ts
        import { Injectable } from '@nestjs/common';
        import { TransferMoneyDto } from './dto/create-manager.dto';
        import { InjectRepository } from '@nestjs/typeorm';
        import { Manager } from './entities/manager.entity';
        import { Repository } from 'typeorm';

        @Injectable()
        export class ManagerService {
            constructor(
                @InjectRepository(Manager) private readonly money: Repository<Manager>,
            ) {}

            async transferMoney(transferMoneyDto: TransferMoneyDto) {
                console.log(transferMoneyDto, 1);
                try {
                    // .manager 服务
                    // .manager.transaction 事物
                    return this.money.manager.transaction(async (manager) => {
                        let from = await this.money.findOne({
                            where: { id: transferMoneyDto.fromId },
                        });
                        let to = await this.money.findOne({
                            where: { id: transferMoneyDto.toId },
                        });
                        if (!from || !to) {
                            throw new Error('用户查询错误');
                        }

                        if (from.money >= transferMoneyDto.money) {
                            // 减钱
                            manager.save(Manager, {
                                id: transferMoneyDto.fromId,
                                money: from.money - transferMoneyDto.money,
                            });
                            // 加钱
                            manager.save(Manager, {
                                id: transferMoneyDto.toId,
                                money: to.money + transferMoneyDto.money,
                            });

                            return {
                                messsage: '转账成功',
                            };
                        } else {
                            return {
                                messsage: '余额不足',
                            };
                        }
                    });
                } catch (error) {
                    throw new Error(error);
                }
            }
        }
        ```

4. 运行结果

    - 转账前

        ![](/backend/senior/nest/052.png)
    - 调用接口进行转账

        ![](/backend/senior/nest/053.png)
    - 转账后

        ![](/backend/senior/nest/054.png)
