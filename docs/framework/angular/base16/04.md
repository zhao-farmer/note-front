# 四、数据管理

## 4.1 Getter 方法 (类似计算属性)

Getter 方法是 Angular 中最接近 Vue 计算属性的实现方式，它提供了一种声明式的方式来定义派生数据。

### 4.1.1 基本用法

1. 代码

    ```ts
    import { Component } from '@angular/core';

    @Component({
        selector: 'getter-01',
        template: `
            <h2>用户信息</h2>
            <p>全名: {{ fullName }}</p>
            <p>年龄: {{ age }} 岁</p>
            <p>出生年份: {{ birthYear }}</p>
        `,
    })
    export class Getter01Component {
        firstName = '张';
        lastName = '三';
        age = 30;

        // Getter 方法 - 计算全名
        get fullName(): string {
            return `${this.lastName}${this.firstName}`;
        }

        // Getter 方法 - 计算出生年份
        get birthYear(): number {
            const currentYear = new Date().getFullYear();
            return currentYear - this.age;
        }
    }

    ```
2. 路由

    ```ts
    {
        path: 'getter',
        children: [
            { path: '01',component: Getter01Component, title: '基本用法' },
        ],
    },
    ```
3. 运行结果

    ![](/framework/angular/base16/032.png)

### 4.1.2 带参数的 Getter 方法

1. 代码

    ```ts
    import { Component } from '@angular/core';

    @Component({
        selector: 'getter-02',
        template: `
            <div *ngFor="let product of products">
            <h3>{{ product.name }}</h3>
            <p>折扣价: {{ getDiscountedPrice(product) | currency }}</p>
            </div>
        `,
    })
    export class Getter02Component {
        discountRate = 0.8;
        products = [
            { id: 1, name: '笔记本', price: 5000 },
            { id: 2, name: '手机', price: 3000 },
        ];

        // 返回计算函数
        get getDiscountedPrice(): (product: any) => number {
            return (product) => product.price * this.discountRate;
        }
    }

    ```
2. 路由

    ```ts
     {
        path: 'getter',
        children: [
            { path: '01',component: Getter01Component, title: '基本用法' },
            { path: '02',component: Getter02Component, title: '带参数的 Getter 方法' },
        ],
    },
    ```
3. 运行结果

    ![](/framework/angular/base16/033.png)

### 4.1.3 缓存计算结果

1. 代码

    ```ts
    import { Component } from '@angular/core';

    @Component({
        selector: 'getter-03',
        template: `
            <p>斐波那契数列第 {{ n }} 项: {{ fibonacci }}</p>
            <button (click)="n = n + 1">下一项</button>
        `,
    })
    export class Getter03Component {
        private _fibCache = new Map<number, number>();
        n = 10;

        get fibonacci(): number {
            return this.calculateFib(this.n);
        }

        private calculateFib(n: number): number {
            if (this._fibCache.has(n)) {
                return this._fibCache.get(n)!;
            }

            if (n <= 1) {
                this._fibCache.set(n, n);
                return n;
            }

            const result = this.calculateFib(n - 1) + this.calculateFib(n - 2);
            this._fibCache.set(n, result);
            return result;
        }
    }

    ```
2. 路由

    ```ts
     {
        path: 'getter',
        children: [
            { path: '01',component: Getter01Component, title: '基本用法' },
            { path: '02',component: Getter02Component, title: '带参数的 Getter 方法' },
            { path: '03',component: Getter03Component, title: '缓存计算结果' },
        ],
    },
    ```
3. 运行结果

    ![](/framework/angular/base16/034.gif)

## 4.2 管道

管道(Pipe)是 Angular 中用于格式化数据的强大工具，可以在模板中直接转换数据显示格式。

使用管道的组件一定要注册，才能使用

### 4.2.1 常用管道

1. 常用内置管道

    ```html
    <!-- 日期格式化 -->
    <p>{{ currentDate | date:'yyyy-MM-dd HH:mm:ss' }}</p>

    <!-- 货币格式化 -->
    <p>{{ price | currency:'CNY':'symbol':'1.2-2' }}</p>

    <!-- 数字格式化 -->
    <p>{{ numberValue | number:'1.2-2' }}</p>

    <!-- 百分比格式化 -->
    <p>{{ completionRate | percent:'1.2-2' }}</p>

    <!-- 大写/小写转换 -->
    <p>{{ 'hello' | uppercase }}</p>
    <p>{{ 'WORLD' | lowercase }}</p>

    <!-- JSON格式化(调试用) -->
    <pre>{{ object | json }}</pre>

    <!-- 切片(数组或字符串) -->
    <p>{{ 'abcdefg' | slice:1:4 }}</p> <!-- 输出: bcd -->
    ```

2. 参数说明
    - date 管道格式参数：
        - 处理 `new Date()`
    - currency 管道参数：
        - 第一个参数：货币代码 (如 'USD', 'CNY')
        - 第二个参数：显示符号还是代码 ('symbol' 或 'code')
        - 第三个参数：数字格式
    - number 和 percent 管道参数：
        - '整数位最小数.小数位最小数-小数位最大数'
        - 例如 '1.2-2' 表示至少1位整数，至少2位小数，最多2位小数

3. 代码

    ```ts
    import { Component } from '@angular/core';

    @Component({
        selector: 'pipe-01',
        template: `
            <h2>管道示例</h2>
            <p>原始日期: {{ currentDate }}</p>
            <p>格式化日期: {{ currentDate | date : 'yyyy年MM月dd日 HH:mm:ss' }}</p>

            <p>原始价格: {{ product.price }}</p>
            <p>
            货币格式化: {{ product.price | currency : 'CNY' : 'symbol' : '1.2-2' }}
            </p>

            <p>原始文本: {{ longText }}</p>
            <p>截断文本: {{ longText | slice : 0 : 20 }}...</p>

            <p>JSON格式: {{ user | json }}</p>
        `,
    })
    export class Pipe01Component {
        currentDate = new Date();
        product = {
            name: '智能手机',
            price: 2999.99,
        };
        longText = 'Angular是一个由Google维护的开源前端框架，用于构建单页面应用程序。';
        user = {
            name: '李四',
            age: 30,
            address: {
            city: '北京',
            street: '朝阳区',
            },
        };
    }
    ```
4. 路由

    ```ts
    {
        path: 'pipe',
        children: [
            { path: '01',component: Pipe01Component, title: '基本用法' },
        ],
    },
    ```
5. 运行结果

    ![](/framework/angular/base16/035.png)

### 4.2.2 多参数管道与链式管道

1. 格式

    ```html
    <!-- 多个参数 -->
    <p>{{ currentDate | date:'fullDate':'UTC':'zh-Hans' }}</p>

    <!-- 链式管道 -->
    <p>{{ text | uppercase | slice:0:10 }}</p>
    ```

2. 代码示例

    ```ts
    import { Component } from '@angular/core';

    @Component({
        selector: 'pipe-02',
        template: `
            <div class="product-card">
                <!-- 多参数date管道 -->
                <div class="product-date">
                    上架时间: {{ product.releaseDate | date:'yyyy年MM月dd日':'UTC+8':'zh-Hans' }}
                </div>

                <h2>{{ product.name | uppercase }}</h2>

                <!-- 多参数currency管道 -->
                <div class="product-price">
                    价格: {{ product.price | currency:'CNY':'symbol':'1.2-2' }}
                    <span class="original-price">
                    (原价: {{ product.originalPrice | currency:'CNY':'symbol':'1.0-0' }})
                    </span>
                </div>

                <!-- 链式管道：number → uppercase -->
                <div class="product-rating">
                    评分: {{ product.rating | number:'1.1-1' | uppercase }}
                </div>

                <!-- 链式管道：date → slice → lowercase -->
                <div class="product-update">
                    最后更新: {{ product.lastUpdated | date:'medium' | slice:0:10 | lowercase }}
                </div>

                <!-- 多参数percent管道 -->
                <div class="product-discount">
                    折扣力度: {{ product.discount | percent:'1.0-2' }}
                </div>

                <!-- 复杂链式管道：json → slice → uppercase -->
                <div class="product-specs">
                    规格: {{ product.specifications | json | slice:0:30 | uppercase }}...
                </div>
            </div>
        `,
        styles: [`
            .product-card {
                border: 1px solid #ddd;
                padding: 20px;
                margin: 15px;
                max-width: 400px;
                font-family: Arial, sans-serif;
            }
            .product-date {
                color: #666;
                font-size: 0.9em;
                margin-bottom: 5px;
            }
            h2 {
                color: #333;
                margin: 10px 0;
            }
            .product-price {
                color: #e53935;
                font-weight: bold;
                font-size: 1.2em;
            }
            .original-price {
                color: #999;
                font-size: 0.9em;
                text-decoration: line-through;
            }
            .product-rating {
                color: #ff9800;
                margin: 8px 0;
            }
            .product-update {
                color: #2196f3;
                font-size: 0.9em;
            }
            .product-discount {
                color: #4caf50;
                font-weight: bold;
            }
            .product-specs {
                margin-top: 10px;
                color: #795548;
                font-family: monospace;
            }
        `]
    })
    export class Pipe02Component {
        product = {
            name: 'angular 高级编程指南',
            price: 89.99,
            originalPrice: 99.99,
            rating: 4.8723,
            discount: 0.1, // 10%折扣
            releaseDate: '2023-05-15T08:00:00Z',
            lastUpdated: '2023-10-20T14:30:00Z',
            specifications: {
                pages: 356,
                language: '中文',
                publisher: '技术出版社',
                ISBN: '978-7-121-45678-9'
            }
        };
    }
    ```
3. 示例解析
    1. 多参数管道使用
        - date 管道：

            ```js
            {{ product.releaseDate | date:'yyyy年MM月dd日':'UTC+8':'zh-Hans' }}
            ```

            参数1：格式字符串 'yyyy年MM月dd日'

            参数2：时区 'UTC+8'

            参数3：本地化 'zh-Hans'

        - currency 管道：

            ```js
            {{ product.price | currency:'CNY':'symbol':'1.2-2' }}
            ```

            参数1：货币代码 'CNY'

            参数2：显示方式 'symbol' (显示¥符号)

            参数3：数字格式 '1.2-2' (至少1位整数，精确到2位小数)

    2. 链式管道使用
        
        - number → uppercase：

            ```js
            {{ product.rating | number:'1.1-1' | uppercase }}
            ```

            先通过 number 管道格式化为1位小数

            再通过 uppercase 转为大写

        - date → slice → lowercase：

            ```js
            {{ product.lastUpdated | date:'medium' | slice:0:10 | lowercase }}
            ```
    
            先通过 date 格式化为中等长度日期

            再通过 slice 取前10个字符

            最后通过 lowercase 转为小写

    3. 复杂链式管道
        
        - json → slice → uppercase：

            ```js
            {{ product.specifications | json | slice:0:30 | uppercase }}
            ```

            先通过 json 管道转为JSON字符串

            再通过 slice 取前30个字符

            最后通过 uppercase 转为大写
4. 路由

    ```ts
     {
        path: 'pipe',
        children: [
            { path: '01',component: Pipe01Component, title: '基本用法' },
            { path: '02',component: Pipe02Component, title: '复杂管道' },
        ],
    },
    ```
5. 运行结果

    ![](/framework/angular/base16/036.png)

### 4.2.3 管道异步数据
    
1. 代码

    ```ts
    import { Component } from '@angular/core';
    import { Observable, of } from 'rxjs';
    import { delay } from 'rxjs/operators';

    @Component({
        selector: 'pipe-03',
        template: `
            <h2>异步数据展示</h2>

            <div *ngIf="userData$ | async as user; else loading">
                <p>姓名: {{ user.name }}</p>
                <p>角色: {{ user.role }}</p>
            </div>

            <ng-template #loading>
                <p>加载中...</p>
            </ng-template>

            <h3>消息列表</h3>
            <ul>
                <li *ngFor="let message of messages$ | async">
                    {{ message }}
                </li>
            </ul>
        `
    })
    export class Pipe03Component {
        userData$: Observable<any>;
        messages$: Observable<string[]>;

        constructor() {
            // 模拟异步数据
            this.userData$ = of({
                name: '王五',
                role: '管理员'
            }).pipe(delay(2000)); // 延迟2秒模拟网络请求

            this.messages$ = of([
                '系统维护通知',
                '新版本发布',
                '安全提醒'
            ]).pipe(delay(1000));
        }
    }
    ```
2. 路由

    ```ts
    {
        path: 'pipe',
        children: [
            { path: '01',component: Pipe01Component, title: '基本用法' },
            { path: '02',component: Pipe02Component, title: '复杂管道' },
            { path: '03',component: Pipe03Component, title: '管道异步数据' },
        ],
    },
    ```
3. 运行结果

    ![](/framework/angular/base16/037.gif)

### 4.2.4 自定义管道

1. 代码

    ```ts
    import { Pipe, PipeTransform,Component } from '@angular/core';

    @Pipe({
        name: 'truncate'
    })
    export class TruncatePipe implements PipeTransform {
        transform(value: string, limit: number = 10, ellipsis: string = '...'): string {
            if (!value) return '';
            return value.length > limit
            ? value.substring(0, limit) + ellipsis
            : value;
        }
    }

    @Component({
        selector: 'app-parent-04',
        template: `
            <p>{{ longText | truncate:20:'...更多' }}</p>
        `
    })
    export class Pipe04Component {
        longText = 'Angular是一个由Google维护的开源前端框架，用于构建单页面应用程序。';
    }

    ```
2. 路由

    ```ts
    {
        path: 'pipe',
        children: [
            { path: '01',component: Pipe01Component, title: '基本用法' },
            { path: '02',component: Pipe02Component, title: '复杂管道' },
            { path: '03',component: Pipe03Component, title: '管道异步数据' },
            { path: '04',component: Pipe04Component, title: '自定义管道' },
        ],
    },
    ```
3. 运行结果

    ![](/framework/angular/base16/038.png)

## 4.3 RXJS

### 4.3.1 搜索框防抖

1. 代码

    ```ts
    import { Component, ElementRef, ViewChild, AfterViewInit } from '@angular/core';
    import { fromEvent } from 'rxjs';
    import { debounceTime, distinctUntilChanged, switchMap } from 'rxjs/operators'

    @Component({
        selector: 'rxjs-01',
        template: `
            <input #searchInput placeholder="搜索...">
            <ul>
                <li *ngFor="let item of results">{{ item }}</li>
            </ul>
        `
    })
    export class Rxjs01Component implements AfterViewInit {

    @ViewChild('searchInput') input!: ElementRef;
        results: string[] = [];

        // 页面组件加载完成后调用
        ngAfterViewInit() {
            fromEvent(this.input.nativeElement, 'input').pipe(
                debounceTime(300),
                distinctUntilChanged(),
                switchMap((e: any) => this.searchApi(e.target.value))
            ).subscribe(data => this.results = data);
        }

        searchApi(term: string): Promise<string[]> {
            // 实际项目中替换为真实HTTP请求
            return new Promise(resolve => {
                setTimeout(() => resolve([`${term}结果1`, `${term}结果2`]), 500);
            });
        }
    }

    ```
2. 路由

    ```ts
    {
        path: 'rxjs',
        children: [
            { path: '01',component: Rxjs01Component, title: '搜索框防抖' },
        ],
    },
    ```
3. 运行结果

    ![](/framework/angular/base16/039.gif)

### 4.3.2 多数据源合并

1. json-server 数据源

    ```json
    {
        "users-count":50,
        "orders-count":1980
    }
    ```
2. 入口模块开启http

    ```ts
    import { HttpClientModule } from '@angular/common/http';

    @NgModule({
        imports: [
            HttpClientModule,
        ],
    })
    export class AppModule { }
    ```

3. 代码

    ```ts
    import { Component } from '@angular/core';
    import { forkJoin } from 'rxjs';
    import { HttpClient } from '@angular/common/http';

    @Component({
        selector: 'rxjs-01',
        template: `
            <div *ngIf="loading">加载中...</div>
            <div *ngIf="!loading">
            <p>用户数: {{ stats.users }}</p>
            <p>订单数: {{ stats.orders }}</p>
            </div>
        `
    })
    export class Rxjs02Component {
        stats = { users: 0, orders: 0 };
        loading = true;

        constructor(private http: HttpClient) {}

        ngOnInit() {
            forkJoin({
                users: this.http.get<number>('http://localhost:3000/users-count'),
                orders: this.http.get<number>('http://localhost:3000/orders-count')
            }).subscribe({
                next: res => {
                    this.stats = res;
                    this.loading = false;
                },
                error: () => this.loading = false
            });
        }
    }
    ```
4. 路由

    ```ts
    {
        path: 'rxjs',
        children: [
            { path: '01',component: Rxjs01Component, title: '搜索框防抖' },
            { path: '02',component: Rxjs02Component, title: '合并数据' },
        ],
    },
    ```
5. 运行结果

    ![](/framework/angular/base16/042.png)

### 4.3.3 组件通信服务

1. 通信组件

    ```ts
    // message.service.ts
    import { Injectable } from '@angular/core';
    import { Subject } from 'rxjs';

    @Injectable({ providedIn: 'root' })
    export class MessageService {
        // subject类型
        private messageSubject = new Subject<string>();

        // 对外暴露只读Observable
        messages$ = this.messageSubject.asObservable();

        send(message: string) {
            this.messageSubject.next(message);
        }
    }
    ```

2. 使用组件(同一页面才能进行通信)

    ```ts
    import { Component, OnInit, OnDestroy,ViewChild,ElementRef } from '@angular/core';
    import { MessageService } from '../message.service';
    import { Subscription } from 'rxjs';

    @Component({
        selector: 'rxjs-sender',
        template: `
            <input type="text" #content>
            <button (click)="send()">发送消息</button>
        `,
    })
    export class SenderComponent {

        // 依赖注入
        constructor(private messageService: MessageService) {}

        // 使用ref 绑定对象
        @ViewChild('content') contentStr!: ElementRef;

        // 通过中间的消息组件进行发送
        send() {
            this.messageService.send(this.contentStr.nativeElement.value);
        }
    }

    @Component({
        selector: 'rxjs-receiver',
        template: `<div>收到: {{ message }}</div>`,
    })
    export class ReceiverComponent implements OnInit, OnDestroy {
        message = '';

        // rxjs的 Subscription 对象
        private sub: Subscription = new Subscription();

        // 依赖注入
        constructor(private messageService: MessageService) {}

        // 初始化后绑定监控
        ngOnInit() {
            this.sub =  this.messageService.messages$.subscribe(value => {
                this.message = value
            }
            );
        }
        // 页面销毁后 同样销毁
        ngOnDestroy() {
            this.sub.unsubscribe();
        }
    }

    // 这种兄弟组件的通信 只有同一个页面中才能使用
    @Component({
        template: `
            <rxjs-sender/>
            <hr>
            <rxjs-receiver/>
        `,
    })
    export class Rxjs03Component{}
    ```

3. 路由

    ```ts
    {
        path: 'rxjs',
        children: [
            { path: '01',component: Rxjs01Component, title: '搜索框防抖' },
            { path: '02',component: Rxjs02Component, title: '合并数据' },
            { path: '03',component: Rxjs03Component, title: '兄弟组件通信' },
        ],
    },
    ```
4. 运行结果

    ![](/framework/angular/base16/043.gif)

### 4.3.4 自动取消订阅

1. 代码

    ```ts
    import { Component, OnDestroy } from '@angular/core';
    import { interval, Subject } from 'rxjs';
    import { takeUntil } from 'rxjs/operators';

    @Component({
    template: `计数: {{ count }}`
    })
    export class Rxjs04Component implements OnDestroy {
        count = 0;
        private destroy$ = new Subject<void>();

        constructor() {
            interval(1000).pipe(
            takeUntil(this.destroy$)
            ).subscribe(() => this.count++);
        }

        ngOnDestroy() {
            this.destroy$.next();
            this.destroy$.complete();
        }
    }
    ```
2. 路由

    ```ts
    {
        path: 'rxjs',
        children: [
            { path: '01',component: Rxjs01Component, title: '搜索框防抖' },
            { path: '02',component: Rxjs02Component, title: '合并数据' },
            { path: '03',component: Rxjs03Component, title: '兄弟组件通信' },
            { path: '04',component: Rxjs04Component, title: '自动取消订阅' },
        ],
    },
    ```


### 4.3.5 表单值变化监听

1. 添加配置

    ```ts
    import { NgModule } from '@angular/core';
    import { ReactiveFormsModule } from '@angular/forms'; // 添加这行

    @NgModule({
        imports: [
            // 其他模块...
            ReactiveFormsModule // 添加这行
        ],
        // 其他配置...
    })
    export class AppModule { }
    ```

2. 代码

    ```ts
    import { Component } from '@angular/core';
    import { FormControl } from '@angular/forms';

    @Component({
        selector: 'rxjs-05',
        template: `
            <input [formControl]="searchControl">
            <p>当前值: {{ searchValue }}</p>
        `
    })
    export class Rxjs05Component {
        searchControl = new FormControl('');
        searchValue: string | null = "";

        constructor() {
            this.searchControl.valueChanges.subscribe(value =>
            this.searchValue = value
            );
        }
    }

    ```
3. 路由

    ```ts
    {
        path: 'rxjs',
        children: [
            { path: '01',component: Rxjs01Component, title: '搜索框防抖' },
            { path: '02',component: Rxjs02Component, title: '合并数据' },
            { path: '03',component: Rxjs03Component, title: '兄弟组件通信' },
            { path: '04',component: Rxjs04Component, title: '自动取消订阅' },
            { path: '05',component: Rxjs05Component, title: ' 表单值变化监听' },
        ],
    },
    ```

4. 运行结果

    ![](/framework/angular/base16/044.gif)

## 4.4 信号(Signals)

### 4.4.1 认识Signals

Angular 16 引入了全新的响应式原语 Signals，这是一种更高效、更直观的状态管理方式。


1. Signals 基础

    -  创建 Signal

        ```ts
        import { signal } from '@angular/core';

        // 创建可写Signal
        count = signal(0);

        // 创建带有复杂对象的Signal
        user = signal({ name: '张三', age: 30 });

        // 创建只读Signal
        readonly title = signal('Angular 16');
        ```

    - 读取 Signal 值

        ```ts
        // 在组件类中读取
        currentCount = this.count();

        // 在模板中读取
        <p>{{ count() }}</p>
        ```

    - 更新 Signal

        ```ts
        // 设置新值
        this.count.set(5);

        // 基于前值更新
        this.count.update(prev => prev + 1);

        // 更新对象Signal的部分属性
        this.user.mutate(user => {
            user.age = 31;
        });
        ```

2. 计算 Signal (Computed)

    ```ts
    import { computed } from '@angular/core';

    // 基于其他Signal计算
    doubleCount = computed(() => this.count() * 2);

    // 复杂计算
    userDescription = computed(() => {
        const user = this.user();
        return `${user.name} (${user.age}岁)`;
    });
    ```

3. Effect 副作用

    ```ts
    import { effect } from '@angular/core';

    // 基本effect
    effect(() => {
        console.log('当前计数:', this.count());
    });

    // 带清理函数的effect
    effect((onCleanup) => {
        const timer = setTimeout(() => {
            // 延迟操作
        }, 1000);
        
        onCleanup(() => clearTimeout(timer));
    });
    ```

4. 与模板集成

    - 直接在模板中使用

        ```html
        <div>
            <h2>{{ title() }}</h2>
            <p>计数: {{ count() }}</p>
            <p>双倍计数: {{ doubleCount() }}</p>
            
            <button (click)="count.update(c => c + 1)">增加</button>
        </div>
        ```

    - 与指令配合

        ```html
        <div *ngIf="user().age >= 18; else minorBlock">
            欢迎成人用户
        </div>

        <ng-template #minorBlock>
            未成年用户受限
        </ng-template>
        ```

5. 与 RxJS 互操作

    -  Signal → Observable

        ```ts
        import { toObservable } from '@angular/core/rxjs-interop';

        count$ = toObservable(this.count);

        // 使用RxJS操作符
        filteredCount$ = this.count$.pipe(
            filter(count => count > 5)
        );
        ```

    - Observable → Signal

        ```ts
        import { toSignal } from '@angular/core/rxjs-interop';

        data = toSignal(this.http.get('/api/data'), { initialValue: [] });
        ```
### 4.4.2 示例：购物车

1. 代码

    ```ts
    import { Component, signal, computed } from '@angular/core';

    interface CartItem {
        id: number;
        name: string;
        price: number;
        quantity: number;
    }

    @Component({
        selector: 'signal-01',
        template: `
            <h2>购物车</h2>
            <ul>
                <li *ngFor="let item of items()">
                    {{ item.name }} - {{ item.price | currency }}
                    <button (click)="updateQuantity(item.id, -1)">-</button>
                    {{ item.quantity }}
                    <button (click)="updateQuantity(item.id, 1)">+</button>
                </li>
            </ul>

            <div>总价: {{ totalPrice() | currency }}</div>
            <div *ngIf="hasDiscount()">折扣价: {{ discountedPrice() | currency }}</div>
        `,
    })
    export class Signal01Component {
        items = signal<CartItem[]>([
            { id: 1, name: 'Angular书', price: 99, quantity: 1 },
            { id: 2, name: 'RxJS指南', price: 89, quantity: 2 },
        ]);

        discount = signal(0.1); // 10%折扣

        // 计算属性
        totalPrice = computed(() =>
            this.items().reduce((sum, item) => sum + item.price * item.quantity, 0)
        );

        discountedPrice = computed(() => this.totalPrice() * (1 - this.discount()));

        hasDiscount = computed(() => this.discount() > 0);

        // 操作方法
        updateQuantity(id: number, change: number) {
            this.items.update((items) =>
                items.map((item) =>
                    item.id === id ? { ...item, quantity: item.quantity + change } : item
                ).filter((item) => item.quantity > 0)
            );
        }
    }

    ```
2. 路由

    ```ts
    {
        path: 'signal',
        component: Signal01Component,
        title: '案例：购物车'
    }
    ```
3. 运行结果

    ![](/framework/angular/base16/045.gif)










## 4.5 投影（类似插槽）

### 4.5.1 单插槽投影

最简单的投影形式是使用 `<ng-content>` 标签：

1. 代码

    ```ts
    import { Component } from '@angular/core';

    // 子组件
    @Component({
        selector: 'projection-01-child',
        template: `
            <div class="child-component">
            <h2>子组件标题</h2>
            <ng-content></ng-content>
            </div>
        `
    })
    export class Projection01ChildComponent {}

    // 父组件内容填充到子组件
    @Component({
        selector: 'projection-01',
        template: `
            <projection-01-child>
                <p>这是投影到子组件中的内容</p>
            </projection-01-child>
        `,
    })
    export class Projection01Component {}

    ```

2. 路由

    ```ts
    {
        path: 'projection',
        children: [
            { path: '01',component: Projection01Component, title: '单插槽投影' },
        ],
    },
    ```

3. 运行结果

    ![](/framework/angular/base16/047.png)

### 4.5.2 多插槽投影

Angular 支持多个投影位置，通过 select 属性指定：

1. 代码

    ```ts
    import { Component } from '@angular/core';

    // 子组件
    @Component({
        selector: 'projection-02-child',
        template: `
            <div class="card">
                <div class="header">
                    <ng-content select="[card-header]"></ng-content>
                </div>
                <div class="content">
                    <ng-content select="[card-content]"></ng-content>
                </div>
                <div class="footer">
                    <ng-content select="[card-footer]"></ng-content>
                </div>
            </div>
        `
    })
    export class Projection02ChildComponent {}

    // 父组件内容填充到子组件
    @Component({
        selector: 'projection-02',
        template: `
            <projection-02-child>
            <div card-header>卡片标题</div>
            <div card-content>卡片内容...</div>
            <div card-footer>卡片页脚</div>
            </projection-02-child>
        `,
    })
    export class Projection02Component {}
    ```

2. 路由

    ```ts
    {
        path: 'projection',
        children: [
            { path: '01',component: Projection01Component, title: '单插槽投影' },
            { path: '02',component: Projection02Component, title: '多插槽投影' },
        ],
    },
    ```

3. 运行结果

    ![](/framework/angular/base16/048.png)

### 4.5.3 条件投影

有时我们需要根据条件决定是否投影内容

1. 代码

    ```ts
   import { Component } from '@angular/core';

    // 子组件
    @Component({
        selector: 'projection-03-child',
        template: `
            <button (click)="showContent = !showContent">切换内容</button>
            <div *ngIf="showContent">
                <ng-content></ng-content>
            </div>
        `
    })
    export class Projection03ChildComponent {
        showContent:boolean = true
    }

    // 父组件内容填充到子组件
    @Component({
        selector: 'projection-02',
        template: `
            <projection-03-child>
                <p>按条件展示内容</p>
            </projection-03-child>
        `,  
    })
    export class Projection03Component {}

    ```

2. 路由

    ```ts
    {
        path: 'projection',
        children: [
            { path: '01',component: Projection01Component, title: '单插槽投影' },
            { path: '02',component: Projection02Component, title: '多插槽投影' },
            { path: '03',component: Projection03Component, title: '按条件投影' },
        ],
    },
    ```

3. 运行结果

    ![](/framework/angular/base16/049.gif)
