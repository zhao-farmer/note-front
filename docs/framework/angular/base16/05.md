# 五、装饰器

## 5.1 依赖注入

### 5.1.1 认识依赖注入

1. 基本概念

    - 什么是依赖注入
        
        依赖注入是一种设计模式，它将对象的创建与其使用分离。在Angular中，这意味着：

        - 组件/服务不需要自己创建依赖项
        - 依赖关系由Angular的注入器系统管理
        - 依赖项可以被替换或模拟，便于测试

    - 注入器层次结构

        Angular有一个多级注入器系统：

        - 模块级注入器 - 每个@NgModule都有自己的注入器
        - 组件级注入器 - 每个组件也有自己的注入器，继承自模块注入器

2. 基本用法

    1. 服务提供

        ```ts
        import { Injectable } from '@angular/core';

        @Injectable({
            providedIn: 'root' // 在根注入器中提供
        })
        export class DataService {
            // 服务逻辑
        }
        ```

        - providedIn选项有几种可能的值：
            - 'root' - 应用级单例
            - 'platform' - 特殊单例，共享于同一页面上的多个应用
            - 'any' - 每个惰性加载模块都会得到自己的实例
            - 特定模块 - 只在特定模块中提供

    2. 组件/指令中的注入

        ```ts
        import { Component } from '@angular/core';
        import { DataService } from './data.service';

        @Component({
            selector: 'app-example',
            template: `...`
        })
        export class ExampleComponent {
            constructor(private dataService: DataService) {}
        }
    ```

2. 高级用法


    1. 多级提供者

        ```ts
        @Component({
            selector: 'app-child',
            template: `...`,
            providers: [DataService] // 为组件及其子组件提供新实例
        })
        export class ChildComponent {}
        ```

    2. 使用InjectionToken
    对于非类依赖，可以使用InjectionToken：

    ```ts
        import { InjectionToken } from '@angular/core';

        export const API_URL = new InjectionToken<string>('api.url');

        // 在模块中提供
        @NgModule({
        providers: [
            { provide: API_URL, useValue: 'https://api.example.com' }
        ]
        })
        export class AppModule {}

        // 在使用处注入
        constructor(@Inject(API_URL) private apiUrl: string) {}
    ```
    3. 工厂提供者

        ```ts
        @NgModule({
            providers: [
                {
                provide: DataService,
                useFactory: (http: HttpClient, config: AppConfig) => {
                    return new DataService(http, config.apiUrl);
                },
                deps: [HttpClient, AppConfig]
                }
            ]
        })
        export class AppModule {}
        ```

    4. 可选依赖
        ```ts
        import { Optional } from '@angular/core';

        constructor(@Optional() private optionalService: OptionalService) {}
        ```
### 5.1.2 使用案例展示

1. 创建项目结构



    ```md
    src/ 
    ├── app/
    │   ├── services/    
    │   │   ├── data.service.ts 
    │   │   ├── logger.service.ts 
    │   │   └── config.ts
    │   ├── components/  
    │   │   ├── child.component.ts
    │   │   ├── parent.component.ts
    │   │   └──standalone.component.ts      
    │   ├── app.component.ts   
    └── └── app.module.ts     
    ```




2. 实现服务和配置

    - 非类依赖 - 配置令牌 (config.ts)

        ```ts
        import { InjectionToken } from '@angular/core';

        // 定义非类依赖的InjectionToken
        export const APP_CONFIG = new InjectionToken<AppConfig>('app.config');

        export interface AppConfig {
            apiUrl: string;
            production: boolean;
            maxRetries: number;
        }

        export const DEFAULT_CONFIG: AppConfig = {
            apiUrl: 'https://api.example.com',
            production: false,
            maxRetries: 3
        };
        ```

    - 基础服务 (logger.service.ts)

        ```ts
        import { Injectable } from '@angular/core';

        @Injectable({
            providedIn: 'root'
        })
        export class LoggerService {
            log(message: string): void {
                console.log(`[LOG] ${message}`);
            }

            error(message: string): void {
                console.error(`[ERROR] ${message}`);
            }
        }
        ```

    -  数据服务 (data.service.ts)

        ```ts
        import { Injectable, Inject, Optional } from '@angular/core';
        import { APP_CONFIG, AppConfig } from './config';
        import { LoggerService } from './logger.service';

        @Injectable()
        export class DataService {
            private retryCount = 0;

            constructor(
                @Inject(APP_CONFIG) private config: AppConfig,
                private logger: LoggerService,
                @Optional() private extraService?: ExtraService
            ) {
                this.logger.log(`使用API初始化的DataService: ${config.apiUrl}`);
            }

            fetchData(): string {
                if (this.extraService) {
                    this.logger.log('使用附加的服务');
                }
                return `已获取数据 (重试计数: ${this.retryCount++})`;
            }
        }

        // 可选依赖的服务
        @Injectable()
        export class ExtraService {
            doSomething(): string {
                return 'Extra service action';
            }
        }
        ```
3. 实现组件

    - 父组件 (parent.component.ts)

        ```ts
        import { Component } from '@angular/core';
        import { DataService } from '../services/data.service';
        import { LoggerService } from '../services/logger.service';

        @Component({
        selector: 'app-parent',
            template: `
                <h2>父组件</h2>
                <p>{{ parentData }}</p>
                <app-child></app-child>
            `,
            providers: [
                // 组件级提供者 - 为这个组件及其子组件创建新的DataService实例
                DataService,
                LoggerService
            ]
        })
        export class ParentComponent {
            parentData: string;

            constructor(private dataService: DataService) {
                this.parentData = dataService.fetchData();
            }
        }
        ```

    - 子组件 (child.component.ts)

        ```ts
        import { Component } from '@angular/core';
        import { DataService } from '../services/data.service';
        import { LoggerService } from '../services/logger.service';

        @Component({
            selector: 'app-child',
            template: `
                <h3>子组件</h3>
                <p>{{ childData }}</p>
                <p>与父实例相同? {{ isSameInstance }}</p>
            `
        })
        export class ChildComponent {
            childData: string;
            isSameInstance: boolean;

            constructor(
                private dataService: DataService,
                private parentDataService: DataService,
                private logger: LoggerService
            ) {
                this.childData = dataService.fetchData();
                this.isSameInstance = dataService === parentDataService;
                logger.log('Child component initialized');
            }
        }
        ```

    - 独立组件 (standalone.component.ts)

        ```ts
        import { Component, Optional } from '@angular/core';
        import { DataService } from '../services/data.service';
        import { APP_CONFIG, AppConfig, DEFAULT_CONFIG } from '../services/config';
        import { LoggerService } from '../services/logger.service';
        import { ExtraService } from '../services/data.service';
        import { CommonModule } from '@angular/common';

        @Component({
            selector: 'app-standalone',
            standalone: true,
            imports: [CommonModule],
            template: `
                <h2>独立组件</h2>
                <p>{{ standaloneData }}</p>
                <p>有服务模块? {{ hasExtraService }}</p>
            `,
            providers: [
                // 工厂提供者
                {
                    provide: DataService,
                    useFactory: (logger: LoggerService, config: AppConfig) => {
                        return new DataService(config, logger);
                    },
                    deps: [LoggerService, APP_CONFIG]
                },
                // 提供非类依赖
                { provide: APP_CONFIG, useValue: { ...DEFAULT_CONFIG, apiUrl: 'https://api.standalone.com' } },
                // 可选提供者
                ExtraService
            ]
        })
        export class StandaloneComponent {
            standaloneData: string;
            hasExtraService: boolean;

            constructor(
                private dataService: DataService,
                @Optional() private extraService?: ExtraService
            ) {
                this.standaloneData = dataService.fetchData();
                this.hasExtraService = !!extraService;
            }
        }
        ```

4. 配置应用模块 (app.module.ts)

    ```ts
    import { NgModule } from '@angular/core';
    import { BrowserModule } from '@angular/platform-browser';
    import { APP_CONFIG, DEFAULT_CONFIG } from './services/config';
    import { LoggerService } from './services/logger.service';

    import { AppComponent } from './app.component';
    import { ParentComponent } from './components/parent.component';
    import { ChildComponent } from './components/child.component';
    import { StandaloneComponent } from './components/standalone.component';

    @NgModule({
        declarations: [
            AppComponent,
            ParentComponent,
            ChildComponent
        ],
        imports: [
            BrowserModule,
            StandaloneComponent // 导入独立组件
        ],
        providers: [
            // 根级提供者
            LoggerService,

            // 非类依赖提供
            { provide: APP_CONFIG, useValue: DEFAULT_CONFIG },

            // 工厂提供者示例
            {
            provide: 'API_KEY',
            useFactory: () => {
                return localStorage.getItem('apiKey') || 'default-key';
            }
            }
        ],
        bootstrap: [AppComponent]
    })
    export class AppModule { }
    ```

5. 主组件 (app.component.ts)

    ```ts
    import { Component, Inject } from '@angular/core';
    import { APP_CONFIG, AppConfig } from './services/config';
    import { LoggerService } from './services/logger.service';

    @Component({
        selector: 'app-root',
        template: `
            <h1>Angular DI Demo</h1>
            <app-parent></app-parent>
            <app-standalone></app-standalone>
            <hr>
            <p>根URL地址: {{ apiUrl }}</p>
            <p>API Key: {{ apiKey }}</p>
        `
    })
    export class AppComponent {
        apiUrl: string;
        apiKey: string;

        constructor(
            @Inject(APP_CONFIG) private config: AppConfig,
            @Inject('API_KEY') private injectedApiKey: string,
            private logger: LoggerService
        ) {
            this.apiUrl = config.apiUrl;
            this.apiKey = injectedApiKey;
            this.logger.log('根组件已初始化');
        }
    }
    ```

6. 案例说明

    1.  **多级提供者**：
        
        *   `ParentComponent`提供了自己的`DataService`实例，`ChildComponent`会使用这个实例
            
        *   根模块和独立组件提供了不同的`APP_CONFIG`值
            
    2.  **非类依赖**：
        
        *   使用`InjectionToken`定义的`APP_CONFIG`配置对象
            
        *   使用字符串令牌`'API_KEY'`的简单示例
            
    3.  **工厂提供者**：
        
        *   独立组件中使用工厂函数创建`DataService`
            
        *   根模块中使用工厂函数获取`API_KEY`
            
    4.  **可选依赖**：
        
        *   `DataService`中可选注入`ExtraService`
            
        *   `StandaloneComponent`中可选注入`ExtraService`
            
    5.  **独立组件依赖注入**：
        
        *   展示了如何在独立组件中提供和使用依赖
            
7. 运行结果

    ![](/framework/angular/base16/046.png)

## 5.2 内置装饰器

Angular 提供了一系列内置装饰器，用于定义和配置应用程序的各个部分。

### 5.2.1 类装饰器


类装饰器用于修饰整个类，定义类的 Angular 特性。

1. @Component

    ```ts
    @Component({
        selector: 'app-user-profile',          // 组件选择器
        standalone: true,                     // 是否作为独立组件
        templateUrl: './user-profile.component.html', // 外部模板
        // 或使用内联模板
        // template: `<div>{{userName}}</div>`, 
        styleUrls: ['./user-profile.component.css'], // 外部样式
        // 或使用内联样式
        // styles: [`div { color: blue; }`],
        imports: [CommonModule, AvatarComponent], // 依赖导入
        changeDetection: ChangeDetectionStrategy.OnPush, // 变更检测策略
        providers: [UserService],              // 服务提供者
        encapsulation: ViewEncapsulation.ShadowDom // 样式封装
    })
    export class UserProfileComponent {
        // 组件逻辑
    }
    ```

2. @Directive

    ```ts
    @Directive({
    selector: '[appTooltip]',             // 指令选择器
        standalone: true,
        host: {                              // 宿主元素绑定
            '(mouseenter)': 'showTooltip()',
            '(mouseleave)': 'hideTooltip()',
            '[class.tooltip-active]': 'isActive'
        }
    })
    export class TooltipDirective {
        @Input() appTooltip = '';            // 输入属性
        isActive = false;

        showTooltip() { /* ... */ }
        hideTooltip() { /* ... */ }
    }
    ```

3. @Pipe

    ```ts
    @Pipe({
        name: 'filterArray',                  // 管道名称
        standalone: true,                     // 独立管道
        pure: false                           // 是否为纯管道
    })
    export class FilterArrayPipe implements PipeTransform {
        transform(items: any[], filterFn: (item: any) => boolean): any[] {
            return items.filter(filterFn);
        }
    }
    ```

4. @Injectable

    ```ts
    @Injectable({
        providedIn: 'root'                    // 服务提供范围
        // 或指定特定模块
        // providedIn: UserModule
    })
    export class UserService {
        // 服务逻辑
    }
    ```

5. @NgModule (传统方式，Angular 16仍支持)

    ```ts
    @NgModule({
        declarations: [UserComponent],        // 声明组件/指令/管道
        imports: [CommonModule],             // 导入模块
        exports: [UserComponent],            // 导出模块
        providers: [UserService]             // 提供服务
    })
    export class UserModule {}
    ```

### 5.2.2 成员装饰器

成员装饰器用于修饰类的属性或方法。

1. @Input

    ```ts
    // 基本用法
    @Input() userName: string;

    // 带默认值
    @Input() isActive = false;

    // 带别名
    @Input('user-id') userId: string;

    // 与Signal结合 (Angular 16+)
    @Input({ required: true }) 
    user = input<User>();  // 必需输入

    @Input() 
    count = input(0);     // 可选输入，默认值0
    ```

2. @Output

    ```ts
    // 基本用法
    @Output() saved = new EventEmitter<void>();

    // 带别名
    @Output('user-deleted') deleted = new EventEmitter<string>();

    // 与Signal结合 (Angular 16+)
    @Output() 
    countChanged = output<number>();  // 输出事件
    ```

3. @ViewChild / @ViewChildren

    ```ts
    // 获取DOM元素
    @ViewChild('submitBtn') 
    submitButton: ElementRef<HTMLButtonElement>;

    // 获取子组件
    @ViewChild(UserProfileComponent) 
    profileComponent: UserProfileComponent;

    // 获取多个元素
    @ViewChildren(ListItemComponent) 
    items: QueryList<ListItemComponent>;
    ```

4. @ContentChild / @ContentChildren

    ```ts
    // 获取投影内容
    @ContentChild(TemplateRef) 
    customTemplate: TemplateRef<any>;

    // 获取多个投影组件
    @ContentChildren(UserAvatarComponent) 
    avatars: QueryList<UserAvatarComponent>;
    ```

5. @HostBinding / @HostListener

    ```ts
    @HostBinding('class.active') 
    isActive = false;

    @HostBinding('attr.aria-label') 
    label = '用户卡片';

    @HostListener('click', ['$event'])
        onHostClick(event: MouseEvent) {
        console.log('宿主元素被点击', event);
    }

    @HostListener('window:resize')
        onWindowResize() {
        console.log('窗口大小改变');
    }
    ```

### 5.2.3 参数饰器

参数装饰器用于修饰类构造函数参数，主要控制依赖注入的行为。Angular 16 提供了多种参数装饰器来精确控制依赖注入的过程。


1. @Inject - 指定注入令牌

    ```ts
    import { Inject } from '@angular/core';

    constructor(
        @Inject('API_ENDPOINT') private apiUrl: string,
        @Inject(HttpClient) private http: HttpClient
    ) {}
    ```

    **使用场景**：

    *   注入非类类型的值（如字符串、配置对象）
    *   明确指定要注入的令牌
        

2. @Optional - 标记可选依赖

    ```ts
    import { Optional } from '@angular/core';

    constructor(
        @Optional() private logger?: LoggerService
    ) {
        if (this.logger) {
            this.logger.log('Component created');
        }
    }
    ```

    **特点**：

    *   如果依赖不存在，注入 `null` 或 `undefined`
        
    *   避免缺少必要依赖时抛出错误
        

3. @Self - 只从当前注入器查找

    ```ts
    import { Self } from '@angular/core';

    constructor(
        @Self() private formControl: NgControl
    ) {}
    ```

    **使用场景**：

    *   确保依赖来自当前组件/指令的注入器
        
    *   避免意外继承父注入器的服务
        

4. @SkipSelf - 跳过当前注入器

    ```ts
    import { SkipSelf } from '@angular/core';

    constructor(
        @SkipSelf() @Optional() private parentService?: ParentService
    ) {}
    ```

    **典型应用**：

    *   避免服务递归注入
        
    *   获取父组件的服务实例
        

5. @Host - 限制在宿主注入器查找

    ```ts
    import { Host } from '@angular/core';

    constructor(
        @Host() @Optional() private dialog?: DialogRef
    ) {}
    ```

    **特点**：

    *   在组件宿主元素级别查找依赖
        
    *   常用于指令获取宿主组件实例

### 5.2.4 综合案例

1. 用户资料

    - 组件 user-profile.component.ts

        ```ts
        import {
            Component, Input, Output, EventEmitter,
            ViewChild, ElementRef, HostListener,
            Inject, Optional, HostBinding, OnInit
        } from '@angular/core';

        @Component({
            selector: 'app-user-profile',
            templateUrl: './user-profile.component.html',
            styleUrls: ['./user-profile.component.css']
        })
        export class UserProfileComponent implements OnInit {
            // 1. 成员装饰器 - 输入属性
            @Input()
            userId!: number;

            // 2. 成员装饰器 - 输出事件
            @Output()
            profileUpdated = new EventEmitter<any>();

            // 3. 成员装饰器 - 视图查询
            @ViewChild('profileHeader', { static: true })
            profileHeader!: ElementRef<HTMLHeadingElement>;

            // 4. 成员装饰器 - 主机绑定
            @HostBinding('class.active')
            isActive = false;

            // 5. 成员装饰器 - 主机监听
            @HostListener('mouseenter')
            onMouseEnter() {
                this.isActive = true;
                console.log('鼠标进入');
            }

            @HostListener('mouseleave')
            onMouseLeave() {
                this.isActive = false;
                console.log('鼠标离开');
            }

            // 组件状态
            userData: any;
            isLoading = true;
            theme = 'light';

            constructor(
                // 6. 参数装饰器 - 依赖注入
                @Inject('API_ENDPOINT') private apiEndpoint: string,
                @Optional() @Inject('DEFAULT_THEME') private defaultTheme: string
            ) {
                this.theme = defaultTheme || 'light';
            }

            ngOnInit() {
                this.loadUserData();
                console.log('标题元素:', this.profileHeader.nativeElement);
            }

            async loadUserData() {
                try {
                    this.isLoading = true;
                    const response = await fetch(`${this.apiEndpoint}/users/${this.userId}`);
                    this.userData = await response.json();
                } catch (error) {
                    console.error('加载用户数据失败', error);
                } finally {
                    this.isLoading = false;
                }
            }

            updateProfile() {
                this.profileUpdated.emit({
                    userId: this.userId,
                    data: this.userData,
                    theme: this.theme
                });
            }

            changeTheme(newTheme: string) {
                this.theme = newTheme;
            }
        }

        ```
    - 页面

        ```html
        <div class="profile-container" [class.loading]="isLoading">
            <h2 #profileHeader>{{ userData?.userName || '加载中...' }}</h2>

            <div *ngIf="!isLoading" class="profile-content">
                <div class="profile-field">
                <label>用户名:</label>
                <span>{{ userData?.userName }}</span>
                </div>

                <div class="profile-field">
                <label>年龄:</label>
                <span>{{ userData?.age  }}</span>
                </div>

                <div class="profile-field">
                <label>主题:</label>
                <select [(ngModel)]="theme" (change)="changeTheme(theme)">
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                </select>
                </div>

                <button (click)="updateProfile()">更新资料</button>
            </div>
        </div>
        ```
    - 样式

        ```css
        .profile-container {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 10px;
            max-width: 500px;
            transition: all 0.3s ease;
        }

        .profile-container.active {
            border-color: #2196F3;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }

        .profile-container.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .profile-content {
            margin-top: 15px;
        }

        .profile-field {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }

        .profile-field label {
            width: 100px;
            font-weight: bold;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
        }

        button {
            margin-top: 15px;
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0b7dda;
        }

        ```
2. 入口配置

    - 应用模块 app.module.ts

        ```ts
        import { NgModule } from '@angular/core';
        import { BrowserModule } from '@angular/platform-browser';
        import { FormsModule } from '@angular/forms';
        import { AppComponent } from './app.component';
        import { UserProfileComponent } from './user-profile/user-profile.component';

        @NgModule({
            declarations: [
                AppComponent,
                UserProfileComponent
            ],
            imports: [
                BrowserModule,
                FormsModule
            ],
            providers: [
                { provide: 'API_ENDPOINT', useValue: 'http://localhost:3000' },
                { provide: 'DEFAULT_THEME', useValue: 'light' }
            ],
            bootstrap: [AppComponent]
        })
        export class AppModule { }
        ```
    - 应用根组件 app.component.ts

        ```ts
        import { Component } from '@angular/core';

        @Component({
            selector: 'app-root',
            template: `
                <h1>用户资料系统</h1>
                <app-user-profile
                [userId]="1"
                (profileUpdated)="onProfileUpdate($event)">
                </app-user-profile>
            `,
        })
        export class AppComponent {
            onProfileUpdate(event: any) {
                console.log('收到资料更新事件:', event);
                // 这里可以添加实际的处理逻辑
            }
        }
        ```