# 六、状态管理库 NgRx

## 6.1 认识NgRx

1. 认识 Action (动作) 

    - 含义：
        
        Action 是一个描述发生了什么事情的简单对象。它是 Store 中数据的唯一来源，无论是用户交互、网络请求还是其他事件，你都需要通过 dispatch 一个 Action 来告诉 Store 要做什么。

    - 关键特性：

        必须有一个 type 属性（字符串），用于唯一标识这个动作。

        可选地包含一个 payload 属性，用来传递数据。

    - 用法 (Angular 16+)：

        - createAction 函数来创建动作，它提供了更好的类型安全。

    - 方法与参数 

        ```ts
        const action = createAction(
            type: string,                    // 第一个参数：Action 类型标识
            config?: Function | PropsCreator, // 第二个参数：Payload 配置（可选）
            options?: ActionOptions          // 第三个参数：配置选项（可选，NgRx 16+）
        );
        ```

        1. 第一个参数：Action Type（必需）
            
            - 含义：Action 的唯一标识符，用于在 reducer 和 effects 中识别不同的 action。

            - 约定俗成的格式：`[Feature] Action Description`

                ```ts
                // 示例
                export const loadUsers = createAction('[User API] Load Users');
                export const login = createAction('[Auth] Login');
                ```
            
            - 特点：

                - 必须是字符串

                - 应该具有描述性

                - 通常使用方括号表示功能模块

        2. 第二个参数：Payload 配置（可选）

            - 含义：定义 action 携带的数据结构
            
            - 使用 props<>()

                ```ts
                import { createAction, props } from '@ngrx/store';

                export const loadUsersSuccess = createAction(
                    '[User] Load Users Success',
                    props<{ users: User[]; totalCount: number }>() // 定义 payload 类型
                );
                ```
            - 使用函数形式（NgRx 16+ 新特性）

                ```ts
                export const addUser = createAction(
                    '[User] Add User',
                    (name: string, email: string, isAdmin: boolean = false) => ({
                        user: { name, email, isAdmin },
                        timestamp: new Date().toISOString()
                    })
                );
                ```
        3. 第三个参数：配置选项（可选，NgRx 16+）

            - 含义：提供额外的 action 行为配置

            ```ts
            export const searchUsers = createAction(
                '[User] Search Users',
                props<{ query: string }>(),
                {
                    // 配置选项
                    debounce: 300,           // 防抖时间（毫秒）
                    dispatch: true,          // 是否立即分发
                    // 自定义元数据
                    metadata: { feature: 'user-search' }
                }
            );
            ```
2. Reducer (归约器)

    - 含义：
        
        Reducer 是一个纯函数。它接收当前的 State 和一个被分发的 Action，然后决定如何根据这个 Action 来更新 State。它负责状态的不可变更新。

    - 关键特性：

        纯函数：相同的输入永远得到相同的输出，没有副作用（不改变外部状态、不调用 API 等）。

        不可变性：必须返回一个全新的状态对象，而不是修改原有的状态。

    - 用法 (Angular 16+)：
    
        使用 createReducer 函数和 on 函数来定义如何处理不同的 Action。

    - 方法与参数

        ```ts
        const reducer = createReducer(
            initialState,          // 第一个参数：初始状态
            ...onHandlers          // 第二个参数起：on() 处理器
        );
        ```

        1. 第一个参数：initialState（初始状态）
            
            - 含义：定义 reducer 的初始状态值

            ```ts
            export interface UserState {
                users: User[];
                loading: boolean;
                error: string | null;
                selectedUserId: number | null;
            }

            // 初始状态
            const initialState: UserState = {
                users: [],
                loading: false,
                error: null,
                selectedUserId: null
            };

            export const userReducer = createReducer(
            initialState,  // ← 第一个参数
            // ... on() 处理器
            );
            ```

        2. 后续参数：on() 处理器

            - 含义：定义对不同 action 的响应处理

            ```ts
            on(
                action,                    // 要处理的 action
                (state, action) => newState // 状态转换函数
            )
            ```

3. Store (存储)

    - 含义：

        Store 是一个包含应用程序状态的不可变对象树。它是 RxJS 的 Observable 形式的状态容器。组件通过 Store 来获取状态 (select) 和触发状态变化 (dispatch)。

    - 关键特性：

        单一可信数据源。

        状态是只读的，只能通过分发 Action 来改变。

        使用 Observables，可以集成到 Angular 的变更检测中。

    - 用法：
        
        主要在组件中注入，用于分发 Action 和选择 (Select) 状态。

    - 注入与初始化

        1. 依赖注入

            ```ts
            private store = inject(Store);
            ```
        2. 基本 Select 用法

            - 选择整个状态片段

                ```ts
                users$: Observable<User[]> = this.store.select(state => state.users);
                ```
            - 选择特定属性

                ```ts
                loading$: Observable<boolean> = this.store.select(state => state.loading);
                error$: Observable<string | null> = this.store.select(state => state.error);
                ```

4. Selector (选择器)
    - 含义：
    
        Selector 是一个纯函数，用于从 Store 的状态树中查询和派生数据。它们提供了记忆功能（memoization），可以高效地计算派生数据，避免不必要的重复计算和渲染。

    - 用法 (Angular 16+)：
        
        使用 createSelector 和 createFeatureSelector 函数。
    
    - 方法与参数
        
        1. createFeatureSelector 方法

            - 语法
                
                ```ts
                createFeatureSelector<T>(featureName: string): MemoizedSelector<object, T>
                ```
            - 参数说明
                
                - featureName: string - 在 StoreModule.forFeature() 中注册的 feature 名称

                - 返回: 一个 memoized selector 函数，用于选择特定的 feature state

            - 示例

                ```ts
                import { createFeatureSelector } from '@ngrx/store';
                import { UserState } from './user.state';

                // 选择整个 user feature state
                export const selectUserState = createFeatureSelector<UserState>('users');
                ```
        2. createSelector 方法
            
            - 语法

                ```ts
                createSelector(
                    ...selectors: any[],
                    projector: (...args: any[]) => any
                ): MemoizedSelector<any, any>
                ```
            - 参数说明
                - selectors: 一个或多个 input selectors（可以是 createFeatureSelector 或其他 createSelector 的结果）
                - projector: 一个函数，接收所有 input selectors 的结果作为参数，返回计算后的值
            - 示例

                ```ts
                import { createSelector } from '@ngrx/store';
                import { UserState } from './user.state';

                export const selectAllUsers = createSelector(
                    selectUserState,                    // input selector
                    (state: UserState) => state.users   // projector 函数
                );
                ```
5. Effect (副作用)

    - 含义：
    
        Effect 用于处理异步操作和副作用（如 HTTP 请求、访问 localStorage、计时器等）。它监听已分发的 Action，执行某些任务（通常是异步的），然后根据任务结果分发新的 Action。

    - 关键特性：

        将副作用与组件和 reducer 隔离开。

        基于 RxJS 的 Observables。

    - 用法 (Angular 16+)：
        
        使用 createEffect 函数。注意：在 Angular 16+ 中，Effect 的默认生命周期策略已更改，通常需要指定 { functional: true } 或使用新的 provideState 和 provideEffects 函数进行注册。
    
    - 方法与参数

        ```ts
        createEffect(
            effectSource: () => Observable<unknown>,
            options?: EffectConfig
        ): EffectRef
        ```

        1. 第一个参数：effectSource 函数
            - 类型: `() => Observable<Action>`
            - 这是一个工厂函数，返回一个 Observable stream。通常使用 RxJS 操作符来处理异步操作。

        2. 第二个参数：options 配置对象（可选）        
            - 类型: EffectConfig

            ```ts
            interface EffectConfig {
                dispatch?: boolean;      // 是否自动dispatch action，默认为true
                useEffectsErrorHandler?: boolean; // 是否使用错误处理，默认为true
                functional?: boolean;    // 是否使用函数式effect，默认为false
            }
6. 数据流

    1. 组件 dispatch 一个 Action (如 increment())。
    2. Store 将这个 Action 分发给所有的 Reducer。
    3. Reducer 根据 Action 的类型，计算出新的状态并返回。Store 用新状态更新。
    4. 如果有 Effect 监听到了这个 Action，它会执行异步任务（如 API 调用），任务完成后，再分发一个新的 Action（如 loadUsersSuccess）回到第 1 步。
    5. 组件 通过 Selector 从 Store 中选择状态，状态变化通过 Observable 推送给组件，组件模板使用 async pipe 订阅并更新视图。

7. 数据流示例图

    ![](/framework/angular/base16/079.png)

## 6.2 完整实例

1. 安装NgRx

    ```sh
    # 安装 NgRx
    npm install @ngrx/store @ngrx/effects

    # 可选：开发工具
    npm install @ngrx/store-devtools
    ```

2. 定义模型

    ```ts
    // models/user.model.ts
    export interface User {
        id: number;
        name: string;
        email: string;
    }

    export interface AppState {
        counter: CounterState;
        users: UserState;
    }

    export interface CounterState {
        count: number;
        loading: boolean;
    }

    export interface UserState {
        list: User[];
        loading: boolean;
        error: string | null;
    }
    ```

3. 定义 Actions

    - 计数
        
        ```ts
        // store/counter/counter.actions.ts
        import { createAction, props } from '@ngrx/store';

        export const increment = createAction('[Counter] Increment');
        export const decrement = createAction('[Counter] Decrement');
        export const reset = createAction('[Counter] Reset');
        export const add = createAction(
            '[Counter] Add',
            props<{ value: number }>()
        );
        export const setLoading = createAction(
            '[Counter] Set Loading',
            props<{ loading: boolean }>()
        );
        ```
    - 用户

        ```ts
        // store/user/user.actions.ts
        import { createAction, props } from '@ngrx/store';
        import { User } from '../../models/user.model';

        export const loadUsers = createAction('[User] Load Users');
        export const loadUsersSuccess = createAction(
            '[User] Load Users Success',
            props<{ users: User[] }>()
        );
        export const loadUsersFailure = createAction(
            '[User] Load Users Failure',
            props<{ error: string }>()
        );
        export const addUser = createAction(
            '[User] Add User',
            props<{ user: User }>()
        );
        export const removeUser = createAction(
            '[User] Remove User',
            props<{ id: number }>()
        );
        ```

4. 定义 Reducers

    - 计数

        ```ts
        // store/counter/counter.reducer.ts
        import { createReducer, on } from '@ngrx/store';
        import { increment, decrement, reset, add, setLoading } from './counter.actions';
        import { CounterState } from '../../models/user.model';

        export const initialState: CounterState = {
            count: 0,
            loading: false
        };

        export const counterReducer = createReducer(
            initialState,
            on(increment, (state) => ({ 
                ...state, 
                count: state.count + 1 
            })),
            on(decrement, (state) => ({ 
                ...state, 
                count: state.count - 1 
            })),
            on(reset, (state) => ({ 
                ...state, 
                count: 0 
            })),
            on(add, (state, { value }) => ({ 
                ...state, 
                count: state.count + value 
            })),
            on(setLoading, (state, { loading }) => ({ 
                ...state, 
                loading 
            }))
        );
        ```

    - 用户

        ```ts
        // store/user/user.reducer.ts
        import { createReducer, on } from '@ngrx/store';
        import { loadUsers, loadUsersSuccess, loadUsersFailure, addUser, removeUser } from './user.actions';
        import { UserState } from '../../models/user.model';

        export const initialState: UserState = {
            list: [],
            loading: false,
            error: null
        };

        export const userReducer = createReducer(
            initialState,
            on(loadUsers, (state) => ({ 
                ...state, 
                loading: true, 
                error: null 
            })),
            on(loadUsersSuccess, (state, { users }) => ({ 
                ...state, 
                list: users, 
                loading: false 
            })),
            on(loadUsersFailure, (state, { error }) => ({ 
                ...state, 
                error, 
                loading: false 
            })),
            on(addUser, (state, { user }) => ({ 
                ...state, 
                list: [...state.list, user] 
            })),
            on(removeUser, (state, { id }) => ({ 
                ...state, 
                list: state.list.filter(user => user.id !== id) 
            }))
        );
        ```

5. 定义 Selectors

    - 计数

        ```ts
        // store/counter/counter.selectors.ts
        import { createSelector, createFeatureSelector } from '@ngrx/store';
        import { CounterState } from '../../models/user.model';

        export const selectCounterState = createFeatureSelector<CounterState>('counter');

        export const selectCount = createSelector(
            selectCounterState,
            (state: CounterState) => state.count
        );

        export const selectCounterLoading = createSelector(
            selectCounterState,
            (state: CounterState) => state.loading
        );

        export const selectDoubleCount = createSelector(
            selectCount,
            (count) => count * 2
        );
        ```

    - 用户

        ```ts
        // store/user/user.selectors.ts
        import { createSelector, createFeatureSelector } from '@ngrx/store';
        import { UserState } from '../../models/user.model';

        export const selectUserState = createFeatureSelector<UserState>('users');

        export const selectUsers = createSelector(
            selectUserState,
            (state: UserState) => state.list
        );

        export const selectUsersLoading = createSelector(
            selectUserState,
            (state: UserState) => state.loading
        );

        export const selectUsersError = createSelector(
            selectUserState,
            (state: UserState) => state.error
        );

        export const selectUserCount = createSelector(
            selectUsers,
            (users) => users.length
        );
        ```

6. 定义 Effects

    ```ts
    // store/user/user.effects.ts
    import { inject } from '@angular/core';
    import { Actions, createEffect, ofType } from '@ngrx/effects';
    import { of } from 'rxjs';
    import { catchError, map, mergeMap, delay } from 'rxjs/operators';
    import { loadUsers, loadUsersSuccess, loadUsersFailure } from './user.actions';
    import { User } from '../../models/user.model';

    export class UserEffects {
        private actions$ = inject(Actions);

        // 模拟用户数据
        private mockUsers: User[] = [
            { id: 1, name: 'Alice', email: 'alice@example.com' },
            { id: 2, name: 'Bob', email: 'bob@example.com' },
            { id: 3, name: 'Charlie', email: 'charlie@example.com' }
        ];

        loadUsers$ = createEffect(() => 
            this.actions$.pipe(
            ofType(loadUsers),
            delay(1000), // 模拟网络延迟
            mergeMap(() => 
                of(this.mockUsers).pipe(
                map(users => loadUsersSuccess({ users })),
                catchError(error => of(loadUsersFailure({ error: error.message })))
                )
            )
            )
        , { functional: true });
    }
    ```

7. 配置 App Module

    ```ts
    // app.module.ts
    import { NgModule } from '@angular/core';
    import { BrowserModule } from '@angular/platform-browser';
    import { FormsModule } from '@angular/forms';
    import { AppRoutingModule } from './app-routing.module';
    import { AppComponent } from './app.component';
    import { StoreModule } from '@ngrx/store';
    import { EffectsModule } from '@ngrx/effects';

    // 页面注册
    import { CounterComponent } from './components/counter.component';
    import { UserComponent } from './components/user.component';

    // 这些都是要进行状态管理的配置
    import { counterReducer } from './store/counter/counter.reducer';
    import { userReducer } from './store/user/user.reducer';
    import { UserEffects } from './store/user/user.effects';


    @NgModule({
        declarations: [
            AppComponent,
            CounterComponent,
            UserComponent,
        ],
        imports: [
            BrowserModule,
            AppRoutingModule,
            FormsModule,
            StoreModule.forRoot({
                counter: counterReducer,
                users: userReducer
            }, {}),
            EffectsModule.forRoot([UserEffects]),
        ],
        providers: [],
        bootstrap: [AppComponent]
    })
    export class AppModule { }
    ```

8. 创建服务（可选）

    ```ts
    // services/user.service.ts
    import { inject, Injectable } from '@angular/core';
    import { HttpClient } from '@angular/common/http';
    import { Observable } from 'rxjs';
    import { User } from '../models/user.model';

    @Injectable({
        providedIn: 'root'
    })
    export class UserService {
        private http = inject(HttpClient);

        getUsers(): Observable<User[]> {
            return this.http.get<User[]>('https://jsonplaceholder.typicode.com/users');
        }
    }
    ```

9. 创建组件

    - 计数组件

        ```ts
        // components/counter.component.ts
        import { Component, inject } from '@angular/core';
        import { CommonModule } from '@angular/common';
        import { Store } from '@ngrx/store';
        import { Observable } from 'rxjs';
        import { 
            increment, 
            decrement, 
            reset, 
            add, 
            setLoading 
        } from '../store/counter/counter.actions';
        import { 
            selectCount, 
            selectDoubleCount, 
            selectCounterLoading 
        } from '../store/counter/counter.selectors';

        @Component({
            selector: 'app-counter',
            standalone: true,
            imports: [CommonModule],
            template: `
                <div class="counter">
                <h2>计数器示例</h2>
                
                <div *ngIf="loading$ | async" class="loading">加载中...</div>
                
                <p>当前值: {{ count$ | async }}</p>
                <p>双倍值: {{ doubleCount$ | async }}</p>
                
                <div class="buttons">
                    <button (click)="onIncrement()" [disabled]="loading$ | async">+1</button>
                    <button (click)="onDecrement()" [disabled]="loading$ | async">-1</button>
                    <button (click)="onAdd(5)" [disabled]="loading$ | async">+5</button>
                    <button (click)="onReset()" [disabled]="loading$ | async">重置</button>
                    <button (click)="toggleLoading()">
                    {{ (loading$ | async) ? '停止加载' : '开始加载' }}
                    </button>
                </div>
                </div>
            `,
            styles: [`
                .counter { padding: 20px; border: 1px solid #ccc; margin: 10px; }
                .loading { color: blue; font-weight: bold; }
                .buttons button { margin: 5px; padding: 8px 12px; }
                button:disabled { opacity: 0.5; }
            `]
        })
        export class CounterComponent {
            private store = inject(Store);

            count$: Observable<number> = this.store.select(selectCount);
            doubleCount$: Observable<number> = this.store.select(selectDoubleCount);
            loading$: Observable<boolean> = this.store.select(selectCounterLoading);

            onIncrement() {
                this.store.dispatch(increment());
            }

            onDecrement() {
                this.store.dispatch(decrement());
            }

            onAdd(value: number) {
                this.store.dispatch(add({ value }));
            }

            onReset() {
                this.store.dispatch(reset());
            }

            toggleLoading() {
                this.store.dispatch(setLoading({ loading: !(this.loading$ | async) }));
            }
        }
        ```
    - 用户组件

        ```ts
        // components/user.component.ts
        import { Component, inject } from '@angular/core';
        import { CommonModule } from '@angular/common';
        import { Store } from '@ngrx/store';
        import { Observable } from 'rxjs';
        import { 
            loadUsers, 
            addUser, 
            removeUser 
        } from '../store/user/user.actions';
        import { 
            selectUsers, 
            selectUsersLoading, 
            selectUsersError,
            selectUserCount 
        } from '../store/user/user.selectors';
        import { User } from '../../models/user.model';

        @Component({
            selector: 'app-user',
            standalone: true,
            imports: [CommonModule],
            template: `
                <div class="user">
                    <h2>用户管理示例</h2>
                    
                    <div *ngIf="loading$ | async" class="loading">加载用户中...</div>
                    <div *ngIf="error$ | async as error" class="error">错误: {{ error }}</div>
                    
                    <p>用户数量: {{ userCount$ | async }}</p>
                    
                    <button (click)="onLoadUsers()" [disabled]="loading$ | async">
                        加载用户
                    </button>
                    
                    <button (click)="onAddUser()" [disabled]="loading$ | async">
                        添加测试用户
                    </button>
                    
                    <div class="user-list">
                        <h3>用户列表:</h3>
                        <div *ngFor="let user of users$ | async" class="user-item">
                            {{ user.name }} ({{ user.email }})
                            <button (click)="onRemoveUser(user.id)">删除</button>
                        </div>
                    </div>
                </div>
            `,
            styles: [`
                .user { padding: 20px; border: 1px solid #ccc; margin: 10px; }
                .loading { color: blue; }
                .error { color: red; }
                .user-item { margin: 5px; padding: 10px; border: 1px solid #eee; }
                button { margin-left: 10px; }
            `]
        })
        export class UserComponent {
            private store = inject(Store);
            private nextId = 4;

            users$: Observable<User[]> = this.store.select(selectUsers);
            loading$: Observable<boolean> = this.store.select(selectUsersLoading);
            error$: Observable<string | null> = this.store.select(selectUsersError);
            userCount$: Observable<number> = this.store.select(selectUserCount);

            onLoadUsers() {
                this.store.dispatch(loadUsers());
            }

            onAddUser() {
                const newUser: User = {
                    id: this.nextId++,
                    name: `用户${this.nextId}`,
                    email: `user${this.nextId}@example.com`
                };
                this.store.dispatch(addUser({ user: newUser }));
            }

            onRemoveUser(id: number) {
                this.store.dispatch(removeUser({ id }));
            }
        }
        ```

10. 主组件

    ```ts
    // app.component.ts
    import { Component } from '@angular/core';

    @Component({
        selector: 'app-root',
        template: `
            <h1>Angular 16 + NgRx 示例</h1>
            <router-outlet></router-outlet>
        `,
    })
    export class AppComponent {
        title = 'ng-project';
    }
    ```

11. 路由

    ```ts
    // app-routing.module.ts
    import { NgModule } from '@angular/core';
    import { RouterModule, Routes } from '@angular/router';
    import { CounterComponent } from './components/counter.component';
    import { UserComponent } from './components/user.component';

    const routes: Routes = [
        { path: '', redirectTo: '/user', pathMatch: 'full' },
        { path: "user",component:UserComponent, title:"user用户" },
        { path: "counter",component:CounterComponent, title:"Counter计数" },
    ];

    @NgModule({
        imports: [RouterModule.forRoot(routes)],
        exports: [RouterModule],
    })
    export class AppRoutingModule {}
    ```

12. 运行结果

    - 计数

        ![](/framework/angular/base16/080.gif)
    - 用户

        ![](/framework/angular/base16/081.gif)


## 6.3 自己的总结


1. 在app.component.ts 中将数据与reducer结合起来

    ```ts
    StoreModule.forRoot({
      users: userReducer
    })
    ```
2. 其中对象中第一个参数 是 reducer 中state

    ```ts
     on(loadUsers, (state) => ({
        ...state,
        loading: true,
        error: null
    })),
    ```
3. selectors 的 createFeatureSelector 的参数是  StoreModule.forRoot 设置的参数名

    ```ts
    export const selectUserState = createFeatureSelector<UserState>('users');
    ```

4. selectors 的 createSelector 中的 state 也是设置中 users

    ```ts
    export const selectUsers = createSelector(
        selectUserState,
        (state: UserState) => state.list
    );
    ```

5. actions中的第一个参数，除了保持不重复，没有其他用处

    ```ts
    export const addUser = createAction(
        '[User] Add User',
        props<{ user: User }>()
    );
    ```