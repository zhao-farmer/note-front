# 一、graphql

## 1.1 介绍与hello

1. 介绍

    GraphQL是Facebook开发的一种数据查询语言，并于2015年公开发布。它是RESTAPI的替代品
    GraphQL 既是一种用于 API 的查询语言也是一个满足你数据査询的运行时。 GraphQL对你的 AP!中的数据提供了一套易于理解的完整描述，使得客户端能够准确地获得它需要的数据，而且没有任何冗余，也让 API更容易地随着时间推移而演进

    - 官网:https://graphal.org/
    - 中文网:http://graphal.cn/
2. 特点

    1. 请求需要的数据，不多不少
    例如:account中有name.age.sex，department等，可以只取得需要的字段。
    2. 获取多个资源，只用一个请求
    3. 描述所有可能类型的系统。便于维护，根据需求平滑演进，添加或者隐藏字段。
        - restful一个接口只能返回一个资源，graphq-次可以获取多个资源。
        - restful用不同的url来区分资源，graphql用类型区分资源。

3. 安装插件

    ```sh
    # 初始化项目
    npm init -y
    # 安装插件
    pnpm install express express-graphql graphql
    ```

4. hello 代码

    ```js
    const express = require("express")
    const {buildSchema} = require("graphql")
    const {graphqlHTTP} = require("express-graphql")

    // 定义 Schema
    const schema = buildSchema(`
        type Query {
            hello: String
            randomNumber: Int
            state: Boolean
        }
    `);

    // 定义 Resolver
    const root = {
        hello: () => 'Hello world!',
        randomNumber: () => Math.floor(Math.random() * 100),
        state: () =>  1 + 1 === 3
    };

    var app = express()

    // 传统的rest接口
    app.use("/home",function(req,res){
        res.send("home data")
    })
    app.use("/list",function(req,res){
        res.send("list data")
    })

    // graphql 的接口
    app.use("/graphql",graphqlHTTP({
        schema:schema,
        rootValue:root,
        graphiql:true
    }))

    app.listen(4000)
    ```

5. 打开 `http://localhost:4000/graphql` 并添加参数观察结果

    ![](/framework/react/expand/001.png)

## 1.2 参数类型与传递

1. 介绍

    - 基本类型:`String`,`Int`,`Float`,`Boolean`和`ID`。可以在shema声明的时候直接使用。
    - `[类型]`代表数组，例如:`[lnt]`代表整型数组
    - 和js传递参数一样，小括号内定义形参，但是注意:参数需要定义类型。
    - !(叹号)代表参数不能为空。

        ```js
        type Query{
            rollDice(numDsce:Int!,numSides:Int):[Int]
        }
        ```
2. 使用复杂数据类型

    - 代码

        ```js
        const express = require("express")
        const {buildSchema} = require("graphql")
        const {graphqlHTTP} = require("express-graphql")

        // 定义 Schema
        const schema = buildSchema(`
            type Account{
                name:String
                age:Int
                location:String
            }

            type Film{
                id:Int
                name:String
                poster:String
                price:Int
            }

            type Query {
                hello: String
                randomNumber: Int
                greet(name: String): String
                getAllAges: [Int]
                getAllNames: [String]
                getAccountInfo: Account
                getNowplayingList:[Film]
            }
        `);


        // 模拟后端返回数据
        var faskeDB = [
            {
                id: 1,
                name: "1111",
                poster: "http://111",
                price:100
            },
            {
                id: 2,
                name: "2222",
                poster: "http://222",
                price:200
            },
            {
                id: 3,
                name: "3333",
                poster: "http://333",
                price:300
            },
        ];


        // 定义 Resolver
        const root = {

            /* 返回基础数据 */
            hello: () => 'Hello world!',
            randomNumber: () => Math.floor(Math.random() * 100),
            greet: ({ name }) => `Hello, ${name}!`,

            /* 获取数组数据 */
            getAllNames:()=>{
                return ["zhangsan","lisi","wangwu"]
            },
            getAllAges(){
                return [19,20,200]
            },
            /* 获取对象数据  */
            getAccountInfo(){
                return {
                    name:"zhangsan",
                    age:18,
                    location:"zhangguo"
                }
            },
            /* 获取数组对象数据 */
            getNowplayingList(){
                return faskeDB
            }
        };

        var app = express()


        // graphql 的接口
        app.use("/graphql",graphqlHTTP({
            schema:schema,
            rootValue:root,
            graphiql:true
        }))

        app.listen(4000)
        ```
    - 调用结果

        ![](/framework/react/expand/002.png)

3. 传递参数

    - 代码

        ```js
        const express = require("express")
        const {buildSchema} = require("graphql")
        const {graphqlHTTP} = require("express-graphql")

        // 定义 Schema
        const schema = buildSchema(`
            type Film{
                id:Int
                name:String
                poster:String
                price:String
            }

            type Query {
                greet(name: String): String
                getFilmDetail(id:Int!):Film
            }
        `);


        // 模拟后端返回数据
        var faskeDB = [
            {
                id: 1,
                name: "1111",
                poster: "http://111",
                price:100
            },
            {
                id: 2,
                name: "2222",
                poster: "http://222",
                price:200
            },
            {
                id: 3,
                name: "3333",
                poster: "http://333",
                price:300
            },
        ];


        // 定义 Resolver
        const root = {
            // 简单参数
            greet: ({ name }) => `Hello, ${name}!`,
            // 虽然参数指定的id,但是传入的是参数
            getFilmDetail({id}){
                return faskeDB.filter(item=>item.id===id)[0]
            }
        };

        var app = express()


        // graphql 的接口
        app.use("/graphql",graphqlHTTP({
            schema:schema,
            rootValue:root,
            graphiql:true
        }))

        app.listen(4000)
        ```
    - 调用结果

        ![](/framework/react/expand/003.png)

## 1.3 mulation

1. 介绍
    
    - 查询使用query，修改数据使用 mutation
    - 一般的数据类型使用 type ，传入的数据类型使用 input

2. 查询数据

    - 代码

        ```js
        const express = require("express")
        const {buildSchema} = require("graphql")
        const {graphqlHTTP} = require("express-graphql")

        // 定义 Schema
        const schema = buildSchema(`
            type Film{
                id:Int
                name:String
                poster:String
                price:Int
            }

            type Query {
                getNowplayingList:[Film]
            }
        `);

        // 模拟后端返回数据
        var faskeDB = [
        {
                id: 1,
                name: "1111",
                poster: "http://111",
                price:100
            },
            {
                id: 2,
                name: "2222",
                poster: "http://222",
                price:200
            },
            {
                id: 3,
                name: "3333",
                poster: "http://333",
                price:300
            },
        ];

        // 定义 Resolver
        const root = {
            getNowplayingList(){
                return faskeDB
            },
        };

        var app = express()

        // graphql 的接口
        app.use("/graphql",graphqlHTTP({
            schema:schema,
            rootValue:root,
            graphiql:true
        }))

        app.listen(4000)
        ```

    - 使用 query 进行查询

        ```js
        query{
            getNowplayingList{
                id
                name
            }
        }
        ```
    - 运行结果

        ![](/framework/react/expand/004.png)

2. 新增数据

    - 代码

        ```js{14-18,25,58-63}
        const express = require("express")
        const {buildSchema} = require("graphql")
        const {graphqlHTTP} = require("express-graphql")

        // 定义 Schema
        const schema = buildSchema(`
            type Film{
                id:Int
                name:String
                poster:String
                price:Int
            }

            input FilmInput{
                name:String
                poster:String
                price:Int
            }

            type Query {
                getNowplayingList:[Film]
            }

            type Mutation{
                createFilm(input:FilmInput):Film
            } 
        `);


        // 模拟后端返回数据
        var faskeDB = [
        {
                id: 1,
                name: "1111",
                poster: "http://111",
                price:100
            },
            {
                id: 2,
                name: "2222",
                poster: "http://222",
                price:200
            },
            {
                id: 3,
                name: "3333",
                poster: "http://333",
                price:300
            },
        ];


        // 定义 Resolver
        const root = {
            getNowplayingList(){
                return faskeDB
            },
            createFilm({input}){
                // 添加id
                var obj = {...input,id:faskeDB.length+1}
                faskeDB.push(obj)
                return obj
            },
        };

        var app = express()


        // graphql 的接口
        app.use("/graphql",graphqlHTTP({
            schema:schema,
            rootValue:root,
            graphiql:true
        }))

        app.listen(4000)
        ```

    - 使用 mutation 进行新增

        ```js
        mutation {
            createFilm(input:{
                name:"zhangsan",
                poster:"aaa",
                price:400
            }){
                id,
                name,
                price,
                poster
            }
        }
        ```
    - 运行结果

        ![](/framework/react/expand/005.png)

3. 修改数据

    - 代码

        ```js{26,65-75}
        const express = require("express")
        const {buildSchema} = require("graphql")
        const {graphqlHTTP} = require("express-graphql")

        // 定义 Schema
        const schema = buildSchema(`
            type Film{
                id:Int
                name:String
                poster:String
                price:Int
            }

            input FilmInput{
                name:String
                poster:String
                price:Int
            }

            type Query {
                getNowplayingList:[Film]
            }

            type Mutation{
                createFilm(input:FilmInput):Film
                updateFilm(id:Int!,input:FilmInput):Film
            } 
        `);


        // 模拟后端返回数据
        var faskeDB = [
        {
                id: 1,
                name: "1111",
                poster: "http://111",
                price:100
            },
            {
                id: 2,
                name: "2222",
                poster: "http://222",
                price:200
            },
            {
                id: 3,
                name: "3333",
                poster: "http://333",
                price:300
            },
        ];


        // 定义 Resolver
        const root = {
            getNowplayingList(){
                return faskeDB
            },
            createFilm({input}){
                // 添加id
                var obj = {...input,id:faskeDB.length+1}
                faskeDB.push(obj)
                return obj
            },
            updateFilm({id,input}){
                var current = null
                faskeDB =  faskeDB.map(item=>{
                    if(item.id === id){
                        current = {...item,...input}
                        return {...item,...input}
                    }
                    return item
                })
                return current
            },
        };

        var app = express()


        // graphql 的接口
        app.use("/graphql",graphqlHTTP({
            schema:schema,
            rootValue:root,
            graphiql:true
        }))

        app.listen(4000)
        ```

    - 使用 mutation 进行修改

        ```js
        mutation {
            updateFilm(id:2,input:{
                name:"222-修改",
                poster:"222-poster-修改",
            }){
                id,
                name,
            }
        }
        ```
    - 运行结果

        ![](/framework/react/expand/006.png)

4. 删除数据

    - 代码

        ```js{27,77-80}
        const express = require("express")
        const {buildSchema} = require("graphql")
        const {graphqlHTTP} = require("express-graphql")

        // 定义 Schema
        const schema = buildSchema(`
            type Film{
                id:Int
                name:String
                poster:String
                price:Int
            }

            input FilmInput{
                name:String
                poster:String
                price:Int
            }

            type Query {
                getNowplayingList:[Film]
            }

            type Mutation{
                createFilm(input:FilmInput):Film
                updateFilm(id:Int!,input:FilmInput):Film
                deleteFilm(id:Int!):Int
            } 
        `);


        // 模拟后端返回数据
        var faskeDB = [
        {
                id: 1,
                name: "1111",
                poster: "http://111",
                price:100
            },
            {
                id: 2,
                name: "2222",
                poster: "http://222",
                price:200
            },
            {
                id: 3,
                name: "3333",
                poster: "http://333",
                price:300
            },
        ];


        // 定义 Resolver
        const root = {
            getNowplayingList(){
                return faskeDB
            },
            createFilm({input}){
                // 添加id
                var obj = {...input,id:faskeDB.length+1}
                faskeDB.push(obj)
                return obj
            },
            updateFilm({id,input}){
                var current = null
                faskeDB =  faskeDB.map(item=>{
                    if(item.id === id){
                        current = {...item,...input}
                        return {...item,...input}
                    }
                    return item
                })
                return current
            },
            deleteFilm({id}){
                faskeDB = faskeDB.filter(item=>item.id!==id)
                return id
            }
        };

        var app = express()


        // graphql 的接口
        app.use("/graphql",graphqlHTTP({
            schema:schema,
            rootValue:root,
            graphiql:true
        }))

        app.listen(4000)
        ```

    - 使用 mutation 进行删除

        ```js
        mutation {
            deleteFilm(id:3)
        }
        ```
    - 运行结果

        ![](/framework/react/expand/007.png)

## 1.4 结合数据库

1. 安装插件

    ```sh
    pnpm install mongoose
    ```
2. 修改代码

    ```js
    const express = require("express")
    const {buildSchema} = require("graphql")
    const {graphqlHTTP} = require("express-graphql")


    // --------------------- 数据库服务 -------------------------
    var mongoose = require("mongoose")
    mongoose.connect("mongodb://localhost:27017/maizuo")

    // 限制 数据库这个films (集合) 只能存三个字段
    var FilmModel = mongoose.model("film",new mongoose.Schema({
        name:String,
        poster:String,
        price:Number
    }))

    // FilmModel.create 创建
    // FilmModel.find 查询
    // FilmModel.update 修改
    // FilmModel.delete 删除
    // ----------------------------------------------

    // 定义 Schema
    const schema = buildSchema(`
        type Film{
            id:String
            name:String
            poster:String
            price:Int
        }

        input FilmInput{
            name:String
            poster:String
            price:Int
        }

        type Query {
            getNowplayingList:[Film]
        }

        type Mutation{
            createFilm(input:FilmInput):Film
            updateFilm(id:String!,input:FilmInput):Film
            deleteFilm(id:String!):String
        } 
    `);


    // 定义 Resolver
    const root = {
        getNowplayingList(){
            return FilmModel.find()
        },
        createFilm({input}){
            /* 
                1. 创建模型
                2. 操作数据库
            */
            return FilmModel.create({
                ...input
            })
        },
        updateFilm({id,input}){
            // 更新返回的 { ok:1, nModified:0, n:1 } 所有要再次查询
            return FilmModel.updateOne({
                _id:id
            },{
                ...input
            }).then(res => FilmModel.find({_id:id})).then(res=>res[0])
        },
        deleteFilm({id}){
            return FilmModel.deleteOne({_id:id}).then(res=>id)
        }
    };

    var app = express()


    // graphql 的接口
    app.use("/graphql",graphqlHTTP({
        schema:schema,
        rootValue:root,
        graphiql:true
    }))

    app.listen(4000)
    ```
3. 各种操作

    - 新增数据

        ![](/framework/react/expand/008.png)
    - 查询数据

        ![](/framework/react/expand/009.png)
    - 修改数据

        ![](/framework/react/expand/010.png)
    - 删除数据

        ![](/framework/react/expand/011.png)


## 1.5 客户端访问

1. 添加静态目录

    ```js{75-76}
    const express = require("express")
    const {buildSchema} = require("graphql")
    const {graphqlHTTP} = require("express-graphql")

    // --------------------- 数据库服务 -------------------------
    var mongoose = require("mongoose")
    mongoose.connect("mongodb://localhost:27017/maizuo")

    // 限制 数据库这个films (集合) 只能存三个字段
    var FilmModel = mongoose.model("film",new mongoose.Schema({
        name:String,
        poster:String,
        price:Number
    }))
    // ----------------------------------------------

    // 定义 Schema
    const schema = buildSchema(`
        type Film{
            id:String
            name:String
            poster:String
            price:Int
        }

        input FilmInput{
            name:String
            poster:String
            price:Int
        }

        type Query {
            getNowplayingList:[Film]
        }

        type Mutation{
            createFilm(input:FilmInput):Film
            updateFilm(id:String!,input:FilmInput):Film
            deleteFilm(id:String!):String
        } 
    `);


    // 定义 Resolver
    const root = {
        getNowplayingList(){
            return FilmModel.find()
        },
        createFilm({input}){
            return FilmModel.create({
                ...input
            })
        },
        updateFilm({id,input}){
            return FilmModel.updateOne({
                _id:id
            },{
                ...input
            }).then(res => FilmModel.find({_id:id})).then(res=>res[0])
        },
        deleteFilm({id}){
            return FilmModel.deleteOne({_id:id}).then(res=>id)
        }
    };

    var app = express()

    // graphql 的接口
    app.use("/graphql",graphqlHTTP({
        schema:schema,
        rootValue:root,
        graphiql:true
    }))

    // 配置静态资源目录
    app.use(express.static("public"))

    app.listen(4000)
    ```
2. 新增 静态页面 `public/home.html`

    - 代码

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
        </head>
        <body>
            <h1>home</h1>

            <button onclick="getData()">查询数据</button>
            <button onclick="createData()">创建数据</button>
            <button onclick="updateData()">更新数据</button>
            <button onclick="deleteData()">删除数据</button>

            <script>
                function getData(){
                    const myquery = `
                        query{
                            getNowplayingList{
                                id
                                name
                            }
                        }
                    `

                    fetch("/graphql",{
                        method:"POST",
                        headers:{
                            "Content-Type":"application/json",
                            "Accept":"application/json"
                        },
                        body:JSON.stringify({
                            query:myquery
                        })

                    }).then(res=>res.json()).then(res=>{
                        console.log(res);
                    })
                }
                function createData(){
                    const myquery = `
                        mutation ($input:FilmInput) {
                            createFilm(input:$input){
                                id,
                                name
                            }
                        }
                    `

                    fetch("/graphql",{
                        method:"POST",
                        headers:{
                            "Content-Type":"application/json",
                            "Accept":"application/json"
                        },
                        // variables 会替换掉 myquery 中的 $input
                        body:JSON.stringify({
                            query:myquery,
                            variables:{
                                input:{
                                    name:"666",
                                    poster:"http://666",
                                    price: 600
                                }
                            }
                        })

                    }).then(res=>res.json()).then(res=>{
                        console.log(res);
                    })
                }
                function updateData(){
                    const myquery = `
                        mutation($id:String!,$input:FilmInput){
                            updateFilm(id:$id,input:$input){
                                id
                                name
                            }
                        }
                    `

                    fetch("/graphql",{
                        method:"POST",
                        headers:{
                            "Content-Type":"application/json",
                            "Accept":"application/json"
                        },
                        body:JSON.stringify({
                            query:myquery,
                            variables: {
                                id:"68c1383773ba67ba4c9ec368",
                                input: {
                                    name: "666-修改",
                                    price: 66,
                                    poster: "http://666-修改"
                                }
                            }
                        })

                    }).then(res=>res.json()).then(res=>{
                        console.log(res);
                    })
                }
                function deleteData(){
                    const myquery = `
                        mutation($id:String!){
                            deleteFilm(id:$id)
                        }
                    `

                    fetch("/graphql",{
                        method:"POST",
                        headers:{
                            "Content-Type":"application/json",
                            "Accept":"application/json"
                        },
                        body:JSON.stringify({
                            query:myquery,
                            variables: {
                                id:"68c1383773ba67ba4c9ec368",
                            }
                        })

                    }).then(res=>res.json()).then(res=>{
                        console.log(res);
                    })
                }
            </script>
        </body>
        </html>
        ```
    - 页面效果

        ![](/framework/react/expand/016.png)

3. 点击按钮操作

    - 查询数据

        ![](/framework/react/expand/012.png)
    - 创建数据

        ![](/framework/react/expand/013.png)
    - 更新数据

        ![](/framework/react/expand/014.png)
    - 删除数据

        ![](/framework/react/expand/015.png)

## 1.6 结合react

1. 结合 

    - [apollographql官网](https://www.apollographql.com/)
    - [apollographql的github地址](https://github.com/apollographql/apollo-client)

2. 初始化项目

    - 创建于安装依赖

        ```sh
        # 创建项目
        create-react-app 2_react
        # 安装依赖
        npm install @apollo/client graphql rxjs
        ```
    - 删除public 下所有文件 
    - 新建index.html

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
        </head>
        <body>
            <div id="root"></div>
        </body>
        </html>
        ```
    - 删除 src 下所有文件 
    - 新增 index.js 文件

        ```js
        import React from 'react';
        import ReactDOM from 'react-dom/client';
        import App from './App';

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        ```
    - 新增 App.jsx 文件

        ```jsx
        function App() {
            return <div>App...</div>
        }

        export default App;
        ```
    - package.json 新增代理

        ```js
        "proxy": "http://localhost:4000/"
        ```

    - 开始运行

        ```sh
        npm start 
        ```

3. 项目代码

    - 修改功能组件 src/components/mutation.jsx

        ```jsx
        import { gql } from "@apollo/client";
        import { useMutation } from "@apollo/client/react";

        const creategql = gql`
            mutation CreateFilm($input: FilmInput) {
                createFilm(input: $input) {
                    id
                    name
                }
            }
        `;

        const updategql = gql`
            mutation ($id: String!, $input: FilmInput) {
                updateFilm(id: $id, input: $input) {
                    id
                    name
                }
            }
        `;
        const deletegql = gql`
            mutation ($id: String!) {
                deleteFilm(id: $id)
            }
        `;

        function MutationData() {
            let [ createFilm ]= useMutation(creategql);
            let [ updateFilm ] = useMutation(updategql);
            let [ deleteFilm ] = useMutation(deletegql);

            // 新增
            const createData = async () => {
                try {
                    let result = await createFilm({
                        variables: {
                            input: {
                                name: "666",
                                poster: "http://666",
                                price: 600,
                            },
                        },
                    });
                    console.log(result);
                } catch (err) {
                    console.error(err);
                }
            };

            // 修改
            const updateData = async () => {
                try {
                    let result = await updateFilm({
                        variables: {
                            id:"68c1595ecfe7397a08e03ecc",
                            input: {
                                name: "666-修改",
                                price: 66,
                                poster: "http://666-修改"
                            }
                        },
                    });
                    console.log(result);
                } catch (err) {
                    console.error(err);
                }
            };

            // 删除
            const deleteData = async () => {
                try {
                    let result = await deleteFilm({
                        variables: {
                            id:"68c1595ecfe7397a08e03ecc",
                        },
                    });
                    console.log(result);
                } catch (err) {
                    console.error(err);
                }
            };

            return (
                <div>
                    <button onClick={createData}>新增数据</button>
                    <button onClick={updateData}>修改数据</button>
                    <button onClick={deleteData}>删除数据</button>
                </div>
            );
        }

        export default MutationData;

        ```
    - 查询功能组件 src/components/query.jsx

        ```jsx
        import { gql } from "@apollo/client";
        import { useQuery } from "@apollo/client/react";

        const getNowplayingList = gql`
            query{
                getNowplayingList{
                    id,
                    name,
                    poster,
                    price
                }
            }
        `;

        function QueryData() {
            const { loading, error, data } = useQuery(getNowplayingList);

            if (loading) return <p>Loading...</p>;
            if (error) return <p>Error </p>;

            return (
                <ul>
                    {data.getNowplayingList.map(({ id, name, price }) => (
                        <li key={id}>
                        物品：{name} / 价格：{price}
                        </li>
                    ))}
                </ul>
            );
        }

        export default QueryData;

        ```
    - src/App.jsx

        ```jsx
        import QueryData from "./components/query";
        import MutationData from "./components/mutation"

        function App() {
            return (
                <div>
                    <QueryData />
                    <hr />
                    <MutationData />
                </div>
            );
        }

        export default App;
        ```
    - 配置 index.js (超级重要)

        ```js
        import React from 'react';
        import ReactDOM from 'react-dom/client';
        import App from './App';
        // 引入 Apollo
        import { ApolloClient, InMemoryCache,HttpLink } from "@apollo/client";
        import { ApolloProvider } from "@apollo/client/react";


        const client = new ApolloClient({
            link: new HttpLink({
                uri: '/graphql', // 替换为GraphQL服务器地址
            }),
            cache: new InMemoryCache(),
        });

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render( 
            <React.StrictMode>
                <ApolloProvider client={client}>
                <App />
                </ApolloProvider>
            </React.StrictMode>
        );
        ```

4. 运行结果

    - 页面效果(查询)

        ![](/framework/react/expand/020.png)
    - 新增数据

        ![](/framework/react/expand/017.png)
    - 修改数据

        ![](/framework/react/expand/018.png)
    - 删除数据

        ![](/framework/react/expand/019.png)