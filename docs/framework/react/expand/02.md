# 二、umi.js

umi，中文可发音为乌米，是一个可插拔的企业级react 应用框架。umi 以路由为基础的，支持类 next.js 的约定式路由，以及各种进阶的路由功能，并以此进行功能扩展，比如支持路由级的按需加载。umi在约定式路由的功能层面会更像 nuxt.js 一些。

[进入官网](https://umijs.org/)

## 2.1 初始化项目

1. 使用命令安装

    ```sh
    # 使用npm
    npx create-umi@latest
    # 使用pnpm-官方推荐
    pnpm dlx create-umi@latest
    ```
2. 安装选项

    ![](/framework/react/expand/021.png)

3.  参数选项

    使用 create-umi 创建项目时，可用的参数如下：

    | option       | description    |
    |--------------|----------------|
    | --no-git     | 创建项目，但不初始化 Git |
    | --no-install | 创建项目，但不自动安装依赖  |

4. 项目启动

    - 启动命令

        ```sh
        cd 1_base
        pnpm dev
        ```
    - 运行展示

        ![](/framework/react/expand/022.png)

## 2.2 路由

### 2.2.1 约定式路由

除配置式路由外，Umi 也支持约定式路由。约定式路由也叫文件路由，就是不需要手写配置，文件系统即路由，通过目录和文件及其命名分析出路由配置。

如果没有 routes 配置，Umi 会进入约定式路由模式，然后分析 src/pages 目录拿到路由配置。

1. 实现步骤

    1. 删除 `.umirc.ts` 或 `config/config.ts` 中的 routes配置
    2. 新建类似下图的设置

       ![](/framework/react/expand/023.png) 
    
    3. layouts/index.jsx

        ```jsx
        import { Link, Outlet } from 'umi';
        import styles from './index.less';

        export default function Layout() {
            return (
                <div className={styles.navs}>
                    <ul>
                        <li>
                            <Link to="/">首页</Link>
                        </li>
                        <li>
                            <Link to="/about">关于</Link>
                        </li>
                        <li>
                            <Link to="/user">用户</Link>
                        </li>
                        <li>
                            <Link to="/posts/123">订单123</Link>
                        </li>
                    </ul>
                    <Outlet />
                </div>
            );
        }
        ```

2. 运行结果

    ![](/framework/react/expand/024.png)

### 2.2.2 配置路由

在 `.umirc.ts` 或 `config/config.ts` 中通过 routes 进行配置，格式为路由信息的数组。

1. 支持的路由路径配置形式：

    ```
    /groups
    /groups/admin
    /users/:id
    /users/:id/messages
    /files/*
    /files/:id/*
    ```

2. .umirc.ts 配置

    ```js
    import { defineConfig } from "umi";

    export default defineConfig({
        routes: [
            // 1. 基本路由
            { path: '/', component: '@/pages/index' },
            { path: '/about', component: '@/pages/about' },
            
            // 2. 嵌套路由
            {
                path: '/user',
                component: '@/layouts/user', // 用户相关页面的布局组件
                routes: [
                    { path: '/user', component: '@/pages/user/index' }, // /user
                    { path: '/user/profile', component: '@/pages/user/profile' }, // /user/profile
                    { path: '/user/settings', component: '@/pages/user/settings' }, // /user/settings
                ],
            },
            
            // 3. 动态路由
            { path: '/posts/:id', component: '@/pages/posts/$id' },
            
            // 4. 重定向
            { path: '/home', redirect: '/' },
            
            // 5. 404 页面
            { path: '/*', component: '@/pages/404' },
        ],
        npmClient: 'pnpm',
    });
    ```

3. 配置路由可以写 页面自己的布局组件

    ```jsx
    import { Link, Outlet } from 'umi';
    import styles from './index.less';

    export default function UserLayout() {
        return (
            <div className={styles.navs}>
                <ul>
                    <li>
                        <Link to="/user">用户首页</Link>
                    </li>
                    <li>
                        <Link to="/user/profile">用户资料</Link>
                    </li>
                    <li>
                        <Link to="/user/settings">用户设置</Link>
                    </li>
                </ul>
                <Outlet />
            </div>
        );
    }
    ```
4. 运行结果

    ![](/framework/react/expand/025.png)


## 2.3 配置代理

1. 新增代理  .umirc.ts 

    ```js
    proxy: {
        '/api': {
        'target': 'http://jsonplaceholder.typicode.com/',
        'changeOrigin': true,
        'pathRewrite': { '^/api' : '' },
        },
    },
    ```

2. 修改 src/pages/index.jsx

    ```jsx
   import React, { useEffect, useState } from "react";

    interface User {
        id: number;
        userId: number;
        title: string;
        completed: boolean;
    }

    export default function HomePage() {
        const [data, setData] = useState<User[]>([]);

        // 只加载一次
        useEffect(() => {
            // 获取数据
            (async () => {
                try {
                    // fetch调用时 使用了代理
                    let reponse = await fetch("/api/todos");
                    let res = await reponse.json();
                    setData(res || []);
                } catch (error) {
                    console.log("error", error);
                }
            })();
        }, []);

        return (
            <div>
                    { 
                        data.map(({ id, title }) => (
                            <li key={id}>{title}</li>
                        ))
                    }
            </div>
        );
    }
    ```

3. 运行结果

    ![](/framework/react/expand/026.png)


## 2.4 使用umi max

1. 创建项目时 这样选择

    ```
    npx create-umi@latest
    ? Pick Umi App Template › - Use arrow-keys. Return to submit.
        Simple App
    ❯   Ant Design Pro
        Vue Simple App
    ```

2. 运行结果

    ![](/framework/react/expand/027.png)