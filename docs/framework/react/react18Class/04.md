# 四、代理、通信、UI


## 4.1 react api访问

### 4.1.1 配置代理 

1. 前置说明
    - React 本身只关注于界面,并不包含发送 ajax 请求的代码
    - 前端应用需要通过 ajax 请求与后台进行交互(json 数据)
    - react 应用中需要集成第三方 ajax 库(或自己封装)
2. 常用的 ajax 请求库
    - jQuery: 比较重,如果需要另外引入不建议使用
    - axios: 轻量级,建议使用<
        - 封装XmlHttpRequest 对象的 ajax←
        - promise 风格
        - 可以用在浏览器端和 node 服务器端


3. 使用 json-server 创建后端接口

    1. 安装插件

        ```sh
        # 安装v0 版本 1版本不能关闭 cors
        npm install json-server@v0 -g
        ```
    2. data/db.json 文件内容

        ```json
        {
            "students":[
                {"id":"001","name":"tom","age":18},
                {"id":"002","name":"jerry","age":19},
                {"id":"003","name":"tony","age":120}
            ]
        }
        ```
    3. 运行文件(新开一个命令行窗口)

        ```sh
        # 进入目录
        cd src/data/
        # 运行文件
        json-server db.json -p 5000
        ```
    4. 数据运行结果

        ![](/framework/react/react18Class/024.png)

4. 前端调用

    1. 安装插件

        ```sh
        npm install axios
        ```
    2. App.jsx 代码

        ```jsx
        import React, { Component } from 'react'
        import axios from "axios"

        export default class App extends Component {

            getStudentData = () =>{
                axios.get("http://localhost:5000/students").then(
                    response => { console.log("成功了",response.data) },
                    error => { console.log("失败了")}
                )
            }

            render() {
                return (
                <div>
                    <button onClick={this.getStudentData}>点我获取学生数据</button>
                </div>
                )
            }
        }
        ```
    3. 运行结果

        ![](/framework/react/react18Class/025.png)

5. 开始配置代理

    1. 启动无cors的后台接口

        ```sh
        json-server db.json -p 5000 --nc
        ```
    2. 全局代理

        - 配置文件 package.json 中

            ```js
            "proxy":"http://localhost:5000"  
            // "proxy":"请求的地址"
            ```
        - 流程图

            ![](/framework/react/react18Class/026.png)

        - App.jsx 的 axios 修改

            ```js
            axios.get("/students").then(
                response => { console.log("成功了",response.data) },
                error => { console.log("失败了")}
            )
            ```

    3. 单独配置

        - 新建文件 src/setupProxy.js
        
            ```js
            const Proxy = require('http-proxy-middleware')
            module.exports = function(app) {
                app.use(
                    Proxy.createProxyMiddleware('/api',{ 
                        target:'http://localhost:5000',
                        changeOrigin:true,
                        pathRewrite:{'/api':''}  
                    })
                )
            }
            ```
        - 参数对象

            - target 属性用于配置转发目标地址，也就是我们数据的地址
            - changeOrigin 属性用于控制服务器收到的请求头中 host 字段，可以理解为一个伪装效果，为 true 时，收到的 host 就为请求数据的地址
            - pathRewrite 属性用于去除请求前缀

        - App.jsx 的 axios 修改

            ```js
            axios.get("/api/students").then(
                response => { console.log("成功了",response.data) },
                error => { console.log("失败了")}
            )
            ```

### 4.1.2 github案例

1. 代码案例

    - src/App.jsx

        ```jsx
        import React, { Component } from "react";
        import Search from "./components/Search";
        import List from "./components/List";
        import "./App.css"

        export default class MyComponent extends Component {
            state = {
                // 用户列表
                user: [],
                // 是否是第一次查询
                isFirst: true,
                // 是否开启loading
                isLoading: false,
                // 报错
                error: "",
            };

            // 更新状态
            updateState = obj => {
                this.setState(obj);
            };

            render() {
                return (
                    <div className="container">
                        <section className="jumbotron">
                            <h3 className="jumbotron-heading">搜索github用户</h3>
                            {/* search组件 */}
                            <Search updateState={this.updateState} />
                        </section>
                        {/* list组件 */}
                        <List {...this.state} />
                    </div>
                );
            }
        }
        ```
    - src/App.css

        ```css
        .row{
            display: flex;
            flex-wrap: wrap;
        }

        .card {
            height: 150px;
            width: 150px;
            border: 1px solid #efefef;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }

        .card > img {
            border-radius: 100px;
        }

        .card-text {
            font-size: 16px;
        }
        ```
    - src/components/Item/index.jsx

        ```jsx
        import React, { Component } from "react";

        export default class Item extends Component {
            render() {
                let { html_url, avatar_url, login } = this.props;
                return (
                    <div className="card">
                        <a href={html_url}>
                            <img src={avatar_url} style={{ width: "100px" }} alt="用户头像" />
                        </a>
                        <p className="card-text">{login}</p>
                    </div>
                );
            }
        }

        ```
    - src/components/List/index.jsx

        ```jsx
        import React, { Component } from "react";
        import Item from "../Item";

        export default class List extends Component {
            render() {
                let { user, isFirst, isLoading, error } = this.props;
                if (isFirst) {
                    return <h2>请输入关键词以搜索用户</h2>;
                } else if (isLoading) {
                    return <h2>Loading...</h2>;
                } else if (error) {
                    return <h2>{error}</h2>;
                } else {
                    return (
                        <div className="row">
                            {user.map(item => {
                                return <Item key={item.login} {...item} />;
                            })}
                        </div>
                    );
                }
            }
        }
        ```
    - src/components/Search/index.jsx

        ```jsx
        import React, { Component } from "react";
        import axios from "axios";

        export default class Search extends Component {
            myRef = React.createRef();

            search = () => {
                // 获取输入
                let keyWord = this.myRef.current.value;
                if (keyWord.trim() === "") {
                    return alert("请输入内容");
                }
                // 发生请求
                let URL = `https://api.github.com/search/users?q=${keyWord}`;
                // 更新状态
                let { updateState } = this.props;
                updateState({
                    user: [],
                    isFirst: false,
                    isLoading: true,
                    error: "",
                });
                axios.get(URL).then(value => {
                        updateState({
                            user: value.data.items,
                            isFirst: false,
                            isLoading: false,
                            error: "",
                        });
                    }).catch(error => {
                        updateState({
                            user: [],
                            isFirst: false,
                            isLoading: false,
                            error: error.message,
                        });
                    });
                // 清空输入
                this.myRef.current.value = "";
            };

            render() {
                return (
                    <div>
                        <input type="text" placeholder="请输入关键字" ref={this.myRef} />
                        &nbsp;
                        <button onClick={this.search}>搜素</button>
                    </div>
                );
            }
        }
        ```

2. 运行结果

    ![](/framework/react/react18Class/027.png)

### 4.1.3 github案例-调用增强

1. github案例中修改 Search 组件,添加fetch 调用

    ```js{26,50-66}
    import React, { Component } from "react";
    import axios from "axios";

    export default class Search extends Component {
        myRef = React.createRef();

        search = () => {
            // 获取输入
            let keyWord = this.myRef.current.value;
            if (keyWord.trim() === "") {
                return alert("请输入内容");
            }
            // 发生请求
            let URL = `https://api.github.com/search/users?q=${keyWord}`;
            let { updateState } = this.props;

            updateState({
                user: [],
                isFirst: false,
                isLoading: true,
                error: "",
            })
            // axios调用
            // this.axiosData(URL,updateState)
            // fetch调用
            this.fetchData(URL,updateState)
            
            // 清空输入
            this.myRef.current.value = "";
        };

        axiosData(URL,updateState){
            axios.get(URL).then(value => {
                updateState({
                    user: value.data.items,
                    isFirst: false,
                    isLoading: false,
                    error: "",
                });
            }).catch(error => {
                updateState({
                    user: [],
                    isFirst: false,
                    isLoading: false,
                    error: error.message,
                });
            });
        };

        fetchData(URL,updateState){
            fetch(URL).then(res => res.json()).then( response => {
                updateState({
                    user: response.items,
                    isFirst: false,
                    isLoading: false,
                    error: "",
                });
            }).catch( error => {
                updateState({
                    user: [],
                    isFirst: false,
                    isLoading: false,
                    error: error.message,
                });
            })
        }

        render() {
            return (
                <div>
                    <input type="text" placeholder="请输入关键字" ref={this.myRef} />
                    &nbsp;
                    <button onClick={this.search}>搜素</button>
                </div>
            );
        }
    }
    ```
2. 使用 async/await 同步获取数据

    ```js{68-101,109}
    import React, { Component } from "react";
    import axios from "axios";

    export default class Search extends Component {
        myRef = React.createRef();

        search = () => {
            // 获取输入
            let keyWord = this.myRef.current.value;
            if (keyWord.trim() === "") {
                return alert("请输入内容");
            }
            // 发生请求
            let URL = `https://api.github.com/search/users?q=${keyWord}`;
            let { updateState } = this.props;

            updateState({
                user: [],
                isFirst: false,
                isLoading: true,
                error: "",
            });
            // axios调用
            // this.axiosData(URL, updateState);
            // fetch调用
            this.fetchData(URL,updateState)

            // 清空输入
            this.myRef.current.value = "";
        };

        axiosData(URL, updateState) {
            axios.get(URL).then(value => {
                updateState({
                    user: value.data.items,
                    isFirst: false,
                    isLoading: false,
                    error: "",
                });
            }).catch(error => {
                updateState({
                    user: [],
                    isFirst: false,
                    isLoading: false,
                    error: error.message,
                });
            });
        }

        fetchData(URL, updateState) {
            fetch(URL).then(res => res.json()).then(response => {
                updateState({
                    user: response.items,
                    isFirst: false,
                    isLoading: false,
                    error: "",
                });
            }).catch(error => {
                updateState({
                    user: [],
                    isFirst: false,
                    isLoading: false,
                    error: error.message,
                });
            });
        }

        asyncSearch = async () => {
            // 获取输入
            let keyWord = this.myRef.current.value;
            if (keyWord.trim() === "") {
                return alert("请输入内容");
            }
            // 发生请求
            let URL = `https://api.github.com/search/users?q=${keyWord}`;
            let { updateState } = this.props;
            // 使用 await 必须使用 try catch
            try {
                // axios 调用
                //  let {data:result} = await axios.get(URL);
                // fetch 调用
                let response = await fetch(URL);
                let result = await response.json();
                // 调用传入的方法
                updateState({
                    user: result.items,
                    isFirst: false,
                    isLoading: false,
                    error: "",
                });
            } catch (error) {
                updateState({
                    user: [],
                    isFirst: false,
                    isLoading: false,
                    error: error.message,
                });
            }
            // 清空输入
            this.myRef.current.value = "";
        };

        render() {
            return (
                <div>
                    <input type="text" placeholder="请输入关键字" ref={this.myRef} />
                    &nbsp;
                    <button onClick={this.search}>搜素</button>
                    <button onClick={this.asyncSearch}>同步搜素</button>
                </div>
            );
        }
    }
    ```


## 4.2 组件通信

1. 父子组件通信 src/components/PropsVerify/index.jsx

    ```jsx
    import React from "react";

    // 父组件
    class PropsParent extends React.Component {
        state = { count: 0 };

        increment = () => {
            this.setState(prevState => ({ count: prevState.count + 1 }));
        };

        render() {
            return (
                <PropsChild
                    count={this.state.count} 
                    increment={this.increment}
                />
            );
        }
    }

    // 子组件
    class PropsChild extends React.Component {
        render() {
            return (
            <div>
                {/* 子组件展示父组件传递的 */}
                <p>Count值: {this.props.count}</p>
                {/* 子组件调用父组件的方法，可以通过参数传递数据 */}
                <button onClick={this.props.increment}>调用increment方法</button>
            </div>
            );
        }
    }

    export default PropsParent
    ```

2. 跨层级组件通信 src/components/ContextVerify/index.jsx

    ```jsx
    import React from "react";

    // 创建Context
    const CountContext = React.createContext();

    // 父组件
    class ContextParent extends React.Component {
    state = { count: 0 };

    increment = () => {
        this.setState(prevState => ({ count: prevState.count + 1 }));
    };

    render() {
        return (
        <CountContext.Provider value={{ 
            count: this.state.count, 
            increment: this.increment 
        }}>
            <Context01Child />
            <Context02Child />
        </CountContext.Provider>
        );
    }
    }

    // 子组件01
    class Context01Child extends React.Component {
    static contextType = CountContext;

    render() {
        return (
        <div>
            <button onClick={this.context.increment}>调用increment方法</button>
        </div>
        );
    }
    }

    // 子组件01
    class Context02Child extends React.Component {
    static contextType = CountContext;

    render() {
        return (
        <div>
            <p>Count值: {this.context.count}</p>
        </div>
        );
    }
    }

    export default ContextParent
    ```

3. App.jsx 调用数据

    ```jsx
    import React, { Component } from "react";

    import PropsParent from "./components/PropsVerify";
    import ContextParent from "./components/ContextVerify";

    export default class App extends Component {

        render() {
            return (
                <div>
                    <h2>验证Props父子组件通信</h2>
                    <PropsParent/>
                    <hr />
                    <h2>验证Context跨层级组件通信</h2>
                    <ContextParent/>
                </div>
            );
        }
    }
    ```

4. 页面展示

    ![](/framework/react/react18Class/028.gif)

## 4.3 使用 antd

1. 安装插件

    ```sh
    npm install antd @ant-design/icons
    ```

2. 业务代码


    1. App.jsx

        ```jsx
        import React from "react";
        import { Table, Button, Modal, Form, Input, InputNumber, message, Space } from "antd";
        import { EditOutlined, DeleteOutlined, PlusOutlined } from "@ant-design/icons";
        import "antd/dist/reset.css";
        import "./App.css";

        class App extends React.Component {
            state = {
                products: [
                    { id: 1, name: "iPhone 13", price: 5999, stock: 100 },
                    { id: 2, name: "MacBook Pro", price: 12999, stock: 50 },
                    { id: 3, name: "AirPods Pro", price: 1999, stock: 200 },
                ],
                isModalVisible: false,
                editingProduct: null,
            };

            formRef = React.createRef();

            columns = [
                {
                    title: "商品名称",
                    dataIndex: "name",
                    key: "name",
                },
                {
                    title: "价格(元)",
                    dataIndex: "price",
                    key: "price",
                    render: price => price.toFixed(2),
                },
                {
                    title: "库存",
                    dataIndex: "stock",
                    key: "stock",
                },
                {
                    title: "操作",
                    key: "action",
                    render: (_, record) => (
                        <Space size="middle">
                            <Button type="primary" icon={<EditOutlined />} onClick={() => this.editProduct(record)}>
                                编辑
                            </Button>
                            <Button danger icon={<DeleteOutlined />} onClick={() => this.deleteProduct(record.id)}>
                                删除
                            </Button>
                        </Space>
                    ),
                },
            ];

            showModal = () => {
                this.setState({
                    isModalVisible: true,
                    editingProduct: null,
                });
                this.formRef.current?.resetFields();
            };

            handleCancel = () => {
                this.setState({ isModalVisible: false });
            };

            editProduct = product => {
                this.setState({
                    isModalVisible: true,
                    editingProduct: product,
                });
                this.formRef.current?.setFieldsValue(product);
            };

            deleteProduct = id => {
                Modal.confirm({
                    title: "确认删除",
                    content: "确定要删除这个商品吗？",
                    okText: "确认",
                    cancelText: "取消",
                    onOk: () => {
                        this.setState({
                            products: this.state.products.filter(product => product.id !== id),
                        });
                        message.success("商品删除成功");
                    },
                });
            };

            handleSubmit = () => {
                this.formRef.current
                    .validateFields()
                    .then(values => {
                        if (this.state.editingProduct) {
                            // 更新商品
                            this.setState({
                                products: this.state.products.map(product => (product.id === this.state.editingProduct.id ? { ...product, ...values } : product)),
                                isModalVisible: false,
                            });
                            message.success("商品更新成功");
                        } else {
                            // 添加新商品
                            const newProduct = {
                                id: Date.now(),
                                ...values,
                            };
                            this.setState({
                                products: [...this.state.products, newProduct],
                                isModalVisible: false,
                            });
                            message.success("商品添加成功");
                        }
                    })
                    .catch(info => {
                        console.log("Validate Failed:", info);
                    });
            };

            render() {
                const { products, isModalVisible, editingProduct } = this.state;

                return (
                    <div className="app">
                        <div className="header">
                            <h1>商品管理系统</h1>
                            <Button type="primary" icon={<PlusOutlined />} onClick={this.showModal}>
                                添加商品
                            </Button>
                        </div>

                        <Table columns={this.columns} dataSource={products} rowKey="id" bordered pagination={{ pageSize: 5 }} />

                        <Modal
                            title={editingProduct ? "编辑商品" : "添加商品"}
                            visible={isModalVisible}
                            onOk={this.handleSubmit}
                            onCancel={this.handleCancel}
                            okText="提交"
                            cancelText="取消"
                        >
                            <Form ref={this.formRef} name="productForm" labelCol={{ span: 4 }} wrapperCol={{ span: 20 }}>
                                <Form.Item label="商品名称" name="name" rules={[{ required: true, message: "请输入商品名称" }]}>
                                    <Input placeholder="请输入商品名称" />
                                </Form.Item>

                                <Form.Item
                                    label="价格"
                                    name="price"
                                    rules={[
                                        { required: true, message: "请输入价格" },
                                        { type: "number", min: 0, message: "价格必须大于0" },
                                    ]}
                                >
                                    <InputNumber placeholder="请输入价格" style={{ width: "100%" }} min={0} step={0.01} />
                                </Form.Item>

                                <Form.Item
                                    label="库存"
                                    name="stock"
                                    rules={[
                                        { required: true, message: "请输入库存数量" },
                                        { type: "number", min: 0, message: "库存必须大于等于0" },
                                    ]}
                                >
                                    <InputNumber placeholder="请输入库存" style={{ width: "100%" }} min={0} />
                                </Form.Item>
                            </Form>
                        </Modal>
                    </div>
                );
            }
        }

        export default App;

        ```

    2. App.css

        ```css
        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            color: #1890ff;
        }

        @media (max-width: 768px) {
            .app {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }  
        ```

3. 运行结果

    ![](/framework/react/react18Class/029.png)