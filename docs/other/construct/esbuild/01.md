# 一、ESbuild 

## 1.1 快速开始

1. 安装插件

    ```sh
    npm install esbuild -g
    ```
2. 代码文件

    - 新建文件 src/main.js

        ```js
        export default "hello esbuild"
        ```
    - 新建文件 src/page1.js

        ```js
        export default "导出page1"
        ```
    - 新建文件 src/page2.js

        ```js
        export default "导出page1"
        ```
3. 命令行基础用法

    ```bash
    # 单文件打包
    esbuild src/main.js --outfile=dist/bundle.js --bundle --minify

    # 多入口打包
    esbuild src/page1.js src/page2.js --outdir=dist --bundle --format=esm
    ```

4. 运行结果

    ![](/other/construct/esbuild/001.png)

5.  常用 CLI 参数

| 参数  | 说明  |
| --- | --- |
| `--bundle` | 打包依赖 |
| `--outfile=FILE` | 单文件输出 |
| `--outdir=DIR` | 多文件输出目录 |
| `--format=esm/cjs/iife` | 输出格式 |
| `--minify` | 压缩代码 |
| `--sourcemap` | 生成 Sourcemap |
| `--target=esnext` | 指定 JavaScript 目标版本 |
| `--platform=node/browser` | 运行环境 |


## 1.2 配置文件 esbuild.config.js

1. 准备工作

    - 创建项目

        ```sh
        npm init -y
        pnpm install esbuild -D
        ```

    - 创建文件 src/main.js

        ```js
        function test(){
            console.log(123);
        }
        test()
        ```

2. 同步配置

    - esbuild.config.js 代码

        ```js
        import esbuild from 'esbuild';

        // 同步配置
        esbuild.buildSync({
            entryPoints: ['src/main.js'],
            outfile: 'dist/bundle.js',
            bundle: true,
            minify: true,
            sourcemap: true,
            target: ['es2020'],
            platform: 'browser'
        });
        ```
    - 命令行打包

        ```sh
        node esbuild.config.js
        ```

    - 命令行结果
    
        ![](/other/construct/esbuild/002.png)


3. 异步配置

    ```js
    import esbuild from 'esbuild';

    // 异步配置（推荐）
    esbuild.build({
        entryPoints: ['src/**/*.js'], // 支持 glob 模式
        outdir: 'dist',
        format: 'esm',
        plugins: [/* 插件 */],
    }).then(() => console.log('构建完成'));
    ```

## 1.3 钩子函数

1. 关键钩子功能说明

| 钩子  | 触发时机 | 典型用途 | 示例返回值 |
| --- | --- | --- | --- |
| ​**​`onStart`​**​ | 构建开始时 | 初始化操作、清理旧文件 | `{ warnings: [] }` |
| ​**​`onResolve`​**​ | 解析模块路径时 | 别名处理、外部依赖标记、虚拟模块 | `{ path, external, namespace }` |
| ​**​`onLoad`​**​ | 加载文件内容前 | 动态生成内容、文件转换、代码修改 | `{ contents, loader, resolveDir }` |
| ​**​`onEnd`​**​ | 构建完成时 | 分析结果、生成报告、通知部署 | 无返回值，接收 `result`参数 |
| ​**​`onDispose`​**​ | 插件卸载时 | 关闭服务、清理临时资源 | 无返回值 |


2. 流程图

    ```mermaid
    graph LR
        A[onStart] --> B[解析+加载]
        B --> C[代码转换]
        C --> D[输出文件]
        D --> E[onEnd]
    ```

3. 代码示例

    ```js
    import esbuild from 'esbuild';
    import path from 'path';
    import fs from 'fs';

    /** 全功能插件（演示所有钩子） */
    const fullFeaturePlugin = {
        name: 'all-hooks-demo',
        setup(build) {
            // ======================
            // 1. 构建生命周期钩子
            // ======================

            /** 构建开始时触发 */
            build.onStart(() => {
                console.log('构建启动');
                return { warnings: [] }; // 可返回初始警告
            });

            /** 构建结束时触发（无论成功与否） */
            build.onEnd((result) => {
                if (result.errors.length > 0) {
                    console.error('构建失败:', result.errors);
                } else {
                    console.log('构建成功');
                    // 可操作 result.metafile 分析依赖
                    if (result.metafile) {
                        fs.writeFileSync('meta.json', JSON.stringify(result.metafile));
                    }
                }
            });

            /** 插件被移除时触发 */
            build.onDispose(() => {
                console.log('插件卸载');
            });

            // ======================
            // 2. 模块解析钩子 (onResolve)
            // ======================

            /** 处理别名 (@/ -> src/) */
            build.onResolve({ filter: /^@\// }, (args) => ({
                path: path.join(args.resolveDir, args.path.replace('@/', 'src/'))
            }));

            /** 标记特定模块为外部依赖 */
            build.onResolve({ filter: /^react$/ }, () => ({
                path: 'react',
                external: true // 不打包此模块
            }));

            /** 创建虚拟模块 */
            build.onResolve({ filter: /^virtual:config/ }, (args) => ({
                path: args.path,
                namespace: 'virtual-module' // 自定义命名空间
            }));

            // ======================
            // 3. 模块加载钩子 (onLoad)
            // ======================

            /** 加载虚拟模块内容 */
            build.onLoad({ filter: /.*/, namespace: 'virtual-module' }, () => ({
                contents: 'export default { env: "production" }',
                loader: 'js' // 指定为 JS 类型
            }));

            /** 转换 CSV 文件为 JS 模块 */
            build.onLoad({ filter: /\.csv$/ }, async (args) => {
                const data = await fs.promises.readFile(args.path, 'utf8');
                return {
                    contents: `export default ${JSON.stringify(data.split('\n'))}`,
                    loader: 'js',
                    resolveDir: path.dirname(args.path)
                };
            });

            /** 移除所有 console.log */
            build.onLoad({ filter: /\.jsx?$/ }, async (args) => {
                let code = await fs.promises.readFile(args.path, 'utf8');
                code = code.replace(/console\.log\(.*?\);?/g, '');
                return { contents: code, loader: 'jsx' };
            });
        }
    };

    // ======================
    // 主配置
    // ======================
    const config = {
        entryPoints: ['src/main.js'],
        outdir: 'dist',
        bundle: true,
        format: 'esm',
        plugins: [fullFeaturePlugin],
        
        // 启用元文件生成（供 onEnd 分析）
        metafile: true,
        
        // 其他配置
        loader: {
            '.png': 'file',          // 图片作为文件输出
            '.svg': 'dataurl'        // SVG 内联为 DataURL
        },
        define: {
            'process.env.NODE_ENV': '"production"'
        }
    };

    // 执行构建
    esbuild.build(config).catch(() => process.exit(1));
    ```

## 1.4 esbuild 配置项


### ​1.4.1 **​输入配置​**​

| 配置项 | 类型  | 默认值 | 说明  |
| --- | --- | --- | --- |
| `entryPoints` | `string[]` | \-  | ​**​必填​**​，入口文件路径（支持 glob 模式如 `src/**/*.js`） |
| `entryNames` | `string` | `[dir]/[name]` | 输出文件名模板（支持 `[name]`、`[hash]`、`[ext]`等占位符） |
| `outbase` | `string` | \-  | 指定基础目录（用于计算输出文件路径的相对位置） |



### 1.4.2 ​**​输出配置​**​

| 配置项 | 类型  | 默认值 | 说明  |
| --- | --- | --- | --- |
| `outfile` | `string` | \-  | 单文件输出路径（与 `outdir`二选一） |
| `outdir` | `string` | \-  | 多文件输出目录（需配合 `entryPoints`使用） |
| `format` | `string` | `iife` | 输出格式：`esm`（ES Module）、`cjs`（CommonJS）、`iife`（自执行函数） |
| `target` | `string[]` | `esnext` | 目标环境（如 `['es2020', 'chrome58', 'node12']`） |
| `platform` | `string` | `browser` | 平台：`browser`（默认）、`node`、`neutral` |
| `globalName` | `string` | \-  | 当 `format`为 `iife`/`umd`时，指定全局变量名（如 `MyLib`） |
| `charset` | `string` | `utf8` | 输出编码：`utf8`或 `ascii` |


### 1.4.3 ​**功能开关​**​

| 配置项 | 类型  | 默认值 | 说明  |
| --- | --- | --- | --- |
| `bundle` | `boolean` | `false` | 是否打包依赖（`node_modules`中的模块） |
| `splitting` | `boolean` | `false` | 是否启用代码分割（需 `format: 'esm'`和 `outdir`） |
| `minify` | `boolean` | `false` | 是否压缩代码（包含 JS/CSS/HTML） |
| `treeShaking` | `boolean` | `true` | 是否启用 Tree-shaking（删除未使用代码） |
| `sourcemap` | `boolean`/`string` | `false` | 生成 Sourcemap：`true`、`false`、`inline`、`external` |
| `metafile` | `boolean` | `false` | 是否生成元文件（包含构建信息，可通过 `result.metafile`获取） |


### ​1.4.4 **加载器与转换​**​

| 配置项 | 类型  | 默认值 | 说明  |
| --- | --- | --- | --- |
| `loader` | `object` | \-  | 文件类型处理器（键为扩展名，值为 loader 类型） |
| `jsx` | `string` | `transform` | JSX 处理方式：`transform`（转换）、`preserve`（保留）、`automatic`（React 17+） |
| `jsxFactory` | `string` | `React.createElement` | 自定义 JSX 工厂函数 |
| `jsxFragment` | `string` | `React.Fragment` | 自定义 JSX Fragment 组件 |

​**​Loader 类型列表​**​：


```javascript
{
  '.js': 'jsx',      // 解析 JSX
  '.ts': 'ts',       // TypeScript
  '.json': 'json',   // JSON -> JS 对象
  '.txt': 'text',    // 纯文本
  '.css': 'css',     // CSS（可压缩）
  '.png': 'file',    // 输出为文件
  '.svg': 'dataurl'  // 内联为 DataURL
}
```

### ​1.4.5 **​路径与别名​**​

| 配置项 | 类型  | 默认值 | 说明  |
| --- | --- | --- | --- |
| `alias` | `object` | \-  | 路径别名（如 `{ '@': './src' }`） |
| `external` | `string[]` | \-  | 外部化依赖（不打包的模块，如 `['react', 'lodash']`） |
| `resolveExtensions` | `string[]` | `['.js',...]` | 解析模块时尝试的扩展名顺序 |
| `mainFields` | `string[]` | `['module', 'main']` | 优先读取的 `package.json`字段 |

### ​1.4.6 **插件与钩子​**​

| 配置项 | 类型  | 默认值 | 说明  |
| --- | --- | --- | --- |
| `plugins` | `array` | `[]` | 插件列表（按顺序执行） |
| `inject` | `string[]` | \-  | 自动注入的模块路径（如 `['./shim.js']`） |

### 1.4.7 ​**优化与高级配置​**​

| 配置项 | 类型  | 默认值 | 说明  |
| --- | --- | --- | --- |
| `define` | `object` | \-  | 全局变量替换（如 `{ 'process.env.NODE_ENV': '"production"' }`） |
| `pure` | `string[]` | \-  | 标记纯函数（如 `['console.log']`以移除副作用） |
| `keepNames` | `boolean` | `false` | 是否保留变量/函数原名（禁用压缩时的名称混淆） |
| `color` | `boolean` | `true` | 终端输出是否带颜色 |
| `logLevel` | `string` | `info` | 日志级别：`verbose`、`debug`、`info`、`warning`、`error`、`silent` |

### ​1.4.8 **​完整配置示例​**​


```javascript
import esbuild from 'esbuild';
import path from 'path';

/** @type {esbuild.BuildOptions} */
const config = {
  // 输入
  entryPoints: ['src/index.tsx', 'src/utils/*.ts'],
  entryNames: '[dir]/[name]-[hash]',
  outbase: 'src',

  // 输出
  outdir: 'dist',
  format: 'esm',
  target: ['es2020', 'chrome80'],
  platform: 'browser',
  charset: 'utf8',

  // 功能开关
  bundle: true,
  splitting: true,
  minify: true,
  sourcemap: true,
  metafile: true,

  // 加载器
  loader: {
    '.ts': 'ts',
    '.svg': 'dataurl',
    '.png': 'file'
  },
  jsx: 'automatic', // React 17+ JSX 转换

  // 路径解析
  alias: {
    '@': path.resolve('src')
  },
  external: ['react'],
  resolveExtensions: ['.tsx', '.ts', '.jsx', '.js'],

  // 插件
  plugins: [
    // 自定义插件...
  ],

  // 高级
  define: {
    'process.env.NODE_ENV': '"production"'
  },
  pure: ['console.debug'],
  logLevel: 'info'
};

// 执行构建
esbuild.build(config).catch(() => process.exit(1));
```


### 1.4.9 ​**​注意事项​**​

1. ​**​`outfile`与 `outdir`互斥​**​：两者只能选其一
    
2. ​**​代码分割限制​**​：需同时满足：
    
    *   `format: 'esm'` 
    *   `bundle: true`
    *    指定 `outdir`
3. ​**​TypeScript 支持​**​：无需额外配置，但需安装 `typescript`
    
4. ​**​性能调优​**​：

    
    ```javascript
    {
        // 限制并发数（默认根据 CPU 核心数）
        maxParallelFileOps: 4,
        // 禁用某些功能以加速开发构建
        minify: false,
        sourcemap: false
    }
    ```
    