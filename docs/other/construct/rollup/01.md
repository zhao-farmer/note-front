# 一、Rollup 配置学习

## 1.1 rollup 基础使用


1. 介绍

    Rollup 是一个 JavaScript ​​模块打包器​​（Module Bundler）。它的核心任务是：将许多小的 JavaScript 文件（模块）高效地编译、组合成一个或少数几个优化后的文件（bundle），以便在浏览器中运行。

    它的核心理念是 ​​“基于 ESM 标准进行 Tree-shaking”​​，这使得它在构建​​库（Library）​​ 和​​应用（Application）​​ 时都非常出色，也是 Vite 在生产环境构建时选择的工具。

2. 核心概念与工作原理
    1. **​​入口点（Entry Point）**​​：你告诉 Rollup 从哪个文件开始分析你的应用（如 src/main.js）。
    2. **​​依赖图（Dependency Graph）**​​：Rollup 从入口点开始，静态分析所有的 import 语句，递归地构建出整个项目的依赖关系图。它​​只包含运行项目所必需的代码​​。
    3. **​​Tree-shaking（摇树优化）**​​：这是 Rollup 的杀手级特性。它通过静态分析，识别并​​剔除那些被定义但从未被使用（dead code）的导出​​。例如，如果你从 lodash 中只导入了一个 debounce 函数，最终打包的文件将只包含 debounce 及其依赖的代码，而不是整个 lodash 库。
    4. **​​打包（Bundling）​**​：将依赖图中所有必要的模块“卷”到一起（这也是它名字 Rollup 的由来），合并成一个或多个高度优化的文件（chunk）。

3. 开始使用

    - 全局安装rollup

        ```
        npm install rollup -g
        ```
    - 新建index.js

        ```js
        import { funcA } from "./a";

        funcA()
        console.log("Hello Rollup");
        ```
    - 新建a.js
        
        ```js
        export const funcA = () =>{
            console.log('a');
        }
        export const funcB = () =>{
            console.log('b');
        }
        ```

4. 执行命令打包

    - 执行命令
        ```js
        // 将index打包为dist
        rollup i index.js --file dist.js
        ```
    - dist.js 打包后的代码

        ```js
        const funcA = () =>{
            console.log('a');
        };

        funcA();
        console.log("Hello Rollup");
        ```
## 1.2 rollup命令行使用

1. 基础打包命令

    ```sh
    # 浏览器用 - 打包成 ES 格式
    rollup src/main.js --file dist/bundle.js --format es

    # Node.js 用 - 打包成 CommonJS 格式
    rollup src/main.js --file dist/bundle.js --format cjs

    # 同时支持浏览器和Node - 打包成 UMD 格式
    rollup src/main.js --file dist/bundle.js --format umd --name "MyBundle"
    ```

2. 命令解释

    - --file / -o: 指定输出的文件路径。
    - --format / -f: 指定输出格式。常见的有：
        - es / esm: ES 模块（适用于现代打包工具和浏览器）
        - cjs: CommonJS（适用于 Node.js）
        - umd: UMD（适用于浏览器和 Node.js，需要 --name）
        - iife: 自执行函数（适用于直接在现代浏览器中通过 `<script>` 标签使用）
    - --name: 当输出格式为 umd 或 iife 时，指定全局变量名。

## 1.3 配置文件

1. 初始化项目

    ```sh
    # 构建项目
    npm init -y
    # 安装rollup
    pnpm install rollup --save-dev
    ```

2. 基础打包配置

    ```js
    // 创建 rollup.config.js
    export default {
        //external:['lodash'] 忽略模块不打包
        //plugins,
        // 以下三个配置项都可以使用这些占位符:
        // 1. [name]: 去除文件后缀后的文件名
        // 2. [hash]: 根据文件名和文件内容生成的 hash 值
        // 3. [format]: 产物模块格式，如 es、cjs
        // 4. [extname]: 产物后缀名(带`.`)
        // 入口模块的输出文件名
        entryFileNames: `[name].js`,
        // 非入口模块(如动态 import)的输出文件名
        chunkFileNames: "chunk-[hash].js",
        // 静态资源文件输出文件名
        assetFileNames: "assets/[name]-[hash][extname]",
        input: "src/main.js", // 入口文件
        output: {
            file: "dist/bundle.js", // 输出文件
            format: "es", // 输出格式
            name: "MyLibrary", // UMD格式需要的全局变量名
        },
    };
    ```

2. 多入口\输出口配置

    ```js
    // 多入口打包
    export default [
        {
            input: 'src/main-a.js',
            output: { file: 'dist/a.js', format: 'es' }
        },
        {
            input: 'src/main-b.js',
            output: [
            { file: 'dist/b-cjs.js', format: 'cjs' },
            { file: 'dist/b-es.js', format: 'es' }
            ]
        }
    ]
    ```

## 1.4 引入外部资源

1. 准备工作

    - rollup.config.js 配置

        ```js
        export default {
            input: "src/main.js",
            output: {
                file: "bundle.js",
                format: "cjs",
            },
        };
        ```
    - src/main.js

        ```js
        import foo from "./foo.js";
        export default function () {
            console.log(foo);
        }
        ```
    - src/foo.js

        ```js
        export default "hello world!";
        ```


2. 出现的问题
    - 安装 lodash-es

        ```sh
        pnpm install lodash-es
        ```

    - 更新 src/main.js，添加外部资源 lodash-es 引入：

        ```js
        import foo from "./foo.js";

        import { sum } from "lodash-es";

        function test() {
            console.log(foo);
            console.log(sum);
            console.log(sum([1, 2]));
        }

        test()
        ```
    - 再次打包 `rollup -c`，发现有报错 `(!) Unresolved dependencies：`

        ![](/other/construct/rollup/001.png)

    - 有 2 种方法引入外部资源：

        1. 添加插件 @rollup/plugin-node-resolve 将我们编写的源码与依赖的第三方库进行合并；
        2. 配置 external 属性，告诉 rollup.js 哪些是外部的类库。

### 1.4.1 resolve 插件


`@rollup/plugin-node-resolve` 插件让 rollup 能够处理外部依赖。

1. 安装：

    ```sh
    pnpm add @rollup/plugin-node-resolve -D
    ```

2. 更新 `rollup.config.js`：

    ```js{1,4}
    import resolve from "@rollup/plugin-node-resolve";

    export default {
        plugins: [resolve()],

        input: "src/main.js",
        output: {
            file: "bundle.js",
            format: "cjs",
        },
    };
    ```

3. 重新打包得到产物，已经包含了 `lodash-es`：


4. 成功运行：

    ![](/other/construct/rollup/002.png)


### 1.4.2 external 属性

1. 保存生成代码的引入状态

    有些场景下，虽然我们使用了 resolve 插件，但可能我们仍然想要某些库保持外部引用状态，这时我们就需要使用 external 属性，来告诉 rollup.js 哪些是外部的类库。

2. 更新 `rollup.config.js`：

    ```js
    import { nodeResolve } from "@rollup/plugin-node-resolve";

    export default {
        input: "src/main.js",
        output: {
            file: "bundle.js",
            format: "esm",
            name: "test",
        },
        plugins: [nodeResolve()],
        external: ["lodash-es"],
    };
    ```

### 1.4.3 external 插件

1. 全局都保持引入

    每个类库都要手动添加至 externals 未免太麻烦，这时候可以用 `rollup-plugin-node-externals` 插件，自动将外部类库声明为 externals。

2. 安装：

    ```sh
    pnpm add rollup-plugin-node-externals -D
    ```

3. 更新 `rollup.config.js`：

    ```js
    import externals from "rollup-plugin-node-externals";

    export default [
        {
            plugins: [
                externals({
                    devDeps: false, // devDependencies 类型的依赖就不用加到 externals 了。
                }),
            ],
        },
    ];
    ```


## 1.5 引入 CommonJs 模块

1.  CommonJs 插件

    rollup.js 编译源码中的模块引用默认只支持 ES6+的模块方式 import/export。然而大量的 npm 模块是基于 CommonJS 模块方式，这就导致了大量 npm 模块不能直接编译使用。

    需要添加 @rollup/plugin-commonjs 插件来支持基于 CommonJS 模块方式 npm 包。

2. 安装：

    ```sh
    pnpm add @rollup/plugin-commonjs -D
    ```

3. 更新 rollup.config.js：

    ```js
    import commonjs from "@rollup/plugin-commonjs";

    export default {
        plugins: [commonjs()],
    };
    ```

3. 更新 src/foo.js：

    ```js
    import resolve from "@rollup/plugin-node-resolve";
    import commonjs from "@rollup/plugin-commonjs";

    export default {
        plugins: [resolve(),commonjs()],

        input: "src/main.js",
        output: {
            file: "bundle.js",
            format: "cjs",
        },
    };
    ```

## 1.6. 引入 Sass 资源

rollup-plugin-postcss 默认集成了对 scss、less、stylus 的支持。

### 1.6.1 打包支持 sass 文件

1. 新增 `src/foo.scss`：

    ```scss
    body {
        background-color: red;
        display: flex;
    }
    ```

2. 更新 `src/main.js`：

    ```js
    import foo from "./foo.js";
    import "./foo.scss";
    import { sum } from "lodash-es";

    function test() {
        console.log(foo);
        console.log(sum([1, 2]));
        console.log(foo.text);
    }

    test()
    ```

3. 安装：

    ```sh
    # 安装sass
    pnpm install sass -D
    # 安装postcss 用于浏览器适配
    pnpm add rollup-plugin-postcss -D
    ```

4. 更新 rollup.config.js：

    ```js
    import resolve from "@rollup/plugin-node-resolve";
    import commonjs from "@rollup/plugin-commonjs";
    import postcss from "rollup-plugin-postcss";

    export default {
        plugins: [resolve(),commonjs(), postcss()],

        input: "src/main.js",
        output: {
            file: "bundle.js",
            format: "cjs",
        },
    };
    ```

### 1.6.2 css 加前缀

1. 安装：

    ```sh
    pnpm add autoprefixer -D
    ```

2. 更新 packages.json：

    ```js
    "browserslist": [
        "defaults",
        "not ie < 8",
        "last 2 versions",
        "> 1%",
        "iOS 7",
        "last 3 iOS versions"
    ]
    ```

3. 更新 rollup.config.js：

    ```js
    import resolve from "@rollup/plugin-node-resolve";
    import commonjs from "@rollup/plugin-commonjs";
    import postcss from "rollup-plugin-postcss";
    import autoprefixer from "autoprefixer";

    export default {
        plugins: [
            resolve(),
            commonjs(), 
            postcss({
                plugins: [autoprefixer()],
            })
        ],

        input: "src/main.js",
        output: {
            file: "bundle.js",
            format: "umd",
            name:"test"
        },
    };
    ```


### 1.6.3 css 压缩

1. 安装：

    ```sh
    pnpm add cssnano -D
    ```

2. 更新 rollup.config.js：

    ```js
    import resolve from "@rollup/plugin-node-resolve";
    import commonjs from "@rollup/plugin-commonjs";
    import postcss from "rollup-plugin-postcss";
    import autoprefixer from "autoprefixer";
    import cssnano from "cssnano";

    export default {
        plugins: [
            resolve(),
            commonjs(), 
            postcss({
                plugins: [autoprefixer(),cssnano()],
            })
        ],

        input: "src/main.js",
        output: {
            file: "bundle.js",
            format: "umd",
            name:"test"
        },
    };
    ```

### 1.6.4 抽离单独的 css 文件

1. 更新 `rollup.config.js`：

    ```js
    export default [
        {
            plugins: [
                postcss({
                    plugins: [autoprefixer(), cssnano()],
                    extract: "css/index.css",
                }),
            ],
        },
    ];
    ```

## 1.7 引入 Typescript 资源

1. 安装必要依赖​

    ```sh
    pnpm install --save-dev typescript @rollup/plugin-typescript @types/node
    ```
2. 基础配置 rollup.config.js

    ```js
    import typescript from "@rollup/plugin-typescript";
    import resolve from "@rollup/plugin-node-resolve";
    import commonjs from "@rollup/plugin-commonjs";

    export default {
        input: "src/main.ts", // TypeScript 入口文件
        output: {
            file: "dist/bundle.js", // 输出文件
            format: "esm", // 输出格式 (esm/cjs/iife/umd)
            sourcemap: true, // 生成 sourcemap
        },
        plugins: [
            resolve(), // 解析 node_modules 中的模块
            commonjs(), // 转换 CommonJS 模块
            typescript(), // 处理 TypeScript
        ],
    };
    ```
3. 关键配置说明​​


    - `​​@rollup/plugin-typescript` 的常用选项​​

        ```js
        typescript({
            tsconfig: './tsconfig.json',  // 指定 tsconfig 路径（默认自动查找）
            include: ['src/**/*.ts'],     // 包含的文件
            exclude: ['node_modules/**'], // 排除的文件
            compilerOptions: {            // 覆盖 tsconfig 中的配置
                module: 'ESNext',
                target: 'ESNext'
            }
        })
        ```
        
    - 在项目根目录创建 tsconfig.json(​​必须配置)：

        ```json
        {
            "compilerOptions": {
                "module": "ESNext",        // 必须为 ESNext 或 ES6+
                "target": "ESNext",        // 编译目标版本
                "moduleResolution": "node",
                "esModuleInterop": true,   // 兼容 CommonJS 和 ESM
                "strict": true,
                "sourceMap": true          // 生成 sourcemap
            },
            "include": ["src/**/*.ts"],  // 包含的文件
            "exclude": ["node_modules"]
        }
        ```
4. 完整工作流示例​​
    - ​文件结构​​

        ```
        project/
        ├── src/
        │   ├── main.ts
        │   └── utils.ts
        ├── tsconfig.json
        ├── rollup.config.js
        └── package.json
        ```
    - ​​示例代码​​

        ```js
        // src/utils.ts
        export const greet = (name: string): string => `Hello, ${name}!`;

        // src/main.ts
        import { greet } from './utils';
        console.log(greet('World'));
        ```
    - ​​构建命令​​

        ```sh
        rollup -c   # 使用 rollup.config.js
        ```
5. 生成类型声明文件 (.d.ts)​​ 

    在 tsconfig.json中启用：

    ```json
    {
        "compilerOptions": {
            "declaration": true,
            "declarationDir": "dist/types"
        }
    }
    ```

## 1.8 打包产物清除调试代码

插件 `@rollup/plugin-strip` 用于从代码中删除 debugger 语句和函数。包括 assert.equal、console.log 等等。

1. 安装：

    ```sh
    pnpm add @rollup/plugin-strip -D
    ```

2. 更新 rollup.config.js：

    ```js
    import strip from "@rollup/plugin-strip";
    export default [
        {
            plugins: [
                strip()
            ];
        }
    ];
    ```

3. src/main.js

    ```js
    import foo from "./foo.js";

    function test() {
        console.log("开始");
        debugger
        console.log(foo);
        debugger
        console.log("结束");
        return "删除了debugger与console.log"
    }

    export default test
    ```
4. 运行结果

    ```js
    function test() {
        return "删除了debugger与console.log"
    }

    export { test as default };
    ```

## 1.9 打包输出文件保留原始模块结构

- preserveModules 设置后保留原来目录结构

    ```js
    output: {
        dir: path.dirname('dist/bundle.js'),
        format: 'es',
        exports: 'named', // 指定导出模式（自动、默认、命名、无）
        preserveModules: true, // 保留模块结构
        preserveModulesRoot: 'src', // 将保留的模块放在根级别的此路径下
    },
    ```

