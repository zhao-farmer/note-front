# 二、Rollup 高级

## 2.1 编程式的构建控制

1. 核心 API 概览

    | 方法                | 作用                   | 返回值             | 使用场景                    |
    |-------------------|----------------------|-----------------|-------------------------|
    | `rollup.rollup()`   | 启动构建流程，生成 bundle 对象  | `Promise<Bundle>` | 开发自定义构建流程、插件测试          |
    | `bundle.generate()` | 生成代码和 sourcemap（内存中） | `Promise<Output>` | 需要后处理代码的场景（如代码分析、自定义压缩） |
    | `bundle.write()`    | 将生成结果写入磁盘            | `Promise<void>`   | 常规生产环境构建                |

2. 完整配置文件 rollup.config.js

    ```js
    import { rollup } from 'rollup';
    import { nodeResolve } from '@rollup/plugin-node-resolve';
    import commonjs from '@rollup/plugin-commonjs';
    import typescript from '@rollup/plugin-typescript';
    import terser from '@rollup/plugin-terser';

    /**
    * Rollup 构建流程分为三个阶段：
    * 1. rollup.rollup() - 创建 bundle 对象
    * 2. bundle.generate() - 内存中生成代码（可选）
    * 3. bundle.write() - 写入磁盘
    */
    export default async function build() {
        try {
            // ============================================
            // 第一阶段：初始化构建（rollup.rollup）
            // ============================================
            const bundle = await rollup({
                // 核心输入配置
                input: 'src/main.ts',
                
                // 插件系统（按顺序执行）
                plugins: [
                    nodeResolve(),          // 解析 node_modules 中的模块
                    commonjs(),             // 转换 CommonJS 为 ESM
                    typescript(),           // 处理 TypeScript
                ],
                
                // 高级配置
                cache: true,              // 启用构建缓存（提升增量构建速度）
                external: ['react'],      // 外部化依赖（不打包进 bundle）
                onwarn(warning) {         // 自定义警告处理
                    if (warning.code === 'UNUSED_EXTERNAL_IMPORT') return;
                    console.warn(warning.message);
                }
            });

            // ============================================
            // 第二阶段：生成内存结果（bundle.generate，可选）
            // ============================================
            const memoryOutput = await bundle.generate({
                format: 'esm',           // 输出格式（esm/cjs/iife/umd）
                sourcemap: true,         // 生成 sourcemap
                chunkFileNames: '[name]-[hash].js', // 动态导入的 chunk 命名
            });

            // 可以在此处分析内存中的输出（例如检查文件大小）
            console.log('Generated chunks:', memoryOutput.output.map(chunk => chunk.fileName));

            // ============================================
            // 第三阶段：写入磁盘（bundle.write）
            // ============================================
            await bundle.write({
                dir: 'dist',             // 输出目录
                format: 'esm',           // 必须与 generate() 的格式一致
                sourcemap: true,         // 输出 .map 文件
                entryFileNames: '[name].js',       // 入口文件名格式
                chunkFileNames: '[name]-[hash].js', // chunk 文件名格式
                assetFileNames: 'assets/[name]-[hash][extname]', // 静态资源文件名
                plugins: [terser()],     // 生产环境专用插件（代码压缩）
            });

            // 关闭 bundle 释放内存
            await bundle.close();
            console.log('Build completed!');

        } catch (error) {
            console.error('Build failed:', error);
            process.exit(1);
        }
    }

    // 执行构建
    build();
    ```
3. 关键配置项详解


    -  ​**​输入配置（rollup.rollup()）​**​

        | 配置项 | 类型  | 说明  |
        | --- | --- | --- |
        | `input` | `string` | 入口文件路径（支持数组形式的多入口） |
        | `plugins` | `array` | 插件列表（执行顺序从前往后） |
        | `external` | `array` | 外部化依赖（如 `['react', 'lodash']`） |
        | `cache` | `boolean` | 启用缓存（默认 `true`，显著提升增量构建速度） |
        | `treeshake` | `object` | 摇树优化配置（如 `{ moduleSideEffects: false }`） |

    -  ​**​输出配置（generate()/write()）​**​

        | 配置项 | 类型  | 说明  |
        | --- | --- | --- |
        | `format` | `string` | 输出格式：`esm`（默认）、`cjs`、`iife`、`umd` |
        | `dir`/ `file` | `string` | `dir`用于多入口输出目录，`file`用于单文件输出 |
        | `sourcemap` | `boolean` | 是否生成 sourcemap（开发建议 `true`） |
        | `entryFileNames` | `string` | 入口文件名模板（如 `[name].js`） |
        | `chunkFileNames` | `string` | 动态导入的 chunk 文件名模板（如 `[name]-[hash].js`） |
        | `assetFileNames` | `string` | 静态资源文件名模板（如 `assets/[name]-[hash][extname]`） |

4. 代码详情

    - 安装插件

        ```sh
        # 安装插件
        pnpm i rollup typescript @types/node @rollup/plugin-typescript @rollup/plugin-commonjs @rollup/plugin-node-resolve @rollup/plugin-terser --save-dev
        # 重新安装tslib
        pnpm add tslib --save-dev
        ```
    - ​​示例代码​​

        ```js
        // src/utils.ts
        export const greet = (name: string): string => `Hello, ${name}!`;

        // src/main.ts
        import { greet } from './utils';
        console.log(greet('World'));
        ```
     - ​​构建命令​​

        ```sh
        rollup -c   # 使用 rollup.config.js
        ```

## 2.2 插件

1. 插件钩子分类（按阶段）

    1. ​**​构建阶段（Build Phase）​**​

        | 钩子  | 触发时机 | 用途  |
        | --- | --- | --- |
        | `options` | 读取配置后，构建前 | 修改或返回新的配置对象 |
        | `buildStart` | 开始构建时 | 初始化操作（如清理旧文件） |
        | `resolveId` | 解析模块路径时 | 自定义路径解析（如别名） |
        | `load` | 加载文件内容前 | 动态生成或修改文件内容 |
        | `transform` | 转换单个模块时 | 代码转换（如 Babel、TS） |

    2. ​**​生成阶段（Output Phase）​**​

        | 钩子  | 触发时机 | 用途  |
        | --- | --- | --- |
        | `renderStart` | 生成输出文件前 | 准备输出环境 |
        | `augmentChunkHash` | 计算 chunk 哈希前 | 根据自定义逻辑修改哈希 |
        | `renderChunk` | 渲染单个 chunk 时 | 修改 chunk 代码（如添加注释） |
        | `generateBundle` | 所有 chunk 生成后，写入前 | 分析或修改最终 bundle |
        | `writeBundle` | 文件写入磁盘后 | 后处理（如上传 CDN） |

2. rollup.config.js（全钩子演示版）

    ```js
    import { defineConfig } from 'rollup';
    import path from 'path';

    export default defineConfig({
        input: 'src/main.js',
        output: {
            dir: 'dist',
            format: 'esm',
            sourcemap: true
        },
        plugins: [
            {
                name: 'all-hooks-demo',
                
                // ========== 构建阶段钩子 ==========
                
                /** 1. 读取配置后立即调用（可修改配置） */
                options(options) {
                    console.log('原始配置:', options);
                    return { ...options, external: ['react'] }; // 添加外部依赖
                },
                
                /** 2. 构建开始时调用 */
                buildStart() {
                    console.log('构建开始！');
                    this.addWatchFile(path.resolve('config.json')); // 添加监听文件
                },
                
                /** 3. 解析模块路径时调用 */
                resolveId(source, importer) {
                    if (source === 'virtual') {
                    return { id: 'virtual-module', external: false }; // 创建虚拟模块
                    }
                    return null; // 交给其他插件处理
                },
                
                /** 4. 加载文件内容前调用 */
                load(id) {
                    if (id === 'virtual-module') {
                    return 'export const msg = "Hello from virtual!"'; // 动态提供模块内容
                    }
                    return null;
                },
                
                /** 5. 转换模块内容时调用 */
                transform(code, id) {
                    if (id.includes('special')) {
                    return {
                        code: code.replace(/console.log\(.*\)/g, ''), // 移除所有 console.log
                        map: null // 可选 sourcemap
                    };
                    }
                    return null;
                },
                
                /** 6. 模块解析完成时调用（较少使用） */
                moduleParsed(moduleInfo) {
                    if (moduleInfo.id.includes('node_modules')) {
                    console.log(`已解析: ${moduleInfo.id}`);
                    }
                },
                
                /** 7. 构建结束时调用（成功或失败） */
                buildEnd(error) {
                    if (error) console.error('构建失败:', error);
                    else console.log('构建阶段完成！');
                },
                
                // ========== 输出阶段钩子 ==========
                
                /** 8. 输出生成前调用 */
                renderStart(outputOptions, inputOptions) {
                    console.log('生成输出到:', outputOptions.dir);
                },
                
                /** 9. 为每个 chunk 生成哈希前调用 */
                augmentChunkHash(chunkInfo) {
                    if (chunkInfo.name === 'main') {
                    return Date.now().toString(); // 动态修改哈希
                    }
                },
                
                /** 10. 渲染每个 chunk 时调用 */
                renderChunk(code, chunk) {
                    if (chunk.isEntry) {
                    return {
                        code: `/* Entry Chunk ${chunk.fileName} */\n${code}`,
                        map: null
                    };
                    }
                    return null;
                },
                
                /** 11. 所有 chunk 生成后调用（可修改最终 bundle） */
                generateBundle(outputOptions, bundle) {
                    console.log('Bundle 文件列表:', Object.keys(bundle));
                    // 删除未使用的 chunk
                    Object.keys(bundle).forEach(name => {
                    if (bundle[name].code.length === 0) delete bundle[name];
                    });
                },
                
                /** 12. 文件写入磁盘后调用 */
                writeBundle(outputOptions, bundle) {
                    console.log('写入完成！');
                    // 可在此处触发部署脚本
                },
                
                /** 13. 关闭 bundle 时调用（清理资源） */
                closeBundle() {
                    console.log('资源已释放');
                }
            }
        ]
    });
    ```

## 2.3 代码分割与webpack一致

1. 修改配置文件 输出项

    ```js
    // rollup.config.js
    export default {
        output: {
            dir: 'dist',
            manualChunks: {
            // 1. 按依赖分组
            vendor: ['react', 'react-dom', 'lodash'],
            
            // 2. 按功能分组
            utils: ['src/utils/date.js', 'src/utils/string.js'],
            
            // 3. 动态分组函数
            shared: (id) => {
                if (id.includes('shared-components')) return 'shared';
                if (id.includes('node_modules')) return 'vendor';
            }
            }
        }
    };
    ```