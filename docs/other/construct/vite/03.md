# 三、Vite 的高级应用

## 3.1 Vite中 HMR 热更新功能

1. vue项目 默认实现热更新

2. 初始化js项目

    - 安装命令

        ```sh
        pnpm create vite
        ```
    - 选项

        ![](/other/construct/vite/033.png)
    - 安装插件

        ```sh
        # 进入目录
        cd 01_hmr
        # 安装插件
        pnpm install 
        ```
3. 调整项目

    1. 删除src下所有项目

    2. 新建 main.js 文件

        ```js
        document.querySelector('#app').innerHTML = `
        <div>
            <h1>Hello Vite! </h1>
        </div>
        `
        ```
    3. 添加任何html代码都会导致刷新页面

4. 修改为 HMR 模式

    ```js
    function render(){
        document.querySelector('#app').innerHTML = `
            <div>
            <h1>Hello Vite! 4710</h1>
            </div>
        `
    }
    render()

    if(import.meta.hot){
        // 接收自己的热更新 vite会推给accept
        // 第一个参数：接收方法对象集合，第二个参数直接调用
        // 第二个参数：用于方法回调
        import.meta.hot.accept(undefined,(newMoudule)=>{    
            newMoudule.render()
        })
    }
    ```

## 3.2 glob-import 批量导入功能

1. 初始化项目

    - 安装命令

        ```sh
        pnpm create vite
        ```
    - 选项

        ![](/other/construct/vite/034.png)

    - 安装插件

        ```sh
        # 进入目录
        cd 02_glob
        # 安装插件
        pnpm install 
        ```
2. 新建导入文件

    - src/glob/a.js

        ```js
        export default 'a'
        ```
    - src/glob/a.json

        ```json
        {
            "hello":"world"
        }
        ```
    - src/glob/b.js

        ```js
        export default 'b'
        ```
    - src/glob/b.json

        ```json
        {
            "hello":"Vite"
        }
        ```
    - src/glob/test-1.js

        ```js
        export default 'test-1'
        ```

3. 代码示例

    1. 打印导入的对象
        - 代码

            ```js
            // 1. 全部导入
            const globModules = import.meta.glob("./glob/*")
            console.log(globModules);
            ```
        - 运行结果

            ![](/other/construct/vite/035.png)
    2. 使用导入的都西昂
        - 代码

            ```js
            // 2.使用
            Object.entries(globModules).forEach(([k,v])=>{
                console.log(k+":");
                v().then(m =>console.log(m.default))
            })
            ```
        - 运行结果

            ![](/other/construct/vite/036.png)

    3. `*.json` 匹配 只导出后缀为json的

    4. 使用 `*-[0-9].js` 类似正则表达式的匹配

## 3.4 预编译优化

1. 核心特性

    1. ​​第三方依赖的转换​​
        - ​问题​​：现代前端项目通常依赖大量 node_modules 中的第三方库（如 lodash、react），这些库可能是 CommonJS 或 UMD 格式，而浏览器无法直接识别。
        - ​解决​​：Vite 在启动时（vite optimize）会将这些依赖预编译为标准的 ​​ESM 格式​​（浏览器原生支持的模块格式），并合并为单个文件，减少网络请求。
    2. ​​性能优化​​
        - ​减少请求数量​​：将多个分散的依赖文件合并为少数几个文件（如 vendor.js），避免浏览器并发请求过多小文件。
        - 缓存优化​​：预编译后的依赖会存储在 node_modules/.vite 目录中，后续启动直接复用（除非 package.json 变更），显著提升冷启动速度。
    3. ​​解决依赖嵌套问题​​
        - 场景​​：某些依赖内部可能包含深层嵌套的 import（例如 A -> B -> C），导致浏览器需要发起大量请求。
        - 解决​​：预编译会扁平化依赖关系，将嵌套引用内联到单个文件中。
    4. ​​动态导入兼容性​​
        - 确保依赖中的动态导入（如 import('module')）在开发和生产环境下行为一致。



2. 初始化js项目

    - 安装命令

        ```sh
        pnpm create vite
        ```
    - 选项

        ![](/other/construct/vite/037.png)
    - 安装插件

        ```sh
        # 进入目录
        cd 03_compile
        # 安装lodash-es
        pnpm install lodash-es
        ```

3. 测试优化情况

    - main.js 使用 loadash.js

        ```js{3-4}
        import { createApp } from 'vue'

        import { throttle } from 'lodash-es'
        console.log(throttle);

        createApp(App).mount('#app')
        ```

    - vite.config.js 配置过滤预编译

        - 代码

            ```js{7-9}
            import { defineConfig } from 'vite'
            import vue from '@vitejs/plugin-vue'

            // https://vite.dev/config/
            export default defineConfig({
                plugins: [vue()],
                optimizeDeps:{
                    exclude: ["lodash-es"]
                }
            })
            ```
        - 浏览器控制台结果

            ![](/other/construct/vite/038.png)

    - 取消预编译

        - 代码

            ```js
            import { defineConfig } from 'vite'
            import vue from '@vitejs/plugin-vue'

            // https://vite.dev/config/
            export default defineConfig({
                plugins: [vue()],
                optimizeDeps:{
                    // exclude: ["lodash-es"]
                }
            })
            ```

        - 项目中 node_modules/.vite/ 展示

            ![](/other/construct/vite/039.png)
        - 浏览器控制台结果

            ![](/other/construct/vite/040.png)

## 3.5 非node服务中集成 Vite

目录结构创建

```sh
#新建项目目录
mkdir 04_ssr_nonode
# 进入目录
cd 04_ssr_nonode

mkdir ssr-server
# 客户端目录
mkdir ssr-client
```


### 3.5.1 服务端

1. 安装插件

    ```sh
    # 创建服务端目录
    mkdir ssr-server
    # 进入目录
    cd ssr-server
    # 初始化项目
    npm init -y
    # 安装模板
    npm install pug
    # 安装express
    npm install express
    ```
2. 模板文件 views/index.pug

    ```pug
    html
    head 
        title= title 
    body 
        h1= message
        div(id="app")
        script(src="http://localhost:5173/@vite/client" type="module")
        script(src="http://localhost:5173/src/main" type="module")
    ```

3. 启动服务文件 server.js

    ```js
    const express = require("express")
    const app = express()

    app.set("view engine","pug")

    app.get("/",(req,res)=>{
        res.render("index",{title:"Hey",message:"Hello therre!"})
    })

    app.listen(4000)
    ```
### 3.5.2 客户端

1. 初始化js项目

    - 安装命令

        ```sh
        pnpm create vite
        ```
    - 选项

        ![](/other/construct/vite/041.png)
    - 安装插件

        ```sh
        # 进入目录
        cd ssr-client
        # 安装依赖
        pnpm install
        ```

2. 启动项目

    ```sh
    pnpm dev
    ```


<!-- ## 3.6 node中集成 SSR

## 3.7 静态站点导出

## 3.8 其他功能 -->

