# WebAssembly

## 1. 介绍

Webassembly (wasm)，一种二进制代码格式，C、C++、Rust、GO 等编译成 wasn 在浏览器中运行

[Webassembly官网](https://webassembly.org/)

## 2. 主要使用场景

1. 非常复杂的计算，计算密集型任务，rust、C 然后再浏览器端执行
2. 图形渲染，skia + Webassembly = canvaskit
3. 音视频剪辑，webcodes、FFmpeg(这个是脚本，那怎么在浏览器端执行呢? wasm)
4. 高性能渲染库，3D,webGis，rust(python)、skia

## 3. 使用 typescript 创建wasm 文件

[assemblyscript官网](https://www.assemblyscript.org/)

1. 初始化项目

    ```sh
    # 构建项目
    npm init -y
    # 安装
    pnpm install assemblyscript -D
    ```
2. package.json 新增构建脚本

    ```js
    "scripts": {
        "asbuild:release": "asc assembly/index.ts --target release"
    },
    ```

3. asconfig.json 配置

    ```json
    {
        "targets":{
            "release":{
                "outFile":"build/release.wasm",
                "textFile":"build/release.wat",
                "sourceMap":true
            }
        },
        "options":{
            "bindings":"esm"
        }
    }
    ```

    - targets 配置
        
        targets 定义了不同的编译目标配置：

        - release：个编译目标的名称
        - outFile: "build/release.wasm" - 指定编译后的 WebAssembly 文件输出路径
        - textFile: "build/release.wat" - 指定生成的 WAT 文件路径（WebAssembly Text Format，是 WASM 的文本表示形式，方便阅读和调试）
        - sourceMap: true - 是否生成源码映射文件，用于调试时将 WASM 代码映射回原始的 AssemblyScript 代码
    - options 配置
        
        options 定义全局编译选项：

        - bindings: "esm" - 表示生成 ES Module 格式的 JavaScript 绑定文件，用于在 JavaScript 中更方便地调用 WASM 模块


4. 新增需要编译的ts文件 assembly/index.ts

    ```ts
    export function add(a:number,b: number): number{
        return a + b;
    }

    export function sub(a: number, b: number): number {
        return a - b;
    }
    ```

5. 进行编译

    - 执行命令

        ```sh
        pnpm asbuild:release
        ```
    - 编译结果

        ![](/other/knowledge/javascript/001.png)

    - 文件介绍

        1. release.wasm (WebAssembly 二进制文件)
            - 最重要的文件，是实际运行的 WebAssembly 模块
            - 二进制格式，体积小，加载快
            - 在浏览器或 Node.js 中实际执行的文件

        2. release.wat (WebAssembly 文本格式)
            - WebAssembly 的人类可读文本表示
            - 用于调试和学习 WebAssembly 的工作原理
            - 可以看到函数、内存布局、指令等

        3. release.js (JavaScript 绑定文件)
            
            链接wasm文件和前端工程的胶水层代码
          

        4. release.d.ts (TypeScript 类型定义)
            - TypeScript 类型声明文件
            - 提供导出函数的类型信息
            - 让 TypeScript 项目能获得类型提示

        5. release.wasm.map (Source Map 文件)

            源代码映射文件

            - 用于调试：将 WASM 代码映射回原始 TypeScript 代码
            - 在浏览器开发工具中可以看到原始代码而不是 WASM
            - 生产环境通常不需要

    - 开发测试使用

        - 开发时：所有文件都有用

            - .wasm - 运行
            - .js - 方便调用
            - .d.ts - 类型提示
            - .wat - 调试和学习
            - .wasm.map - 调试
        - 生产环境：通常只需要

            - .wasm - 必需
            - .js - 如果使用 JS 包装器
            - .d.ts - 如果是 TypeScript 项目

6. 使用wasm文件

    - 新增 index.html

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
        </head>
        <body>
            <script type="module">
                // 使用胶水层的代码
                import { add,sub } from "./build/release.js"

                console.log(add(1,2));
                console.log(sub(1,2));
                
            </script>
        </body>
        </html>
        ```
    - 添加 serve 服务器

        ```sh
        pnpm install serve -D
        ```
    - 添加运行脚本

        ```js{3}
        "scripts": {
            "asbuild:release": "asc assembly/index.ts --target release",
            "dev": "serve ."
        },
        ```
    - 执行命令

        ```sh
        npm run dev
        ```
    - 浏览器控制台打印

        ![](/other/knowledge/javascript/002.png)


