# 四、整合知识点案例

1. 项目特点

    - 完整组件集成
        - 后台脚本​​: 核心逻辑、消息路由、定时任务
        - 内容脚本​​: 页面分析、DOM操作、实时响应
        - 弹出窗口​​: 快速控制、状态显示、即时操作
        - 选项页面​​: 详细设置、数据管理、配置备份

    - 常用API演示
        - chrome.storage- 数据存储和同步
        - chrome.runtime- 消息通信和生命周期
        - chrome.tabs- 标签页管理
        - chrome.scripting- 脚本执行
        - chrome.alarms- 定时任务
        - chrome.notifications- 桌面通知
        - chrome.action- 浏览器按钮控制

    -  高级特性
        - 响应式设计
        - 暗色主题支持
        - 动态内容处理
        - 错误处理和重试机制
        - 数据导入导出
        - 实时状态同步

2. 代码示例

    - 配置文件 manifest.json

        ```json
        {
            "manifest_version": 3,
            "name": "全能网页助手",
            "version": "1.0.0",
            "description": "一个包含所有组件的完整Chrome插件示例",
            "permissions": [
                "activeTab",
                "storage",
                "scripting",
                "alarms",
                "notifications"
            ],
            "background": {
                "service_worker": "background.js",
                "type": "module"
            },
            "content_scripts": [
                {
                    "matches": [
                        "<all_urls>"
                    ],
                    "js": [
                        "content.js"
                    ],
                    "css": [
                        "content.css"
                    ],
                    "run_at": "document_idle"
                }
            ],
            "action": {
                "default_popup": "popup.html",
                "default_title": "网页助手",
                "default_icon": {
                "16": "icons/icon16.png",
                "48": "icons/icon48.png",
                "128": "icons/icon128.png"
                }
            },
            "options_ui": {
                "page": "options.html",
                "open_in_tab": false
            },
            "icons": {
                "16": "icons/icon16.png",
                "48": "icons/icon48.png",
                "128": "icons/icon128.png"
            },
            "web_accessible_resources": [
                {
                    "resources": [
                        "content.js",
                        "content.css"
                    ],
                    "matches": [
                        "<all_urls>"
                    ]
                }
            ]
        }
        ```
    - 后台脚本 background.js

        ```js
        // background.js - 核心后台服务
        class BackgroundService {
            constructor() {
                this.settings = {};
                this.analytics = [];
                this.init();
            }

            async init() {
                console.log("🚀 后台服务初始化");

                await this.loadSettings();
                this.setupEventListeners();
                this.startScheduledTasks();

                console.log("✅ 后台服务就绪");
            }

            // 加载设置
            async loadSettings() {
                const result = await chrome.storage.sync.get(["settings"]);
                this.settings = result.settings || this.getDefaultSettings();
            }

            getDefaultSettings() {
                return {
                    enabled: true,
                    highlightHeadings: true,
                    showStats: true,
                    autoSave: false,
                    theme: "light",
                };
            }

            // 设置事件监听器
            setupEventListeners() {
                // 扩展生命周期事件
                chrome.runtime.onInstalled.addListener(this.handleInstallation.bind(this));

                // 消息通信
                chrome.runtime.onMessage.addListener(this.handleMessage.bind(this));

                // 警报系统
                chrome.alarms.onAlarm.addListener(this.handleAlarm.bind(this));

                // 存储变化
                chrome.storage.onChanged.addListener(this.handleStorageChange.bind(this));

                // 标签页事件
                chrome.tabs.onUpdated.addListener(this.handleTabUpdate.bind(this));
                chrome.tabs.onActivated.addListener(this.handleTabActivated.bind(this));
            }

            // 处理安装事件
            handleInstallation(details) {
                console.log("📦 扩展安装:", details.reason);

                if (details.reason === "install") {
                    this.showNotification("欢迎使用！", "全能网页助手已成功安装。");
                    this.initializeDefaultData();
                }
            }

            // 初始化默认数据
            async initializeDefaultData() {
                const defaultData = {
                    settings: this.getDefaultSettings(),
                    analytics: [],
                    created: new Date().toISOString(),
                };

                await chrome.storage.sync.set(defaultData);
                this.settings = defaultData.settings;
            }

            // 处理消息
            async handleMessage(request, sender, sendResponse) {
                console.log("📨 收到消息:", request.type);

                try {
                    switch (request.type) {
                        case "GET_SETTINGS":
                            sendResponse({ success: true, data: this.settings });
                            break;

                        case "UPDATE_SETTINGS":
                            await this.updateSettings(request.data);
                            sendResponse({ success: true });
                            break;

                        case "GET_ANALYTICS":
                            const analytics = await this.getAnalytics();
                            sendResponse({ success: true, data: analytics });
                            break;

                        case "EXECUTE_SCRIPT":
                            await this.executeContentScript(request.data);
                            sendResponse({ success: true });
                            break;

                        case "PAGE_ANALYZED":
                            await this.savePageAnalysis(request.data);
                            sendResponse({ success: true });
                            break;

                        case "SHOW_NOTIFICATION":
                            this.showNotification(request.data.title, request.data.message);
                            sendResponse({ success: true });
                            break;

                        default:
                            sendResponse({ success: false, error: "未知消息类型" });
                    }
                } catch (error) {
                    console.error("处理消息错误:", error);
                    sendResponse({ success: false, error: error.message });
                }

                return true; // 保持消息通道开放
            }

            // 更新设置
            async updateSettings(newSettings) {
                this.settings = { ...this.settings, ...newSettings };
                await chrome.storage.sync.set({ settings: this.settings });

                // 广播设置更新
                this.broadcastSettingsUpdate();

                console.log("⚙️ 设置已更新");
            }

            // 广播设置更新
            async broadcastSettingsUpdate() {
                // 通知所有标签页
                const tabs = await chrome.tabs.query({});
                for (const tab of tabs) {
                    chrome.tabs
                        .sendMessage(tab.id, {
                            type: "SETTINGS_UPDATED",
                            data: this.settings,
                        })
                        .catch(() => {}); // 忽略错误
                }
            }

            // 获取分析数据
            async getAnalytics() {
                const result = await chrome.storage.local.get(["analytics"]);
                return result.analytics || [];
            }

            // 执行内容脚本
            async executeContentScript(command) {
                const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

                if (tab) {
                    await chrome.scripting.executeScript({
                        target: { tabId: tab.id },
                        func: cmd => {
                            if (window.__contentScript) {
                                window.__contentScript.executeCommand(cmd);
                            }
                        },
                        args: [command],
                    });
                }
            }

            // 保存页面分析
            async savePageAnalysis(data) {
                const result = await chrome.storage.local.get(["analytics"]);
                const analytics = result.analytics || [];

                analytics.push({
                    ...data,
                    id: Date.now(),
                    analyzedAt: new Date().toISOString(),
                });

                // 只保留最近100条记录
                if (analytics.length > 100) {
                    analytics.shift();
                }

                await chrome.storage.local.set({ analytics });
            }

            // 处理警报
            handleAlarm(alarm) {
                switch (alarm.name) {
                    case "daily-cleanup":
                        this.performCleanup();
                        break;
                    case "analytics-report":
                        this.generateAnalyticsReport();
                        break;
                }
            }

            // 处理存储变化
            handleStorageChange(changes, area) {
                if (area === "sync" && changes.settings) {
                    this.settings = changes.settings.newValue;
                    console.log("📦 设置已同步更新");
                }
            }

            // 处理标签页更新
            handleTabUpdate(tabId, changeInfo, tab) {
                if (changeInfo.status === "complete") {
                    console.log("🌐 标签页加载完成:", tab.url);
                }
            }

            // 处理标签页激活
            handleTabActivated(activeInfo) {
                console.log("🔍 激活标签页:", activeInfo.tabId);
            }

            // 启动定时任务
            startScheduledTasks() {
                // 每日清理
                chrome.alarms.create("daily-cleanup", {
                    periodInMinutes: 60 * 24, // 24小时
                });

                // 分析报告
                chrome.alarms.create("analytics-report", {
                    periodInMinutes: 60 * 6, // 6小时
                });

                console.log("⏰ 定时任务已启动");
            }

            // 执行清理
            async performCleanup() {
                console.log("🧹 执行每日清理");
                // 清理逻辑...
            }

            // 生成分析报告
            async generateAnalyticsReport() {
                const analytics = await this.getAnalytics();
                console.log("📊 分析报告: 共", analytics.length, "条记录");
            }

            // 显示通知
            showNotification(title, message) {
                chrome.notifications.create({
                    type: "basic",
                    iconUrl: chrome.runtime.getURL("icons/icon48.png"),
                    title: title,
                    message: message,
                    priority: 1,
                });
            }

            // 工具方法：重试操作
            async retryOperation(operation, maxRetries = 3, delay = 1000) {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        return await operation();
                    } catch (error) {
                        if (attempt === maxRetries) throw error;
                        await this.sleep(delay * attempt);
                    }
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // 初始化后台服务
        const backgroundService = new BackgroundService();

        // 错误处理
        self.addEventListener('unhandledrejection', event => {
            console.error("❌ 未处理的Promise拒绝:", event.reason);
        });

        ```
    - 内容脚本
        - content.css

            ```css
            /* content.css */
            .extension-highlight {
                background-color: #ffff00 !important;
                border: 2px solid #ff6b6b !important;
                padding: 2px 4px !important;
                border-radius: 3px !important;
            }

            .extension-stats-panel {
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                background: white !important;
                border: 2px solid #007bff !important;
                border-radius: 8px !important;
                padding: 12px !important;
                z-index: 10000 !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif !important;
                max-width: 250px !important;
            }

            .extension-stats-panel .stats-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-bottom: 8px !important;
                border-bottom: 1px solid #eee !important;
                padding-bottom: 8px !important;
            }

            .extension-stats-panel .stats-header h4 {
                margin: 0 !important;
                color: #007bff !important;
                font-size: 14px !important;
            }

            .extension-stats-panel .close-btn {
                background: none !important;
                border: none !important;
                font-size: 18px !important;
                cursor: pointer !important;
                color: #999 !important;
            }

            .extension-stats-panel .stats-content {
                font-size: 12px !important;
                line-height: 1.5 !important;
            }

            .extension-stats-panel .stats-content p {
                margin: 4px 0 !important;
                color: #333 !important;
            }

            .extension-control-btn {
                position: fixed !important;
                bottom: 20px !important;
                right: 20px !important;
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background: #007bff !important;
                color: white !important;
                border: none !important;
                cursor: pointer !important;
                z-index: 10001 !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
                font-size: 18px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            /* 暗色主题支持 */
            @media (prefers-color-scheme: dark) {
                .extension-stats-panel {
                    background: #2d3748 !important;
                    border-color: #63b3ed !important;
                    color: white !important;
                }

                .extension-stats-panel .stats-header h4 {
                    color: #63b3ed !important;
                }

                .extension-stats-panel .stats-content p {
                    color: #e2e8f0 !important;
                }
            }
            ```
        - content.js

            ```js
            // content.js - 网页内容处理器
            class ContentScript {
                constructor() {
                    this.settings = {};
                    this.isEnabled = true;
                    this.init();
                }

                async init() {
                    console.log("🚀 内容脚本初始化");

                    await this.loadSettings();
                    this.setupMessageListeners();
                    this.setupMutationObserver();

                    if (document.readyState === "loading") {
                        document.addEventListener("DOMContentLoaded", () => this.onPageReady());
                    } else {
                        this.onPageReady();
                    }
                }

                // 加载设置
                async loadSettings() {
                    try {
                        const result = await chrome.storage.sync.get(["settings"]);
                        this.settings = result.settings || {};
                        this.isEnabled = this.settings.enabled !== false;
                    } catch (error) {
                        console.error("加载设置失败:", error);
                    }
                }

                // 页面就绪
                onPageReady() {
                    if (!this.isEnabled) return;

                    this.analyzePage();
                    this.injectUI();
                    this.applySettings();

                    this.sendAnalysisReport();
                }

                // 分析页面
                analyzePage() {
                    const analysis = {
                        url: window.location.href,
                        title: document.title,
                        wordCount: this.countWords(),
                        linkCount: this.countLinks(),
                        imageCount: this.countImages(),
                        headingCount: this.countHeadings(),
                        pageSize: this.calculatePageSize(),
                        timestamp: new Date().toISOString(),
                    };

                    this.currentAnalysis = analysis;
                    console.log("📊 页面分析完成", analysis);
                }

                // 计数工具方法
                countWords() {
                    const text = document.body.textContent || "";
                    return text
                        .trim()
                        .split(/\s+/)
                        .filter(w => w.length > 0).length;
                }

                countLinks() {
                    return document.links.length;
                }
                countImages() {
                    return document.images.length;
                }
                countHeadings() {
                    return document.querySelectorAll("h1, h2, h3, h4, h5, h6").length;
                }

                calculatePageSize() {
                    return new Blob([document.documentElement.outerHTML]).size;
                }

                // 注入UI
                injectUI() {
                    this.removeExistingUI();

                    if (this.settings.showStats) {
                        this.createStatsPanel();
                    }

                    this.createControlButton();
                }

                // 创建统计面板
                createStatsPanel() {
                    const panel = document.createElement("div");
                    panel.className = "extension-stats-panel";
                    panel.innerHTML = `
                <div class="stats-header">
                    <h4>📊 页面统计</h4>
                    <button class="close-btn">×</button>
                </div>
                <div class="stats-content">
                    <p>📝 字数: ${this.currentAnalysis.wordCount.toLocaleString()}</p>
                    <p>🔗 链接: ${this.currentAnalysis.linkCount}</p>
                    <p>📷 图片: ${this.currentAnalysis.imageCount}</p>
                    <p>📑 标题: ${this.currentAnalysis.headingCount}</p>
                </div>
                `;

                    document.body.appendChild(panel);

                    // 关闭按钮事件
                    panel.querySelector(".close-btn").addEventListener("click", () => {
                        panel.remove();
                    });
                }

                // 创建控制按钮
                createControlButton() {
                    const btn = document.createElement("button");
                    btn.className = "extension-control-btn";
                    btn.textContent = "⚡";
                    btn.title = "网页助手控制";

                    btn.addEventListener("click", () => {
                        this.toggleFeatures();
                    });

                    document.body.appendChild(btn);
                }

                // 切换功能
                toggleFeatures() {
                    this.isEnabled = !this.isEnabled;
                    this.applySettings();

                    chrome.runtime.sendMessage({
                        type: "SHOW_NOTIFICATION",
                        data: {
                            title: this.isEnabled ? "功能已启用" : "功能已禁用",
                            message: this.isEnabled ? "网页助手正在运行" : "网页助手已暂停",
                        },
                    });
                }

                // 应用设置
                applySettings() {
                    if (this.settings.highlightHeadings && this.isEnabled) {
                        this.highlightHeadings();
                    } else {
                        this.removeHighlights();
                    }
                }

                // 高亮标题
                highlightHeadings() {
                    this.removeHighlights();

                    document.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(heading => {
                        heading.classList.add("extension-highlight");
                    });
                }

                // 移除高亮
                removeHighlights() {
                    document.querySelectorAll(".extension-highlight").forEach(el => {
                        el.classList.remove("extension-highlight");
                    });
                }

                // 移除现有UI
                removeExistingUI() {
                    document.querySelectorAll(".extension-stats-panel, .extension-control-btn").forEach(el => el.remove());
                }

                // 设置消息监听
                setupMessageListeners() {
                    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
                        switch (request.type) {
                            case "SETTINGS_UPDATED":
                                this.settings = request.data;
                                this.isEnabled = this.settings.enabled !== false;
                                this.applySettings();
                                sendResponse({ success: true });
                                break;

                            case "EXECUTE_COMMAND":
                                this.executeCommand(request.data);
                                sendResponse({ success: true });
                                break;

                            default:
                                sendResponse({ success: false });
                        }
                    });
                }

                // 设置突变观察器
                setupMutationObserver() {
                    const observer = new MutationObserver(mutations => {
                        mutations.forEach(mutation => {
                            if (mutation.addedNodes.length > 0 && this.isEnabled) {
                                this.handleNewContent(mutation.addedNodes);
                            }
                        });
                    });

                    observer.observe(document.body, {
                        childList: true,
                        subtree: true,
                    });
                }

                // 处理新内容
                handleNewContent(nodes) {
                    nodes.forEach(node => {
                        if (node.nodeType === 1 && this.settings.highlightHeadings) {
                            node.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(heading => {
                                heading.classList.add("extension-highlight");
                            });
                        }
                    });
                }

                // 执行命令
                executeCommand(command) {
                    switch (command) {
                        case "highlight":
                            this.highlightHeadings();
                            break;
                        case "analyze":
                            this.analyzePage();
                            this.injectUI();
                            break;
                    }
                }

                // 发送分析报告
                sendAnalysisReport() {
                    chrome.runtime
                        .sendMessage({
                            type: "PAGE_ANALYZED",
                            data: this.currentAnalysis,
                        })
                        .catch(() => {
                            // 忽略发送失败
                        });
                }
            }

            // 初始化内容脚本
            if (!window.__contentScriptInitialized) {
                window.__contentScriptInitialized = true;
                const contentScript = new ContentScript();
                window.__contentScript = contentScript;
            }
            ```
    - popup 弹窗

        - popup.html

            ```html
            <!-- options.html -->
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8" />
                <link rel="stylesheet" href="options.css" />
            </head>
            <body>
                <div class="options-container">
                    <header class="options-header">
                        <h1>⚙️ 网页助手设置</h1>
                        <p>自定义您的浏览体验</p>
                    </header>

                    <main class="options-main">
                        <form id="settings-form">
                            <div class="setting-group">
                                <h3>🔧 基本设置</h3>
                                <label class="switch">
                                    <input type="checkbox" id="enable-extension" checked />
                                    <span class="slider"></span>
                                    <span class="label-text">启用扩展</span>
                                </label>

                                <label class="switch">
                                    <input type="checkbox" id="highlight-headings" checked />
                                    <span class="slider"></span>
                                    <span class="label-text">高亮标题</span>
                                </label>

                                <label class="switch">
                                    <input type="checkbox" id="show-stats" checked />
                                    <span class="slider"></span>
                                    <span class="label-text">显示统计面板</span>
                                </label>
                            </div>

                            <div class="setting-group">
                                <h3>🎨 外观设置</h3>
                                <label>
                                    主题模式：
                                    <select id="theme">
                                        <option value="light">浅色</option>
                                        <option value="dark">深色</option>
                                        <option value="auto">自动</option>
                                    </select>
                                </label>
                            </div>

                            <div class="setting-group">
                                <h3>📊 数据管理</h3>
                                <div class="button-group">
                                    <button type="button" id="export-data" class="btn secondary">导出所有数据</button>
                                    <button type="button" id="clear-data" class="btn danger">清除数据</button>
                                </div>
                            </div>
                        </form>

                        <div class="actions">
                            <button type="submit" form="settings-form" class="btn primary">💾 保存设置</button>
                            <button type="button" id="reset-btn" class="btn secondary">🔄 恢复默认</button>
                        </div>
                    </main>

                    <footer class="options-footer">
                        <p>版本 1.0.0 | 存储使用: <span id="storage-usage">计算中...</span></p>
                    </footer>
                </div>

                <script src="options.js"></script>
            </body>
            </html>

            ```
        - popup.js

            ```js
            // options.js
            class OptionsManager {
                constructor() {
                    this.settings = {};
                    this.init();
                }

                async init() {
                    await this.loadSettings();
                    this.setupEventListeners();
                    this.updateStorageUsage();
                }

                async loadSettings() {
                    const response = await chrome.runtime.sendMessage({ type: "GET_SETTINGS" });
                    if (response.success) {
                        this.settings = response.data;
                        this.populateForm();
                    }
                }

                populateForm() {
                    document.getElementById("enable-extension").checked = this.settings.enabled !== false;
                    document.getElementById("highlight-headings").checked = this.settings.highlightHeadings !== false;
                    document.getElementById("show-stats").checked = this.settings.showStats !== false;
                    document.getElementById("theme").value = this.settings.theme || "light";
                }

                setupEventListeners() {
                    document.getElementById("settings-form").addEventListener("submit", e => {
                        e.preventDefault();
                        this.saveSettings();
                    });

                    document.getElementById("reset-btn").addEventListener("click", () => {
                        this.resetToDefaults();
                    });

                    document.getElementById("export-data").addEventListener("click", () => {
                        this.exportAllData();
                    });

                    document.getElementById("clear-data").addEventListener("click", () => {
                        this.clearData();
                    });
                }

                getSettingsFromForm() {
                    return {
                        enabled: document.getElementById("enable-extension").checked,
                        highlightHeadings: document.getElementById("highlight-headings").checked,
                        showStats: document.getElementById("show-stats").checked,
                        theme: document.getElementById("theme").value,
                    };
                }

                async saveSettings() {
                    const newSettings = this.getSettingsFromForm();

                    await chrome.runtime.sendMessage({
                        type: "UPDATE_SETTINGS",
                        data: newSettings,
                    });

                    this.settings = newSettings;
                    this.showMessage("设置已保存");
                }

                async resetToDefaults() {
                    if (confirm("确定要恢复默认设置吗？")) {
                        const defaultSettings = {
                            enabled: true,
                            highlightHeadings: true,
                            showStats: true,
                            theme: "light",
                        };

                        await chrome.runtime.sendMessage({
                            type: "UPDATE_SETTINGS",
                            data: defaultSettings,
                        });

                        this.settings = defaultSettings;
                        this.populateForm();
                        this.showMessage("已恢复默认设置");
                    }
                }

                async exportAllData() {
                    const [settings, analytics] = await Promise.all([chrome.runtime.sendMessage({ type: "GET_SETTINGS" }), chrome.runtime.sendMessage({ type: "GET_ANALYTICS" })]);

                    const exportData = {
                        settings: settings.success ? settings.data : {},
                        analytics: analytics.success ? analytics.data : [],
                        exportedAt: new Date().toISOString(),
                    };

                    this.downloadJSON(exportData, "网页助手备份.json");
                    this.showMessage("数据已导出");
                }

                async clearData() {
                    if (confirm("确定要清除所有数据吗？此操作不可撤销。")) {
                        await chrome.storage.local.clear();
                        await chrome.storage.sync.clear();
                        this.showMessage("数据已清除");
                        this.updateStorageUsage();
                    }
                }

                async updateStorageUsage() {
                    const { bytesInUse } = await chrome.storage.local.getBytesInUse();
                    document.getElementById("storage-usage").textContent = this.formatBytes(bytesInUse);
                }

                formatBytes(bytes) {
                    const sizes = ["B", "KB", "MB", "GB"];
                    if (bytes === 0) return "0 B";
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return Math.round(bytes / Math.pow(1024, i), 2) + " " + sizes[i];
                }

                downloadJSON(data, filename) {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                showMessage(text) {
                    // 简单的消息提示实现
                    alert(text);
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                new OptionsManager();
            });

            ```
        - popup.css

            ```css
            /* popup.css */
            .popup-container {
                width: 320px;
                padding: 16px;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            }

            .popup-header {
                text-align: center;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid #e0e0e0;
            }

            .popup-header h2 {
                margin: 0;
                color: #2c3e50;
                font-size: 18px;
            }

            #page-info {
                margin: 4px 0 0 0;
                font-size: 12px;
                color: #7f8c8d;
            }

            .popup-main {
                margin-bottom: 12px;
            }

            .stats-section,
            .actions-section,
            .tools-section {
                margin-bottom: 16px;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 8px;
            }

            .stats-section h4,
            .actions-section h4,
            .tools-section h4 {
                margin: 0 0 8px 0;
                color: #2c3e50;
                font-size: 14px;
            }

            #current-stats {
                font-size: 12px;
                line-height: 1.5;
            }

            .action-btn,
            .tool-btn {
                width: 100%;
                padding: 8px 12px;
                margin: 4px 0;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                transition: background-color 0.2s;
            }

            .action-btn {
                background: #007bff;
                color: white;
            }

            .action-btn:hover {
                background: #0056b3;
            }

            .tool-btn {
                background: #6c757d;
                color: white;
            }

            .tool-btn:hover {
                background: #545b62;
            }

            .popup-footer {
                text-align: center;
                padding-top: 12px;
                border-top: 1px solid #e0e0e0;
                font-size: 11px;
                color: #7f8c8d;
            }
            ```
    - options 配置

        - options.html

            ```html
            <!-- popup.html -->
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8" />
                <link rel="stylesheet" href="popup.css" />
            </head>
            <body>
                <div class="popup-container">
                    <header class="popup-header">
                        <h2>🌐 网页助手</h2>
                        <p id="page-info">分析中...</p>
                    </header>

                    <main class="popup-main">
                        <div class="stats-section">
                            <h4>📊 当前页面</h4>
                            <div id="current-stats">加载中...</div>
                        </div>

                        <div class="actions-section">
                            <h4>⚡ 快速操作</h4>
                            <button id="highlight-btn" class="action-btn">🌟 高亮标题</button>
                            <button id="analyze-btn" class="action-btn">📊 重新分析</button>
                            <button id="toggle-btn" class="action-btn">🔧 切换状态</button>
                        </div>

                        <div class="tools-section">
                            <h4>🛠️ 工具</h4>
                            <button id="options-btn" class="tool-btn">⚙️ 设置</button>
                            <button id="export-btn" class="tool-btn">💾 导出数据</button>
                        </div>
                    </main>

                    <footer class="popup-footer">
                        <span id="status">就绪</span>
                    </footer>
                </div>

                <script src="popup.js"></script>
            </body>
            </html>
            ```
        - options.js

            ```js
            // popup.js
            class PopupManager {
                constructor() {
                    this.currentTab = null;
                    this.settings = {};
                    this.init();
                }

                async init() {
                    await this.loadCurrentTab();
                    await this.loadSettings();
                    this.setupEventListeners();
                    this.updateUI();
                }

                async loadCurrentTab() {
                    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
                    this.currentTab = tab;
                    document.getElementById("page-info").textContent = tab.title;
                }

                async loadSettings() {
                    const response = await chrome.runtime.sendMessage({ type: "GET_SETTINGS" });
                    if (response.success) {
                        this.settings = response.data;
                    }
                }

                setupEventListeners() {
                    document.getElementById("highlight-btn").addEventListener("click", () => {
                        this.highlightHeadings();
                    });

                    document.getElementById("analyze-btn").addEventListener("click", () => {
                        this.analyzePage();
                    });

                    document.getElementById("toggle-btn").addEventListener("click", () => {
                        this.toggleExtension();
                    });

                    document.getElementById("options-btn").addEventListener("click", () => {
                        chrome.runtime.openOptionsPage();
                    });

                    document.getElementById("export-btn").addEventListener("click", () => {
                        this.exportData();
                    });
                }

                async highlightHeadings() {
                    this.setStatus("高亮中...");

                    await chrome.runtime.sendMessage({
                        type: "EXECUTE_SCRIPT",
                        data: { command: "highlight" },
                    });

                    this.setStatus("标题已高亮");
                }

                async analyzePage() {
                    this.setStatus("分析中...");

                    await chrome.runtime.sendMessage({
                        type: "EXECUTE_SCRIPT",
                        data: { command: "analyze" },
                    });

                    // 获取最新统计数据
                    setTimeout(() => this.updateStats(), 1000);
                }

                async toggleExtension() {
                    const newState = !this.settings.enabled;

                    await chrome.runtime.sendMessage({
                        type: "UPDATE_SETTINGS",
                        data: { enabled: newState },
                    });

                    this.settings.enabled = newState;
                    this.updateUI();
                    this.setStatus(newState ? "已启用" : "已禁用");
                }

                async exportData() {
                    const response = await chrome.runtime.sendMessage({ type: "GET_ANALYTICS" });
                    if (response.success) {
                        this.downloadJSON(response.data, "网页分析数据.json");
                        this.setStatus("数据已导出");
                    }
                }

                downloadJSON(data, filename) {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                async updateStats() {
                    try {
                        const response = await chrome.tabs.sendMessage(this.currentTab.id, {
                            action: "GET_PAGE_STATS",
                        });

                        if (response.success) {
                            const stats = response.stats;
                            document.getElementById("current-stats").innerHTML = `
                    📝 字数: ${stats.wordCount.toLocaleString()}<br>
                    🔗 链接: ${stats.linkCount}<br>
                    📷 图片: ${stats.imageCount}<br>
                    📑 标题: ${stats.headingCount}
                    `;
                        }
                    } catch (error) {
                        document.getElementById("current-stats").textContent = "无法获取统计数据";
                    }
                }

                updateUI() {
                    const toggleBtn = document.getElementById("toggle-btn");
                    toggleBtn.textContent = this.settings.enabled ? "🔴 禁用" : "🟢 启用";
                }

                setStatus(message) {
                    document.getElementById("status").textContent = message;
                    setTimeout(() => {
                        document.getElementById("status").textContent = "就绪";
                    }, 2000);
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                new PopupManager();
            });

            ```
        - options.css

            ```css
            /* popup.css */
            .popup-container {
                width: 320px;
                padding: 16px;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            }

            .popup-header {
                text-align: center;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid #e0e0e0;
            }

            .popup-header h2 {
                margin: 0;
                color: #2c3e50;
                font-size: 18px;
            }

            #page-info {
                margin: 4px 0 0 0;
                font-size: 12px;
                color: #7f8c8d;
            }

            .popup-main {
                margin-bottom: 12px;
            }

            .stats-section,
            .actions-section,
            .tools-section {
                margin-bottom: 16px;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 8px;
            }

            .stats-section h4,
            .actions-section h4,
            .tools-section h4 {
                margin: 0 0 8px 0;
                color: #2c3e50;
                font-size: 14px;
            }

            #current-stats {
                font-size: 12px;
                line-height: 1.5;
            }

            .action-btn,
            .tool-btn {
                width: 100%;
                padding: 8px 12px;
                margin: 4px 0;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                transition: background-color 0.2s;
            }

            .action-btn {
                background: #007bff;
                color: white;
            }

            .action-btn:hover {
                background: #0056b3;
            }

            .tool-btn {
                background: #6c757d;
                color: white;
            }

            .tool-btn:hover {
                background: #545b62;
            }

            .popup-footer {
                text-align: center;
                padding-top: 12px;
                border-top: 1px solid #e0e0e0;
                font-size: 11px;
                color: #7f8c8d;
            }
            ```

3. 运行结果

    ![](/other/plugin/chrome/021.png)