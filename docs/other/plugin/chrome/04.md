# å››ã€æ•´åˆçŸ¥è¯†ç‚¹æ¡ˆä¾‹

1. é¡¹ç›®ç‰¹ç‚¹

    - å®Œæ•´ç»„ä»¶é›†æˆ
        - åå°è„šæœ¬â€‹â€‹: æ ¸å¿ƒé€»è¾‘ã€æ¶ˆæ¯è·¯ç”±ã€å®šæ—¶ä»»åŠ¡
        - å†…å®¹è„šæœ¬â€‹â€‹: é¡µé¢åˆ†æã€DOMæ“ä½œã€å®æ—¶å“åº”
        - å¼¹å‡ºçª—å£â€‹â€‹: å¿«é€Ÿæ§åˆ¶ã€çŠ¶æ€æ˜¾ç¤ºã€å³æ—¶æ“ä½œ
        - é€‰é¡¹é¡µé¢â€‹â€‹: è¯¦ç»†è®¾ç½®ã€æ•°æ®ç®¡ç†ã€é…ç½®å¤‡ä»½

    - å¸¸ç”¨APIæ¼”ç¤º
        - chrome.storage- æ•°æ®å­˜å‚¨å’ŒåŒæ­¥
        - chrome.runtime- æ¶ˆæ¯é€šä¿¡å’Œç”Ÿå‘½å‘¨æœŸ
        - chrome.tabs- æ ‡ç­¾é¡µç®¡ç†
        - chrome.scripting- è„šæœ¬æ‰§è¡Œ
        - chrome.alarms- å®šæ—¶ä»»åŠ¡
        - chrome.notifications- æ¡Œé¢é€šçŸ¥
        - chrome.action- æµè§ˆå™¨æŒ‰é’®æ§åˆ¶

    -  é«˜çº§ç‰¹æ€§
        - å“åº”å¼è®¾è®¡
        - æš—è‰²ä¸»é¢˜æ”¯æŒ
        - åŠ¨æ€å†…å®¹å¤„ç†
        - é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
        - æ•°æ®å¯¼å…¥å¯¼å‡º
        - å®æ—¶çŠ¶æ€åŒæ­¥

2. ä»£ç ç¤ºä¾‹

    - é…ç½®æ–‡ä»¶ manifest.json

        ```json
        {
            "manifest_version": 3,
            "name": "å…¨èƒ½ç½‘é¡µåŠ©æ‰‹",
            "version": "1.0.0",
            "description": "ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç»„ä»¶çš„å®Œæ•´Chromeæ’ä»¶ç¤ºä¾‹",
            "permissions": [
                "activeTab",
                "storage",
                "scripting",
                "alarms",
                "notifications"
            ],
            "background": {
                "service_worker": "background.js",
                "type": "module"
            },
            "content_scripts": [
                {
                    "matches": [
                        "<all_urls>"
                    ],
                    "js": [
                        "content.js"
                    ],
                    "css": [
                        "content.css"
                    ],
                    "run_at": "document_idle"
                }
            ],
            "action": {
                "default_popup": "popup.html",
                "default_title": "ç½‘é¡µåŠ©æ‰‹",
                "default_icon": {
                "16": "icons/icon16.png",
                "48": "icons/icon48.png",
                "128": "icons/icon128.png"
                }
            },
            "options_ui": {
                "page": "options.html",
                "open_in_tab": false
            },
            "icons": {
                "16": "icons/icon16.png",
                "48": "icons/icon48.png",
                "128": "icons/icon128.png"
            },
            "web_accessible_resources": [
                {
                    "resources": [
                        "content.js",
                        "content.css"
                    ],
                    "matches": [
                        "<all_urls>"
                    ]
                }
            ]
        }
        ```
    - åå°è„šæœ¬ background.js

        ```js
        // background.js - æ ¸å¿ƒåå°æœåŠ¡
        class BackgroundService {
            constructor() {
                this.settings = {};
                this.analytics = [];
                this.init();
            }

            async init() {
                console.log("ğŸš€ åå°æœåŠ¡åˆå§‹åŒ–");

                await this.loadSettings();
                this.setupEventListeners();
                this.startScheduledTasks();

                console.log("âœ… åå°æœåŠ¡å°±ç»ª");
            }

            // åŠ è½½è®¾ç½®
            async loadSettings() {
                const result = await chrome.storage.sync.get(["settings"]);
                this.settings = result.settings || this.getDefaultSettings();
            }

            getDefaultSettings() {
                return {
                    enabled: true,
                    highlightHeadings: true,
                    showStats: true,
                    autoSave: false,
                    theme: "light",
                };
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners() {
                // æ‰©å±•ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
                chrome.runtime.onInstalled.addListener(this.handleInstallation.bind(this));

                // æ¶ˆæ¯é€šä¿¡
                chrome.runtime.onMessage.addListener(this.handleMessage.bind(this));

                // è­¦æŠ¥ç³»ç»Ÿ
                chrome.alarms.onAlarm.addListener(this.handleAlarm.bind(this));

                // å­˜å‚¨å˜åŒ–
                chrome.storage.onChanged.addListener(this.handleStorageChange.bind(this));

                // æ ‡ç­¾é¡µäº‹ä»¶
                chrome.tabs.onUpdated.addListener(this.handleTabUpdate.bind(this));
                chrome.tabs.onActivated.addListener(this.handleTabActivated.bind(this));
            }

            // å¤„ç†å®‰è£…äº‹ä»¶
            handleInstallation(details) {
                console.log("ğŸ“¦ æ‰©å±•å®‰è£…:", details.reason);

                if (details.reason === "install") {
                    this.showNotification("æ¬¢è¿ä½¿ç”¨ï¼", "å…¨èƒ½ç½‘é¡µåŠ©æ‰‹å·²æˆåŠŸå®‰è£…ã€‚");
                    this.initializeDefaultData();
                }
            }

            // åˆå§‹åŒ–é»˜è®¤æ•°æ®
            async initializeDefaultData() {
                const defaultData = {
                    settings: this.getDefaultSettings(),
                    analytics: [],
                    created: new Date().toISOString(),
                };

                await chrome.storage.sync.set(defaultData);
                this.settings = defaultData.settings;
            }

            // å¤„ç†æ¶ˆæ¯
            async handleMessage(request, sender, sendResponse) {
                console.log("ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:", request.type);

                try {
                    switch (request.type) {
                        case "GET_SETTINGS":
                            sendResponse({ success: true, data: this.settings });
                            break;

                        case "UPDATE_SETTINGS":
                            await this.updateSettings(request.data);
                            sendResponse({ success: true });
                            break;

                        case "GET_ANALYTICS":
                            const analytics = await this.getAnalytics();
                            sendResponse({ success: true, data: analytics });
                            break;

                        case "EXECUTE_SCRIPT":
                            await this.executeContentScript(request.data);
                            sendResponse({ success: true });
                            break;

                        case "PAGE_ANALYZED":
                            await this.savePageAnalysis(request.data);
                            sendResponse({ success: true });
                            break;

                        case "SHOW_NOTIFICATION":
                            this.showNotification(request.data.title, request.data.message);
                            sendResponse({ success: true });
                            break;

                        default:
                            sendResponse({ success: false, error: "æœªçŸ¥æ¶ˆæ¯ç±»å‹" });
                    }
                } catch (error) {
                    console.error("å¤„ç†æ¶ˆæ¯é”™è¯¯:", error);
                    sendResponse({ success: false, error: error.message });
                }

                return true; // ä¿æŒæ¶ˆæ¯é€šé“å¼€æ”¾
            }

            // æ›´æ–°è®¾ç½®
            async updateSettings(newSettings) {
                this.settings = { ...this.settings, ...newSettings };
                await chrome.storage.sync.set({ settings: this.settings });

                // å¹¿æ’­è®¾ç½®æ›´æ–°
                this.broadcastSettingsUpdate();

                console.log("âš™ï¸ è®¾ç½®å·²æ›´æ–°");
            }

            // å¹¿æ’­è®¾ç½®æ›´æ–°
            async broadcastSettingsUpdate() {
                // é€šçŸ¥æ‰€æœ‰æ ‡ç­¾é¡µ
                const tabs = await chrome.tabs.query({});
                for (const tab of tabs) {
                    chrome.tabs
                        .sendMessage(tab.id, {
                            type: "SETTINGS_UPDATED",
                            data: this.settings,
                        })
                        .catch(() => {}); // å¿½ç•¥é”™è¯¯
                }
            }

            // è·å–åˆ†ææ•°æ®
            async getAnalytics() {
                const result = await chrome.storage.local.get(["analytics"]);
                return result.analytics || [];
            }

            // æ‰§è¡Œå†…å®¹è„šæœ¬
            async executeContentScript(command) {
                const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

                if (tab) {
                    await chrome.scripting.executeScript({
                        target: { tabId: tab.id },
                        func: cmd => {
                            if (window.__contentScript) {
                                window.__contentScript.executeCommand(cmd);
                            }
                        },
                        args: [command],
                    });
                }
            }

            // ä¿å­˜é¡µé¢åˆ†æ
            async savePageAnalysis(data) {
                const result = await chrome.storage.local.get(["analytics"]);
                const analytics = result.analytics || [];

                analytics.push({
                    ...data,
                    id: Date.now(),
                    analyzedAt: new Date().toISOString(),
                });

                // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•
                if (analytics.length > 100) {
                    analytics.shift();
                }

                await chrome.storage.local.set({ analytics });
            }

            // å¤„ç†è­¦æŠ¥
            handleAlarm(alarm) {
                switch (alarm.name) {
                    case "daily-cleanup":
                        this.performCleanup();
                        break;
                    case "analytics-report":
                        this.generateAnalyticsReport();
                        break;
                }
            }

            // å¤„ç†å­˜å‚¨å˜åŒ–
            handleStorageChange(changes, area) {
                if (area === "sync" && changes.settings) {
                    this.settings = changes.settings.newValue;
                    console.log("ğŸ“¦ è®¾ç½®å·²åŒæ­¥æ›´æ–°");
                }
            }

            // å¤„ç†æ ‡ç­¾é¡µæ›´æ–°
            handleTabUpdate(tabId, changeInfo, tab) {
                if (changeInfo.status === "complete") {
                    console.log("ğŸŒ æ ‡ç­¾é¡µåŠ è½½å®Œæˆ:", tab.url);
                }
            }

            // å¤„ç†æ ‡ç­¾é¡µæ¿€æ´»
            handleTabActivated(activeInfo) {
                console.log("ğŸ” æ¿€æ´»æ ‡ç­¾é¡µ:", activeInfo.tabId);
            }

            // å¯åŠ¨å®šæ—¶ä»»åŠ¡
            startScheduledTasks() {
                // æ¯æ—¥æ¸…ç†
                chrome.alarms.create("daily-cleanup", {
                    periodInMinutes: 60 * 24, // 24å°æ—¶
                });

                // åˆ†ææŠ¥å‘Š
                chrome.alarms.create("analytics-report", {
                    periodInMinutes: 60 * 6, // 6å°æ—¶
                });

                console.log("â° å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨");
            }

            // æ‰§è¡Œæ¸…ç†
            async performCleanup() {
                console.log("ğŸ§¹ æ‰§è¡Œæ¯æ—¥æ¸…ç†");
                // æ¸…ç†é€»è¾‘...
            }

            // ç”Ÿæˆåˆ†ææŠ¥å‘Š
            async generateAnalyticsReport() {
                const analytics = await this.getAnalytics();
                console.log("ğŸ“Š åˆ†ææŠ¥å‘Š: å…±", analytics.length, "æ¡è®°å½•");
            }

            // æ˜¾ç¤ºé€šçŸ¥
            showNotification(title, message) {
                chrome.notifications.create({
                    type: "basic",
                    iconUrl: chrome.runtime.getURL("icons/icon48.png"),
                    title: title,
                    message: message,
                    priority: 1,
                });
            }

            // å·¥å…·æ–¹æ³•ï¼šé‡è¯•æ“ä½œ
            async retryOperation(operation, maxRetries = 3, delay = 1000) {
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        return await operation();
                    } catch (error) {
                        if (attempt === maxRetries) throw error;
                        await this.sleep(delay * attempt);
                    }
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // åˆå§‹åŒ–åå°æœåŠ¡
        const backgroundService = new BackgroundService();

        // é”™è¯¯å¤„ç†
        self.addEventListener('unhandledrejection', event => {
            console.error("âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:", event.reason);
        });

        ```
    - å†…å®¹è„šæœ¬
        - content.css

            ```css
            /* content.css */
            .extension-highlight {
                background-color: #ffff00 !important;
                border: 2px solid #ff6b6b !important;
                padding: 2px 4px !important;
                border-radius: 3px !important;
            }

            .extension-stats-panel {
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                background: white !important;
                border: 2px solid #007bff !important;
                border-radius: 8px !important;
                padding: 12px !important;
                z-index: 10000 !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif !important;
                max-width: 250px !important;
            }

            .extension-stats-panel .stats-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                margin-bottom: 8px !important;
                border-bottom: 1px solid #eee !important;
                padding-bottom: 8px !important;
            }

            .extension-stats-panel .stats-header h4 {
                margin: 0 !important;
                color: #007bff !important;
                font-size: 14px !important;
            }

            .extension-stats-panel .close-btn {
                background: none !important;
                border: none !important;
                font-size: 18px !important;
                cursor: pointer !important;
                color: #999 !important;
            }

            .extension-stats-panel .stats-content {
                font-size: 12px !important;
                line-height: 1.5 !important;
            }

            .extension-stats-panel .stats-content p {
                margin: 4px 0 !important;
                color: #333 !important;
            }

            .extension-control-btn {
                position: fixed !important;
                bottom: 20px !important;
                right: 20px !important;
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background: #007bff !important;
                color: white !important;
                border: none !important;
                cursor: pointer !important;
                z-index: 10001 !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
                font-size: 18px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            /* æš—è‰²ä¸»é¢˜æ”¯æŒ */
            @media (prefers-color-scheme: dark) {
                .extension-stats-panel {
                    background: #2d3748 !important;
                    border-color: #63b3ed !important;
                    color: white !important;
                }

                .extension-stats-panel .stats-header h4 {
                    color: #63b3ed !important;
                }

                .extension-stats-panel .stats-content p {
                    color: #e2e8f0 !important;
                }
            }
            ```
        - content.js

            ```js
            // content.js - ç½‘é¡µå†…å®¹å¤„ç†å™¨
            class ContentScript {
                constructor() {
                    this.settings = {};
                    this.isEnabled = true;
                    this.init();
                }

                async init() {
                    console.log("ğŸš€ å†…å®¹è„šæœ¬åˆå§‹åŒ–");

                    await this.loadSettings();
                    this.setupMessageListeners();
                    this.setupMutationObserver();

                    if (document.readyState === "loading") {
                        document.addEventListener("DOMContentLoaded", () => this.onPageReady());
                    } else {
                        this.onPageReady();
                    }
                }

                // åŠ è½½è®¾ç½®
                async loadSettings() {
                    try {
                        const result = await chrome.storage.sync.get(["settings"]);
                        this.settings = result.settings || {};
                        this.isEnabled = this.settings.enabled !== false;
                    } catch (error) {
                        console.error("åŠ è½½è®¾ç½®å¤±è´¥:", error);
                    }
                }

                // é¡µé¢å°±ç»ª
                onPageReady() {
                    if (!this.isEnabled) return;

                    this.analyzePage();
                    this.injectUI();
                    this.applySettings();

                    this.sendAnalysisReport();
                }

                // åˆ†æé¡µé¢
                analyzePage() {
                    const analysis = {
                        url: window.location.href,
                        title: document.title,
                        wordCount: this.countWords(),
                        linkCount: this.countLinks(),
                        imageCount: this.countImages(),
                        headingCount: this.countHeadings(),
                        pageSize: this.calculatePageSize(),
                        timestamp: new Date().toISOString(),
                    };

                    this.currentAnalysis = analysis;
                    console.log("ğŸ“Š é¡µé¢åˆ†æå®Œæˆ", analysis);
                }

                // è®¡æ•°å·¥å…·æ–¹æ³•
                countWords() {
                    const text = document.body.textContent || "";
                    return text
                        .trim()
                        .split(/\s+/)
                        .filter(w => w.length > 0).length;
                }

                countLinks() {
                    return document.links.length;
                }
                countImages() {
                    return document.images.length;
                }
                countHeadings() {
                    return document.querySelectorAll("h1, h2, h3, h4, h5, h6").length;
                }

                calculatePageSize() {
                    return new Blob([document.documentElement.outerHTML]).size;
                }

                // æ³¨å…¥UI
                injectUI() {
                    this.removeExistingUI();

                    if (this.settings.showStats) {
                        this.createStatsPanel();
                    }

                    this.createControlButton();
                }

                // åˆ›å»ºç»Ÿè®¡é¢æ¿
                createStatsPanel() {
                    const panel = document.createElement("div");
                    panel.className = "extension-stats-panel";
                    panel.innerHTML = `
                <div class="stats-header">
                    <h4>ğŸ“Š é¡µé¢ç»Ÿè®¡</h4>
                    <button class="close-btn">Ã—</button>
                </div>
                <div class="stats-content">
                    <p>ğŸ“ å­—æ•°: ${this.currentAnalysis.wordCount.toLocaleString()}</p>
                    <p>ğŸ”— é“¾æ¥: ${this.currentAnalysis.linkCount}</p>
                    <p>ğŸ“· å›¾ç‰‡: ${this.currentAnalysis.imageCount}</p>
                    <p>ğŸ“‘ æ ‡é¢˜: ${this.currentAnalysis.headingCount}</p>
                </div>
                `;

                    document.body.appendChild(panel);

                    // å…³é—­æŒ‰é’®äº‹ä»¶
                    panel.querySelector(".close-btn").addEventListener("click", () => {
                        panel.remove();
                    });
                }

                // åˆ›å»ºæ§åˆ¶æŒ‰é’®
                createControlButton() {
                    const btn = document.createElement("button");
                    btn.className = "extension-control-btn";
                    btn.textContent = "âš¡";
                    btn.title = "ç½‘é¡µåŠ©æ‰‹æ§åˆ¶";

                    btn.addEventListener("click", () => {
                        this.toggleFeatures();
                    });

                    document.body.appendChild(btn);
                }

                // åˆ‡æ¢åŠŸèƒ½
                toggleFeatures() {
                    this.isEnabled = !this.isEnabled;
                    this.applySettings();

                    chrome.runtime.sendMessage({
                        type: "SHOW_NOTIFICATION",
                        data: {
                            title: this.isEnabled ? "åŠŸèƒ½å·²å¯ç”¨" : "åŠŸèƒ½å·²ç¦ç”¨",
                            message: this.isEnabled ? "ç½‘é¡µåŠ©æ‰‹æ­£åœ¨è¿è¡Œ" : "ç½‘é¡µåŠ©æ‰‹å·²æš‚åœ",
                        },
                    });
                }

                // åº”ç”¨è®¾ç½®
                applySettings() {
                    if (this.settings.highlightHeadings && this.isEnabled) {
                        this.highlightHeadings();
                    } else {
                        this.removeHighlights();
                    }
                }

                // é«˜äº®æ ‡é¢˜
                highlightHeadings() {
                    this.removeHighlights();

                    document.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(heading => {
                        heading.classList.add("extension-highlight");
                    });
                }

                // ç§»é™¤é«˜äº®
                removeHighlights() {
                    document.querySelectorAll(".extension-highlight").forEach(el => {
                        el.classList.remove("extension-highlight");
                    });
                }

                // ç§»é™¤ç°æœ‰UI
                removeExistingUI() {
                    document.querySelectorAll(".extension-stats-panel, .extension-control-btn").forEach(el => el.remove());
                }

                // è®¾ç½®æ¶ˆæ¯ç›‘å¬
                setupMessageListeners() {
                    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
                        switch (request.type) {
                            case "SETTINGS_UPDATED":
                                this.settings = request.data;
                                this.isEnabled = this.settings.enabled !== false;
                                this.applySettings();
                                sendResponse({ success: true });
                                break;

                            case "EXECUTE_COMMAND":
                                this.executeCommand(request.data);
                                sendResponse({ success: true });
                                break;

                            default:
                                sendResponse({ success: false });
                        }
                    });
                }

                // è®¾ç½®çªå˜è§‚å¯Ÿå™¨
                setupMutationObserver() {
                    const observer = new MutationObserver(mutations => {
                        mutations.forEach(mutation => {
                            if (mutation.addedNodes.length > 0 && this.isEnabled) {
                                this.handleNewContent(mutation.addedNodes);
                            }
                        });
                    });

                    observer.observe(document.body, {
                        childList: true,
                        subtree: true,
                    });
                }

                // å¤„ç†æ–°å†…å®¹
                handleNewContent(nodes) {
                    nodes.forEach(node => {
                        if (node.nodeType === 1 && this.settings.highlightHeadings) {
                            node.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(heading => {
                                heading.classList.add("extension-highlight");
                            });
                        }
                    });
                }

                // æ‰§è¡Œå‘½ä»¤
                executeCommand(command) {
                    switch (command) {
                        case "highlight":
                            this.highlightHeadings();
                            break;
                        case "analyze":
                            this.analyzePage();
                            this.injectUI();
                            break;
                    }
                }

                // å‘é€åˆ†ææŠ¥å‘Š
                sendAnalysisReport() {
                    chrome.runtime
                        .sendMessage({
                            type: "PAGE_ANALYZED",
                            data: this.currentAnalysis,
                        })
                        .catch(() => {
                            // å¿½ç•¥å‘é€å¤±è´¥
                        });
                }
            }

            // åˆå§‹åŒ–å†…å®¹è„šæœ¬
            if (!window.__contentScriptInitialized) {
                window.__contentScriptInitialized = true;
                const contentScript = new ContentScript();
                window.__contentScript = contentScript;
            }
            ```
    - popup å¼¹çª—

        - popup.html

            ```html
            <!-- options.html -->
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8" />
                <link rel="stylesheet" href="options.css" />
            </head>
            <body>
                <div class="options-container">
                    <header class="options-header">
                        <h1>âš™ï¸ ç½‘é¡µåŠ©æ‰‹è®¾ç½®</h1>
                        <p>è‡ªå®šä¹‰æ‚¨çš„æµè§ˆä½“éªŒ</p>
                    </header>

                    <main class="options-main">
                        <form id="settings-form">
                            <div class="setting-group">
                                <h3>ğŸ”§ åŸºæœ¬è®¾ç½®</h3>
                                <label class="switch">
                                    <input type="checkbox" id="enable-extension" checked />
                                    <span class="slider"></span>
                                    <span class="label-text">å¯ç”¨æ‰©å±•</span>
                                </label>

                                <label class="switch">
                                    <input type="checkbox" id="highlight-headings" checked />
                                    <span class="slider"></span>
                                    <span class="label-text">é«˜äº®æ ‡é¢˜</span>
                                </label>

                                <label class="switch">
                                    <input type="checkbox" id="show-stats" checked />
                                    <span class="slider"></span>
                                    <span class="label-text">æ˜¾ç¤ºç»Ÿè®¡é¢æ¿</span>
                                </label>
                            </div>

                            <div class="setting-group">
                                <h3>ğŸ¨ å¤–è§‚è®¾ç½®</h3>
                                <label>
                                    ä¸»é¢˜æ¨¡å¼ï¼š
                                    <select id="theme">
                                        <option value="light">æµ…è‰²</option>
                                        <option value="dark">æ·±è‰²</option>
                                        <option value="auto">è‡ªåŠ¨</option>
                                    </select>
                                </label>
                            </div>

                            <div class="setting-group">
                                <h3>ğŸ“Š æ•°æ®ç®¡ç†</h3>
                                <div class="button-group">
                                    <button type="button" id="export-data" class="btn secondary">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
                                    <button type="button" id="clear-data" class="btn danger">æ¸…é™¤æ•°æ®</button>
                                </div>
                            </div>
                        </form>

                        <div class="actions">
                            <button type="submit" form="settings-form" class="btn primary">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                            <button type="button" id="reset-btn" class="btn secondary">ğŸ”„ æ¢å¤é»˜è®¤</button>
                        </div>
                    </main>

                    <footer class="options-footer">
                        <p>ç‰ˆæœ¬ 1.0.0 | å­˜å‚¨ä½¿ç”¨: <span id="storage-usage">è®¡ç®—ä¸­...</span></p>
                    </footer>
                </div>

                <script src="options.js"></script>
            </body>
            </html>

            ```
        - popup.js

            ```js
            // options.js
            class OptionsManager {
                constructor() {
                    this.settings = {};
                    this.init();
                }

                async init() {
                    await this.loadSettings();
                    this.setupEventListeners();
                    this.updateStorageUsage();
                }

                async loadSettings() {
                    const response = await chrome.runtime.sendMessage({ type: "GET_SETTINGS" });
                    if (response.success) {
                        this.settings = response.data;
                        this.populateForm();
                    }
                }

                populateForm() {
                    document.getElementById("enable-extension").checked = this.settings.enabled !== false;
                    document.getElementById("highlight-headings").checked = this.settings.highlightHeadings !== false;
                    document.getElementById("show-stats").checked = this.settings.showStats !== false;
                    document.getElementById("theme").value = this.settings.theme || "light";
                }

                setupEventListeners() {
                    document.getElementById("settings-form").addEventListener("submit", e => {
                        e.preventDefault();
                        this.saveSettings();
                    });

                    document.getElementById("reset-btn").addEventListener("click", () => {
                        this.resetToDefaults();
                    });

                    document.getElementById("export-data").addEventListener("click", () => {
                        this.exportAllData();
                    });

                    document.getElementById("clear-data").addEventListener("click", () => {
                        this.clearData();
                    });
                }

                getSettingsFromForm() {
                    return {
                        enabled: document.getElementById("enable-extension").checked,
                        highlightHeadings: document.getElementById("highlight-headings").checked,
                        showStats: document.getElementById("show-stats").checked,
                        theme: document.getElementById("theme").value,
                    };
                }

                async saveSettings() {
                    const newSettings = this.getSettingsFromForm();

                    await chrome.runtime.sendMessage({
                        type: "UPDATE_SETTINGS",
                        data: newSettings,
                    });

                    this.settings = newSettings;
                    this.showMessage("è®¾ç½®å·²ä¿å­˜");
                }

                async resetToDefaults() {
                    if (confirm("ç¡®å®šè¦æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿ")) {
                        const defaultSettings = {
                            enabled: true,
                            highlightHeadings: true,
                            showStats: true,
                            theme: "light",
                        };

                        await chrome.runtime.sendMessage({
                            type: "UPDATE_SETTINGS",
                            data: defaultSettings,
                        });

                        this.settings = defaultSettings;
                        this.populateForm();
                        this.showMessage("å·²æ¢å¤é»˜è®¤è®¾ç½®");
                    }
                }

                async exportAllData() {
                    const [settings, analytics] = await Promise.all([chrome.runtime.sendMessage({ type: "GET_SETTINGS" }), chrome.runtime.sendMessage({ type: "GET_ANALYTICS" })]);

                    const exportData = {
                        settings: settings.success ? settings.data : {},
                        analytics: analytics.success ? analytics.data : [],
                        exportedAt: new Date().toISOString(),
                    };

                    this.downloadJSON(exportData, "ç½‘é¡µåŠ©æ‰‹å¤‡ä»½.json");
                    this.showMessage("æ•°æ®å·²å¯¼å‡º");
                }

                async clearData() {
                    if (confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
                        await chrome.storage.local.clear();
                        await chrome.storage.sync.clear();
                        this.showMessage("æ•°æ®å·²æ¸…é™¤");
                        this.updateStorageUsage();
                    }
                }

                async updateStorageUsage() {
                    const { bytesInUse } = await chrome.storage.local.getBytesInUse();
                    document.getElementById("storage-usage").textContent = this.formatBytes(bytesInUse);
                }

                formatBytes(bytes) {
                    const sizes = ["B", "KB", "MB", "GB"];
                    if (bytes === 0) return "0 B";
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return Math.round(bytes / Math.pow(1024, i), 2) + " " + sizes[i];
                }

                downloadJSON(data, filename) {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                showMessage(text) {
                    // ç®€å•çš„æ¶ˆæ¯æç¤ºå®ç°
                    alert(text);
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                new OptionsManager();
            });

            ```
        - popup.css

            ```css
            /* popup.css */
            .popup-container {
                width: 320px;
                padding: 16px;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            }

            .popup-header {
                text-align: center;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid #e0e0e0;
            }

            .popup-header h2 {
                margin: 0;
                color: #2c3e50;
                font-size: 18px;
            }

            #page-info {
                margin: 4px 0 0 0;
                font-size: 12px;
                color: #7f8c8d;
            }

            .popup-main {
                margin-bottom: 12px;
            }

            .stats-section,
            .actions-section,
            .tools-section {
                margin-bottom: 16px;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 8px;
            }

            .stats-section h4,
            .actions-section h4,
            .tools-section h4 {
                margin: 0 0 8px 0;
                color: #2c3e50;
                font-size: 14px;
            }

            #current-stats {
                font-size: 12px;
                line-height: 1.5;
            }

            .action-btn,
            .tool-btn {
                width: 100%;
                padding: 8px 12px;
                margin: 4px 0;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                transition: background-color 0.2s;
            }

            .action-btn {
                background: #007bff;
                color: white;
            }

            .action-btn:hover {
                background: #0056b3;
            }

            .tool-btn {
                background: #6c757d;
                color: white;
            }

            .tool-btn:hover {
                background: #545b62;
            }

            .popup-footer {
                text-align: center;
                padding-top: 12px;
                border-top: 1px solid #e0e0e0;
                font-size: 11px;
                color: #7f8c8d;
            }
            ```
    - options é…ç½®

        - options.html

            ```html
            <!-- popup.html -->
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8" />
                <link rel="stylesheet" href="popup.css" />
            </head>
            <body>
                <div class="popup-container">
                    <header class="popup-header">
                        <h2>ğŸŒ ç½‘é¡µåŠ©æ‰‹</h2>
                        <p id="page-info">åˆ†æä¸­...</p>
                    </header>

                    <main class="popup-main">
                        <div class="stats-section">
                            <h4>ğŸ“Š å½“å‰é¡µé¢</h4>
                            <div id="current-stats">åŠ è½½ä¸­...</div>
                        </div>

                        <div class="actions-section">
                            <h4>âš¡ å¿«é€Ÿæ“ä½œ</h4>
                            <button id="highlight-btn" class="action-btn">ğŸŒŸ é«˜äº®æ ‡é¢˜</button>
                            <button id="analyze-btn" class="action-btn">ğŸ“Š é‡æ–°åˆ†æ</button>
                            <button id="toggle-btn" class="action-btn">ğŸ”§ åˆ‡æ¢çŠ¶æ€</button>
                        </div>

                        <div class="tools-section">
                            <h4>ğŸ› ï¸ å·¥å…·</h4>
                            <button id="options-btn" class="tool-btn">âš™ï¸ è®¾ç½®</button>
                            <button id="export-btn" class="tool-btn">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
                        </div>
                    </main>

                    <footer class="popup-footer">
                        <span id="status">å°±ç»ª</span>
                    </footer>
                </div>

                <script src="popup.js"></script>
            </body>
            </html>
            ```
        - options.js

            ```js
            // popup.js
            class PopupManager {
                constructor() {
                    this.currentTab = null;
                    this.settings = {};
                    this.init();
                }

                async init() {
                    await this.loadCurrentTab();
                    await this.loadSettings();
                    this.setupEventListeners();
                    this.updateUI();
                }

                async loadCurrentTab() {
                    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
                    this.currentTab = tab;
                    document.getElementById("page-info").textContent = tab.title;
                }

                async loadSettings() {
                    const response = await chrome.runtime.sendMessage({ type: "GET_SETTINGS" });
                    if (response.success) {
                        this.settings = response.data;
                    }
                }

                setupEventListeners() {
                    document.getElementById("highlight-btn").addEventListener("click", () => {
                        this.highlightHeadings();
                    });

                    document.getElementById("analyze-btn").addEventListener("click", () => {
                        this.analyzePage();
                    });

                    document.getElementById("toggle-btn").addEventListener("click", () => {
                        this.toggleExtension();
                    });

                    document.getElementById("options-btn").addEventListener("click", () => {
                        chrome.runtime.openOptionsPage();
                    });

                    document.getElementById("export-btn").addEventListener("click", () => {
                        this.exportData();
                    });
                }

                async highlightHeadings() {
                    this.setStatus("é«˜äº®ä¸­...");

                    await chrome.runtime.sendMessage({
                        type: "EXECUTE_SCRIPT",
                        data: { command: "highlight" },
                    });

                    this.setStatus("æ ‡é¢˜å·²é«˜äº®");
                }

                async analyzePage() {
                    this.setStatus("åˆ†æä¸­...");

                    await chrome.runtime.sendMessage({
                        type: "EXECUTE_SCRIPT",
                        data: { command: "analyze" },
                    });

                    // è·å–æœ€æ–°ç»Ÿè®¡æ•°æ®
                    setTimeout(() => this.updateStats(), 1000);
                }

                async toggleExtension() {
                    const newState = !this.settings.enabled;

                    await chrome.runtime.sendMessage({
                        type: "UPDATE_SETTINGS",
                        data: { enabled: newState },
                    });

                    this.settings.enabled = newState;
                    this.updateUI();
                    this.setStatus(newState ? "å·²å¯ç”¨" : "å·²ç¦ç”¨");
                }

                async exportData() {
                    const response = await chrome.runtime.sendMessage({ type: "GET_ANALYTICS" });
                    if (response.success) {
                        this.downloadJSON(response.data, "ç½‘é¡µåˆ†ææ•°æ®.json");
                        this.setStatus("æ•°æ®å·²å¯¼å‡º");
                    }
                }

                downloadJSON(data, filename) {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                async updateStats() {
                    try {
                        const response = await chrome.tabs.sendMessage(this.currentTab.id, {
                            action: "GET_PAGE_STATS",
                        });

                        if (response.success) {
                            const stats = response.stats;
                            document.getElementById("current-stats").innerHTML = `
                    ğŸ“ å­—æ•°: ${stats.wordCount.toLocaleString()}<br>
                    ğŸ”— é“¾æ¥: ${stats.linkCount}<br>
                    ğŸ“· å›¾ç‰‡: ${stats.imageCount}<br>
                    ğŸ“‘ æ ‡é¢˜: ${stats.headingCount}
                    `;
                        }
                    } catch (error) {
                        document.getElementById("current-stats").textContent = "æ— æ³•è·å–ç»Ÿè®¡æ•°æ®";
                    }
                }

                updateUI() {
                    const toggleBtn = document.getElementById("toggle-btn");
                    toggleBtn.textContent = this.settings.enabled ? "ğŸ”´ ç¦ç”¨" : "ğŸŸ¢ å¯ç”¨";
                }

                setStatus(message) {
                    document.getElementById("status").textContent = message;
                    setTimeout(() => {
                        document.getElementById("status").textContent = "å°±ç»ª";
                    }, 2000);
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                new PopupManager();
            });

            ```
        - options.css

            ```css
            /* popup.css */
            .popup-container {
                width: 320px;
                padding: 16px;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            }

            .popup-header {
                text-align: center;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid #e0e0e0;
            }

            .popup-header h2 {
                margin: 0;
                color: #2c3e50;
                font-size: 18px;
            }

            #page-info {
                margin: 4px 0 0 0;
                font-size: 12px;
                color: #7f8c8d;
            }

            .popup-main {
                margin-bottom: 12px;
            }

            .stats-section,
            .actions-section,
            .tools-section {
                margin-bottom: 16px;
                padding: 12px;
                background: #f8f9fa;
                border-radius: 8px;
            }

            .stats-section h4,
            .actions-section h4,
            .tools-section h4 {
                margin: 0 0 8px 0;
                color: #2c3e50;
                font-size: 14px;
            }

            #current-stats {
                font-size: 12px;
                line-height: 1.5;
            }

            .action-btn,
            .tool-btn {
                width: 100%;
                padding: 8px 12px;
                margin: 4px 0;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                transition: background-color 0.2s;
            }

            .action-btn {
                background: #007bff;
                color: white;
            }

            .action-btn:hover {
                background: #0056b3;
            }

            .tool-btn {
                background: #6c757d;
                color: white;
            }

            .tool-btn:hover {
                background: #545b62;
            }

            .popup-footer {
                text-align: center;
                padding-top: 12px;
                border-top: 1px solid #e0e0e0;
                font-size: 11px;
                color: #7f8c8d;
            }
            ```

3. è¿è¡Œç»“æœ

    ![](/other/plugin/chrome/021.png)