# 五、实际案例

## 5.1 需求-api请求

postman 原本就是 chrome 插件，后来直接成了单独程序了，每次访问都要验证用户

我也不是专业测试，不需要记录每次的访问

国产的 apifox 也能使用，但跟postman一样太重了，所以直接写一个验证后台API的插件

## 5.2 代码示例

1. 配置文件 manifest.json

    ```json
    {
        "manifest_version": 3,
        "name": "API Client Extension",
        "version": "1.0",
        "description": "一个支持多种API访问方式的浏览器扩展",
        "permissions": [
            "activeTab",
            "storage"
        ],
        "background": {
            "service_worker": "background.js"
        },
        "action": {
            "default_popup": "popup.html",
            "default_icon": {
                "16": "icons/icon16.png",
                "48": "icons/icon48.png",
                "128": "icons/icon128.png"
            }
        },
        "icons": {
            "16": "icons/icon16.png",
            "48": "icons/icon48.png",
            "128": "icons/icon128.png"
        },
        "web_accessible_resources": [
            {
                "resources": ["rest.html", "websocket.html", "webflux.html", "graphql.html"],
                "matches": ["<all_urls>"]
            }
        ]
    }
    ```

2. 使用 worker_services 绕过跨域

    ```js
    // background.js
    chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
        if (request.type === "FETCH_PROXY") {
            // 代理请求以绕过CORS限制
            fetch(request.url, request.options)
            .then(response => {
                // 将响应转换为文本
                return response.text().then(text => ({
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries()),
                body: text
                }));
            })
            .then(result => {
                sendResponse({ success: true, data: result });
            })
            .catch(error => {
                sendResponse({ success: false, error: error.message });
            });

            // 保持消息通道开放
            return true;
        }
    });
    ```

3. popup 弹窗

    - popup.html

        ```html
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <style>
                body {
                width: 300px;
                padding: 20px;
                font-family: Arial, sans-serif;
                }

                h1 {
                font-size: 18px;
                text-align: center;
                margin-bottom: 20px;
                }

                .option {
                display: block;
                padding: 12px;
                margin-bottom: 10px;
                background-color: #4285f4;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 16px;
                cursor: pointer;
                text-align: center;
                text-decoration: none;
                }

                .option:hover {
                background-color: #3367d6;
                }

                .option:active {
                background-color: #2a56c6;
                }
            </style>
        </head>
        <body>
            <h1>API客户端</h1>
            <a href="rest.html" class="option" target="_blank">REST</a>
            <a href="websocket.html" class="option" target="_blank">WebSocket</a>
            <a href="webflux.html" class="option" target="_blank">WebFlux</a>
            <a href="graphql.html" class="option" target="_blank">GraphQL</a>

            <script src="popup.js"></script>
        </body>
        </html>
        ```
    - popup.js 获取不同的页面

        ```js 
        // popup.js
        document.addEventListener('DOMContentLoaded', function() {
            // 为每个选项添加点击事件监听器
            const options = document.querySelectorAll('.option');

            options.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    const url = this.getAttribute('href');

                    // 在新标签页中打开对应的页面
                    chrome.tabs.create({ url: chrome.runtime.getURL(url) });

                    // 关闭弹窗
                    window.close();
                });
            });
        });
        ```

3. rest 类型

    - rest.html

        ```html
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8" />
            <title>REST API Client</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                }

                h1 {
                    text-align: center;
                    color: #333;
                }

                .form-group {
                    margin-bottom: 15px;
                }

                label {
                    display: block;
                    margin-bottom: 5px;
                    font-weight: bold;
                }

                input,
                select,
                textarea {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    box-sizing: border-box;
                }

                button {
                    background-color: #4caf50;
                    color: white;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 16px;
                }

                button:hover {
                    background-color: #45a049;
                }

                .method-buttons {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 15px;
                }

                .method-btn {
                    flex: 1;
                    background-color: #f0f0f0;
                    color: #333;
                }

                .method-btn.active {
                    background-color: #4285f4;
                    color: white;
                }

                .response {
                    margin-top: 20px;
                    padding: 15px;
                    background-color: #f9f9f9;
                    border-radius: 4px;
                    display: none;
                }

                .response-header {
                    font-weight: bold;
                    margin-bottom: 10px;
                }

                .response-body {
                    white-space: pre-wrap;
                    font-family: monospace;
                }
            </style>
        </head>
        <body>
            <h1>REST API Client</h1>

            <div class="method-buttons">
                <button class="method-btn active" data-method="GET">GET</button>
                <button class="method-btn" data-method="POST">POST</button>
                <button class="method-btn" data-method="PUT">PUT</button>
                <button class="method-btn" data-method="DELETE">DELETE</button>
                <button class="method-btn" data-method="PATCH">PATCH</button>
            </div>

            <div class="form-group">
                <label for="url">URL:</label>
                <input type="text" id="url" placeholder="请输入调用的API" value="https://jsonplaceholder.typicode.com/posts" />
            </div>

            <div class="form-group">
                <label for="headers">Headers (JSON格式):</label>
                <textarea id="headers" rows="3" placeholder='{"Content-Type": "application/json"}'></textarea>
            </div>

            <div class="form-group" id="body-section" style="display: none">
                <label for="body">请求体 (JSON格式):</label>
                <textarea id="body" rows="6" placeholder='{"name": "John", "age": 30}'></textarea>
            </div>

            <button id="send-btn">发送请求</button>

            <div class="response" id="response">
                <div class="response-header">响应:</div>
                <div class="response-body" id="response-body"></div>
            </div>

            <script src="rest.js"></script>
        </body>
        </html>
        ```
    - rest.js

        ```js
        // rest.js
        document.addEventListener("DOMContentLoaded", function () {
            // 方法按钮事件处理
            const methodButtons = document.querySelectorAll(".method-btn");
            const bodySection = document.getElementById("body-section");
            let currentMethod = "GET";

            methodButtons.forEach(button => {
                button.addEventListener("click", function () {
                    // 移除所有按钮的active类
                    methodButtons.forEach(btn => btn.classList.remove("active"));

                    // 为当前按钮添加active类
                    this.classList.add("active");

                    // 更新当前方法
                    currentMethod = this.getAttribute("data-method");

                    // 根据方法类型显示/隐藏请求体
                    if (currentMethod === "GET" || currentMethod === "DELETE") {
                        bodySection.style.display = "none";
                    } else {
                        bodySection.style.display = "block";
                    }
                });
            });

            // 发送请求按钮事件处理
            document.getElementById("send-btn").addEventListener("click", sendRequest);

            async function sendRequest() {
                const url = document.getElementById("url").value;
                const headersText = document.getElementById("headers").value;
                const bodyText = document.getElementById("body").value;

                if (!url) {
                    alert("请输入URL");
                    return;
                }

                try {
                    // 解析headers
                    let headers = {};
                    if (headersText) {
                        headers = JSON.parse(headersText);
                    }

                    // 构建请求选项
                    const options = {
                        method: currentMethod,
                        headers: headers,
                    };

                    // 如果不是GET或DELETE请求，添加请求体
                    if (currentMethod !== "GET" && currentMethod !== "DELETE" && bodyText) {
                        options.body = bodyText;
                    }

                    // 使用后台脚本代理请求以绕过CORS限制
                    chrome.runtime.sendMessage(
                        {
                            type: "FETCH_PROXY",
                            url: url,
                            options: options,
                        },
                        response => {
                            if (response.success) {
                                const data = response.data;
                                // 显示响应
                                document.getElementById("response-body").textContent = `Status: ${data.status} ${data.statusText}\n\n${data.body}`;
                                document.getElementById("response").style.display = "block";
                            } else {
                                document.getElementById("response-body").textContent = `错误: ${response.error}`;
                                document.getElementById("response").style.display = "block";
                            }
                        }
                    );
                } catch (error) {
                    document.getElementById("response-body").textContent = `错误: ${error.message}`;
                    document.getElementById("response").style.display = "block";
                }
            }
        });
        ```

4. websocket 类型

    - websocket.html

        ```html
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8" />
            <title>WebSocket Client</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                }

                h1 {
                    text-align: center;
                    color: #333;
                }

                .form-group {
                    margin-bottom: 15px;
                }

                label {
                    display: block;
                    margin-bottom: 5px;
                    font-weight: bold;
                }

                input,
                textarea {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    box-sizing: border-box;
                }

                button {
                    background-color: #4caf50;
                    color: white;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 16px;
                    margin-right: 10px;
                }

                button:hover {
                    background-color: #45a049;
                }

                button:disabled {
                    background-color: #cccccc;
                    cursor: not-allowed;
                }

                .connection-status {
                    padding: 10px;
                    border-radius: 4px;
                    margin-bottom: 15px;
                    text-align: center;
                }

                .connected {
                    background-color: #d4edda;
                    color: #155724;
                    border: 1px solid #c3e6cb;
                }

                .disconnected {
                    background-color: #f8d7da;
                    color: #721c24;
                    border: 1px solid #f5c6cb;
                }

                .messages {
                    height: 300px;
                    overflow-y: auto;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    padding: 10px;
                    margin-bottom: 15px;
                    background-color: #f9f9f9;
                }

                .message {
                    margin-bottom: 10px;
                    padding: 5px;
                    border-radius: 3px;
                }

                .sent {
                    background-color: #d1ecf1;
                    text-align: right;
                }

                .received {
                    background-color: #e2e3e5;
                    text-align: left;
                }
            </style>
        </head>
        <body>
            <h1>WebSocket Client</h1>

            <div class="form-group">
                <label for="ws-url">WebSocket URL:</label>
                <input type="text" id="ws-url" placeholder="ws://localhost:8080/websocket" value="wss://echo.websocket.org" />
            </div>

            <button id="connect-btn">连接</button>
            <button id="disconnect-btn" disabled>断开连接</button>

            <div class="connection-status disconnected" id="connection-status">未连接</div>

            <div class="messages" id="messages"></div>

            <div class="form-group">
                <label for="message">消息:</label>
                <textarea id="message" rows="3" placeholder="输入要发送的消息"></textarea>
            </div>

            <button id="send-btn" disabled>发送</button>
            <button id="clear-btn">清空消息</button>

            <script src="websocket.js"></script>
        </body>
        </html>
        ```
    - websocket.js

        ```js
        // websocket.js
        document.addEventListener("DOMContentLoaded", function () {
            let ws = null;

            const connectBtn = document.getElementById("connect-btn");
            const disconnectBtn = document.getElementById("disconnect-btn");
            const sendBtn = document.getElementById("send-btn");
            const clearBtn = document.getElementById("clear-btn");
            const wsUrl = document.getElementById("ws-url");
            const messageInput = document.getElementById("message");
            const messagesDiv = document.getElementById("messages");
            const connectionStatus = document.getElementById("connection-status");

            // 连接按钮事件处理
            connectBtn.addEventListener("click", connect);

            // 断开连接按钮事件处理
            disconnectBtn.addEventListener("click", disconnect);

            // 发送按钮事件处理
            sendBtn.addEventListener("click", sendMessage);

            // 清空消息按钮事件处理
            clearBtn.addEventListener("click", clearMessages);

            function connect() {
                const url = wsUrl.value;
                if (!url) {
                    alert("请输入WebSocket URL");
                    return;
                }

                try {
                    ws = new WebSocket(url);

                    ws.onopen = function (event) {
                        updateConnectionStatus("已连接", true);
                        addMessage("连接已建立", "received");
                    };

                    ws.onmessage = function (event) {
                        addMessage("接收: " + event.data, "received");
                    };

                    ws.onclose = function (event) {
                        updateConnectionStatus("未连接", false);
                        addMessage("连接已关闭", "received");
                    };

                    ws.onerror = function (error) {
                        addMessage("错误: " + error.message, "received");
                    };
                } catch (error) {
                    alert("连接失败: " + error.message);
                }
            }

            function disconnect() {
                if (ws) {
                    ws.close();
                }
            }

            function sendMessage() {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const message = messageInput.value;
                    if (message) {
                        ws.send(message);
                        addMessage("发送: " + message, "sent");
                        messageInput.value = "";
                    }
                }
            }

            function addMessage(text, type) {
                const messageDiv = document.createElement("div");
                messageDiv.className = "message " + type;
                messageDiv.textContent = text;
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            function clearMessages() {
                messagesDiv.innerHTML = "";
            }

            function updateConnectionStatus(text, connected) {
                connectionStatus.textContent = text;
                connectionStatus.className = "connection-status " + (connected ? "connected" : "disconnected");

                connectBtn.disabled = connected;
                disconnectBtn.disabled = !connected;
                sendBtn.disabled = !connected;
            }
        });

        ```

5. webflux 类型

    - webflux.html

        ```html
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8" />
            <title>WebFlux Client</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                }

                h1 {
                    text-align: center;
                    color: #333;
                }

                .form-group {
                    margin-bottom: 15px;
                }

                label {
                    display: block;
                    margin-bottom: 5px;
                    font-weight: bold;
                }

                input,
                select,
                textarea {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    box-sizing: border-box;
                }

                button {
                    background-color: #4caf50;
                    color: white;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 16px;
                    margin-right: 10px;
                }

                button:hover {
                    background-color: #45a049;
                }

                .method-buttons {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 15px;
                }

                .method-btn {
                    flex: 1;
                    background-color: #f0f0f0;
                    color: #333;
                }

                .method-btn.active {
                    background-color: #4285f4;
                    color: white;
                }

                .response {
                    margin-top: 20px;
                    padding: 15px;
                    background-color: #f9f9f9;
                    border-radius: 4px;
                    display: none;
                }

                .response-header {
                    font-weight: bold;
                    margin-bottom: 10px;
                }

                .response-body {
                    white-space: pre-wrap;
                    font-family: monospace;
                }

                .stream-data {
                    margin-top: 20px;
                    padding: 15px;
                    background-color: #f9f9f9;
                    border-radius: 4px;
                    display: none;
                }

                .stream-header {
                    font-weight: bold;
                    margin-bottom: 10px;
                }

                .stream-content {
                    white-space: pre-wrap;
                    font-family: monospace;
                    max-height: 300px;
                    overflow-y: auto;
                }
            </style>
        </head>
        <body>
            <h1>WebFlux Client</h1>

            <div class="method-buttons">
                <button class="method-btn active" data-method="GET">GET</button>
                <button class="method-btn" data-method="POST">POST</button>
                <button class="method-btn" data-method="PUT">PUT</button>
                <button class="method-btn" data-method="DELETE">DELETE</button>
            </div>

            <div class="form-group">
                <label for="url">URL:</label>
                <input type="text" id="url" placeholder="https://api.example.com/stream" value="https://httpbin.org/stream/5" />
            </div>

            <div class="form-group">
                <label for="headers">Headers (JSON格式):</label>
                <textarea id="headers" rows="3" placeholder='{"Content-Type": "application/json"}'></textarea>
            </div>

            <div class="form-group" id="body-section" style="display: none">
                <label for="body">请求体 (JSON格式):</label>
                <textarea id="body" rows="6" placeholder='{"name": "John", "age": 30}'></textarea>
            </div>

            <button id="send-btn">发送请求</button>
            <button id="stream-btn">流式请求</button>
            <button id="cancel-btn" style="display: none">取消</button>

            <div class="response" id="response">
                <div class="response-header">响应:</div>
                <div class="response-body" id="response-body"></div>
            </div>

            <div class="stream-data" id="stream-data">
                <div class="stream-header">流式数据:</div>
                <div class="stream-content" id="stream-content"></div>
            </div>

            <script src="webflux.js"></script>
        </body>
        </html>
        ```
    - webflux.js

        ```js
        // webflux.js
        document.addEventListener("DOMContentLoaded", function () {
            // 方法按钮事件处理
            const methodButtons = document.querySelectorAll(".method-btn");
            const bodySection = document.getElementById("body-section");
            const cancelBtn = document.getElementById("cancel-btn");
            const streamDataDiv = document.getElementById("stream-data");
            const streamContent = document.getElementById("stream-content");
            let currentMethod = "GET";
            let abortController = null;

            methodButtons.forEach(button => {
                button.addEventListener("click", function () {
                    // 移除所有按钮的active类
                    methodButtons.forEach(btn => btn.classList.remove("active"));

                    // 为当前按钮添加active类
                    this.classList.add("active");

                    // 更新当前方法
                    currentMethod = this.getAttribute("data-method");

                    // 根据方法类型显示/隐藏请求体
                    if (currentMethod === "GET" || currentMethod === "DELETE") {
                        bodySection.style.display = "none";
                    } else {
                        bodySection.style.display = "block";
                    }
                });
            });

            // 发送请求按钮事件处理
            document.getElementById("send-btn").addEventListener("click", sendRequest);

            // 流式请求按钮事件处理
            document.getElementById("stream-btn").addEventListener("click", streamRequest);

            // 取消按钮事件处理
            cancelBtn.addEventListener("click", cancelRequest);

            async function sendRequest() {
                const url = document.getElementById("url").value;
                const headersText = document.getElementById("headers").value;
                const bodyText = document.getElementById("body").value;

                if (!url) {
                    alert("请输入URL");
                    return;
                }

                try {
                    // 解析headers
                    let headers = {};
                    if (headersText) {
                        headers = JSON.parse(headersText);
                    }

                    // 构建请求选项
                    const options = {
                        method: currentMethod,
                        headers: headers,
                    };

                    // 如果不是GET或DELETE请求，添加请求体
                    if (currentMethod !== "GET" && currentMethod !== "DELETE" && bodyText) {
                        options.body = bodyText;
                    }

                    // 使用后台脚本代理请求以绕过CORS限制
                    chrome.runtime.sendMessage(
                        {
                            type: "FETCH_PROXY",
                            url: url,
                            options: options,
                        },
                        response => {
                            if (response.success) {
                                const data = response.data;
                                // 显示响应
                                document.getElementById("response-body").textContent = `Status: ${data.status} ${data.statusText}\n\n${data.body}`;
                                document.getElementById("response").style.display = "block";
                            } else {
                                document.getElementById("response-body").textContent = `错误: ${response.error}`;
                                document.getElementById("response").style.display = "block";
                            }
                        }
                    );
                } catch (error) {
                    document.getElementById("response-body").textContent = `错误: ${error.message}`;
                    document.getElementById("response").style.display = "block";
                }
            }

            async function streamRequest() {
                const url = document.getElementById("url").value;
                const headersText = document.getElementById("headers").value;
                const bodyText = document.getElementById("body").value;

                if (!url) {
                    alert("请输入URL");
                    return;
                }

                // 显示流式数据区域
                streamDataDiv.style.display = "block";
                streamContent.textContent = "连接中...\n";

                try {
                    // 创建AbortController用于取消请求
                    abortController = new AbortController();

                    // 显示取消按钮
                    cancelBtn.style.display = "inline-block";

                    // 解析headers
                    let headers = {};
                    if (headersText) {
                        headers = JSON.parse(headersText);
                    }

                    // 构建请求选项
                    const options = {
                        method: currentMethod,
                        headers: headers,
                        signal: abortController.signal,
                    };

                    // 如果不是GET或DELETE请求，添加请求体
                    if (currentMethod !== "GET" && currentMethod !== "DELETE" && bodyText) {
                        options.body = bodyText;
                    }

                    // 使用后台脚本代理请求以绕过CORS限制
                    chrome.runtime.sendMessage(
                        {
                            type: "FETCH_PROXY",
                            url: url,
                            options: options,
                        },
                        response => {
                            if (response.success) {
                                const data = response.data;
                                // 显示响应
                                streamContent.textContent = data.body;
                                streamContent.scrollTop = streamContent.scrollHeight;
                            } else {
                                streamContent.textContent = `错误: ${response.error}`;
                            }

                            // 隐藏取消按钮
                            cancelBtn.style.display = "none";
                            abortController = null;
                        }
                    );
                } catch (error) {
                    streamContent.textContent = `错误: ${error.message}`;

                    // 隐藏取消按钮
                    cancelBtn.style.display = "none";
                    abortController = null;
                }
            }

            function cancelRequest() {
                if (abortController) {
                    abortController.abort();
                }
            }
        });

        ```
6. graphql 类型

    - graphql.html

        ```html
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8" />
            <title>GraphQL Client</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 1000px;
                    margin: 0 auto;
                    padding: 20px;
                }

                h1 {
                    text-align: center;
                    color: #333;
                }

                .form-group {
                    margin-bottom: 15px;
                }

                label {
                    display: block;
                    margin-bottom: 5px;
                    font-weight: bold;
                }

                input,
                textarea {
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    box-sizing: border-box;
                }

                button {
                    background-color: #4caf50;
                    color: white;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 16px;
                    margin-right: 10px;
                }

                button:hover {
                    background-color: #45a049;
                }

                .editor-container {
                    display: flex;
                    gap: 20px;
                    margin-bottom: 15px;
                }

                .editor {
                    flex: 1;
                }

                .editor label {
                    margin-bottom: 5px;
                }

                .editor textarea {
                    height: 300px;
                    font-family: monospace;
                    font-size: 14px;
                }

                .response {
                    margin-top: 20px;
                    padding: 15px;
                    background-color: #f9f9f9;
                    border-radius: 4px;
                    display: none;
                }

                .response-header {
                    font-weight: bold;
                    margin-bottom: 10px;
                }

                .response-body {
                    white-space: pre-wrap;
                    font-family: monospace;
                }

                .example-btn {
                    background-color: #f0f0f0;
                    color: #333;
                    padding: 5px 10px;
                    font-size: 14px;
                    margin-right: 5px;
                    margin-bottom: 5px;
                }

                .example-btn:hover {
                    background-color: #e0e0e0;
                }
            </style>
        </head>
        <body>
            <h1>GraphQL Client</h1>

            <div class="form-group">
                <label for="endpoint">GraphQL端点:</label>
                <input type="text" id="endpoint" placeholder="https://api.example.com/graphql" value="https://graphqlzero.almansi.me/api" />
            </div>

            <div class="form-group">
                <label for="headers">Headers (JSON格式):</label>
                <textarea id="headers" rows="3" placeholder='{"Authorization": "Bearer token"}'></textarea>
            </div>

            <div class="editor-container">
                <div class="editor">
                    <label for="query">GraphQL查询:</label>
                    <textarea id="query" placeholder="输入GraphQL查询"></textarea>
                </div>
                <div class="editor">
                    <label for="variables">变量 (JSON格式):</label>
                    <textarea id="variables" placeholder="输入变量 (JSON格式)"></textarea>
                </div>
            </div>

            <div class="form-group">
                <button id="send-btn">执行查询</button>
                <button id="clear-btn">清空</button>
            </div>

            <div class="form-group">
                <label>示例查询:</label>
                <br />
                <button class="example-btn" data-query="query { posts { data { id title } } }">获取文章列表</button>
                <button class="example-btn" data-query="query { post(id: 1) { id title body } }">获取单篇文章</button>
                <button class="example-btn" data-query='mutation { createPost(input: { title: "新文章", body: "内容" }) { id title body } }'>创建文章</button>
            </div>

            <div class="response" id="response">
                <div class="response-header">响应:</div>
                <div class="response-body" id="response-body"></div>
            </div>

            <script src="graphql.js"></script>
        </body>
        </html>
        ```
    - graphql.js

        ```js
        // graphql.js
        document.addEventListener("DOMContentLoaded", function () {
            // 发送查询按钮事件处理
            document.getElementById("send-btn").addEventListener("click", sendQuery);

            // 清空按钮事件处理
            document.getElementById("clear-btn").addEventListener("click", clearAll);

            // 示例查询按钮事件处理
            const exampleButtons = document.querySelectorAll(".example-btn");
            exampleButtons.forEach(button => {
                button.addEventListener("click", function () {
                    const query = this.getAttribute("data-query");
                    document.getElementById("query").value = query;
                });
            });

            async function sendQuery() {
                const endpoint = document.getElementById("endpoint").value;
                const query = document.getElementById("query").value;
                const variablesText = document.getElementById("variables").value;
                const headersText = document.getElementById("headers").value;

                if (!endpoint) {
                    alert("请输入GraphQL端点");
                    return;
                }

                if (!query) {
                    alert("请输入GraphQL查询");
                    return;
                }

                try {
                    // 解析变量
                    let variables = {};
                    if (variablesText) {
                        variables = JSON.parse(variablesText);
                    }

                    // 解析headers
                    let headers = {
                        "Content-Type": "application/json",
                    };
                    if (headersText) {
                        headers = { ...headers, ...JSON.parse(headersText) };
                    }

                    // 构建请求体
                    const requestBody = {
                        query: query,
                        variables: variables,
                    };

                    // 构建请求选项
                    const options = {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify(requestBody),
                    };

                    // 使用后台脚本代理请求以绕过CORS限制
                    chrome.runtime.sendMessage(
                        {
                            type: "FETCH_PROXY",
                            url: endpoint,
                            options: options,
                        },
                        response => {
                            if (response.success) {
                                const data = response.data;
                                // 尝试解析JSON响应
                                try {
                                    const jsonData = JSON.parse(data.body);
                                    document.getElementById("response-body").textContent = JSON.stringify(jsonData, null, 2);
                                } catch (e) {
                                    // 如果不是JSON格式，直接显示文本
                                    document.getElementById("response-body").textContent = data.body;
                                }
                                document.getElementById("response").style.display = "block";
                            } else {
                                document.getElementById("response-body").textContent = `错误: ${response.error}`;
                                document.getElementById("response").style.display = "block";
                            }
                        }
                    );
                } catch (error) {
                    document.getElementById("response-body").textContent = `错误: ${error.message}`;
                    document.getElementById("response").style.display = "block";
                }
            }

            function clearAll() {
                document.getElementById("query").value = "";
                document.getElementById("variables").value = "";
                document.getElementById("response").style.display = "none";
            }
        });
        ```

## 5.3 最终测试与打包

1. 彻底测试​​：在各种场景和网站下测试你的扩展，确保没有错误和崩溃。
2. ​打包扩展​​：
    - 打开 Chrome 的扩展管理页面：chrome://extensions。
    - 开启 ​​“开发者模式”​​。
    - 点击 ​​“打包扩展程序”​​。
    - 选择你的扩展​​根目录​​（包含 manifest.json的文件夹）。
    - “私有密钥文件”留空（首次打包），点击“打包扩展程序”。
    - 这会生成一个 .crx文件（用于发布）和一个 .pem文件（​​私钥，务必妥善保管！​​ 未来更新扩展必须使用同一个私钥）

## 5.4 发布到商店

**第 1 步：访问开发者仪表板** 

1.  访问 Chrome 网上应用店开发者仪表板。
    
2.  使用你的 ​**​Google 账号​**​登录。​**​强烈建议使用一个专门用于开发的、稳定的 Google 账号，而不是个人日常账号。​**​
    

**第 2 步：支付注册费** 

1.  首次发布需要支付 ​**​一次性 5 美元​**​ 的开发者注册费。
    
2.  支付方式支持信用卡等。支付完成后，你的账号就成为了开发者账号，可以发布应用和扩展。
    

**第 3 步：上传你的扩展** 

1.  在开发者仪表板中，点击 ​**​“新增项目”​**​ -> ​**​“新建扩展”​**​（如果你要更新已有扩展，则点击对应扩展的“编辑”）。
    
2.  系统会要求你上传 `.zip`文件。
    
    *   ​**​注意：这里不是上传之前生成的 `.crx`文件！​**​
        
    *   ​**​你需要将你的扩展项目文件夹（包含 `manifest.json`, 脚本、图标、html 等所有文件）直接压缩成一个 `.zip`包。​**​
        
    *   ​**​不要包含无关文件​**​（如 `.git`目录、源代码 `.ts`文件、`.pem`私钥文件等）。
        
    
**第 4 步：填写商品详情**

这是最关键的一步，直接影响用户是否愿意安装。你需要填写一个表单：

*   **​扩展程序名称​**​：吸引人且易于搜索的名称。
    
*   **​简短说明​**​：一句话简介，显示在列表页。
    
*   **​详细说明​**​：详细介绍功能、使用方法、特色等。
    
*   **​图标​**​：上传 `128x128`的图标。
    
*   **​类别​**​：为你的扩展选择一个合适的类别（如“生产效率”、“社交”）。
    
*   **​语言​**​：选择扩展支持的语言。
    
*   **​上传截图​**​：上传展示扩展功能的截图。
    
*   **​上传宣传图片​**​（可选但推荐）：上传 `1400x560`的横幅图。
    
*   **​隐私权政策​**​：如果需要，填入你的隐私政策网址。
    
*   **​权限​**​：系统会根据你的 `manifest.json`自动列出权限。你最好在详细说明中解释​**​为什么需要这些权限​**​，以增加用户信任度。（例如：“需要‘读取所有网站数据’的权限是为了在您浏览的任何页面上注入内容脚本并显示浮动窗口。”）
    

**第 5 步：选择发布选项并提交审核**

在表格最后，你需要选择发布方式：

*   **​公开发布​**​：所有用户都能在商店搜索和看到你的扩展。
    
*   **​不公开​**​（仅限测试）：只有你指定的测试用户（通过 Google 账号邮箱）才能安装。这是​**​上线前进行最终测试的完美方式​**​。
    
*   **​受信任的测试人员​**​：介于两者之间，扩展是公开的，但会标明是测试版。
    

填写完所有信息后，点击 ​**​“提交以供审核”​**​。
