# 一、AJAX

## 1.1 认识ajax
1. AJAX简介
    - AJAX 全称为Asynchronous JavaScript And XML，就是异步的`JS`和`XML`通过AJAX 可以在浏览器中向服务器发送异步请求
    - 最大的优势：**无刷新获取数据**
    - AJAX 不是新的编程语言，而是一种将现有的标准组合在一起使用的新方式
2. AJAX 的优点
    1. 可以无需刷新页面而与服务器端进行通信
    2. 允许你根据用户事件来更新部分页面内容
3. AJAX 的缺点
    1. 没有浏览历史，不能回退
    2. 存在跨域问题(同源)
    3. SEO 不友好

## 1.2 HTTP相关


http问题可查看 [MDN 文档](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Overview)


### 1.2.1 HTTP 请求交互过程
1. 示例图

    ![](/script/other/ajax/001.png)
2. 过程
    1. 前后应用从浏览器端向服务器发送HTTP 请求(请求报文)
    2. 后台服务器接收到请求后, 调度服务器应用处理请求, 向浏览器端返回HTTP响应(响应报文)
    3. 浏览器端接收到响应, 解析显示响应体/调用监视回调

### 1.2.2 HTTP 报文

HTTP（hypertext transport protocol）协议『超文本传输协议』，协议详细规定了浏览器和万维网服务器之间互相通信的规则。


1. 请求报文(重点是格式与参数)

    | Request Header  | 说明                                  |
    | --------------- | ----------------------------------- |
    | Accept          | 浏览器可接收的数据格式（如：*/*）                  |
    | Accept-Language | 客户端接收的语言类型（如：zh-CN,en-US）           |
    | Connection      | 维护客户端和服务端的连接关系（如：Keep-Alive）        |
    | Host            | 连接的目标主机和端口号（如：localhost:8080）       |
    | User-Agent      | 客户端版本号的名字                           |
    | Accept-Encoding | 客户端能接收的压缩数据的类型（如：gzip）              |
    | Cookie          | 客户端暂存服务端的信息                         |
    | Content-type    | 发送数据的格式，get请求没有（如：application/json） |

2. 响应报文

    | Response Headers | 说明                                           |
    | ---------------- | -------------------------------------------- |
    | Content-Type     | 服务端发送的类型及采用的编码方式（如：text/html; charset=utf-8） |
    | Content-Encoding | 服务端能够发送压缩编码类型（如：gzip）                        |
    | Content-Length   | 服务端发送的压缩数据的长度（如：128）                         |
    | Set-Cookie       | 服务端发送到客户端的暂存数据                               |
    | Cache-Control    | 缓存相关                                         |
    | Last-Modified    | 缓存相关                                         |
    | Etag             | 缓存相关                                         |

3. post请求体参数格式

    1. Content-Type: application/x-www-form-urlencoded;charset=utf-8
    用于键值对参数，参数的键值用=连接, 参数之间用&连接
    例如: `name=%E5%B0%8F%E6%98%8E&age=12`
    2. Content-Type: application/json;charset=utf-8
    用于 json 字符串参数
    例如: `{"name": "%E5%B0%8F%E6%98%8E", "age": 12}`
    3. Content-Type: multipart/form-data
    用于文件上传请求

### 1.2.3 HTTP 其他 

1.  常见的响应状态码

    - 状态码
        - `1xx`：指示信息-表示请求已接收，继续处理
        - `2xx`：成功-表示请求已被成功接收
        - `3xx`：重定向-要完成请求必须进行更进一步的操作
        - `4xx`：客户端错误-请求有语法错误或请求无法实现
        - `5xx`：服务器错误-服务器未能实现合法的请求
    - 常见的http状态码
        - `200`：客户端请求成功
        - `206`：客户发送带有`range`头的GET请求，服务器完成了它
        - `301`：重定向（永久）
        - `302`：重定向（临时）
        - `304`：资源未被修改，有缓存
        - `403`：请求被拒绝
        - `404`：资源未找到
        - `500`：服务器错误
        - `504`：网关超时

2. 请求类型

    1. `GET`: 从服务器端**读取**数据（查）
    2. `POST`: 向服务器端**添加**新数据 （增）
    3. `PUT`: 更新资源 （改）
    4. `DELETE`: **删除**服务器端数据 （删）

## 1.3 操作XMLHttpRequest


### 1.3.1 属性与接口

1. 理解

    - 使用XMLHttpRequest (XHR)对象可以与服务器交互, 也就是发送ajax 请求
    - 前端可以获取到数据，而无需让整个的页面刷新。
    - 这使得Web 页面可以只更新页面的局部，而不影响用户的操作。
    - [点击查看XMLHttpRequest文档](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest)，AJAX 的所有操作都是通过XMLHttpRequest对象进行的

2. ajax 请求状态

    [点击查看xhr.readyState文档]( https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/readyState) 中请求的当前状态

    - 0: 表示XMLHttpRequest 实例已经生成，但是open()方法还没有被调用
    - 1: 表示send()方法还没有被调用，仍然可以使用setRequestHeader()，设定HTTP请求的头信息
    - 2: 表示send()方法已经执行，并且头信息和状态码已经收到
    - 3: 表示正在接收服务器传来的body 部分的数据
    - 4: 表示服务器数据已经完全接收，或者本次接收已经失败了

3. API总结

    - XMLHttpRequest()：创建 XHR 对象的构造函数
    - status：响应状态码值，如 200、404
    - statusText：响应状态文本，如 ’ok‘、‘not found’
    - readyState：标识请求状态的只读属性 0-1-2-3-4
    - onreadystatechange：绑定 readyState 改变的监听
    - responseType：指定响应数据类型，如果是 ‘json’，得到响应后自动解析响应
    - response：响应体数据，类型取决于 responseType 的指定
    - timeout：指定请求超时时间，默认为 0 代表没有限制
    - ontimeout：绑定超时的监听
    - onerror：绑定请求网络错误的监听
    - open()：初始化一个请求，参数为：(method, url[, async])
    - send(data)：发送请求
    - abort()：中断请求 （发出到返回之间）
    - getResponseHeader(name)：获取指定名称的响应头值
    - getAllResponseHeaders()：获取所有响应头组成的字符串
    - setRequestHeader(name, value)：设置请求头

### 1.3.2 代码实操

1. 获取本地文件内容

    - index.html文件

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
        </head>
        <body>
            <button>aaa</button>
            <script>
                // ajax === async javascript and XML
                // json {"name":"zhangsan"}
                // ajax(道) 和 XMLHttpRequest(术)

                var xhr = new XMLHttpRequest()

                xhr.open("get","1.json",true)
                // 第一个参数 get post
                // 第二个参数 请求地址
                // 第三个参数 是否异步 只能写成 true 或者不写

                // 发送请求
                xhr.send()

                // 监听
                xhr.onreadystatechange = function(){
                    // readystate 是 xhr 对象中的属性, 表示状态 0 1 2 3 4
                    if(xhr.readyState === 4){
                        // 使用 正则表达式 代替 xhr.status === 200
                        if(/^2\d{2}$/.test(xhr.status)){
                            console.log(xhr.responseText);
                        }else{
                            console.log("error",xhr.responseText);
                        }
                    }
                }

                // 加载完直接判断
                xhr.onload = function(){
                    console.log(xhr.readyState);
                }

            </script>
        </body>
        </html>
        ```
    - 1.json 文件

        ```json
        {
            "name": "zhangsan"
        }
        ```

2. 使用url获取数据并展示

    - index.html文件
        
        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
            <style>
                .box{
                    width: 600px;
                    height: 600px;
                }
                img{
                    max-width: 100%;
                    max-height: 100%;
                }
            </style>
        </head>
        <body>
            <button id="btn">click</button>
            <div class="box">
                <img src="" class="picture">
            </div>
        

            <script>
                const obtn = document.querySelector("#btn");
                const img = document.querySelector(".picture")

                obtn.onclick = () =>{
                    //获取图片
                    getUrlImage()
                }

                let url = "https://tea.qingnian8.com/tools/taoShow"

                function getUrlImage(){
                    var xhr = new XMLHttpRequest()
                    xhr.open("get",url)
                    xhr.send()
                    // 可以直接判断
                    xhr.onload = function(){
                        if(/^2\d{2}$/.test(xhr.status)){
                            render(xhr.responseText)
                        }else{
                            console.log("error",xhr.responseText);
                        }
                    }
                }

                getUrlImage()

                function render(res){
                let data =  JSON.parse(res)
                img.src = data.data[0].url
                }

            </script>
        </body>
        </html>
        ```
    - 运行结果

        ![](/script/other/ajax/002.gif)

3. 请求方式

    - 安装 json-server 插件

        ```sh
        npm install json-server -g
        ```
    - 运行json文件

        ```sh
        json-server .\db.json --watch
        ```
    - 输入内容展示接口

        - 修改db.json文件

            ```json
            {
                "list":["111","222","333"],
                "users":[
                ],
                "shopcar":[],
                "detail":{
                    "name":"手机"
                }
            }
            ```
        - 控制台打印

            ![](/script/other/ajax/003.png)
    - html调用

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
        </head>
        <body>
            <script>
                var xhr = new XMLHttpRequest()

                xhr.open("get","http://localhost:3000/list")

                // 发送请求
                xhr.send()

                // 加载完直接判断
                xhr.onload = function(){
                    if(/^2\d{2}$/.test(xhr.status)){
                            console.log(xhr.responseText);
                    }else{
                        console.log("error",xhr.responseText);
                    }
                }
            </script>
        </body>
        </html>
        ```
    - 运行结果

        ![](/script/other/ajax/004.png)

4. 其他请求方式

    - db.json

        ```json
        {
            "users": [
                {
                    "id": "1",
                    "name": "zhangsan"
                },
                {
                    "id": "2",
                    "name": "lisi"
                }
            ]
        }
        ```

    - 使用json-server 条用数据启动

        ```sh
        json-server .\db.json --watch --port 3005
        ```

    - index.html

        ```html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Document</title>
        </head>
        <body>
            <button id="get">get</button>
            <button id="post">post</button>
            <button id="put">put</button>
            <button id="patch">patch</button>
            <button id="delete">delete</button>

            <script>

                var oget = document.querySelector("#get")
                var opost = document.querySelector("#post")
                var oput = document.querySelector("#put")
                var opatch = document.querySelector("#patch")
                var odelete = document.querySelector("#delete")

                oget.onclick = function(){
                    // 创建XMLHttpRequest对象
                    var xhr = new XMLHttpRequest()
                    // 设置链接
                    xhr.open("get","http://localhost:3005/users?id=1")
                    // 发送请求
                    xhr.send()
                    // 加载完直接判断
                    xhr.onload = function(){
                        if(/^2\d{2}$/.test(xhr.status)){
                            console.log(xhr.responseText);
                        }else{
                            console.log("error",xhr.responseText);
                        }
                    }
                }
                opost.onclick = function(){
                    var xhr = new XMLHttpRequest()
                    xhr.open("POST","http://localhost:3005/users")
            
                    // 数据放到send的参数中
                    // form编码  name=wangwu&age=100
                    // xhr.setRequestHeader("content-type","application/x-www-form-urlencoded")
                    // xhr.send(`name=tiechui&age=18`)

                    // json格式  {"name":"wangwu","age":100}
                    xhr.setRequestHeader("content-type","application/json")
                    xhr.send(JSON.stringify({
                        name:"zhaoliu",
                        age:90
                    }))

                    xhr.onload = function(){
                        if(/^2\d{2}$/.test(xhr.status)){
                            console.log(JSON.parse(xhr.responseText));
                        }else{
                            console.log("error",xhr.responseText);
                        }
                    }
                }

                // 全量更新
                oput.onclick = function(){
                    var xhr = new XMLHttpRequest()
                    xhr.open("PUT","http://localhost:3005/users/2")
        
                    xhr.setRequestHeader("content-type","application/json")
                    xhr.send(JSON.stringify({
                        "name":"test",
                        "age":80
                    }))

                    xhr.onload = function(){
                        if(/^2\d{2}$/.test(xhr.status)){
                            console.log(JSON.parse(xhr.responseText));
                        }else{
                            console.log("error",xhr.responseText);
                        }
                    }
                }

                // 增量更新
                opatch.onclick = function(){
                    var xhr = new XMLHttpRequest()
                    xhr.open("PATCH","http://localhost:3005/users/2")
        
                    xhr.setRequestHeader("content-type","application/json")
                    xhr.send(JSON.stringify({
                        "name":"test2"
                    }))

                    xhr.onload = function(){
                        if(/^2\d{2}$/.test(xhr.status)){
                            console.log(JSON.parse(xhr.responseText));
                        }else{
                            console.log("error",xhr.responseText);
                        }
                    }
                }

                odelete.onclick = function(){
                    
                    var xhr = new XMLHttpRequest()
                    xhr.open("DELETE","http://localhost:3005/users/2")
        
                    xhr.send()
                    xhr.onload = function(){
                        console.log(222);
                        
                        if(/^2\d{2}$/.test(xhr.status)){
                            console.log(JSON.parse(xhr.responseText));
                        }else{
                            console.log("error",xhr.responseText);
                        }
                    }
                }
            </script>
        </body>
        </html>
        ```
