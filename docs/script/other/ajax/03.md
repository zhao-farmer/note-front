# 三、axios


## 3.1 初识Axios

1. Axios 是什么?

    1. 前端最流行的`Ajax`请求库
    2. react/vue 官方都推荐使用 axios 发ajax 请求
    3. [文档: https://github.com/axios/axios](https://github.com/axios/axios)

2. Axios 特点

    1. 基于 xhr + promise 的异步 ajax请求库
    2. 浏览器端/node 端都可以使用
    3. 支持请求／响应拦截器
    4. 支持请求取消
    5. 请求/响应数据转换
    6. 批量发送多个请求

3. Axios 常用语法

    - axios(config): 通用/最本质的发任意类型请求的方式
    - axios(url[, config]): 可以只指定url 发get 请求
    - axios.request(config): 等同于axios(config)
    - axios.get(url[, config]): 发get 请求
    - axios.delete(url[, config]): 发delete 请求
    - axios.post(url[, data, config]): 发post 请求
    - axios.put(url[, data, config]): 发put 请求

    - axios.defaults.xxx: 请求的默认全局配置（method\baseURL\params\timeout…）
    - axios.interceptors.request.use(): 添加请求拦截器
    - axios.interceptors.response.use(): 添加响应拦截器

    - axios.create([config]): 创建一个新的axios(它没有下面的功能)

    - axios.Cancel(): 用于创建取消请求的错误对象
    - axios.CancelToken(): 用于创建取消请求的 token 对象
    - axios.isCancel(): 是否是一个取消请求的错误
    - axios.all(promises): 用于批量执行多个异步请求
    - axios.spread(): 用来指定接收所有成功数据的回调函数的方法


    ![](/backend/quote/api/005.png)


## 3.2 基础使用


1. 配置对象常用的配置项

```js
{
    // 路径url
    url: '/user',

    // 请求方法，默认get
    method: 'get', 

    //基础url，最终请求的url是 baseURL+url拼接，所以再全局设置默认，可以使得发送请求时的url变得简洁
    baseURL: 'https://some-domain.com/api/',

    //设置请求头
    headers: {'X-Requested-With': 'XMLHttpRequest'},

    //设置请求url的query参数，可以使得url简洁。
    //比如url是https://some-domain.com/api/user  然后params如下设置，那么最终的url是：
    //https://some-domain.com/api/user?ID=12345&name=Jack
    params: {
        ID: 12345,
        name:"Jack"
    },


    //设置请求体
    data: {
        firstName: 'Fred'
    },

    //设置请求的另外一种格式，不过这个是直接设置字符串的
    data: 'Country=Brasil&City=Belo Horizonte',

    //请求超时，单位毫秒，默认0，不超时。
    timeout: 1000,

    //响应数据类型，默认json
    responseType: 'json', 

    //响应数据的编码规则，默认utf-8
    responseEncoding: 'utf8',

    //响应体的最大长度 
    maxContentLength: 2000,

    // 请求体的最大长度
    maxBodyLength: 2000,

    //设置响应状态码为多少时是成功，调用resolve，否则调用reject失败
    //默认是大于等于200，小于300
    validateStatus: function (status) {
        return status >= 200 && status < 300; 
    }
}
```


2. 示例代码使用

    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Document</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" ></script>
    </head>
    <body>
        <button id="get">get</button>
        <button id="post">post</button>
        <button id="put">put</button>
        <button id="patch">patch</button>
        <button id="delete">delete</button>

        <script>

            var oget = document.querySelector("#get")
            var opost = document.querySelector("#post")
            var oput = document.querySelector("#put")
            var opatch = document.querySelector("#patch")
            var odelete = document.querySelector("#delete")

            oget.onclick = function(){
                // 直接调用
                axios.get("http://localhost:3005/users")
                .then(res=>{
                    console.log(res);
                }).catch(err=>{
                    console.log(res);
                })

            
                // url上加参数
                axios.get("http://localhost:3005/users?id=1")
                .then(res=>{
                    console.log(res.data);
                }).catch(err=>{
                    console.log(res);
                })

                // 使用params参数
                axios.get("http://localhost:3005/users",{
                    params:{
                        name:"lisi"
                    }
                }).then(res=>{
                    console.log(res.data);
                }).catch(err=>{
                    console.log(res);
                })
                
            }
            opost.onclick = function(){
                // post 请求 json格式
                axios.post("http://localhost:3005/users",{
                    name:"xiaohong",
                    age:20
                }).then(res=>{
                    console.log(res.data);
                }).catch(err=>{
                    console.log(res);
                })

                // 表单方式
                axios.post("http://localhost:3005/users","name=tiechui&age=80")
                .then(res=>{
                    console.log(res.data);
                }).catch(err=>{
                    console.log(res);
                })

                // 配置的方式去写
                axios({
                    method:"post",
                    url:"http://localhost:3005/users",
                    // get params
                    // put post data
                    data:{
                        name:"gangdan",
                        age:60
                    }
                }).then(res=>{
                    console.log(res);
                })
            }

            // 全量更新
            oput.onclick = function(){
                axios.put("http://localhost:3005/users/2",{
                    age:170
                }).then(res=>{
                    console.log(res.data);
                }).catch(err=>{
                    console.log(res);
                })
            }

            // 增量更新
            opatch.onclick = function(){
                axios.patch("http://localhost:3005/users/1",{
                    age:170
                }).then(res=>{
                    console.log(res.data);
                }).catch(err=>{
                    console.log(res);
                })
            }

            odelete.onclick = function(){
                axios.delete("http://localhost:3005/users/2").then(res=>{
                    console.log(res.data);
                }).catch(err=>{
                    console.log(res);
                })
                
            }
        </script>
    </body>
    </html>
    ```

## 3.3 高级使用

### 3.3.1 默认配置


可以设置全局默认配置，是为了避免多种重复配置在不同请求中重复，比如baseURL、timeout等，这里设置baseURL。

```js
        axios.defaults.baseURL="http://localhost:3000";

        //因为上面配置了baseURL，所以我们之后的请求只需要配置url不用像之前那样的全路径
        axios.get("/posts/1")
       .then(response=>{
           console.log(response);
       })
```

### 3.3.2 创建一个新的axios对象

根据指定配置创建一个新的 axios, 也就是每个新 axios 都有自己的配置

新 axios 只是没有取消请求和批量发请求的方法, 其它所有语法都是一致的

1. **为什么要设计这个语法?**
    - 需求: 项目中有部分接口需要的配置与另一部分接口需要的配置不太一样, 如何处理（比如有多个baseURL需要指定）
    -  解决: 创建2 个新axios, 每个都有自己特有的配置, 分别应用到不同要求的接口请求中

2. 代码调用

    ```js
    const instance = axios.create({ // instance是函数类型
        baseURL: 'http://localhost:3000'
    })

    // 使用instance发Ajax请求
    instance({
        url: '/posts'
    })

    instance.get('/posts')
    ```

### 3.3.3 拦截器

**请求拦截器**（在发送请求前，使用函数对请求的参数和内容进行处理和检测，若请求有问题可直接进行拦截->取消，后进先执行=则后面的请求拦截器先执行）

**响应拦截器**（对响应的结果预处理，先进先执行=前面的响应拦截器先执行）

1. 请求拦截器：

    - 在真正发送请求前执行的回调函数
    - 可以对请求进行检查或配置进行特定处理
    - 失败的回调函数，传递的默认是error
    - 成功的回调函数，传递的默认是config（也必须是）

2. 响应拦截器

    - 在请求得到响应后执行的回调函数
    - 可以对响应数据进行特定处理
    - 成功的回调函数，传递的默认是response
    - 失败的回调函数，传递的默认是error

3. 请求转换器：对请求头和请求体数据进行特定处理的函数

    响应转换器：将响应体json字符串解析为js对象或数组的函数

    1. 说明: 调用axios()并不是立即发送ajax 请求, 而是需要经历一个较长的流程
    2. 流程: 请求拦截器2 => 请求拦截器1 => 发ajax 请求 => 响应拦截器1 => 响应拦截器2 => 请求的回调
    3. 注意: 此流程是通过 promise 串连起来的, 请求拦截器传递的是config, 响应拦截器传递的是response

4. 示例代码

    ```html
    <!DOCTYPE html>
    <html lang="en">
        <head>
            <meta charset="UTF-8" />
            <title>Document</title>
            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        </head>
        <body>
            <button id="get">get</button>
            <script>
                var oget = document.querySelector("#get");


                //设置一个请求拦截器，在请求拦截器中可以对请求参数进行修改
                axios.interceptors.request.use(
                    //config：配置对象
                    function (config) {
                        console.log("请求拦截器 成功 1号");
                        // config.headers.test = "I am only a header!";
                        //修改 config 中的参数
                        config.params = { a: 100 };
                        return config;
                    },
                    error => {
                        console.log("请求拦截器 失败 1号");
                        return Promise.reject(error);
                    }
                );

                axios.interceptors.request.use(
                    function (config) {
                        config.timeout = 5000;
                        console.log("请求拦截器 成功 2号");
                        // config.headers.test = "I am only a header!";
                        //修改 config 中的参数
                        config.timeout = 2000;
                        return config;
                    },
                    error => {
                        console.log("请求拦截器 失败 2号");
                        return Promise.reject(error);
                    }
                );

                //设置一个响应拦截器，可以对响应结果做一些处理
                axios.interceptors.response.use(
                    function (response) {
                        console.log("响应拦截器 成功 1号");
                        //返回到请求回调时，只要data数据
                        return response.data;
                    },
                    function (error) {
                        console.log("响应拦截器 失败 1号");
                        return Promise.reject(error);
                    }
                );

                oget.onclick = function(){
                    //发送请求
                    axios({
                        method: "GET",
                        url: "http://localhost:3005/users",
                    }).then(response => {
                        console.log(response);
                    }).catch(reason => {
                        console.log(reason);
                    });
                }
            
            </script>
        </body>
    </html>
    ```
### 3.3.4 请求中断
 
如果页面跳转了，url还在一直执行，获取的数据已经是无效的

```js
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Document</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    </head>
    <body>
         <button id="get">get请求</button>
        <button id="abort">abort</button>
        <script>
            var oget = document.querySelector("#get");
            const conntroller = new AbortController();

            // 拦截器
            oget.onclick = function(){
                axios({
                    method: "GET",
                    url: "http://localhost:3005/users",
                    signal: conntroller.signal
                }).then(response => {
                    console.log(response);
                }).catch(reason => {
                    console.log(reason);
                });
            }

            abort.onclick = function(){
                conntroller.abort()
            }
           
        </script>
    </body>
</html>
```

## 3.4 在vue中封装axios

1. `requests.js`

    ```js
    //对于axios进行二次封装
    import axios from 'axios';
    //获取仓库:存储数据
    import store from '@/store';

    //axios.create方法执行,其实返回一个axios和request一样的
    let requests = axios.create({
        //基础路径,发请求URL携带api【发现:真实服务器接口都携带/api】
        baseURL: '/api',
        //超时的设置
        timeout: 5000,
    });

    //请求拦截器:将来项目中【N个请求】，只要发请求,会触发请求拦截器!!!
    requests.interceptors.request.use(config => {
        //请求拦截器:请求头【header】,请求头能否给服务器携带参数
        //请求拦截器：其实项目中还有一个重要的作用,给服务器携带请求们的公共的参数
        if (store.state.detail.nanoid_token) {
            config.headers.userTempId = store.state.detail.nanoid_token;
        }
        if (store.state.user.token) {
            config.headers.token = store.state.user.token;
        }
        return config;
    });

    //响应拦截器：请求数据返回会执行
    requests.interceptors.response.use(
        res => {
            //res:实质就是项目中发请求、服务器返回的数据
            return res.data;
        },
        err => {
            //温馨提示:某一天发请求,请求失败,请求失败的信息打印出来
            alert(err.message);
            //终止Promise链
            return new Promise();
        }
    );

    //最后需要暴露:暴露的是添加新的功能的axios,即为requests
    export default requests;
    ```

2. 其他文件调用

    ```js
    import requests from '@/api/requests';
    //注册的接口
    export const reqRegister = data =>
    requests({ url: `/user/passport/register`, method: 'post', data });
    ```