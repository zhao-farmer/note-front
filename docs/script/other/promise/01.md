# 一、promise基础使用


## 1.1 引出promise


1. 回调地狱

    - 当一个回调函数嵌套一个回调函数的时候
    - 就会出现一个嵌套结构
    - 当嵌套的多了就会出现回调地狱的情况
    - 比如我们发送三个 ajax 请求
        - 第一个正常发送
        - 第二个请求需要第一个请求的结果中的某一个值作为参数
        - 第三个请求需要第二个请求的结果中的某一个值作为参数

        ```js
        ajax({
            url: "我是第一个请求",
            success: function (res) {
                console.log(res);//打印第一个请求结果
                // 发送第二个请求
                ajax({
                    url: "我是第二个请求",
                    data: {
                        name: "张三"
                    },
                    success: function (res1) {
                        console.log(res1);//打印第二个请求结果
                        //发送第三个请求
                        ajax({
                            url: "我是第三个请求",
                            method: "POST",
                            data: {
                                name: "李四",
                                age: 18
                            },
                            success: function (res2) {
                                console.log(res2);//打印第三个请求结果
                            }
                        })
                    }
                })
            }
        })
        ```
2. 代码模拟 ajax方法

    ```js
    function ajax(url,successCb,errorCb){
        setTimeout(() => {
            // 如果成功
            successCb()
            // 如果失败
            errorCb()
        }, 1000);
    }

    ajax("111",()=>{
        console.log("ajax成功");
        
    },()=>{
        console.log("ajax失败");
    })
    ```

## 1.2 promise基本语法

1. 基础使用

    - 创建运行
        - 当我们new一个promise，此时我们需要传递一个回调函数，这个函数为立即执行的，称之为（executor）
        - 这个回调函数，我们需要传入两个参数回调函数，reslove,reject(函数可以进行传参)

    - 接受结果
        - 当执行了reslove函数，会回调promise对象的.then方法第一个参数
        - 当执行了reject函数，会回调promise对象的.then方法第二个参数或使用.catche函数

2. 代码示例

    ```js
    // promise(承诺) 构造函数
    // 接受的参数 executor 执行器
    var mypro = new Promise((resolve,reject)=>{
        // 如果销售额达到了
        // resolve()
        // 如果销售额没达到
        // reject();
        setTimeout(() => {
            // resolve()
            reject();
        }, 1000);
    })

    // 进行时，有承诺、拒绝承诺
    mypro.then(()=>{
        console.log("发奖金");
    },()=>{
        console.log("不发奖金");
    })

    // 拒绝承诺
    mypro.catch(()=>{
        console.log("不发奖金");
    })

    // 结合使用
    mypro.then(()=>{
        console.log("发奖金");
    }).catch(()=>{
        console.log("不发奖金");
    })
    ``` 

3. 封装ajax

    ```js
    function ajax(url){
        return new Promise((resolve,reject)=>{
            setTimeout(() => {
                // resolve();
                reject();
            }, 2000);
        })
    }

    ajax("1111").then(()=>{
        console.log("请求成功");
    }).catch(()=>{
        console.log("请求失败");
    })
    ```

## 1.3 promise的状态

1. 异步理解

    Promise 对象通过自身的状态，来控制异步操作。Promise 实例具有三种状态。

    - 异步操作未完成(pending)
    - 异步操作成功(fu1fi11ed)
    - 异步操作失败(rejected)

2. 对象理解

    使用promise的时候，给它一个承诺，我们可以将他划分为三个阶段

    - pending(待定)，执行了executor，状态还在等待中，没有被兑现，也没有被拒绝
    - fulfilled(已兑现)，执行了resolve函数则代表了已兑现状态
    - rejected(已拒绝)，执行了reject函数则代表了已拒绝状态
3. Promise 的最终结果只有两种。

    - 异步操作成功，Promise 实例传回一个值(value)，状态变为fu1fi11ed。
    - 异步操作失败，Promise 实例抛出一个错误(error)，状态变为rejected

    ![](/backend/quote/api/006.png)

4. 代码模拟

    ```js
    var mypro = new Promise((resolve,reject)=>{
        setTimeout(() => {
            resolve()
            // reject();
        }, 1000);
    })

    // 操作未完成 pending
    console.log(mypro);

    // 第一个操作成功 fulfilled
    // 第二个操作失败 rejected
    mypro.then(()=>{
        console.log("发奖金");
        console.log(mypro);
    },()=>{
        console.log("不发奖金111");
        console.log(mypro);
    })
    ```

## 1.4 promise的结果

```js

function ajax(url){
    return new Promise((resolve,reject)=>{
        setTimeout(() => {
            // resolve(["111","222","333"]);
            reject({code:401,info:"aaaa"})
        }, 2000);
    })
}

var pajax = ajax("1111");

pajax.then((res)=>{
    console.log("请求成功",res);
    console.log(pajax);
}).catch((err)=>{
    console.log("请求失败",err);
    console.log(pajax);
})
```

## 1.5 promise对ajax的封装

```js
function ajax(url){
    return new Promise((resolve,reject)=>{
        var xhr = new XMLHttpRequest();
        xhr.open("get",url,true)
        xhr.send()
        xhr.onreadystatechange = function(){
            if(xhr.readyState == 4){
                if(xhr.status>=200 && xhr.status <300){
                    // 成功
                    resolve(JSON.parse(xhr.responseText))
                }else{
                    // 失败
                    reject(xhr.responseText)
                }
            }
        }
    })
}

let file = "1.json"
let url = "https://api.kuleu.com/api/MP4_xiaojiejie?type=json"

ajax(url).then(res=>{
    console.log("success",res);
}).catch(err=>{
    console.log("err",err);
})
   
```