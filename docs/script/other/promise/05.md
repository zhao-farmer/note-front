# 五、async/await



## 5.1 认识 async/await

1. async 函数

    - async 关键字用于声明一个异步函数
    - 异步函数总是返回一个 Promise
        - 如果返回非 Promise 值，会自动包装成 resolved Promise
        - 如果抛出异常，返回 rejected Promise


2. await 表达式

    - await 只能在 async 函数内部使用

    - 它会"暂停" async 函数的执行，等待 Promise 完成

        - 如果 Promise 成功，返回 resolved 值

        - 如果 Promise 失败，抛出 rejection 的值（可以用 try/catch 捕获）

3. 代码示例

    ```js
    function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function test() {
    console.log('开始');
    await delay(1000); // 等待1秒
    console.log('1秒后');
    return '完成';
    }

    test().then(console.log); 
    /*
    输出:
    开始
    (等待1秒)
    1秒后
    完成
    */
    ```

## 5.2 async/await 应用

1. 处理多个请求

    ```js
    function ajax(url) {
        return new Promise((resolve, reject) => {
            var xhr = new XMLHttpRequest();
            xhr.open("get", url, true);
            xhr.send();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        // 成功
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        // 失败
                        reject(xhr.responseText);
                    }
                }
            };
        });
    }

    var name="tiechui"

    async function getData() {
        var res1 = ajax(`http://localhost:3000/news?author=${name}`)
        var res2 = ajax(`http://localhost:3000/comments?newsId=${res1[0].id}`)
        return res2
    }

    getData().then(res => {
        console.log("success", res);
    }).catch(err => {
        console.log("error", err);
    })
    ```

2. 使用try catch进行监控

    ```js
    function ajax(url) {
        return new Promise((resolve, reject) => {
            var xhr = new XMLHttpRequest();
            xhr.open("get", url, true);
            xhr.send();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        // 成功
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        // 失败
                        reject(xhr.responseText);
                    }
                }
            };
        });
    }

    var name="tiechui"

    async function getData() {
        try{
            var res1 = ajax(`http://localhost:3000/news?author=${name}`)
            var res2 = ajax(`http://localhost:3000/comments?newsId=${res1[0].id}`)
        
            console.log("构建页面",res2);
        }catch(error){
            console.log("error",error);
        }
    }

    getData()
    ```